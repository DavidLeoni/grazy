(function(){var e=Array;typeof Float32Array!="undefined"&&Float32Array.prototype!==undefined&&Float32Array.prototype.slice===undefined&&(Float32Array.prototype.slice=function(t,n){var r=this.length;t===undefined?t=0:t<0&&(t+=r),n===undefined?n=r:n<0&&(n+=r),r=n-t;if(0<r){var i=new Float32Array(r),s=0;do i[s]=this[t],s+=1,t+=1;while(t<n);return i}return new Float32Array(0)});var t={version:1,precision:1e-6,FLOAT_MAX:3.402823466e38,select:function(t,n,r){return t?n:r},reciprocal:function(t){if(t!==0)return 1/t;throw"Division by zero"},truncate:function(t){return t|0},v2BuildZero:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=0,n},v2BuildOne:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=1,n},v2BuildXAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=0,n},v2BuildYAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=1,n},v2Build:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n,i[1]=r,i},v2Copy:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n[0],r[1]=n[1],r},v2Set:function(t,n){t[0]=n[0],t[1]=n[1]},v2Neg:function(n,r){return r===undefined&&(r=new e(2)),r[0]=-n[0],r[1]=-n[1],r},v2Add:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i},v2Add3:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s},v2Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(2)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o},v2Sub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i},v2Mul:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i},v2MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s},v2Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]},v2PerpDot:function(t,n){return t[0]*n[1]-t[1]*n[0]},v2LengthSq:function(t){var n=t[0],r=t[1];return n*n+r*r},v2Length:function(t){var n=t[0],r=t[1];return Math.sqrt(n*n+r*r)},v2Reciprocal:function(r,i){i===undefined&&(i=new e(2));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i},v2Normalize:function(n,r){r===undefined&&(r=new e(2));var i=n[0],s=n[1],o=i*i+s*s;if(o>0){var u=1/Math.sqrt(o);r[0]=i*u,r[1]=s*u}else r[0]=0,r[1]=0;return r},v2Abs:function(n,r){r===undefined&&(r=new e(2));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r},v2Max:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Min:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r},v2MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s]},v2MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1]]},v2MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1]]},v2MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1]]},v2MaskNot:function(t){return[!t[0],!t[1]]},v2MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1]]},v2MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1]]},v2Select:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s},v2ScalarBuild:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n,r[1]=n,r},v2ScalarMax:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarMin:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r,i[1]=n[1]+r,i},v2ScalarSub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r,i[1]=n[1]-r,i},v2ScalarMul:function(n,r,i){return i===undefined&&(i=new e(2)),r===0?(i[0]=0,i[1]=0):(i[0]=n[0]*r,i[1]=n[1]*r),i},v2AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s},v2EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s]},v2LessScalarMask:function(t,n){return[t[0]<n,t[1]<n]},v2GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n]},v2GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n]},v2Lerp:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s},v3BuildZero:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=0,r},v3BuildOne:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=1,r[2]=1,r},v3BuildXAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=0,r[2]=0,r},v3BuildYAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=1,r[2]=0,r},v3BuildZAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=1,r},v3Build:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n,o[1]=r,o[2]=i,o},v3Copy:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},v3Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},v3Neg:function(n,r){return r===undefined&&(r=new e(3)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r},v3Add:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0],s[1]=n[1]+r[1],s[2]=n[2]+r[2],s},v3Add3:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s},v3Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(3)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o},v3Sub:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]-r[0],s[1]=n[1]-r[1],s[2]=n[2]-r[2],s},v3Mul:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i},v3MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s},v3Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]},v3Cross:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=n[0],u=n[1],a=n[2],f=r[0],l=r[1],c=r[2];return s[0]=u*c-a*l,s[1]=a*f-o*c,s[2]=o*l-u*f,s},v3LengthSq:function(t){var n=t[0],r=t[1],i=t[2];return n*n+r*r+i*i},v3Length:function(t){var n=t[0],r=t[1],i=t[2];return Math.sqrt(n*n+r*r+i*i)},v3Reciprocal:function(r,i){i===undefined&&(i=new e(3));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i},v3Normalize:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=n[0],o=n[1],u=n[2],a=s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);i[0]=s*f,i[1]=o*f,i[2]=u*f}else i[0]=0,i[1]=0,i[2]=0;return i},v3Abs:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=Math.abs;return i[0]=s(n[0]),i[1]=s(n[1]),i[2]=s(n[2]),i},v3Max:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.max;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Min:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.min;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r},v3MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s]},v3MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2]]},v3MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2]]},v3MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2]]},v3MaskNot:function(t){return[!t[0],!t[1],!t[2]]},v3MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2]]},v3MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2]]},v3Select:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s},v3ScalarBuild:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n,r[1]=n,r[2]=n,r},v3ScalarMax:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarMin:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i},v3ScalarSub:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i},v3ScalarMul:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),r===0?(s[0]=0,s[1]=0,s[2]=0):(s[0]=n[0]*r,s[1]=n[1]*r,s[2]=n[2]*r),s},v3AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s},v3EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s]},v3LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n]},v3GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n]},v3GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n]},v3Lerp:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n[0]+(r[0]-n[0])*i,o[1]=n[1]+(r[1]-n[1])*i,o[2]=n[2]+(r[2]-n[2])*i,o},v4BuildZero:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=0,r[1]=0,r[2]=0,r[3]=0,r},v4BuildOne:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=1,r[1]=1,r[2]=1,r[3]=1,r},v4Build:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},v4Copy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},v4Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},v4Neg:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=-n[3],r},v4Add:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i[2]=n[2]+r[2],i[3]=n[3]+r[3],i},v4Add3:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s[3]=n[3]+r[3]+i[3],s},v4Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(4)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o[3]=n[3]+r[3]+i[3]+s[3],o},v4Sub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i[2]=n[2]-r[2],i[3]=n[3]-r[3],i},v4Mul:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i[3]=n[3]*r[3],i},v4MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s[3]=n[3]*r[3]+i[3],s},v4Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3]},v4LengthSq:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return n*n+r*r+i*i+s*s},v4Length:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return Math.sqrt(n*n+r*r+i*i+s*s)},v4Reciprocal:function(r,i){i===undefined&&(i=new e(4));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i[3]=s(r[3]),i},v4Normalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=n[3],a=i*i+s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);r[0]=i*f,r[1]=s*f,r[2]=o*f,r[3]=u*f}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},v4Abs:function(n,r){r===undefined&&(r=new e(4));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r[2]=i(n[2]),r[3]=i(n[3]),r},v4Max:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Min:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},v4MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s,i(n[3]-r[3])<=s]},v4MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2],t[3]<n[3]]},v4MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2],t[3]>n[3]]},v4MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2],t[3]>=n[3]]},v4MaskNot:function(t){return[!t[0],!t[1],!t[2],!t[3]]},v4MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2],t[3]||n[3]]},v4MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2],t[3]&&n[3]]},v4Many:function(t){return t[0]||t[1]||t[2]||t[3]},v4MaskAll:function(t){return t[0]&&t[1]&&t[2]&&t[3]},v4Select:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s[3]=n[3]?r[3]:i[3],s},v4ScalarBuild:function(n,r){return r===undefined&&(r=new e(4)),r[0]=n,r[1]=n,r[2]=n,r[3]=n,r},v4ScalarMax:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarMin:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i[3]=n[3]+r,i},v4ScalarSub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i[3]=n[3]-r,i},v4ScalarMul:function(r,i,s){return i===0?t.v4BuildZero(s):(s===undefined&&(s=new e(4)),s[0]=r[0]*i,s[1]=r[1]*i,s[2]=r[2]*i,s[3]=r[3]*i,s)},v4AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s[3]=n[3]+r[3]*i,s},v4ScalarEqual:function(n,r){var i=Math.abs,s=t.precision;return i(n[0]-r)<=s&&i(n[1]-r)<=s&&i(n[2]-r)<=s&&i(n[3]-r)<=s},v4EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s,i(n[3]-r)<=s]},v4LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n,t[3]<n]},v4GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n,t[3]>n]},v4GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n,t[3]>=n]},v4Lerp:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s[2]=n[2]+(r[2]-n[2])*i,s[3]=n[3]+(r[3]-n[3])*i,s},aabbBuild:function(n,r,i,s,o,u,a){var f=a;return f===undefined&&(f=new e(6)),f[0]=n,f[1]=r,f[2]=i,f[3]=s,f[4]=o,f[5]=u,f},aabbBuildEmpty:function(n){var r=this.FLOAT_MAX,i=n;return i===undefined&&(i=new e(6)),i[0]=r,i[1]=r,i[2]=r,i[3]=-r,i[4]=-r,i[5]=-r,i},aabbCopy:function(n,r){var i=r;return i===undefined&&(i=new e(6)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i},aabbSet:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5]},aabbIsEmpty:function(t){return t[0]>t[3]},aabbMin:function(t,n){return n===undefined?t.slice(0,3):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n)},aabbMax:function(t,n){return n===undefined?t.slice(3,6):(n[0]=t[3],n[1]=t[4],n[2]=t[5],n)},aabbGetCenterAndHalf:function(t,n,r){var i=(t[0]+t[3])*.5,s=(t[1]+t[4])*.5,o=(t[2]+t[5])*.5;n[0]=i,n[1]=s,n[2]=o,r[0]=t[3]-i,r[1]=t[4]-s,r[2]=t[5]-o},aabbIsInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2];if(o*(o<0?t[0]:t[3])+u*(u<0?t[1]:t[4])+a*(a<0?t[2]:t[5])<s[3])return!1;i+=1}while(i<r);return!0},aabbIsFullyInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2];if(o*(o>0?t[0]:t[3])+u*(u>0?t[1]:t[4])+a*(a>0?t[2]:t[5])<s[3])return!1;i+=1}while(i<r);return!0},aabbUnion:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]<r[0]?n[0]:r[0],i[1]=n[1]<r[1]?n[1]:r[1],i[2]=n[2]<r[2]?n[2]:r[2],i[3]=n[3]>r[3]?n[3]:r[3],i[4]=n[4]>r[4]?n[4]:r[4],i[5]=n[5]>r[5]?n[5]:r[5],i},aabbUnionArray:function(r,i){i===undefined&&(i=new e(6)),t.aabbCopy(r[0],i);var s=r.length;for(var o=1;o<s;o+=1){var u=r[o];i[0]=i[0]<u[0]?i[0]:u[0],i[1]=i[1]<u[1]?i[1]:u[1],i[2]=i[2]<u[2]?i[2]:u[2],i[3]=i[3]>u[3]?i[3]:u[3],i[4]=i[4]>u[4]?i[4]:u[4],i[5]=i[5]>u[5]?i[5]:u[5]}return i},aabbAddPoints:function(t,n){var r,i=n.length,s=t[0],o=t[1],u=t[2],a=t[3],f=t[4],l=t[5],c,h,p,d;for(r=0;r<i;r+=1)c=n[r],h=c[0],p=c[1],d=c[2],s=s<h?s:h,o=o<p?o:p,u=u<d?u:d,a=a>h?a:h,f=f>p?f:p,l=l>d?l:d;t[0]=s,t[1]=o,t[2]=u,t[3]=a,t[4]=f,t[5]=l},aabbTransform:function(n,r,i){i===undefined&&(i=new e(6));var s=(n[0]+n[3])*.5,o=(n[1]+n[4])*.5,u=(n[2]+n[5])*.5,a=n[3]-s,f=n[4]-o,l=n[5]-u,c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9]+(c*s+d*o+g*u),E=r[10]+(h*s+v*o+y*u),S=r[11]+(p*s+m*o+b*u),x=Math.abs,T=x(c)*a+x(d)*f+x(g)*l,N=x(h)*a+x(v)*f+x(y)*l,C=x(p)*a+x(m)*f+x(b)*l;return i[0]=w-T,i[1]=E-N,i[2]=S-C,i[3]=w+T,i[4]=E+N,i[5]=S+C,i},aabbIntercept:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]>r[0]?n[0]:r[0],i[1]=n[1]>r[1]?n[1]:r[1],i[2]=n[2]>r[2]?n[2]:r[2],i[3]=n[3]<r[3]?n[3]:r[3],i[4]=n[4]<r[4]?n[4]:r[4],i[5]=n[5]<r[5]?n[5]:r[5],i},aabbOverlaps:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]},aabbSphereOverlaps:function(t,n,r){var i=n[0],s=n[1],o=n[2],u=r*r,a=t[0],f=t[1],l=t[2],c=t[3],h=t[4],p=t[5],d=0,v;return i<a?(v=a-i,d+=v*v):i>c&&(v=i-c,d+=v*v),s<f?(v=f-s,d+=v*v):s>h&&(v=s-h,d+=v*v),o<l?(v=l-o,d+=v*v):o>p&&(v=o-p,d+=v*v),d<=u},aabbIsInside:function(t,n){return t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]},aabbTestInside:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]?t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]?2:1:0},m33BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(9)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},m33Build:function(n,r,i,s){var o,u=arguments.length;return u>=9?(u>9?(o=arguments[9],o===undefined&&(o=new e(9))):o=new e(9),o[0]=arguments[0],o[1]=arguments[1],o[2]=arguments[2],o[3]=arguments[3],o[4]=arguments[4],o[5]=arguments[5],o[6]=arguments[6],o[7]=arguments[7],o[8]=arguments[8]):(o=s,o===undefined&&(o=new e(9)),o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=r[0],o[4]=r[1],o[5]=r[2],o[6]=i[0],o[7]=i[1],o[8]=i[2]),o},m33Copy:function(n,r){var i=r;return i===undefined&&(i=new e(9)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i},m33FromAxisRotation:function(n,r,i){var s=i;s===undefined&&(s=new e(9));var o=Math.sin(r),u=Math.cos(r),a=1-u,f=n[0],l=n[1],c=n[2],h=a*f,p=a*l,d=a*c,v=o*f,m=o*l,g=o*c;return s[0]=h*f+u,s[1]=h*l-g,s[2]=h*c+m,s[3]=p*f+g,s[4]=p*l+u,s[5]=p*c-v,s[6]=d*f-m,s[7]=d*l+v,s[8]=d*c+u,s},m33FromQuat:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a;return i[0]=1-l-c,i[1]=h-p,i[2]=d+v,i[3]=h+p,i[4]=1-f-c,i[5]=m-g,i[6]=d-v,i[7]=m+g,i[8]=1-f-l,i},m33Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m33Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m33At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m33SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m33SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m33SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m33Transpose:function(n,r){r===undefined&&(r=new e(9));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r},m33Determinant:function(t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8];return n*(o*l-u*f)+r*(u*a-s*l)+i*(s*f-o*a)},m33Inverse:function(r,i){i===undefined&&(i=new e(9));var s=t.m33Determinant(r);if(s===0)return i[0]=i[1]=i[2]=0,i[3]=i[4]=i[5]=0,i[6]=i[7]=i[8]=0,i;var o=r[0],u=r[1],a=r[2],f=r[3],l=r[4],c=r[5],h=r[6],p=r[7],d=r[8],v=1/s;return i[0]=(l*d+c*-p)*v,i[1]=(p*a+d*-u)*v,i[2]=(u*c-a*l)*v,i[3]=(c*h+f*-d)*v,i[4]=(d*o+h*-a)*v,i[5]=(f*a-o*c)*v,i[6]=(f*p+l*-h)*v,i[7]=(h*u+p*-o)*v,i[8]=(o*l-f*u)*v,i},m33InverseTranspose:function(n,r){r===undefined&&(r=new e(9));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=i*(a*h-f*c)+s*(f*l-u*h)+o*(u*c-a*l);if(p===0)return r[0]=r[1]=r[2]=0,r[3]=r[4]=r[5]=0,r[6]=r[7]=r[8]=0,r;var d=1/p;return r[0]=(a*h+f*-c)*d,r[3]=(c*o+h*-s)*d,r[6]=(s*f-o*a)*d,r[1]=(f*l+u*-h)*d,r[4]=(h*i+l*-o)*d,r[7]=(u*o-i*f)*d,r[2]=(u*c+a*-l)*d,r[5]=(l*s+c*-i)*d,r[8]=(i*a-u*s)*d,r},m33Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i===undefined&&(i=new e(9)),i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i},m33Transform:function(n,r,i){i===undefined&&(i=new e(3));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s+n[3]*o+n[6]*u,i[1]=n[1]*s+n[4]*o+n[7]*u,i[2]=n[2]*s+n[5]*o+n[8]*u,i},m33Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r&&i(t[4]-n[4])<=r&&i(t[5]-n[5])<=r&&i(t[6]-n[6])<=r&&i(t[7]-n[7])<=r&&i(t[8]-n[8])<=r},m33MulM43:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i[9]=r[9],i[10]=r[10],i[11]=r[11],i},m33MulM44:function(n,r,i){i===undefined&&(i=new e(16));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8],x=r[9],T=r[10],N=r[11];return i[0]=d*s+y*o+S*u,i[1]=v*s+b*o+x*u,i[2]=m*s+w*o+T*u,i[3]=g*s+E*o+N*u,i[4]=d*a+y*f+S*l,i[5]=v*a+b*f+x*l,i[6]=m*a+w*f+T*l,i[7]=g*a+E*f+N*l,i[8]=d*c+y*h+S*p,i[9]=v*c+b*h+x*p,i[10]=m*c+w*h+T*p,i[11]=g*c+E*h+N*p,i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],i},m33ScalarAdd:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]+r;return i},m33ScalarSub:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]-r;return i},m33ScalarMul:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]*r;return i},m34BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r},m34Pos:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n[3],r[1]=n[7],r[2]=n[11],r},m34Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3],i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[7]=n[7],i[8]=n[8]*u,i[9]=n[9]*u,i[10]=n[10]*u,i[11]=n[11],i},m43BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r[9]=0,r[10]=0,r[11]=0,r},m43Build:function(n,r,i,s,o,u,a,f,l,c,h,p,d){var v,m=arguments.length;return m>=12?(m>12?(v=arguments[12],v===undefined&&(v=new e(12))):v=new e(12),v[0]=arguments[0],v[1]=arguments[1],v[2]=arguments[2],v[3]=arguments[3],v[4]=arguments[4],v[5]=arguments[5],v[6]=arguments[6],v[7]=arguments[7],v[8]=arguments[8],v[9]=arguments[9],v[10]=arguments[10],v[11]=arguments[11]):(v=o,v===undefined&&(v=new e(12)),v[0]=n[0],v[1]=n[1],v[2]=n[2],v[3]=r[0],v[4]=r[1],v[5]=r[2],v[6]=i[0],v[7]=i[1],v[8]=i[2],v[9]=s[0],v[10]=s[1],v[11]=s[2]),v},m43BuildTranslation:function(n,r,i,s){var o;return 3<=arguments.length?(o=s,o===undefined&&(o=new e(12)),o[9]=n,o[10]=r,o[11]=i):(o=r,o===undefined&&(o=new e(12)),o[9]=n[0],o[10]=n[1],o[11]=n[2]),o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=1,o[5]=0,o[6]=0,o[7]=0,o[8]=1,o},m43Copy:function(n,r){var i=r;return i===undefined&&(i=new e(12)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43FromM33V3:function(n,r,i){var s=i;return s===undefined&&(s=new e(12)),s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[3],s[4]=n[4],s[5]=n[5],s[6]=n[6],s[7]=n[7],s[8]=n[8],s[9]=r[0],s[10]=r[1],s[11]=r[2],s},m43FromAxisRotation:function(n,r,i){var s=Math.sin(r),o=Math.cos(r),u=1-o,a=n[0],f=n[1],l=n[2],c=u*a,h=u*f,p=u*l,d=s*a,v=s*f,m=s*l,g=i;return g===undefined&&(g=new e(12)),g[0]=c*a+o,g[1]=c*f-m,g[2]=c*l+v,g[3]=h*a+m,g[4]=h*f+o,g[5]=h*l-d,g[6]=p*a-v,g[7]=p*f+d,g[8]=p*l+o,g[9]=0,g[10]=0,g[11]=0,g},m43FromQuatPos:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=2*s*s,p=2*o*o,d=2*u*u,v=2*s*o,m=2*u*a,g=2*s*u,y=2*o*a,b=2*o*u,w=2*s*a;return i[0]=1-p-d,i[1]=v-m,i[2]=g+y,i[3]=v+m,i[4]=1-h-d,i[5]=b-w,i[6]=g-y,i[7]=b+w,i[8]=1-h-p,i[9]=f,i[10]=l,i[11]=c,i},m43FromRTS:function(n,r,i,s){var o=n[0],u=n[1],a=n[2],f=n[3],l=2*o*o,c=2*u*u,h=2*a*a,p=2*o*u,d=2*a*f,v=2*o*a,m=2*u*f,g=2*u*a,y=2*o*f,b=i[0],w=i[1],E=i[2],S=s;return S===undefined&&(S=new e(12)),S[0]=b*(1-c-h),S[1]=b*(p-d),S[2]=b*(v+m),S[3]=w*(p+d),S[4]=w*(1-l-h),S[5]=w*(g-y),S[6]=E*(v-m),S[7]=E*(g+y),S[8]=E*(1-l-c),S[9]=r[0],S[10]=r[1],S[11]=r[2],S},m43FromRT:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a,y=i;return y===undefined&&(y=new e(12)),y[0]=1-l-c,y[1]=h-p,y[2]=d+v,y[3]=h+p,y[4]=1-f-c,y[5]=m-g,y[6]=d-v,y[7]=m+g,y[8]=1-f-l,y[9]=r[0],y[10]=r[1],y[11]=r[2],y},m43Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m43Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m43At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m43Pos:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[9],i[1]=n[10],i[2]=n[11],i},m43SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m43SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m43SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m43SetPos:function(t,n){t[9]=n[0],t[10]=n[1],t[11]=n[2]},m43SetAxisRotation:function(t,n,r){var i=Math.sin(r),s=Math.cos(r),o=1-s,u=n[0],a=n[1],f=n[2],l=o*u,c=o*a,h=o*f,p=i*u,d=i*a,v=i*f;t[0]=l*u+s,t[1]=l*a-v,t[2]=l*f+d,t[3]=c*u+v,t[4]=c*a+s,t[5]=c*f-p,t[6]=h*u-d,t[7]=h*a+p,t[8]=h*f+s},m43InverseOrthonormal:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r[9]=-(p*i+d*s+v*o),r[10]=-(p*u+d*a+v*f),r[11]=-(p*l+d*c+v*h),r},m43Orthonormalize:function(r,i){var s=t.v3Normalize,o=t.v3Length,u=t.v3Dot,a=t.v3Cross,f=Math.abs,l=t.m43Right(r),c=t.m43Up(r),h=t.m43At(r),p=t.m43Pos(r),d=o(l),v=o(c),m=o(h);s(l,l),s(c,c),s(h,h);var g,y,b;if(d>0)if(v>0)if(m>0){var w=f(u(c,h)),E=f(u(h,l)),S=f(u(l,c));w<E?w<S?(g=c,y=h,b=l):(g=l,y=c,b=h):E<S?(g=h,y=l,b=c):(g=l,y=c,b=h)}else g=l,y=c,b=h;else g=h,y=l,b=c;else g=c,y=h,b=l;return a(g,y,b),s(b,b),a(b,g,y),s(y,y),i===undefined&&(i=new e(12)),i[0]=l[0],i[1]=l[1],i[2]=l[2],i[3]=c[0],i[4]=c[1],i[5]=c[2],i[6]=h[0],i[7]=h[1],i[8]=h[2],i[9]=p[0],i[10]=p[1],i[11]=p[2],i},m43Determinant:function(t){return t[0]*(t[4]*t[8]-t[5]*t[7])+t[1]*(t[5]*t[6]-t[3]*t[8])+t[2]*(t[3]*t[7]-t[4]*t[6])},m43Inverse:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=i*(a*h-f*c)+s*(f*l-u*h)+o*(u*c-a*l);if(m===0)return r;r===undefined&&(r=new e(12));var g=1/m;return r[0]=(a*h+f*-c)*g,r[1]=(c*o+h*-s)*g,r[2]=(s*f-o*a)*g,r[3]=(f*l+u*-h)*g,r[4]=(h*i+l*-o)*g,r[5]=(u*o-i*f)*g,r[6]=(u*c+a*-l)*g,r[7]=(l*s+c*-i)*g,r[8]=(i*a-u*s)*g,r[9]=(u*(d*h-c*v)+a*(l*v-p*h)+f*(p*c-l*d))*g,r[10]=(l*(o*d-s*v)+c*(i*v-p*o)+h*(p*s-i*d))*g,r[11]=(p*(o*a-s*f)+d*(i*f-u*o)+v*(u*s-i*a))*g,r},m43Translate:function(t,n){t[9]+=n[0],t[10]+=n[1],t[11]+=n[2]},m43Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3]*o,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*u,i[7]=n[7]*u,i[8]=n[8]*u,i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43TransformVector:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a,s[1]=n[1]*o+n[4]*u+n[7]*a,s[2]=n[2]*o+n[5]*u+n[8]*a,s},m43TransformPoint:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a+n[9],s[1]=n[1]*o+n[4]*u+n[7]*a+n[10],s[2]=n[2]*o+n[5]*u+n[8]*a+n[11],s},m43Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=i;return C===undefined&&(C=new e(12)),C[0]=g*s+w*o+x*u,C[1]=y*s+E*o+T*u,C[2]=b*s+S*o+N*u,C[3]=g*a+w*f+x*l,C[4]=y*a+E*f+T*l,C[5]=b*a+S*f+N*l,C[6]=g*c+w*h+x*p,C[7]=y*c+E*h+T*p,C[8]=b*c+S*h+N*p,C[9]=g*d+w*v+x*m+r[9],C[10]=y*d+E*v+T*m+r[10],C[11]=b*d+S*v+N*m+r[11],C},m43MulM44:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(16)),A[0]=g*s+E*o+N*u,A[1]=y*s+S*o+C*u,A[2]=b*s+x*o+k*u,A[3]=w*s+T*o+L*u,A[4]=g*a+E*f+N*l,A[5]=y*a+S*f+C*l,A[6]=b*a+x*f+k*l,A[7]=w*a+T*f+L*l,A[8]=g*c+E*h+N*p,A[9]=y*c+S*h+C*p,A[10]=b*c+x*h+k*p,A[11]=w*c+T*h+L*p,A[12]=g*d+E*v+N*m+r[12],A[13]=y*d+S*v+C*m+r[13],A[14]=b*d+x*v+k*m+r[14],A[15]=w*d+T*v+L*m+r[15],A},m43Transpose:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11];return i[0]=s,i[1]=a,i[2]=c,i[3]=d,i[4]=o,i[5]=f,i[6]=h,i[7]=v,i[8]=u,i[9]=l,i[10]=p,i[11]=m,i},m43MulTranspose:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(12)),A[0]=g*s+w*o+x*u,A[1]=g*a+w*f+x*l,A[2]=g*c+w*h+x*p,A[3]=g*d+w*v+x*m+C,A[4]=y*s+E*o+T*u,A[5]=y*a+E*f+T*l,A[6]=y*c+E*h+T*p,A[7]=y*d+E*v+T*m+k,A[8]=b*s+S*o+N*u,A[9]=b*a+S*f+N*l,A[10]=b*c+S*h+N*p,A[11]=b*d+S*v+N*m+L,A},m43Offset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43NegOffset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=-r[0],y=-r[1],b=-r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43InverseTransposeProjection:function(n,r,i){i===undefined&&(i=new e(12));var s=.5/r[0],o=.5/r[1],u=.5/r[2],a=n[0]*s,f=n[1]*s,l=n[2]*s,c=n[3]*o,h=n[4]*o,p=n[5]*o,d=n[6]*u,v=n[7]*u,m=n[8]*u,g=n[9],y=n[10],b=n[11];return i[0]=a,i[1]=f,i[2]=l,i[3]=.5-(g*a+y*f+b*l),i[4]=c,i[5]=h,i[6]=p,i[7]=.5-(g*c+y*h+b*p),i[8]=d,i[9]=v,i[10]=m,i[11]=.5-(g*d+y*v+b*m),i},m43ScalarAdd:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]+r;return i},m43ScalarSub:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]-r;return i},m43ScalarMul:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]*r;return i},m44BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(16)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},m44Build:function(n,r,i,s,o){var u,a=arguments.length;return a>=16?(a>16?(u=arguments[16],u===undefined&&(u=new e(16))):u=new e(16),u[0]=arguments[0],u[1]=arguments[1],u[2]=arguments[2],u[3]=arguments[3],u[4]=arguments[4],u[5]=arguments[5],u[6]=arguments[6],u[7]=arguments[7],u[8]=arguments[8],u[9]=arguments[9],u[10]=arguments[10],u[11]=arguments[11],u[12]=arguments[12],u[13]=arguments[13],u[14]=arguments[14],u[15]=arguments[15]):(u=o,u===undefined&&(u=new e(16)),u[0]=n[0],u[1]=n[1],u[2]=n[2],u[3]=n[3],u[4]=r[0],u[5]=r[1],u[6]=r[2],u[7]=r[3],u[8]=i[0],u[9]=i[1],u[10]=i[2],u[11]=i[3],u[12]=s[0],u[13]=s[1],u[14]=s[2],u[15]=s[3]),u},m44Copy:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],r},m44Right:function(t,n){return n===undefined?t.slice(0,4):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n)},m44Up:function(t,n){return n===undefined?t.slice(4,8):(n[0]=t[4],n[1]=t[5],n[2]=t[6],n[3]=t[7],n)},m44At:function(t,n){return n===undefined?t.slice(8,12):(n[0]=t[8],n[1]=t[9],n[2]=t[10],n[3]=t[11],n)},m44Pos:function(t,n){return n===undefined?t.slice(12):(n[0]=t[12],n[1]=t[13],n[2]=t[14],n[3]=t[15],n)},m44SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},m44SetUp:function(t,n){t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3]},m44SetAt:function(t,n){t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=n[3]},m44SetPos:function(t,n){t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=n[3]},m44Translate:function(t,n){t[12]+=n[0],t[13]+=n[1],t[14]+=n[2],t[15]+=n[3]},m44Scale:function(n,r,i){return i===undefined&&(i=new e(16)),i[0]=n[0]*r[0],i[1]=n[1]*r[0],i[2]=n[2]*r[0],i[3]=n[3],i[4]=n[4]*r[1],i[5]=n[5]*r[1],i[6]=n[6]*r[1],i[7]=n[7],i[8]=n[8]*r[2],i
[9]=n[9]*r[2],i[10]=n[10]*r[2],i[11]=n[11],i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],i},m44Transform:function(n,r,i){var s=r[0],o=r[1],u=r[2],a=r[3];return i===undefined&&(i=new e(4)),a!==1?(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12]*a,i[1]=n[1]*s+n[5]*o+n[9]*u+n[13]*a,i[2]=n[2]*s+n[6]*o+n[10]*u+n[14]*a,i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]*a):(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12],i[1]=n[1]*s+n[5]*o+n[9]*u+n[13],i[2]=n[2]*s+n[6]*o+n[10]*u+n[14],i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]),i},m44Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r[0],S=r[1],x=r[2],T=r[3],N=r[4],C=r[5],k=r[6],L=r[7],A=r[8],O=r[9],M=r[10],_=r[11],D=r[12],P=r[13],H=r[14],B=r[15];return i===undefined&&(i=new e(16)),i[0]=E*s+N*o+A*u+D*a,i[1]=S*s+C*o+O*u+P*a,i[2]=x*s+k*o+M*u+H*a,i[3]=T*s+L*o+_*u+B*a,i[4]=E*f+N*l+A*c+D*h,i[5]=S*f+C*l+O*c+P*h,i[6]=x*f+k*l+M*c+H*h,i[7]=T*f+L*l+_*c+B*h,i[8]=E*p+N*d+A*v+D*m,i[9]=S*p+C*d+O*v+P*m,i[10]=x*p+k*d+M*v+H*m,i[11]=T*p+L*d+_*v+B*m,i[12]=E*g+N*y+A*b+D*w,i[13]=S*g+C*y+O*b+P*w,i[14]=x*g+k*y+M*b+H*w,i[15]=T*g+L*y+_*b+B*w,i},m44Inverse:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15];r===undefined&&(r=new e(16));var w=i*f-s*a,E=i*l-o*a,S=i*c-u*a,x=s*l-o*f,T=s*c-u*f,N=o*c-u*l,C=h*g-p*m,k=h*y-d*m,L=h*b-v*m,A=p*y-d*g,O=p*b-v*g,M=d*b-v*y,_=w*M-E*O+S*A+x*L-T*k+N*C;if(_===0)r[0]=0,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=0;else{var D=1/_;r[0]=(+(f*M)-l*O+c*A)*D,r[4]=(-(a*M)+l*L-c*k)*D,r[8]=(+(a*O)-f*L+c*C)*D,r[12]=(-(a*A)+f*k-l*C)*D,r[1]=(-(s*M)+o*O-u*A)*D,r[5]=(+(i*M)-o*L+u*k)*D,r[9]=(-(i*O)+s*L-u*C)*D,r[13]=(+(i*A)-s*k+o*C)*D,r[2]=(+(g*N)-y*T+b*x)*D,r[6]=(-(m*N)+y*S-b*E)*D,r[10]=(+(m*T)-g*S+b*w)*D,r[14]=(-(m*x)+g*E-y*w)*D,r[3]=(-(p*N)+d*T-v*x)*D,r[7]=(+(h*N)-d*S+v*E)*D,r[11]=(-(h*T)+p*S-v*w)*D,r[15]=(+(h*x)-p*E+d*w)*D}return r},m44Transpose:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[4],r[2]=n[8],r[3]=n[12],r[4]=n[1],r[5]=n[5],r[6]=n[9],r[7]=n[13],r[8]=n[2],r[9]=n[6],r[10]=n[10],r[11]=n[14],r[12]=n[3],r[13]=n[7],r[14]=n[11],r[15]=n[15],r},m44ScalarAdd:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]+r;return i},m44ScalarSub:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]-r;return i},m44ScalarMul:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]*r;return i},quatBuild:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},quatCopy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},quatIsSimilar:function(n,r,i){i===undefined&&(i=this.precision);var s=n;n[3]*r[3]<0&&(s=t.v4Neg(n));var o=t.v4LengthSq(t.v4Sub(s,r)),u=i*i;return o<u},quatLength:function(n){return t.v4Length(n)},quatDot:function(n,r){return t.v4Dot(n,r)},quatMul:function(n,r,i){i===undefined&&(i=new e(4));var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=r[3],p=c*o-l*u,d=f*u-c*s,v=l*s-f*o;return i[0]=s*h+f*a+p,i[1]=o*h+l*a+d,i[2]=u*h+c*a+v,i[3]=h*a-(f*s+l*o+c*u),i},quatMulTranslate:function(t,n,r,i,s,o){var u=t[0],a=t[1],f=t[2],l=t[3],c=r[0],h=r[1],p=r[2],d=r[3],v=f*h-a*p,m=u*p-f*c,g=a*c-u*h;s[0]=c*l+u*d+v,s[1]=h*l+a*d+m,s[2]=p*l+f*d+g,s[3]=l*d-(u*c+a*h+f*p);var y=n[0],b=n[1],w=n[2],E=i[0],S=i[1],x=i[2],T=l*l-(u*u+a*a+f*f),N=E*T,C=S*T,k=x*T;T=u*E+a*S+f*x;var L=T+T;N+=u*L,C+=a*L,k+=f*L,v=f*S-a*x,m=u*x-f*E,g=a*E-u*S;var A=l+l;N+=v*A,C+=m*A,k+=g*A,o[0]=N+y,o[1]=C+b,o[2]=k+w},quatNormalize:function(n,r){var i=t.quatDot(n,n);if(i===0)return t.v4BuildZero(r);var s=1/Math.sqrt(i);return t.v4ScalarMul(n,s,r)},quatConjugate:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=n[3],r},quatLerp:function(n,r,i,s){s===undefined&&(s=new e(4));var o=n[0],u=n[1],a=n[2],f=n[3],l=r[0],c=r[1],h=r[2],p=r[3];return s[0]=(l-o)*i+o,s[1]=(c-u)*i+u,s[2]=(h-a)*i+a,s[3]=(p-f)*i+f,s},cosMinSlerpAngle:Math.cos(Math.PI/40),quatSlerp:function(r,i,s,o){var u=o;u===undefined&&(u=new e(4));var a=r[0],f=r[1],l=r[2],c=r[3],h=i[0],p=i[1],d=i[2],v=i[3],m=a*h+f*p+l*d+c*v,g=m;g<0&&(a=-a,f=-f,l=-l,c=-c,g=-g);if(g>t.cosMinSlerpAngle){if(g>1-1e-6)return u[0]=a,u[1]=f,u[2]=l,u[3]=c,u;var y=s;m<=0&&(y=-s);var b=(h-a)*y+a,w=(p-f)*y+f,E=(d-l)*y+l,S=(v-c)*y+c,x=Math.sqrt(b*b+w*w+E*E+S*S),T=1/x;return u[0]=b*T,u[1]=w*T,u[2]=E*T,u[3]=S*T,u}var N=Math.sin,C=Math.acos(g),k=1/N(C),L=N((1-s)*C)*k;return a*=L,f*=L,l*=L,c*=L,L=N(s*C)*k,h*=L,p*=L,d*=L,v*=L,u[0]=a+h,u[1]=f+p,u[2]=l+d,u[3]=c+v,u},quatFromM43:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p,d,v,m,g,y=i+a+h+1;y>t.precision?(m=Math.sqrt(y)/2,p=(f-c)/(4*m),d=(l-o)/(4*m),v=(s-u)/(4*m)):i>a&&i>h?(g=Math.sqrt(1+i-a-h)*2,m=(f-c)/g,p=.25*g,d=(u+s)/g,v=(l+o)/g):a>h?(g=Math.sqrt(1+a-i-h)*2,m=(l-o)/g,p=(u+s)/g,d=.25*g,v=(c+f)/g):(g=Math.sqrt(1+h-i-a)*2,m=(s-u)/g,p=(l+o)/g,d=(c+f)/g,v=.25*g);var b=t.quatNormalize([p,d,v,m],r);return t.quatConjugate(b,r)},quatFromAxisRotation:function(r,i,s){var o=.5*i,u=Math.sin(o),a=Math.cos(o),f=s;return f===undefined&&(f=new e(4)),f[0]=r[0]*u,f[1]=r[1]*u,f[2]=r[2]*u,f[3]=a,t.quatNormalize(f,f)},quatToAxisRotation:function(r,i){i===undefined&&(i=new e(4));var s=r[3],o=Math.acos(s)*2,u=1-s*s;if(u<t.precision)i[0]=1,i[1]=0,i[2]=0,i[3]=o;else{var a=1/Math.sqrt(u);i[0]=r[0]*a,i[1]=r[1]*a,i[2]=r[2]*a,i[3]=o}return i},quatTransformVector:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=a*a-(s*s+o*o+u*u),p=f*h,d=l*h,v=c*h;h=s*f+o*l+u*c;var m=h+h;p+=s*m,d+=o*m,v+=u*m;var g=u*l-o*c,y=s*c-u*f,b=o*f-s*l,w=a+a;return p+=g*w,d+=y*w,v+=b*w,i===undefined&&(i=new e(3)),i[0]=p,i[1]=d,i[2]=v,i},quatEqual:function(t,n,r){r===undefined&&(r=this.precision);var i=Math.abs;return i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},quatPosBuild:function(n,r,i,s,o,u,a,f){var l;return arguments.length<7?(l=i,l===undefined&&(l=new e(7)),l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],l[4]=r[0],l[5]=r[1],l[6]=r[2]):(l=f,l===undefined&&(l=new e(7)),l[0]=n,l[1]=r,l[2]=i,l[3]=s,l[4]=o,l[5]=u,l[6]=a),l},quatPosTransformVector:function(n,r,i){return t.quatTransformVector(n,r,i)},quatPosTransformPoint:function(n,r){var i=n.slice(4,7),s=t.quatTransformVector(n,r);return t.v3Add(s,i)},quatPosMul:function(n,r){var i=r.slice(4,7),s=t.quatMul(n,r),o=t.quatPosTransformPoint(n,i);return s[4]=o[0],s[5]=o[1],s[6]=o[2],s},isVisibleBox:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=n[0],f=n[1],l=n[2],c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9],E=r[10],S=r[11],x=c*a,T=h*a,N=p*a,C=d*a,k=v*f,L=m*f,A=g*f,O=y*f,M=b*l,_=w*l,D=E*l,P=S*l,H=c*s+v*o+b*u+r[12],B=h*s+m*o+w*u+r[13],j=p*s+g*o+E*u+r[14],F=d*s+y*o+S*u+r[15];return!(H-F>i(x-C)+i(k-O)+i(M-P)||H+F<-(i(x+C)+i(k+O)+i(M+P))||B-F>i(T-C)+i(L-O)+i(_-P)||B+F<-(i(T+C)+i(L+O)+i(_+P))||j-F>i(N-C)+i(A-O)+i(D-P)||j+F<-(i(N+C)+i(A+O)+i(D+P))||F+F<-(i(C+C)+i(O+O)+i(P+P)))},isVisibleBoxOrigin:function(t,n){var r=Math.abs,i=t[0],s=t[1],o=t[2],u=n[0]*i,a=n[1]*i,f=n[2]*i,l=n[3]*i,c=n[4]*s,h=n[5]*s,p=n[6]*s,d=n[7]*s,v=n[8]*o,m=n[9]*o,g=n[10]*o,y=n[11]*o,b=n[12],w=n[13],E=n[14],S=n[15];return!(b-S>r(u-l)+r(c-d)+r(v-y)||b+S<-(r(u+l)+r(c+d)+r(v+y))||w-S>r(a-l)+r(h-d)+r(m-y)||w+S<-(r(a+l)+r(h+d)+r(m+y))||E-S>r(f-l)+r(p-d)+r(g-y)||E+S<-(r(f+l)+r(p+d)+r(g+y))||S+S<-(r(l+l)+r(d+d)+r(y+y)))},isVisibleSphere:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=r[0],f=r[1],l=r[2],c=r[3],h=r[4],p=r[5],d=r[6],v=r[7],m=r[8],g=r[9],y=r[10],b=r[11],w=a,E=f,S=l,x=c,T=h,N=p,C=d,k=v,L=m,A=g,O=y,M=b,_=a*s+h*o+m*u+r[12],D=f*s+p*o+g*u+r[13],P=l*s+d*o+y*u+r[14],H=c*s+v*o+b*u+r[15],B=-n;return!(_-H>n*(i(w-x)+i(T-k)+i(L-M))||_+H<B*(i(w+x)+i(T+k)+i(L+M))||D-H>n*(i(E-x)+i(N-k)+i(A-M))||D+H<B*(i(E+x)+i(N+k)+i(A+M))||P-H>n*(i(S-x)+i(C-k)+i(O-M))||P+H<B*(i(S+x)+i(C+k)+i(O+M))||H+H<B*(i(x+x)+i(k+k)+i(M+M)))},isVisibleSphereOrigin:function(t,n){var r=Math.abs,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15],w=-t;return!(m-b>t*(r(i-u)+r(a-c)+r(h-v))||m+b<w*(r(i+u)+r(a+c)+r(h+v))||g-b>t*(r(s-u)+r(f-c)+r(p-v))||g+b<w*(r(s+u)+r(f+c)+r(p+v))||y-b>t*(r(o-u)+r(l-c)+r(d-v))||y+b<w*(r(o+u)+r(l+c)+r(d+v))||b+b<w*(r(u+u)+r(c+c)+r(v+v)))},isVisibleSphereUnit:function(t){var n=Math.abs,r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],v=t[12],m=t[13],g=t[14],y=t[15];return!(v-y>n(r-o)+n(u-l)+n(c-d)||v+y<-(n(r+o)+n(u+l)+n(c+d))||m-y>n(i-o)+n(a-l)+n(h-d)||m+y<-(n(i+o)+n(a+l)+n(h+d))||g-y>n(s-o)+n(f-l)+n(p-d)||g+y<-(n(s+o)+n(f+l)+n(p+d))||y+y<-(n(o+o)+n(l+l)+n(d+d)))},transformBox:function(n,r,i){var s=Math.abs,o=i[0],u=i[1],a=i[2],f=i[3],l=i[4],c=i[5],h=i[6],p=i[7],d=i[8],v=n[0],m=n[1],g=n[2],y=r[0],b=r[1],w=r[2],E=new e(3);E[0]=o*v+f*m+h*g+i[9],E[1]=u*v+l*m+p*g+i[10],E[2]=a*v+c*m+d*g+i[11];var S=new e(3);return S[0]=s(o)*y+s(f)*b+s(h)*w,S[1]=s(u)*y+s(l)*b+s(p)*w,S[2]=s(a)*y+s(c)*b+s(d)*w,{center:E,halfExtents:E}},planeNormalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=i*i+s*s+o*o;if(u>0){var a=1/Math.sqrt(u);r[0]=i*a,r[1]=s*a,r[2]=o*a,r[3]=n[3]*a}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},extractFrustumPlanes:function(n,r){var i=t.planeNormalize,s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r||[];return E[0]=i([a+s,h+f,m+p,-(w+g)],E[0]),E[1]=i([a-s,h-f,m-p,-(w-g)],E[1]),E[2]=i([a-o,h-l,m-d,-(w-y)],E[2]),E[3]=i([a+o,h+l,m+d,-(w+y)],E[3]),E[4]=i([a+u,h+c,m+v,-(w+b)],E[4]),E[5]=i([a-u,h-c,m-v,-(w-b)],E[5]),E},isInsidePlanesPoint:function(t,n){var r=t[0],i=t[1],s=t[2],o=n.length,u=0;do{var a=n[u];if(a[0]*r+a[1]*i+a[2]*s<a[3])return!1;u+=1}while(u<o);return!0},isInsidePlanesSphere:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=r.length,a=0;do{var f=r[a];if(f[0]*i+f[1]*s+f[2]*o<f[3]-n)return!1;a+=1}while(a<u);return!0},isInsidePlanesBox:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=n[0],a=n[1],f=n[2],l=i+u,c=s+a,h=o+f,p=i-u,d=s-a,v=o-f,m=r.length,g=0;do{var y=r[g],b=y[0],w=y[1],E=y[2];if(b*(b<0?p:l)+w*(w<0?d:c)+E*(E<0?v:h)<y[3])return!1;g+=1}while(g<m);return!0},extractIntersectingPlanes:function(t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n.length,l=[],c=0,h=0;do{var p=n[h],d=p[0],v=p[1],m=p[2];d*(d>0?r:o)+v*(v>0?i:u)+m*(m>0?s:a)<p[3]&&(l[c]=p,c+=1),h+=1}while(h<f);return l}};if(typeof Float32Array!="undefined"){var n=new Float32Array([1,2,3]);n[0]=t.FLOAT_MAX,t.FLOAT_MAX=n[0],e=Float32Array}t.arrayConstructor=e,TurbulenzEngine.hasOwnProperty("VMath")&&(TurbulenzEngine.VMath=t);var r={skipAsserts:!1,assert:function(t,n){t||this.skipAsserts||this.breakInDebugger.doesNotExist()},beget:function(t){var n=function(){};return n.prototype=t,new n},log:function(t,n){var r=window.console;if(r)switch(arguments.length){case 1:r.log(arguments[0]);break;case 2:r.log(arguments[0],arguments[1]);break;case 3:r.log(arguments[0],arguments[1],arguments[2]);break;case 4:r.log(arguments[0],arguments[1],arguments[2],arguments[3]);break;default:var i=[].splice.call(arguments,0);r.log(i.join(" "))}},nearestLowerPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t-(t>>>1)},nearestUpperPow2:function(t){return t-=1,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t+1},ajax:function(t){var n="",r=t.method,i=t.data||{},s=t.encrypt,o=null,u=t.url,a=t.requestHandler,f=t.callback;if(s){i.requestUrl=u;var l=JSON.stringify(i);r==="POST"&&(l=TurbulenzEngine.encrypt(l)),n+="data="+encodeURIComponent(l)+"&",n+="gameSessionId="+encodeURIComponent(i.gameSessionId),o=TurbulenzEngine.generateSignature(l)}else if(i){var c;for(c in i)i.hasOwnProperty(c)&&(n.length!==0&&(n+="&"),r==="POST"?n+=c+"="+i[c]:n+=encodeURIComponent(c)+"="+encodeURIComponent(i[c]))}var h=function(t,n){var r=this.xhr;this.xhr.onreadystatechange=null,this.xhr=null;var i;i=JSON.parse(t);if(s){var o=r.getResponseHeader("X-TZ-Signature"),a=TurbulenzEngine.verifySignature(t,o);t=null,TurbulenzEngine.setTimeout(function(){var e=i.requestUrl;if(a)if(!TurbulenzEngine.encryptionEnabled||e===u){f(i,n),f=null;return}n===400?f(i,n,"Verification Failed"):f({msg:"Verification failed",ok:!1},400,"Verification Failed"),f=null},0)}else t=null,TurbulenzEngine.setTimeout(function(){f(i,n),f=null},0)},p=function(i,s,u){var a;if(window.XMLHttpRequest)a=new window.XMLHttpRequest;else{if(!window.ActiveXObject){t.error&&t.error("No XMLHTTPRequest object could be created");return}a=new window.ActiveXObject("Microsoft.XMLHTTP")}u.xhr=a;var l=function(){if(a.readyState===4&&TurbulenzEngine&&!TurbulenzEngine.isUnloading()){var t=a.responseText,n=a.status,r=n!==0&&a.statusText||"No connection or cross domain request";if(a.getAllResponseHeaders()===""&&t===""&&n===200&&r==="OK"){s("",0);return}s.call(u,t,n)}};a.open(r,n&&r!=="POST"?i+"?"+n:i,!0),f&&(a.onreadystatechange=l),o&&a.setRequestHeader("X-TZ-Signature",o),r==="POST"?(a.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),a.send(n)):a.send()};if(a)a.request({src:u,requestFn:p,responseFilter:t.responseFilter,onload:h});else{var d={src:u};p(u,h,d)}},ajaxStatusCodes:{0:"No Connection, Timeout Or Cross Domain Request",100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested range not satisfiable",417:"Expectation Failed",429:"Too Many Requests",480:"Temporarily Unavailable",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version not supported"}},i={v2ToArray:function(t){return[t[0],t[1]]},arrayToV2:function(t,n,r){return t.v2Build(n[0],n[1],r)},v3ToArray:function(t){return[t[0],t[1],t[2]]},arrayToV3:function(t,n,r){return t.v3Build(n[0],n[1],n[2],r)},v4ToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToV4:function(t,n,r){return t.v4Build(n[0],n[1],n[2],n[3],r)},quatToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToQuat:function(t,n,r){return t.quatBuild(n[0],n[1],n[2],n[3],r)},aabbToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]},arrayToAABB:function(t,n,r){return t.aabbBuild(n[0],n[1],n[2],n[3],n[4],n[5],r)},quatPosToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6]]},arrayToQuatPos:function(t,n,r){return t.quatPosBuild(n[0],n[1],n[2],n[3],n[4],n[5],n[6],r)},m33ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]},arrayToM33:function(t,n,r){return t.m33Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],r)},m43ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},arrayToM43:function(t,n,r){return t.m43Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],r)},m34ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},m44ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]},arrayToM44:function(t,n,r){return t.m44Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15],r)}},s=function(){function e(){}return e.prototype.add=function(){this.referenceCount+=1},e.prototype.remove=function(){this.referenceCount-=1,this.referenceCount===0&&(this.destroyedObserver&&this.destroyedObserver.notify(this.object),this.object.destroy(),this.object=null)},e.prototype.subscribeDestroyed=function(e){this.destroyedObserver||(this.destroyedObserver=l.create()),this.destroyedObserver.subscribe(e)},e.prototype.unsubscribeDestroyed=function(e){this.destroyedObserver.unsubscribe(e)},e.create=function(t){var n=new e;return n.object=t,n.referenceCount=0,n},e.version=1,e}(),o={profiles:{},sortMode:{alphabetical:0,duration:1,max:2,min:3,calls:4},start:function(t){var n=this.profiles[t];n||(n={name:t,calls:0,duration:0,min:Number.MAX_VALUE,max:0,sumOfSquares:0},this.profiles[t]=n),n.start=TurbulenzEngine.time},stop:function(t){var n=TurbulenzEngine.time,r=this.profiles[t];if(r){var i=n-r.start;r.duration+=i,r.calls+=1,r.sumOfSquares+=i*i,i>r.max&&(r.max=i),i<r.min&&(r.min=i)}},reset:function(){this.profiles={}},getReport:function(t,n){var r=[],i,s=0,u;for(u in this.profiles)this.profiles.hasOwnProperty(u)&&(i=this.profiles[u],s<i.duration&&(s=i.duration),r.push(i));var a;t===o.sortMode.alphabetical?a=function(t,n){return t.name<n.name?-1:t.name>n.name?1:0}:t===o.sortMode.max?a=function(t,n){return n.max-t.max}:t===o.sortMode.min?a=function(t,n){return n.min-t.min}:t===o.sortMode.calls?a=function(t,n){return n.calls-t.calls}:a=function(t,n){return n.duration-t.duration},r.sort(a);var f,l="",c=n?n.precision:8,h=n?n.percentagePrecision:1,p=n?n.seperator:" ",d=r.length,v,m,g;for(g=0;g<d;g+=1)i=r[g],f=i.name,f+=p+i.calls,f+=p+i.duration.toFixed(c),f+=p+i.max.toFixed(c),f+=p+i.min.toFixed(c),m=i.duration/i.calls,f+=p+m.toFixed(c),v=Math.sqrt(i.sumOfSquares/i.calls-m*m),f+=p+v.toFixed(c),f+=p+(100*i.duration/s).toFixed(h)+"%\n",l+=f;return l}},u={};u.createArray=function(t){var n={},r=[];t.head&&(t=t.head);var i=function(t){var s=n[t.url];s||(s={},n[t.url]=s);var o=t.functionName===""?"(anonymous)":t.functionName,u=s[o];u||(u={},s[o]=u);var a=u[t.lineNumber];if(!a){var f={functionName:o,numberOfCalls:t.numberOfCalls,totalTime:t.totalTime,selfTime:t.selfTime,url:t.url,lineNumber:t.lineNumber};r[r.length]=f,u[t.lineNumber]=f}else a.totalTime+=t.totalTime,a.selfTime+=t.selfTime,a.numberOfCalls+=t.numberOfCalls;var l=typeof t.children=="function"?t.children():t.children;if(l){var c=l.length,h;for(h=0;h<c;h+=1)i(l[h])}};return i(t),r},u.sort=function(t,n,r){n||(n="totalTime");var i=function(e,t){return e[n]-t[n]},s=function(e,t){return t[n]-e[n]};r===!1?t.sort(i):t.sort(s)};var a=function(){function e(e,t,n){return this.escapeNodeOffset=t,this.externalNode=n,this.extents=e,this}return e.prototype.isLeaf=function(){return!!this.externalNode},e.prototype.reset=function(e,t,n,r,i,s,o,u){this.escapeNodeOffset=o,this.externalNode=u;var a=this.extents;a[0]=e,a[1]=t,a[2]=n,a[3]=r,a[4]=i,a[5]=s},e.prototype.clear=function(){this.escapeNodeOffset=1,this.externalNode=undefined;var e=this.extents,t=Number.MAX_VALUE;e[0]=t,e[1]=t,e[2]=t,e[3]=-t,e[4]=-t,e[5]=-t},e.create=function(t,n,r){return new e(t,n,r)},e.version=1,e}(),f=function(){function e(e){this.numNodesLeaf=4,this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.highQuality=e,this.ignoreY=!1,this.nodesStack=new Array(32)}return e.prototype.add=function(e,t){var n=this.endNode;e.spatialIndex=n;var r=new this.arrayConstructor(6);r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],this.nodes[n]=a.create(r,1,e),this.endNode=n+1,this.needsRebuild=!0,this.numAdds+=1,this.numExternalNodes+=1},e.prototype.remove=function(e){var t=e.spatialIndex;if(t!==undefined){if(this.numExternalNodes>1){var n=this.nodes;n[t].clear();var r=this.endNode;if(t+1>=r){while(!n[r-1].externalNode)r-=1;this.endNode=r}else this.needsRebuild=!0;this.numExternalNodes-=1}else this.clear();e.spatialIndex=undefined}},e.prototype.findParent=function(e){var t=this.nodes,n=e,r=0,i;do n-=1,r+=1,i=t[n];while(i.escapeNodeOffset<=r);return i},e.prototype.update=function(e,t){var n=e.spatialIndex;if(n!==undefined){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=this.needsRebuild,l=this.needsRebound,c=this.nodes,h=c[n],p=h.extents,d=f||l||p[0]>r||p[1]>i||p[2]>s||p[3]<o||p[4]<u||p[5]<a;p[0]=r,p[1]=i,p[2]=s,p[3]=o,p[4]=u,p[5]=a;if(d&&!f&&1<c.length){this.numUpdates+=1,this.startUpdate>n&&(this.startUpdate=n),this.endUpdate<n&&(this.endUpdate=n);if(!l)if(2*this.numUpdates>this.numExternalNodes)this.needsRebound=!0;else{var v=this.findParent(n),m=v.extents;if(m[0]>r||m[1]>i||m[2]>s||m[3]<o||m[4]<u||m[5]<a)this.needsRebound=!0}else this.numUpdates>3*this.numExternalNodes&&(this.needsRebuild=!0,this.numAdds=this.numUpdates)}}else this.add(e,t)},e.prototype.needsFinalize=function(){return this.needsRebuild||this.needsRebound},e.prototype.finalize=function(){this.needsRebuild?this.rebuild():this.needsRebound&&this.rebound()},e.prototype.rebound=function(){var e=this.nodes;if(e.length>1){var t=this.startUpdate,n=this.endUpdate,r=this.nodesStack,i=0,s=0;for(;;){var o=e[s],u=s,a=s+o.escapeNodeOffset,f=s+1,l;do{l=e[f];var c=f+l.escapeNodeOffset;if(!(f<n))break;l.externalNode||c>t&&(r[i]=s,i+=1,s=f),f=c}while(f<a);if(s===u){f=s+1,l=e[f];var h=l.extents,p=h[0],d=h[1],v=h[2],m=h[3],g=h[4],y=h[5];f+=l.escapeNodeOffset;while(f<a)l=e[f],h=l.extents,p>h[0]&&(p=h[0]),d>h[1]&&(d=h[1]),v>h[2]&&(v=h[2]),m<h[3]&&(m=h[3]),g<h[4]&&(g=h[4]),y<h[5]&&(y=h[5]),f+=l.escapeNodeOffset;h=o.extents,h[0]=p,h[1]=d,h[2]=v,h[3]=m,h[4]=g,h[5]=y,n=s;if(!(0<i))break;i-=1,s=r[i]}}}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype.rebuild=function(){if(this.numExternalNodes>0){var e=this.nodes,t,n,r;if(this.numExternalNodes===e.length)t=e,n=e.length,e=[],this.nodes=e;else{t=[],t.length=this.numExternalNodes,n=0,r=this.endNode;for(var i=0;i<r;i+=1){var s=e[i];s.externalNode&&(e[i]=undefined,t[n]=s,n+=1)}t.length>n&&(t.length=n)}var o;if(n>1){n>this.numNodesLeaf&&this.numAdds>0&&(this.highQuality?this._sortNodesHighQuality(t):this.ignoreY?this._sortNodesNoY(t):this._sortNodes(t)),e.length=this._predictNumNodes(0,n,0),this._recursiveBuild(t,0,n,0),r=e[0].escapeNodeOffset,e.length>r&&(e.length=r),this.endNode=r,o=e[0];var u=o.extents,a=u[3]-u[0],f=u[4]-u[1],l=u[5]-u[2];this.ignoreY=4*f<(a<=l?a:l)}else o=t[0],o.externalNode.spatialIndex=0,e.length=1,e[0]=o,this.endNode=1;t=null}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype._sortNodes=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[1]+t[4]}function s(e){var t=e.extents;return t[2]+t[5]}function o(e){var t=e.extents;return-(t[0]+t[3])}function u(e){var t=e.extents;return-(t[1]+t[4])}function a(e){var t=e.extents;return-(t[2]+t[5])}function h(e,n,p){var d=n+p>>1;c===0?l?f(e,n,d,p,o):f(e,n,d,p,r):c===2?l?f(e,n,d,p,a):f(e,n,d,p,s):l?f(e,n,d,p,u):f(e,n,d,p,i),c===0?c=2:c===2?c=1:c=0,l=!l,n+t<d&&h(e,n,d),d+t<p&&h(e,d,p)}var t=this.numNodesLeaf,n=e.length,f=this._nthElement,l=!1,c=0;h(e,0,n)},e.prototype._sortNodesNoY=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[2]+t[5]}function s(e){var t=e.extents;return-(t[0]+t[3])}function o(e){var t=e.extents;return-(t[2]+t[5])}function l(e,n,c){var h=n+c>>1;f===0?a?u(e,n,h,c,s):u(e,n,h,c,r):a?u(e,n,h,c,o):u(e,n,h,c,i),f===0?f=2:f=0,a=!a,n+t<h&&l(e,n,h),h+t<c&&l(e,h,c)}var t=this.numNodesLeaf,n=e.length,u=this._nthElement,a=!1,f=0;l(e,0,n)},e.prototype._sortNodesHighQuality=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[1]+t[4]}function s(e){var t=e.extents;return t[2]+t[5]}function o(e){var t=e.extents;return t[0]+t[2]+t[3]+t[5]}function u(e){var t=e.extents;return t[0]-t[2]+t[3]-t[5]}function a(e){var t=e.extents;return-(t[0]+t[3])}function f(e){var t=e.extents;return-(t[1]+t[4])}function l(e){var t=e.extents;return-(t[2]+t[5])}function c(e){var t=e.extents;return-(t[0]+t[2]+t[3]+t[5])}function h(e){var t=e.extents;return-(t[0]-t[2]+t[3]-t[5])}function m(e,n,g){var y=n+g>>1;p(e,n,y,g,r);var b=d(e,n,y)+d(e,y,g);p(e,n,y,g,i);var w=d(e,n,y)+d(e,y,g);p(e,n,y,g,s);var E=d(e,n,y)+d(e,y,g);p(e,n,y,g,o);var S=d(e,n,y)+d(e,y,g);p(e,n,y,g,u);var x=d(e,n,y)+d(e,y,g);b<=w&&b<=E&&b<=S&&b<=x?v?p(e,n,y,g,a):p(e,n,y,g,r):E<=w&&E<=S&&E<=x?v?p(e,n,y,g,l):p(e,n,y,g,s):w<=S&&w<=x?v?p(e,n,y,g,f):p(e,n,y,g,i):S<=x?v?p(e,n,y,g,c):p(e,n,y,g,o):v?p(e,n,y,g,h):p(e,n,y,g,u),v=!v,n+t<y&&m(e,n,y),y+t<g&&m(e,y,g)}var t=this.numNodesLeaf,n=e.length,p=this._nthElement,d=this._calculateSAH,v=!1;m(e,0,n)},e.prototype._calculateSAH=function(e,t,n){var r,i,s,o,u,a,f,l;r=e[t],i=r.extents,s=i[0],o=i[1],u=i[2],a=i[3],f=i[4],l=i[5];for(var c=t+1;c<n;c+=1)r=e[c],i=r.extents,s>i[0]&&(s=i[0]),o>i[1]&&(o=i[1]),u>i[2]&&(u=i[2]),a<i[3]&&(a=i[3]),f<i[4]&&(f=i[4]),l<i[5]&&(l=i[5]);return a-s+(f-o)+(l-u)},e.prototype._nthElement=function(e,t,n,r,i){function s(e,t,n){return e<t?t<n?t:e<n?n:e:e<n?e:t<n?n:t}function o(e,t,n,r){var i=t+1;while(i!==n){var s=e[i],o=r(s),u=i,a=i-1;while(u!==t&&o<r(e[a]))e[u]=e[a],u-=1,a-=1;u!==i&&(e[u]=s),i+=1}}while(r-t>8){var u=s(i(e[t]),i(e[t+(r-t>>1)]),i(e[r-1])),a=t,f=r,l;for(;;a+=1){while(i(e[a])<u)a+=1;do f-=1;while(u<i(e[f]));if(a>=f){l=a;break}var c=e[a];e[a]=e[f],e[f]=c}l<=n?t=l:r=l}o(e,t,r,i)},e.prototype._recursiveBuild=function(e,t,n,r){var i=this.nodes,s=r;r+=1;var o,u,f,l,c,h,p,d,v;if(t+this.numNodesLeaf>=n){d=e[t],p=d.extents,o=p[0],u=p[1],f=p[2],l=p[3],c=p[4],h=p[5],d.externalNode.spatialIndex=r,this._replaceNode(i,r,d);for(var m=t+1;m<n;m+=1)d=e[m],p=d.extents,o>p[0]&&(o=p[0]),u>p[1]&&(u=p[1]),f>p[2]&&(f=p[2]),l<p[3]&&(l=p[3]),c<p[4]&&(c=p[4]),h<p[5]&&(h=p[5]),r+=1,d.externalNode.spatialIndex=r,this._replaceNode(i,r,d);v=i[r]}else{var g=t+n>>1;t+1>=g?(d=e[t],d.externalNode.spatialIndex=r,this._replaceNode(i,r,d)):this._recursiveBuild(e,t,g,r),v=i[r],p=v.extents,o=p[0],u=p[1],f=p[2],l=p[3],c=p[4],h=p[5],r+=v.escapeNodeOffset,g+1>=n?(d=e[g],d.externalNode.spatialIndex=r,this._replaceNode(i,r,d)):this._recursiveBuild(e,g,n,r),v=i[r],p=v.extents,o>p[0]&&(o=p[0]),u>p[1]&&(u=p[1]),f>p[2]&&(f=p[2]),l<p[3]&&(l=p[3]),c<p[4]&&(c=p[4]),h<p[5]&&(h=p[5])}var y=i[s];if(y!==undefined)y.reset(o,u,f,l,c,h,r+v.escapeNodeOffset-s);else{var b=new this.arrayConstructor(6);b[0]=o,b[1]=u,b[2]=f,b[3]=l,b[4]=c,b[5]=h,i[s]=a.create(b,r+v.escapeNodeOffset-s)}},e.prototype._replaceNode=function(e,t,n){var r=e[t];e[t]=n;if(r!==undefined){do t+=1;while(e[t]!==undefined);e[t]=r}},e.prototype._predictNumNodes=function(e,t,n){n+=1;if(e+this.numNodesLeaf>=t)n+=t-e;else{var r=e+t>>1;e+1>=r?n+=1:n=this._predictNumNodes(e,r,n),r+1>=t?n+=1:n=this._predictNumNodes(r,t,n)}return n},e.prototype.getVisibleNodes=function(e,t,n){var r=0;if(this.numExternalNodes>0){var i=this.nodes,s=this.endNode,o=e.length,u=n===undefined?t.length:n,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=0;for(;;){a=i[x],f=a.extents,c=f[0],h=f[1],p=f[2],d=f[3],v=f[4],m=f[5],g=!0,y=0;do{b=e[y],w=b[0],E=b[1],S=b[2];if(w*(w<0?c:d)+E*(E<0?h:v)+S*(S<0?p:m)<b[3]){g=!1;break}y+=1}while(y<o);if(g)if(a.externalNode){t[u]=a.externalNode,u+=1,r+=1,x+=1;if(x>=s)break}else{g=!0,y=0;do{b=e[y],w=b[0],E=b[1],S=b[2];if(w*(w>0?c:d)+E*(E>0?h:v)+S*(S>0?p:m)<b[3]){g=!1;break}y+=1}while(y<o);if(g){l=x+a.escapeNodeOffset,x+=1;do a=i[x],a.externalNode&&(t[u]=a.externalNode,u+=1,r+=1),x+=1;while(x<l);if(x>=s)break}else x+=1}else{x+=a.escapeNodeOffset;if(x>=s)break}}}return r},e.prototype.getOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=this.nodes,l=this.endNode,c,h,p,d=0,v=n===undefined?t.length:n,m=0;for(;;){c=f[m],h=c.extents;var g=h[0],y=h[1],b=h[2],w=h[3],E=h[4],S=h[5];if(r<=w&&i<=E&&s<=S&&o>=g&&u>=y&&a>=b)if(c.externalNode){t[v]=c.externalNode,v+=1,d+=1,m+=1;if(m>=l)break}else if(o>=w&&u>=E&&a>=S&&r<=g&&i<=y&&s<=b){p=m+c.escapeNodeOffset,m+=1;do c=f[m],c.externalNode&&(t[v]=c.externalNode,v+=1,d+=1),m+=1;while(m<p);if(m>=l)break}else m+=1;else{m+=c.escapeNodeOffset;if(m>=l)break}}return d}return 0},e.prototype.getSphereOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=t*t,i=e[0],s=e[1],o=e[2],u=this.nodes,a=this.endNode,f,l,c=n.length,h=0;for(;;){f=u[h],l=f.extents;var p=l[0],d=l[1],v=l[2],m=l[3],g=l[4],y=l[5],b=0,w;i<p?(w=p-i,b+=w*w):i>m&&(w=i-m,b+=w*w),s<d?(w=d-s,b+=w*w):s>g&&(w=s-g,b+=w*w),o<v?(w=v-o,b+=w*w):o>y&&(w=o-y,b+=w*w);if(b<=r){h+=1;if(f.externalNode){n[c]=f.externalNode,c+=1;if(h>=a)break}}else{h+=f.escapeNodeOffset;if(h>=a)break}}}},e.prototype.getOverlappingPairs=function(e,t){if(this.numExternalNodes>0){var n=this.nodes,r=this.endNode,i,s,o,u,a=0,f=t===undefined?e.length:t,l=0,c;for(;;){i=n[l];while(!i.externalNode)l+=1,i=n[l];l+=1;if(!(l<r))break;s=i.externalNode,u=i.extents;var h=u[0],p=u[1],d=u[2],v=u[3],m=u[4],g=u[5];c=l;for(;;){o=n[c],u=o.extents;if(h<=u[3]&&p<=u[4]&&d<=u[5]&&v>=u[0]&&m>=u[1]&&g>=u[2]){c+=1;if(o.externalNode){e[f]=s,e[f+1]=o.externalNode,f+=2,a+=2;if(c>=r)break}}else{c+=o.escapeNodeOffset;if(c>=r)break}}}return a}return 0},e.prototype.getExtents=function(){return 0<this.nodes.length?this.nodes[0].extents:null},e.prototype.getRootNode=function(){return this.nodes[0]},e.prototype.getNodes=function(){return this.nodes},e.prototype.getEndNodeIndex=function(){return this.endNode},e.prototype.clear=function(){this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.ignoreY=!1},e.rayTest=function(e,t,n){function d(e,t){var n=e[0],r=e[1],i=e[2],d=e[3],v=e[4],m=e[5];if(n<=s&&s<=d&&r<=o&&o<=v&&i<=u&&u<=m)return 0;var g,y,b,w,E;a>=0?(E=n-s,g=E===0?0:E*c,E=d-s,y=E===0?0:E*c):(g=(d-s)*c,y=(n-s)*c),f>=0?(E=r-o,b=E===0?0:E*h,E=v-o,w=E===0?0:E*h):(b=(v-o)*h,w=(r-o)*h);if(g>w||b>y)return undefined;b>g&&(g=b),w<y&&(y=w);var S,x;return l>=0?(E=i-u,S=E===0?0:E*p,E=m-u,x=E===0?0:E*p):(S=(m-u)*p,x=(i-u)*p),g>x||S>y?undefined:(S>g&&(g=S),x<y&&(y=x),g<0&&(g=y),0<=g&&g<t?g:undefined)}function g(e,r,i){var s=e.getNodes(),o=s[r],u=d(o.extents,i);if(u===undefined)return i;if(o.externalNode){var a=n(e,o.externalNode,t,u,i);a&&(m=a,i=a.factor)}else{var f=v.length,l;for(l=0;l<f;l+=1){var c=v[l];if(u>c.distance)break}v.splice(l-1,0,{tree:e,nodeIndex:r,distance:u})}return i}var r=t.origin,i=t.direction,s=r[0],o=r[1],u=r[2],a=i[0],f=i[1],l=i[2],c=1/a,h=1/f,p=1/l,v=[],m=null,y=t.maxFactor,b,w;for(w=0;w<e.length;w+=1)b=e[w],b.endNode!==0&&(y=g(b,0,y));while(v.length!==0){var E=v.pop();if(E.distance>=y)continue;var S=E.nodeIndex;b=E.tree;var x=b.getNodes(),T=x[S],N=S+T.escapeNodeOffset,C=S+1;do y=g(b,C,y),C+=x[C].escapeNodeOffset;while(C<N)}return m},e.create=function(t){return new e(t?!0:!1)},e.version=1,e}();(function(){f.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(f.prototype.arrayConstructor=Float32Array)}})();var l=function(){function e(){}return e.prototype.subscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e)return;t.push(e)},e.prototype.unsubscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){t.splice(r,1);break}},e.prototype.unsubscribeAll=function(){this.subscribers.length=0},e.prototype.notify=function(e,t,n,r,i,s,o,u,a,f,l,c){var h=this.subscribers,p=this.subscribers.length,d=0;while(d<p)h[d].apply(null,arguments),h.length===p?d+=1:p=h.length},e.create=function(){var t=new e;return t.subscribers=[],t},e}(),c=function(){function e(){}return e.prototype.processBytes=function(t,n){if(!this.isValidHeader(t)){this.onerror(n);return}var r=4,i=this.parseHeader(t,r);r+=124,this.width=i.dwWidth,this.height=i.dwHeight,i.dwCaps2&this.DDSF_VOLUME&&i.dwDepth>0?this.depth=i.dwDepth:this.depth=1,i.dwFlags&this.DDSF_MIPMAPCOUNT?this.numLevels=i.dwMipMapCount:this.numLevels=1;if(i.dwCaps2&this.DDSF_CUBEMAP){var s=0;s+=i.dwCaps2&this.DDSF_CUBEMAP_POSITIVEX?1:0,s+=i.dwCaps2&this.DDSF_CUBEMAP_NEGATIVEX?1:0,s+=i.dwCaps2&this.DDSF_CUBEMAP_POSITIVEY?1:0,s+=i.dwCaps2&this.DDSF_CUBEMAP_NEGATIVEY?1:0,s+=i.dwCaps2&this.DDSF_CUBEMAP_POSITIVEZ?1:0,s+=i.dwCaps2&this.DDSF_CUBEMAP_NEGATIVEZ?1:0;if(s!==6||this.width!==this.height){this.onerror(n);return}this.numFaces=s}else this.numFaces=1;var o=!1,u=0,a=this.gd;if(i.ddspf.dwFlags&this.DDSF_FOURCC)switch(i.ddspf.dwFourCC){case this.FOURCC_DXT1:this.format=a.PIXELFORMAT_DXT1,u=8,o=!0;break;case this.FOURCC_DXT2:case this.FOURCC_DXT3:this.format=a.PIXELFORMAT_DXT3,u=16,o=!0;break;case this.FOURCC_DXT4:case this.FOURCC_DXT5:case this.FOURCC_RXGB:this.format=a.PIXELFORMAT_DXT5,u=16,o=!0;break;case this.FOURCC_R8G8B8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8,u=3;break;case this.FOURCC_A8R8G8B8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8A8,u=4;break;case this.FOURCC_R5G6B5
:this.bgrFormat=this.BGRPIXELFORMAT_B5G6R5,u=2;break;case this.FOURCC_A8:this.format=a.PIXELFORMAT_A8,u=1;break;case this.FOURCC_A8B8G8R8:this.format=a.PIXELFORMAT_R8G8B8A8,u=4;break;case this.FOURCC_L8:this.format=a.PIXELFORMAT_L8,u=1;break;case this.FOURCC_A8L8:this.format=a.PIXELFORMAT_L8A8,u=2;break;case this.FOURCC_UNKNOWN:case this.FOURCC_ATI1:case this.FOURCC_ATI2:case this.FOURCC_X8R8G8B8:case this.FOURCC_X8B8G8R8:case this.FOURCC_A2B10G10R10:case this.FOURCC_A2R10G10B10:case this.FOURCC_A16B16G16R16:case this.FOURCC_R16F:case this.FOURCC_A16B16G16R16F:case this.FOURCC_R32F:case this.FOURCC_A32B32G32R32F:case this.FOURCC_L16:case this.FOURCC_X1R5G5B5:case this.FOURCC_A1R5G5B5:case this.FOURCC_A4R4G4B4:case this.FOURCC_R3G3B2:case this.FOURCC_A8R3G3B2:case this.FOURCC_X4R4G4B4:case this.FOURCC_A4L4:case this.FOURCC_D16_LOCKABLE:case this.FOURCC_D32:case this.FOURCC_D24X8:case this.FOURCC_D16:case this.FOURCC_D32F_LOCKABLE:case this.FOURCC_G16R16:case this.FOURCC_G16R16F:case this.FOURCC_G32R32F:break;default:this.onerror(n);return}else if(i.ddspf.dwFlags===this.DDSF_RGBA&&i.ddspf.dwRGBBitCount===32)i.ddspf.dwRBitMask===255&&i.ddspf.dwGBitMask===65280&&i.ddspf.dwBBitMask===16711680&&i.ddspf.dwABitMask===4278190080?this.format=a.PIXELFORMAT_R8G8B8A8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8A8,u=4;else if(i.ddspf.dwFlags===this.DDSF_RGB&&i.ddspf.dwRGBBitCount===32)i.ddspf.dwRBitMask===255&&i.ddspf.dwGBitMask===65280&&i.ddspf.dwBBitMask===16711680?this.format=a.PIXELFORMAT_R8G8B8A8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8A8,u=4;else if(i.ddspf.dwFlags===this.DDSF_RGB&&i.ddspf.dwRGBBitCount===24)i.ddspf.dwRBitMask===255&&i.ddspf.dwGBitMask===65280&&i.ddspf.dwBBitMask===16711680?this.format=a.PIXELFORMAT_R8G8B8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8,u=3;else if(i.ddspf.dwFlags===this.DDSF_RGB&&i.ddspf.dwRGBBitCount===16)i.ddspf.dwRBitMask===63488&&i.ddspf.dwGBitMask===2016&&i.ddspf.dwBBitMask===31?this.format=a.PIXELFORMAT_R5G6B5:this.bgrFormat=this.BGRPIXELFORMAT_B5G6R5,u=2;else{if(i.ddspf.dwRGBBitCount!==8){this.onerror(n);return}this.format=a.PIXELFORMAT_L8,u=1}var f=0;for(var l=0;l<this.numFaces;l+=1){var c=this.width,h=this.height,p=this.depth;for(var d=0;d<this.numLevels;d+=1){var v=o?Math.floor((c+3)/4):c,m=o?Math.floor((h+3)/4):h;f+=v*m*p*u,c=c>1?c>>1:1,h=h>1?h>>1:1,p=p>1?p>>1:1}}if(t.length<r+f){this.onerror(n);return}this.bytesPerPixel=u;var g=t.subarray(r);t=null;var y=!1;switch(this.bgrFormat){case this.BGRPIXELFORMAT_B8G8R8:this.format=a.PIXELFORMAT_R8G8B8,y=!0;break;case this.BGRPIXELFORMAT_B8G8R8A8:this.format=a.PIXELFORMAT_R8G8B8A8,y=!0;break;case this.BGRPIXELFORMAT_B5G6R5:this.format=a.PIXELFORMAT_R5G6B5,y=!0;break;default:}y&&(g=this.convertBGR2RGB(g));if(this.format===a.PIXELFORMAT_DXT1){if(!a.isSupported("TEXTURE_DXT1")){if(this.hasDXT1Alpha(g)){this.format=a.PIXELFORMAT_R5G5B5A1,e.decodeInWorker(e.WorkerCommand.DXT1A,g,this);return}this.format=a.PIXELFORMAT_R5G6B5,e.decodeInWorker(e.WorkerCommand.DXT1,g,this);return}}else if(this.format===a.PIXELFORMAT_DXT3){if(!a.isSupported("TEXTURE_DXT3")){this.format=a.PIXELFORMAT_R4G4B4A4,e.decodeInWorker(e.WorkerCommand.DXT3,g,this);return}}else if(this.format===a.PIXELFORMAT_DXT5&&!a.isSupported("TEXTURE_DXT5")){this.format=a.PIXELFORMAT_R4G4B4A4,e.decodeInWorker(e.WorkerCommand.DXT5,g,this);return}this.onload(g,this.width,this.height,this.format,this.numLevels,this.numFaces>1,this.depth,n)},e.createWorker=function(t){var n="var convertDXT1To565 = "+this.convertDXT1To565.toString()+";\n"+"var convertDXT1To5551 = "+this.convertDXT1To5551.toString()+";\n"+"var convertDXT3To4444 = "+this.convertDXT3To4444.toString()+";\n"+"var convertDXT5To4444 = "+this.convertDXT5To4444.toString()+";\n"+"var command, srcWidth, srcHeight, srcNumLevels, srcNumFaces, srcOffset;\n"+"onmessage = function decoderOnMessage(event)\n"+"{\n"+"    var edata = event.data;\n"+"    if (edata instanceof ArrayBuffer)\n"+"    {\n"+"        var data = new Uint8Array(edata, srcOffset);\n"+"        switch (command)\n"+"        {\n"+"            case 0: // DXT1\n"+"                data = convertDXT1To565(data, srcWidth, srcHeight, srcNumLevels, srcNumFaces);\n"+"                break;\n"+"            case 1: // DXT1A\n"+"                data = convertDXT1To5551(data, srcWidth, srcHeight, srcNumLevels, srcNumFaces);\n"+"                break;\n"+"            case 2: // DXT3\n"+"                data = convertDXT3To4444(data, srcWidth, srcHeight, srcNumLevels, srcNumFaces);\n"+"                break;\n"+"            case 3: // DXT4\n"+"                data = convertDXT5To4444(data, srcWidth, srcHeight, srcNumLevels, srcNumFaces);\n"+"                break;\n"+"            default:\n"+"                data = null;\n"+"                break;\n"+"        };\n"+"        if (data)\n"+"        {\n"+"            postMessage(data.buffer, [data.buffer]);\n"+"        }\n"+"        else\n"+"        {\n"+"            postMessage(null);\n"+"        }\n"+"    }\n"+"    else\n"+"    {\n"+"        command = edata.command;\n"+"        srcWidth = edata.width;\n"+"        srcHeight = edata.height;\n"+"        srcNumLevels = edata.numLevels;\n"+"        srcNumFaces = edata.numFaces;\n"+"        srcOffset = edata.byteOffset;\n"+"    }\n"+"};",r=new Blob([n],{type:"text/javascript"}),i=typeof URL!="undefined"?URL:window.webkitURL,s=i.createObjectURL(r),o=new Worker(s);if(o){var u=e.workerQueues[t];o.onmessage=function(e){var t=u.shift();o.load-=((t.width+3)*(t.height+3)>>4)*t.numLevels*t.numFaces;var n=e.data;n?t.onload(n,t.width,t.height,t.format,t.numLevels,t.numFaces>1,t.depth,200):t.onerror(200)},o.load=0}return i.revokeObjectURL(s),o},e.decodeInWorker=function(t,n,r){var i=this.maxNumWorkers;if(i){var s=this.workerQueues,o=this.workers,u=-1,a;if(!o){this.workerQueues=s=[],this.workers=o=[],u=0;for(a=0;a<i;a+=1){s[a]=[],o[a]=this.createWorker(a);if(!o[a]){u=-1;break}}}else{u=0;var f=o[0].load;for(a=1;a<i;a+=1){var l=o[a].load;f>l&&(f=l,u=a)}}if(u!==-1){var c=o[u];c.load+=((r.width+3)*(r.height+3)>>4)*r.numLevels*r.numFaces,s[u].push(r);var h=n.byteOffset,p;r.externalBuffer?(p=n.buffer.slice(h,h+n.byteLength),h=0):p=n.buffer,c.postMessage({command:t,width:r.width,height:r.height,numLevels:r.numLevels,numFaces:r.numFaces,byteOffset:h}),c.postMessage(p,[p]);return}this.maxNumWorkers=0}var d;switch(t){case e.WorkerCommand.DXT1:d=function(){n=e.convertDXT1To565(n,r.width,r.height,r.numLevels,r.numFaces),r.onload(n,r.width,r.height,r.format,r.numLevels,r.numFaces>1,r.depth,200)};break;case e.WorkerCommand.DXT1A:d=function(){n=e.convertDXT1To5551(n,r.width,r.height,r.numLevels,r.numFaces),r.onload(n,r.width,r.height,r.format,r.numLevels,r.numFaces>1,r.depth,200)};break;case e.WorkerCommand.DXT3:d=function(){n=e.convertDXT3To4444(n,r.width,r.height,r.numLevels,r.numFaces),r.onload(n,r.width,r.height,r.format,r.numLevels,r.numFaces>1,r.depth,200)};break;case e.WorkerCommand.DXT5:d=function(){n=e.convertDXT5To4444(n,r.width,r.height,r.numLevels,r.numFaces),r.onload(n,r.width,r.height,r.format,r.numLevels,r.numFaces>1,r.depth,200)};break;default:d=null}d?TurbulenzEngine.setTimeout(d,0):r.onerror(200)},e.prototype.parseHeader=function(e,t){function n(){var n=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24;return t+=4,n}function r(){return{dwSize:n(),dwFlags:n(),dwFourCC:n(),dwRGBBitCount:n(),dwRBitMask:n(),dwGBitMask:n(),dwBBitMask:n(),dwABitMask:n()}}var i={dwSize:n(),dwFlags:n(),dwHeight:n(),dwWidth:n(),dwPitchOrLinearSize:n(),dwDepth:n(),dwMipMapCount:n(),dwReserved1:[n(),n(),n(),n(),n(),n(),n(),n(),n(),n(),n()],ddspf:r(),dwCaps1:n(),dwCaps2:n(),dwReserved2:[n(),n(),n()]};return i},e.prototype.isValidHeader=function(e){return 68===e[0]&&68===e[1]&&83===e[2]&&32===e[3]},e.prototype.convertBGR2RGB=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=this.numLevels,s=this.numFaces,o=0;for(var u=0;u<i;u+=1)o+=n*r,n=n>1?Math.floor(n/2):1,r=r>1?Math.floor(r/2):1;var a=o*t*s,f=0;if(t===3||t===4){do{var l=e[f];e[f]=e[f+2],e[f+2]=l,f+=t}while(f<a)}else if(t===2){var c=new Uint16Array(o*s),h=0,p=0,d,v,m,g=31,y=2016;do{var b=e[h+1]<<8|e[h];h+=2,d=(b&g)<<11,v=b&y,m=b>>11&g,c[p]=d|v|m,p+=1}while(f<a);return c}return e},e.prototype.decode565=function(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t[3]=255,t},e.prototype.decodeColor=function(t,n,r,i,s){var o=s.cache,u=e.prototype.decode565,a=t[n+1]<<8|t[n];n+=2;var f=t[n+1]<<8|t[n];n+=2;var l,c,h,p,d;if(a!==f){l=u(a,o[0]),c=u(f,o[1]),h=o[2],p=o[3];if(a>f){for(d=0;d<3;d+=1){var v=l[d],m=c[d];h[d]=(v*2+m)/3|0,p[d]=(v+m*2)/3|0}h[3]=255,p[3]=255}else{for(d=0;d<3;d+=1)h[d]=l[d]+c[d]>>1,p[d]=0;h[3]=255,p[3]=0}}else{l=u(a,o[0]),c=l,h=l,p=o[1];for(d=0;d<4;d+=1)p[d]=0}var g=s.colorArray;g[0]=l,g[1]=c,g[2]=h,g[3]=p;var y,b,w;if(r)for(d=0;d<4;d+=1)y=t[n+d],b=i[d],b[0]=g[y&3],b[1]=g[y>>2&3],b[2]=g[y>>4&3],b[3]=g[y>>6&3];else for(d=0;d<4;d+=1)y=t[n+d],b=i[d],w=g[y&3],b[0][0]=w[0],b[0][1]=w[1],b[0][2]=w[2],b[0][3]=w[3],w=g[y>>2&3],b[1][0]=w[0],b[1][1]=w[1],b[1][2]=w[2],b[1][3]=w[3],w=g[y>>4&3],b[2][0]=w[0],b[2][1]=w[1],b[2][2]=w[2],b[2][3]=w[3],w=g[y>>6&3],b[3][0]=w[0],b[3][1]=w[1],b[3][2]=w[2],b[3][3]=w[3]},e.prototype.decodeDXT3Alpha=function(e,t,n){for(var r=0;r<4;r+=1){var i=e[t+1]<<8|e[t];t+=2;var s=n[r];i?(s[0][3]=(i&15)*17,s[1][3]=(i>>4&15)*17,s[2][3]=(i>>8&15)*17,s[3][3]=(i>>12&15)*17):(s[0][3]=0,s[1][3]=0,s[2][3]=0,s[3][3]=0)}},e.prototype.decodeDXT5Alpha=function(e,t,n,r){var i=e[t];t+=1;var s=e[t];t+=1;var o=r.alphaArray;o[0]=i,o[1]=s,i>s?(o[2]=(i*6+s*1)/7|0,o[3]=(i*5+s*2)/7|0,o[4]=(i*4+s*3)/7|0,o[5]=(i*3+s*4)/7|0,o[6]=(i*2+s*5)/7|0,o[7]=(i*1+s*6)/7|0):i<s?(o[2]=(i*4+s*1)/5|0,o[3]=(i*3+s*2)/5|0,o[4]=(i*2+s*3)/5|0,o[5]=(i*1+s*4)/5|0,o[6]=0,o[7]=255):(o[2]=i,o[3]=i,o[4]=i,o[5]=i,o[6]=0,o[7]=255);var u;for(var a=0;a<2;a+=1){var f=e[t]|e[t+1]<<8|e[t+2]<<16;t+=3,u=n[a*2],u[0][3]=o[f&7],u[1][3]=o[f>>3&7],u[2][3]=o[f>>6&7],u[3][3]=o[f>>9&7],u=n[a*2+1],u[0][3]=o[f>>12&7],u[1][3]=o[f>>15&7],u[2][3]=o[f>>18&7],u[3][3]=o[f>>21&7]}},e.prototype.convertToRGBA32=function(e,t,n){var r,i=this.width,s=this.height,o=this.numLevels,u=this.numFaces,a=0;for(r=0;r<o;r+=1)a+=i*s,i=i>1?i>>1:1,s=s>1?s>>1:1;var f=new Uint8Array(a*4*u),l=0,c=0,h=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]];for(var p=0;p<u;p+=1){i=this.width,s=this.height;for(var d=0;d<o;d+=1){var v=i>4?4:i,m=s>4?4:s,g=s+3>>2,y=i+3>>2,b=i*4,w=v*4,E=b*(m-1);for(var S=0;S<g;S+=1){for(var x=0;x<y;x+=1){t(e,l,h);var T=c;for(var N=0;N<m;N+=1){var C=h[N],k=T;for(var L=0;L<v;L+=1){var A=C[L];f[k]=A[0],f[k+1]=A[1],f[k+2]=A[2],f[k+3]=A[3],k+=4}T+=b}l+=n,c+=w}c+=E}i=i>1?i>>1:1,s=s>1?s>>1:1}}return f},e.prototype.hasDXT1Alpha=function(e){var t=e.length,n,r,i;for(n=0;n<t;n+=8){var s=e[n+1]<<8|e[n],o=e[n+3]<<8|e[n+2];if(s<=o)for(r=0;r<4;r+=1){i=e[n+4+r];if(i===0)continue;if((i&3)===3||(i>>2&3)===3||(i>>4&3)===3||(i>>6&3)===3)return!0}}return!1},e.prototype.encodeR5G6B5=function(e){return(e[2]&248)>>>3|(e[1]&252)<<3|(e[0]&248)<<8},e.prototype.encodeR5G5B5A1=function(e){return e[3]>>>7|(e[2]&248)>>>2|(e[1]&248)<<3|(e[0]&248)<<8},e.prototype.encodeR4G4B4A4=function(e){return e[3]>>>4|e[2]&240|(e[1]&240)<<4|(e[0]&240)<<8},e.convertDXT1To565=function(e,t,n,r,i){function u(e,t,n,r,i){function s(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t[3]=255,t}var o=e[t+1]<<8|e[t];t+=2;var u=e[t+1]<<8|e[t];t+=2;var a,f,l,c,h;if(o!==u){a=s(o,r[0]),f=s(u,r[1]),l=r[2],c=r[3];if(o>u){for(h=0;h<3;h+=1){var p=a[h],d=f[h];l[h]=(p*2+d)/3|0,c[h]=(p+d*2)/3|0}l[3]=255,c[3]=255}else{for(h=0;h<3;h+=1)l[h]=a[h]+f[h]>>1,c[h]=0;l[3]=255,c[3]=0}}else{a=s(o,r[0]),f=a,l=a,c=r[1];for(h=0;h<4;h+=1)c[h]=0}var v=i;v[0]=a,v[1]=f,v[2]=l,v[3]=c;var m,g,y;for(h=0;h<4;h+=1)m=e[t+h],g=n[h],g[0]=v[m&3],g[1]=v[m>>2&3],g[2]=v[m>>4&3],g[3]=v[m>>6&3]}var s=[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],o=new Array(4),a,f=t,l=n,c=r,h=i,p=0;for(a=0;a<c;a+=1)p+=f*l,f=f>1?f>>1:1,l=l>1?l>>1:1;var d=new Uint16Array(p*1*h),v=0,m=0,g=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]];for(var y=0;y<h;y+=1){f=t,l=n;for(var b=0;b<c;b+=1){var w=f>4?4:f,E=l>4?4:l,S=l+3>>2,x=f+3>>2,T=f*1,N=w*1,C=T*(E-1);for(var k=0;k<S;k+=1){for(var L=0;L<x;L+=1){u(e,v,g,s,o);var A=m;for(var O=0;O<E;O+=1){var M=g[O],_=A;for(var D=0;D<w;D+=1){var P=M[D];d[_]=(P[2]&248)>>>3|(P[1]&252)<<3|(P[0]&248)<<8,_+=1}A+=T}v+=8,m+=N}m+=C}f=f>1?f>>1:1,l=l>1?l>>1:1}}return d},e.convertDXT1To5551=function(e,t,n,r,i){function u(e,t,n,r,i){function s(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t[3]=255,t}var o=e[t+1]<<8|e[t];t+=2;var u=e[t+1]<<8|e[t];t+=2;var a,f,l,c,h;if(o!==u){a=s(o,r[0]),f=s(u,r[1]),l=r[2],c=r[3];if(o>u){for(h=0;h<3;h+=1){var p=a[h],d=f[h];l[h]=(p*2+d)/3|0,c[h]=(p+d*2)/3|0}l[3]=255,c[3]=255}else{for(h=0;h<3;h+=1)l[h]=a[h]+f[h]>>1,c[h]=0;l[3]=255,c[3]=0}}else{a=s(o,r[0]),f=a,l=a,c=r[1];for(h=0;h<4;h+=1)c[h]=0}var v=i;v[0]=a,v[1]=f,v[2]=l,v[3]=c;var m,g,y;for(h=0;h<4;h+=1)m=e[t+h],g=n[h],g[0]=v[m&3],g[1]=v[m>>2&3],g[2]=v[m>>4&3],g[3]=v[m>>6&3]}var s=[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],o=new Array(4),a,f=t,l=n,c=r,h=i,p=0;for(a=0;a<c;a+=1)p+=f*l,f=f>1?f>>1:1,l=l>1?l>>1:1;var d=new Uint16Array(p*1*h),v=0,m=0,g=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]];for(var y=0;y<h;y+=1){f=t,l=n;for(var b=0;b<c;b+=1){var w=f>4?4:f,E=l>4?4:l,S=l+3>>2,x=f+3>>2,T=f*1,N=w*1,C=T*(E-1);for(var k=0;k<S;k+=1){for(var L=0;L<x;L+=1){u(e,v,g,s,o);var A=m;for(var O=0;O<E;O+=1){var M=g[O],_=A;for(var D=0;D<w;D+=1){var P=M[D];d[_]=P[3]>>>7|(P[2]&248)>>>2|(P[1]&248)<<3|(P[0]&248)<<8,_+=1}A+=T}v+=8,m+=N}m+=C}f=f>1?f>>1:1,l=l>1?l>>1:1}}return d},e.convertDXT3To4444=function(e,t,n,r,i){function s(e,t,n,r,i){function s(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t[3]=255,t}var o=e[t+1]<<8|e[t];t+=2;var u=e[t+1]<<8|e[t];t+=2;var a,f,l,c,h;if(o!==u){a=s(o,r[0]),f=s(u,r[1]),l=r[2],c=r[3];if(o>u){for(h=0;h<3;h+=1){var p=a[h],d=f[h];l[h]=(p*2+d)/3|0,c[h]=(p+d*2)/3|0}l[3]=255,c[3]=255}else{for(h=0;h<3;h+=1)l[h]=a[h]+f[h]>>1,c[h]=0;l[3]=255,c[3]=0}}else{a=s(o,r[0]),f=a,l=a,c=r[1];for(h=0;h<4;h+=1)c[h]=0}var v=i;v[0]=a,v[1]=f,v[2]=l,v[3]=c;var m,g,y;for(h=0;h<4;h+=1)m=e[t+h],g=n[h],y=v[m&3],g[0][0]=y[0],g[0][1]=y[1],g[0][2]=y[2],g[0][3]=y[3],y=v[m>>2&3],g[1][0]=y[0],g[1][1]=y[1],g[1][2]=y[2],g[1][3]=y[3],y=v[m>>4&3],g[2][0]=y[0],g[2][1]=y[1],g[2][2]=y[2],g[2][3]=y[3],y=v[m>>6&3],g[3][0]=y[0],g[3][1]=y[1],g[3][2]=y[2],g[3][3]=y[3]}function o(e,t,n){for(var r=0;r<4;r+=1){var i=e[t+1]<<8|e[t];t+=2;var s=n[r];i?(s[0][3]=(i&15)*17,s[1][3]=(i>>4&15)*17,s[2][3]=(i>>8&15)*17,s[3][3]=(i>>12&15)*17):(s[0][3]=0,s[1][3]=0,s[2][3]=0,s[3][3]=0)}}var u=[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],a=new Array(4),f,l=t,c=n,h=r,p=i,d=0;for(f=0;f<h;f+=1)d+=l*c,l=l>1?l>>1:1,c=c>1?c>>1:1;var v=new Uint16Array(d*1*p),m=0,g=0,y=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]];for(var b=0;b<p;b+=1){l=t,c=n;for(var w=0;w<h;w+=1){var E=l>4?4:l,S=c>4?4:c,x=c+3>>2,T=l+3>>2,N=l*1,C=E*1,k=N*(S-1);for(var L=0;L<x;L+=1){for(var A=0;A<T;A+=1){s(e,m+8,y,u,a),o(e,m,y);var O=g;for(var M=0;M<S;M+=1){var _=y[M],D=O;for(var P=0;P<E;P+=1){var H=_[P];v[D]=H[3]>>>4|H[2]&240|(H[1]&240)<<4|(H[0]&240)<<8,D+=1}O+=N}m+=16,g+=C}g+=k}l=l>1?l>>1:1,c=c>1?c>>1:1}}return v},e.convertDXT5To4444=function(e,t,n,r,i){function s(e,t,n,r,i){function s(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t[3]=255,t}var o=e[t+1]<<8|e[t];t+=2;var u=e[t+1]<<8|e[t];t+=2;var a,f,l,c,h;if(o!==u){a=s(o,r[0]),f=s(u,r[1]),l=r[2],c=r[3];if(o>u){for(h=0;h<3;h+=1){var p=a[h],d=f[h];l[h]=(p*2+d)/3|0,c[h]=(p+d*2)/3|0}l[3]=255,c[3]=255}else{for(h=0;h<3;h+=1)l[h]=a[h]+f[h]>>1,c[h]=0;l[3]=255,c[3]=0}}else{a=s(o,r[0]),f=a,l=a,c=r[1];for(h=0;h<4;h+=1)c[h]=0}var v=i;v[0]=a,v[1]=f,v[2]=l,v[3]=c;var m,g,y;for(h=0;h<4;h+=1)m=e[t+h],g=n[h],y=v[m&3],g[0][0]=y[0],g[0][1]=y[1],g[0][2]=y[2],g[0][3]=y[3],y=v[m>>2&3],g[1][0]=y[0],g[1][1]=y[1],g[1][2]=y[2],g[1][3]=y[3],y=v[m>>4&3],g[2][0]=y[0],g[2][1]=y[1],g[2][2]=y[2],g[2][3]=y[3],y=v[m>>6&3],g[3][0]=y[0],g[3][1]=y[1],g[3][2]=y[2],g[3][3]=y[3]}function o(e,t,n,r){var i=e[t];t+=1;var s=e[t];t+=1;var o=r;o[0]=i,o[1]=s,i>s?(o[2]=(i*6+s*1)/7|0,o[3]=(i*5+s*2)/7|0,o[4]=(i*4+s*3)/7|0,o[5]=(i*3+s*4)/7|0,o[6]=(i*2+s*5)/7|0,o[7]=(i*1+s*6)/7|0):i<s?(o[2]=(i*4+s*1)/5|0,o[3]=(i*3+s*2)/5|0,o[4]=(i*2+s*3)/5|0,o[5]=(i*1+s*4)/5|0,o[6]=0,o[7]=255):(o[2]=i,o[3]=i,o[4]=i,o[5]=i,o[6]=0,o[7]=255);var u;for(var a=0;a<2;a+=1){var f=e[t]|e[t+1]<<8|e[t+2]<<16;t+=3,u=n[a*2],u[0][3]=o[f&7],u[1][3]=o[f>>3&7],u[2][3]=o[f>>6&7],u[3][3]=o[f>>9&7],u=n[a*2+1],u[0][3]=o[f>>12&7],u[1][3]=o[f>>15&7],u[2][3]=o[f>>18&7],u[3][3]=o[f>>21&7]}}var u=[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],a=new Array(4),f=new Uint8Array(8),l,c=t,h=n,p=r,d=i,v=0;for(l=0;l<p;l+=1)v+=c*h,c=c>1?c>>1:1,h=h>1?h>>1:1;var m=new Uint16Array(v*1*d),g=0,y=0,b=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]];for(var w=0;w<d;w+=1){c=t,h=n;for(var E=0;E<p;E+=1){var S=c>4?4:c,x=h>4?4:h,T=h+3>>2,N=c+3>>2,C=c*1,k=S*1,L=C*(x-1);for(var A=0;A<T;A+=1){for(var O=0;O<N;O+=1){s(e,g+8,b,u,a),o(e,g,b,f);var M=y;for(var _=0;_<x;_+=1){var D=b[_],P=M;for(var H=0;H<S;H+=1){var B=D[H];m[P]=B[3]>>>4|B[2]&240|(B[1]&240)<<4|(B[0]&240)<<8,P+=1}M+=C}g+=16,y+=k}y+=L}c=c>1?c>>1:1,h=h>1?h>>1:1}}return m},e.create=function(t){function r(e,t,n,r){return e.charCodeAt(0)+t.charCodeAt(0)*256+n.charCodeAt(0)*65536+r.charCodeAt(0)*16777216}var n=new e;n.gd=t.gd,n.onload=t.onload,n.onerror=t.onerror,n.FOURCC_ATI1=r("A","T","I","1"),n.FOURCC_ATI2=r("A","T","I","2"),n.FOURCC_RXGB=r("R","X","G","B");var i=t.src;if(i){n.src=i;var s;if(window.XMLHttpRequest)s=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror(0),null;s=new window.ActiveXObject("Microsoft.XMLHTTP")}s.onreadystatechange=function(){if(s.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=s.status,t=s.status!==0&&s.statusText||"No connection";e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200);if(s.getAllResponseHeaders()===""){var r;s.responseType==="arraybuffer"?r=!s.response:s.mozResponseArrayBuffer?r=!s.mozResponseArrayBuffer:r=!s.responseText;if(r){n.onerror&&n.onerror(0),s.onreadystatechange=null,s=null;return}}if(e===200||e===0){var i;if(s.responseType==="arraybuffer")i=s.response;else if(s.mozResponseArrayBuffer)i=s.mozResponseArrayBuffer;else{var o=s.responseText,u=o.length;i=[],i.length=u;for(var a=0;a<u;a+=1)i[a]=o.charCodeAt(a)&255}n.externalBuffer=!1,n.processBytes(new Uint8Array(i),e)}else n.onerror&&n.onerror(e)}s.onreadystatechange=null,s=null}},s.open("GET",t.src,!0),s.hasOwnProperty&&s.hasOwnProperty("responseType")?s.responseType="arraybuffer":s.overrideMimeType?s.overrideMimeType("text/plain; charset=x-user-defined"):s.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),s.send(null)}else n.externalBuffer=!0,n.processBytes(t.data,0);return n},e.destroy=function(){var e=this.maxNumWorkers;if(e){this.workerQueues=null;var t=this.workers;if(t){this.workers=null;var n;for(n=0;n<e;n+=1)t[n].terminate()}}},e.version=1,e.maxNumWorkers=typeof Worker=="undefined"||typeof Blob=="undefined"||typeof URL=="undefined"&&typeof window.webkitURL=="undefined"?0:4,e.WorkerCommand={DXT1:0,DXT1A:1,DXT3:2,DXT5:3},e.workerQueues=null,e.workers=null,e}();c.prototype.DDSF_CAPS=1,c.prototype.DDSF_HEIGHT=2,c.prototype.DDSF_WIDTH=4,c.prototype.DDSF_PITCH=8,c.prototype.DDSF_PIXELFORMAT=4096,c.prototype.DDSF_MIPMAPCOUNT=131072,c.prototype.DDSF_LINEARSIZE=524288,c.prototype.DDSF_DEPTH=8388608,c.prototype.DDSF_ALPHAPIXELS=1,c.prototype.DDSF_FOURCC=4,c.prototype.DDSF_RGB=64,c.prototype.DDSF_RGBA=65,c.prototype.DDSF_COMPLEX=8,c.prototype.DDSF_TEXTURE=4096,c.prototype.DDSF_MIPMAP=4194304,c.prototype.DDSF_CUBEMAP=512,c.prototype.DDSF_CUBEMAP_POSITIVEX=1024,c.prototype.DDSF_CUBEMAP_NEGATIVEX=2048,c.prototype.DDSF_CUBEMAP_POSITIVEY=4096,c.prototype.DDSF_CUBEMAP_NEGATIVEY=8192,c.prototype.DDSF_CUBEMAP_POSITIVEZ=16384,c.prototype.DDSF_CUBEMAP_NEGATIVEZ=32768,c.prototype.DDSF_CUBEMAP_ALL_FACES=64512,c.prototype.DDSF_VOLUME=2097152,c.prototype.FOURCC_UNKNOWN=0,c.prototype.FOURCC_R8G8B8=20,c.prototype.FOURCC_A8R8G8B8=21,c.prototype.FOURCC_X8R8G8B8=22,c.prototype.FOURCC_R5G6B5=23,c.prototype.FOURCC_X1R5G5B5=24,c.prototype.FOURCC_A1R5G5B5=25,c.prototype.FOURCC_A4R4G4B4=26,c.prototype.FOURCC_R3G3B2=27,c.prototype.FOURCC_A8=28,c.prototype.FOURCC_A8R3G3B2=29,c.prototype.FOURCC_X4R4G4B4=30,c.prototype.FOURCC_A2B10G10R10=31,c.prototype.FOURCC_A8B8G8R8=32,c.prototype.FOURCC_X8B8G8R8=33,c.prototype.FOURCC_G16R16=34,c.prototype.FOURCC_A2R10G10B10=35,c.prototype.FOURCC_A16B16G16R16=36,c.prototype.FOURCC_L8=50,c.prototype.FOURCC_A8L8=51,c.prototype.FOURCC_A4L4=52,c.prototype.FOURCC_DXT1=827611204,c.prototype.FOURCC_DXT2=844388420,c.prototype.FOURCC_DXT3=861165636,c.prototype.FOURCC_DXT4=877942852,c.prototype.FOURCC_DXT5=894720068,c.prototype.FOURCC_D16_LOCKABLE=70,c.prototype.FOURCC_D32=71,c.prototype.FOURCC_D24X8=77,c.prototype.FOURCC_D16=80,c.prototype.FOURCC_D32F_LOCKABLE=82,c.prototype.FOURCC_L16=81,c.prototype.FOURCC_R16F=111,c.prototype.FOURCC_G16R16F=112,c.prototype.FOURCC_A16B16G16R16F=113,c.prototype.FOURCC_R32F=114,c.prototype.FOURCC_G32R32F=115,c.prototype.FOURCC_A32B32G32R32F=116,c.prototype.BGRPIXELFORMAT_B5G6R5=1,c.prototype.BGRPIXELFORMAT_B8G8R8A8=2,c.prototype.BGRPIXELFORMAT_B8G8R8=3;var h=function(){function e(){}return e.prototype.setData=function(e,t,n,r,i,s,o){var u=this.gd,a=this.target;u.bindTexture(a,this.glTexture),3<=arguments.length?(r===undefined&&(r=0),i===undefined&&(i=0),s===undefined&&(s=this.width-r),o===undefined&&(o=this.height-i),this.updateSubData(e,t,n,r,i,s,o)):this.updateData(e),u.bindTexture(a,null)},e.prototype.createGLTexture=function(e){var t=this.gd,n=t.gl,r;if(this.cubemap)r=n.TEXTURE_CUBE_MAP;else{if(this.depth>1)return!1;r=n.TEXTURE_2D}this.target=r;var i=n.createTexture();return this.glTexture=i,t.bindTexture(r,i),n.texParameteri(r,n.TEXTURE_MAG_FILTER,n.LINEAR),this.mipmaps||1<this.numDataLevels?n.texParameteri(r,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_NEAREST):n.texParameteri(r,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(r,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(r,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),this.updateData(e),t.bindTexture(r,null),!0},e.prototype.updateData=function(e){function r(e){return Math.floor(Math.log(e)/Math.LN2)}var t=this.gd,n=t.gl,i=this.mipmaps&&this.numDataLevels!==1+Math.max(r(this.width),r(this.height)),s=this.format,o,u,a,f=null,l;if(s===t.PIXELFORMAT_A8)o=n.ALPHA,u=n.UNSIGNED_BYTE,a=1,e&&!e.src&&(e instanceof Uint8Array?f=e:f=new Uint8Array(e));else if(s===t.PIXELFORMAT_L8)o=n.LUMINANCE,u=n.UNSIGNED_BYTE,a=1,e&&!e.src&&(e instanceof Uint8Array?f=e:f=new Uint8Array(e));else if(s===t.PIXELFORMAT_L8A8)o=n.LUMINANCE_ALPHA,u=n.UNSIGNED_BYTE,a=2,e&&!e.src&&(e instanceof Uint8Array?f=e:f=new Uint8Array(e));else if(s===t.PIXELFORMAT_R5G5B5A1)o=n.RGBA,u=n.UNSIGNED_SHORT_5_5_5_1,a=1,e&&!e.src&&(e instanceof Uint16Array?f=e:f=new Uint16Array(e));else if(s===t.PIXELFORMAT_R5G6B5)o=n.RGB,u=n.UNSIGNED_SHORT_5_6_5,a=1,e&&!e.src&&(e instanceof Uint16Array?f=e:f=new Uint16Array(e));else if(s===t.PIXELFORMAT_R4G4B4A4)o=n.RGBA,u=n.UNSIGNED_SHORT_4_4_4_4,a=1,e&&!e.src&&(e instanceof Uint16Array?f=e:f=new Uint16Array(e));else if(s===t.PIXELFORMAT_R8G8B8A8)o=n.RGBA,u=n.UNSIGNED_BYTE,a=4,e&&!e.src&&(e instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray?f=new Uint8Array(e.buffer):f=e:f=new Uint8Array(e));else if(s===t.PIXELFORMAT_R8G8B8)o=n.RGB,u=n.UNSIGNED_BYTE,a=3,e&&!e.src&&(e instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray?f=new Uint8Array(e.buffer):f=e:f=new Uint8Array(e));else if(s===t.PIXELFORMAT_D24S8)o=n.DEPTH_STENCIL,u=n.UNSIGNED_INT,a=1,e&&!e.src&&(f=new Uint32Array(e));else{if(s!==t.PIXELFORMAT_DXT1&&s!==t.PIXELFORMAT_DXT3&&s!==t.PIXELFORMAT_DXT5)return;l=t.compressedTexturesExtension;if(!l)return;s===t.PIXELFORMAT_DXT1?(o=l.COMPRESSED_RGBA_S3TC_DXT1_EXT,a=8):s===t.PIXELFORMAT_DXT3?(o=l.COMPRESSED_RGBA_S3TC_DXT3_EXT,a=16):(o=l.COMPRESSED_RGBA_S3TC_DXT5_EXT,a=16);if(o===undefined)return;e&&!e.src&&(e instanceof Uint8Array?f=e:f=new Uint8Array(e))}var c=e&&0<this.numDataLevels?this.numDataLevels:1,h=this.width,d=this.height,v=0,m,g,y,b;if(this.cubemap){if(e&&e instanceof p)return;m=n.TEXTURE_CUBE_MAP;for(var w=0;w<6;w+=1){var E=n.TEXTURE_CUBE_MAP_POSITIVE_X+w;for(g=0;g<c;g+=1)l?(y=Math.floor((h+3)/4)*Math.floor((d+3)/4)*a,f?c===1?b=f:b=f.subarray(v,v+y):b=new Uint8Array(y),t.WEBGL_compressed_texture_s3tc?n.compressedTexImage2D(E,g,o,h,d,0,b):l.compressedTexImage2D(E,g,o,h,d,0,b)):(y=h*d*a,f?(c===1?b=f:b=f.subarray(v,v+y),n.texImage2D(E,g,o,h,d,0,o,u,b)):e?n.texImage2D(E,g,o,o,u,e):(u===n.UNSIGNED_SHORT_5_6_5||u===n.UNSIGNED_SHORT_5_5_5_1||u===n.UNSIGNED_SHORT_4_4_4_4?b=new Uint16Array(y):b=new Uint8Array(y),n.texImage2D(E,g,o,h,d,0,o,u,b))),v+=y,h=h>1?Math.floor(h/2):1,d=d>1?Math.floor(d/2):1;h=this.width,d=this.height}}else if(e&&e instanceof p)m=n.TEXTURE_2D,n.texImage2D(m,0,o,o,u,e.video);else{m=n.TEXTURE_2D;for(g=0;g<c;g+=1)l?(y=Math.floor((h+3)/4)*Math.floor((d+3)/4)*a,f?c===1?b=f:b=f.subarray(v,v+y):b=new Uint8Array(y),t.WEBGL_compressed_texture_s3tc?n.compressedTexImage2D(m,g,o,h,d,0,b):l.compressedTexImage2D(m,g,o,h,d,0,b)):(y=h*d*a,f?(c===1?b=f:b=f.subarray(v,v+y),n.texImage2D(m,g,o,h,d,0,o,u,b)):e?n.texImage2D(m,g,o,o,u,e):(u===n.UNSIGNED_SHORT_5_6_5||u===n.UNSIGNED_SHORT_5_5_5_1||u===n.UNSIGNED_SHORT_4_4_4_4?b=new Uint16Array(y):b=new Uint8Array(y),n.texImage2D(m,g,o,h,d,0,o,u,b))),v+=y,h=h>1?Math.floor(h/2):1,d=d>1?Math.floor(d/2):1}i&&n.generateMipmap(m)},e.prototype.updateSubData=function(e,t,n,r,i,s,o){var u=this.gd,a=u.gl,f=this.format,l,c,h,d;if(f===u.PIXELFORMAT_A8)l=a.ALPHA,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?h=e:h=new Uint8Array(e);else if(f===u.PIXELFORMAT_L8)l=a.LUMINANCE,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?h=e:h=new Uint8Array(e);else if(f===u.PIXELFORMAT_L8A8)l=a.LUMINANCE_ALPHA,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?h=e:h=new Uint8Array(e);else if(f===u.PIXELFORMAT_R5G5B5A1)l=a.RGBA,c=a.UNSIGNED_SHORT_5_5_5_1,e instanceof Uint16Array?h=e:h=new Uint16Array(e);else if(f===u.PIXELFORMAT_R5G6B5)l=a.RGB,c=a.UNSIGNED_SHORT_5_6_5,e instanceof Uint16Array?h=e:h=new Uint16Array(e);else if(f===u.PIXELFORMAT_R4G4B4A4)l=a.RGBA,c=a.UNSIGNED_SHORT_4_4_4_4,e instanceof Uint16Array?h=e:h=new Uint16Array(e);else if(f===u.PIXELFORMAT_R8G8B8A8)l=a.RGBA,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray?h=new Uint8Array(e.buffer):h=e:h=new Uint8Array(e);else if(f===u.PIXELFORMAT_R8G8B8)l=a.RGB,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray?h=new Uint8Array(e.buffer):h=e:h=new Uint8Array(e);else{if(f!==u.PIXELFORMAT_DXT1&&f!==u.PIXELFORMAT_DXT3&&f!==u.PIXELFORMAT_DXT5)return;d=u.compressedTexturesExtension;if(!d)return;f===u.PIXELFORMAT_DXT1?l=d.COMPRESSED_RGBA_S3TC_DXT1_EXT:f===u.PIXELFORMAT_DXT3?l=d.COMPRESSED_RGBA_S3TC_DXT3_EXT:l=d.COMPRESSED_RGBA_S3TC_DXT5_EXT,e instanceof Uint8Array?h=e:h=new Uint8Array(e)}var v;if(this.cubemap){if(e instanceof p)return;v=a.TEXTURE_CUBE_MAP_POSITIVE_X+t}else{if(e instanceof p){v=a.TEXTURE_2D,a.texSubImage2D(v,n,r,i,l,c,e.video);return}v=a.TEXTURE_2D}d?u.WEBGL_compressed_texture_s3tc?a.compressedTexSubImage2D(v,n,r,i,s,o,l,h):d.compressedTexSubImage2D(v,n,r,i,s,o,l,h):a.texSubImage2D(v,n,r,i,s,o,l,c,h)},e.prototype.updateMipmaps=function(e){if(this.mipmaps){if(this.depth>1){TurbulenzEngine.callOnError("3D texture mipmap generation unsupported");return}if(this.cubemap&&e!==5)return;var t=this.gd,n=t.gl,r=this.target;t.bindTexture(r,this.glTexture),n.generateMipmap(r),t.bindTexture(r,null)}},e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glTexture;if(t){var n=e.gl;n&&(e.unbindTexture(t),n.deleteTexture(t)),delete this.glTexture}delete this.sampler,delete this.gd}},e.prototype.typedArrayIsValid=function(e){var t=this.gd,n=this.format;if(t){if(n===t.PIXELFORMAT_A8||n===t.PIXELFORMAT_L8||n===t.PIXELFORMAT_S8)return(e instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray)&&e.length===this.width*this.height*this.depth;if(n===t.PIXELFORMAT_L8A8)return(e instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray)&&e.length===2*this.width*this.height*this.depth;if(n===t.PIXELFORMAT_R8G8B8)return(e instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray)&&e.length===3*this.width*this.height*this.depth;if(n===t.PIXELFORMAT_R8G8B8A8)return(e instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray)&&e.length===4*this.width*this.height*this.depth;if(n===t.PIXELFORMAT_R5G5B5A1||n===t.PIXELFORMAT_R5G6B5||n===t.PIXELFORMAT_R4G4B4A4)return e instanceof Uint16Array&&e.length===this.width*this.height*this.depth}return!1},e.create=function(t,n){var r=new e;r.gd=t,r.mipmaps=n.mipmaps,r.dynamic=n.dynamic,r.renderable=n.renderable,r.numDataLevels=0,r.id=++t.counters.textures;var i=n.src;if(i){r.name=n.name||i;var s,o=n.data;o?o[0]===137&&o[1]===80&&o[2]===78&&o[3]===71?s=".png":o[0]!==255||o[1]!==216||o[2]!==255||o[3]!==224&&o[3]!==225?o[0]===68&&o[1]===68&&o[2]===83&&o[3]===32?s=".dds":s=i.slice(-4):s=".jpg":s=i.slice(-4);if(s===".dds"||s===".tga"){if(s===".tga"&&typeof vt!="undefined"){var u={gd:t,onload:function(t,i,s,o,u){r.width=i,r.height=s,r.depth=1,r.format=o,r.cubemap=!1;var a=r.createGLTexture(t);n.onload&&n.onload(a?r:null,u)},onerror:function(t){r.failed=!0,n.onload&&n.onload(null,t)},data:undefined,src:undefined};return o?u.data=o:u.src=i,vt.create(u),r}if(s===".dds"&&typeof c!="undefined"){var a={gd:t,onload:function(t,i,s,o,u,a,f,l){r.width=i,r.height=s,r.format=o,r.cubemap=a,r.depth=f,r.numDataLevels=u;var c=r.createGLTexture(t);n.onload&&n.onload(c?r:null,l)},onerror:function(t){r.failed=!0,n.onload&&n.onload(null,t)},data:undefined,src:undefined};return o?a.data=o:a.src=i,c.create(a),r}return TurbulenzEngine.callOnError("Missing image loader required for "+i),r=e.create(t,{name:n.name||i,width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:n.mipmaps,dynamic:n.dynamic,renderable:n.renderable,data:[255,20,147,255,255,0,0,255,255,255,255,255,255,20,147,255]}),n.onload&&(TurbulenzEngine?TurbulenzEngine.setTimeout(function(){n.onload(r,200)},0):window.setTimeout(function(){n.onload(r,200)},0)),r}var f=new Image,l=function(){r.width=f.width,r.height=f.height,r.depth=1,r.format=t.PIXELFORMAT_R8G8B8A8,r.cubemap=!1;var i=r.createGLTexture(f);n.onload&&n.onload(i?r:null,200)};f.onload=l,f.onerror=function(){r.failed=!0,n.onload&&n.onload(null)};if(o){if(typeof Blob!="undefined"&&typeof URL!="undefined"&&URL.createObjectURL){var h;s===".jpg"||s===".jpeg"?h=new Blob([o],{type:"image/jpeg"}):s===".png"&&(h=new Blob([o],{type:"image/png"})),f.onload=function(){l(),URL.revokeObjectURL(f.src)},i=URL.createObjectURL(h)}else s===".jpg"||s===".jpeg"?i="data:image/jpeg;base64,"+TurbulenzEngine.base64Encode(o):s===".png"&&(i="data:image/png;base64,"+TurbulenzEngine.base64Encode(o));f.src=i}else if(typeof URL!="undefined"&&URL.createObjectURL){var p=new XMLHttpRequest;p.onreadystatechange=function(){if(p.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading
()){var e=p.status;e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200),p.getAllResponseHeaders()===""&&!p.response?n.onload&&n.onload(null,0):e===200||e===0?(f.onload=function(){l(),URL.revokeObjectURL(f.src)},f.src=URL.createObjectURL(p.response)):n.onload(null,e),p.onreadystatechange=null,p=null}return r}},p.open("GET",i,!0),p.responseType="blob",p.send()}else f.crossOrigin="anonymous",f.src=i}else{if(""===i&&n.onload)return null;var d=n.format;typeof d=="string"&&(d=t["PIXELFORMAT_"+d]),r.width=n.width,r.height=n.height,r.depth=n.depth,r.format=d,r.cubemap=n.cubemap,r.name=n.name;var v=r.createGLTexture(n.data);v||(r=null),n.renderable&&(t.PIXELFORMAT_D16===d?r.glDepthAttachment=t.gl.DEPTH_ATTACHMENT:t.PIXELFORMAT_D24S8===d&&(r.glDepthAttachment=t.gl.DEPTH_STENCIL_ATTACHMENT)),n.onload&&n.onload(r,200)}return r},e.version=1,e}(),p=function(){function e(){}return e.prototype.play=function(e){var t=this.video;this.playing||(this.playing=!0,this.paused=!1),e===undefined&&(e=0);if(.01<Math.abs(t.currentTime-e))try{t.currentTime=e}catch(n){}return t.play(),!0},e.prototype.stop=function(){var e=this.playing;if(e){this.playing=!1,this.paused=!1;var t=this.video;t.pause(),t.currentTime=0}return e},e.prototype.pause=function(){return this.playing?(this.paused||(this.paused=!0,this.video.pause()),!0):!1},e.prototype.resume=function(e){if(this.paused){this.paused=!1;var t=this.video;if(e!==undefined&&.01<Math.abs(t.currentTime-e))try{t.currentTime=e}catch(n){}return t.play(),!0}return!1},e.prototype.rewind=function(){return this.playing?(this.video.currentTime=0,!0):!1},e.prototype.destroy=function(){this.stop(),this.video&&(this.elementAdded&&(this.elementAdded=!1,TurbulenzEngine.canvas.parentElement.removeChild(this.video)),this.video=null)},e.create=function(t){var n=new e,r=t.onload,i=t.looping,s=t.src,o=navigator.userAgent.toLowerCase(),u=document.createElement("video");u.preload="auto",u.autobuffer=!0,u.muted=!0,i?u.loop!==undefined&&!o.match(/firefox/)?u.loop=!0:u.onended=function(){u.src=s,u.play()}:u.onended=function(){n.playing=!1},n.video=u,n.src=s,n.playing=!1,n.paused=!1,o.match(/safari/)&&!o.match(/chrome/)&&(u.setAttribute("style","visibility: hidden;"),TurbulenzEngine.canvas.parentElement.appendChild(u),n.elementAdded=!0);if(u.webkitDecodedFrameCount!==undefined){var a=-1,f=0;Object.defineProperty(n,"tell",{get:function(){return a!==this.video.webkitDecodedFrameCount&&(a=this.video.webkitDecodedFrameCount,f=this.video.currentTime),f},enumerable:!0,configurable:!1})}else Object.defineProperty(n,"tell",{get:function(){return this.video.currentTime},enumerable:!0,configurable:!1});Object.defineProperty(n,"looping",{get:function(){return i},enumerable:!0,configurable:!1});var l=function(){r&&(r(null),r=null),u.removeEventListener("error",l),u=null,n.video=null,n.playing=!1};u.addEventListener("error",l,!1);var c=function(){n.length=u.duration,n.width=u.videoWidth,n.height=u.videoHeight,r&&(r(n,200),r=null),u.removeEventListener("progress",h),u.removeEventListener("canplaythrough",c)},h=function(){0<u.buffered.length&&u.buffered.end(0)>=u.duration&&c()};return u.addEventListener("progress",h,!1),u.addEventListener("canplaythrough",c,!1),u.crossorigin="anonymous",u.src=s,n},e.version=1,e}(),d=function(){function e(){}return e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glBuffer;if(t){var n=e.gl;n&&n.deleteRenderbuffer(t),delete this.glBuffer}delete this.gd}},e.create=function(t,n){var r=new e,i=n.width,s=n.height,o=n.format;typeof o=="string"&&(o=t["PIXELFORMAT_"+o]);if(o!==t.PIXELFORMAT_D24S8&&o!==t.PIXELFORMAT_D16)return null;var u=t.gl,a=u.createRenderbuffer();u.bindRenderbuffer(u.RENDERBUFFER,a);var f,l;return t.PIXELFORMAT_D16===o?(f=u.DEPTH_COMPONENT16,l=u.DEPTH_ATTACHMENT):(f=u.DEPTH_STENCIL,l=u.DEPTH_STENCIL_ATTACHMENT),u.renderbufferStorage(u.RENDERBUFFER,f,i,s),r.width=u.getRenderbufferParameter(u.RENDERBUFFER,u.RENDERBUFFER_WIDTH),r.height=u.getRenderbufferParameter(u.RENDERBUFFER,u.RENDERBUFFER_HEIGHT),u.bindRenderbuffer(u.RENDERBUFFER,null),r.width<i||r.height<s?(u.deleteRenderbuffer(a),null):(r.gd=t,r.format=o,r.glDepthAttachment=l,r.glBuffer=a,r.id=++t.counters.renderBuffers,r)},e.version=1,e}(),v=function(){function e(){}return e.prototype.copyBox=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]},e.prototype.bind=function(){var e=this.gd,t=e.gl;this.colorTexture0&&(e.unbindTexture(this.colorTexture0.glTexture),this.colorTexture1&&(e.unbindTexture(this.colorTexture1.glTexture),this.colorTexture2&&(e.unbindTexture(this.colorTexture2.glTexture),this.colorTexture3&&e.unbindTexture(this.colorTexture3.glTexture)))),this.depthTexture&&e.unbindTexture(this.depthTexture.glTexture),t.bindFramebuffer(t.FRAMEBUFFER,this.glObject);var n=e.drawBuffersExtension;n&&(e.WEBGL_draw_buffers?n.drawBuffersWEBGL(this.buffers):n.drawBuffersEXT(this.buffers));var r=e.state;return this.copyBox(this.oldViewportBox,r.viewportBox),this.copyBox(this.oldScissorBox,r.scissorBox),e.setViewport(0,0,this.width,this.height),e.setScissor(0,0,this.width,this.height),!0},e.prototype.unbind=function(){var e=this.gd,t=e.gl;t.bindFramebuffer(t.FRAMEBUFFER,null);var n=e.drawBuffersExtension;if(n){var r=[t.BACK];e.WEBGL_draw_buffers?n.drawBuffersWEBGL(r):n.drawBuffersEXT(r)}e.setViewport.apply(e,this.oldViewportBox),e.setScissor.apply(e,this.oldScissorBox),this.colorTexture0&&(this.colorTexture0.updateMipmaps(this.face),this.colorTexture1&&(this.colorTexture1.updateMipmaps(this.face),this.colorTexture2&&(this.colorTexture2.updateMipmaps(this.face),this.colorTexture3&&this.colorTexture3.updateMipmaps(this.face)))),this.depthTexture&&this.depthTexture.updateMipmaps(this.face)},e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glObject;if(t){var n=e.gl;n&&n.deleteFramebuffer(t),delete this.glObject}delete this.colorTexture0,delete this.colorTexture1,delete this.colorTexture2,delete this.colorTexture3,delete this.depthBuffer,delete this.depthTexture,delete this.gd}},e.create=function(t,n){var r=new e,i=n.colorTexture0,s=i?n.colorTexture1||null:null,o=s?n.colorTexture2||null:null,u=o?n.colorTexture3||null:null,a=n.depthBuffer||null,f=n.depthTexture||null,l=n.face,c=t.maxSupported("RENDERTARGET_COLOR_TEXTURES");if(s&&c<2)return null;if(o&&c<3)return null;if(u&&c<4)return null;var h=t.gl,p=h.COLOR_ATTACHMENT0,d=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,d);var v,m;if(i){v=i.width,m=i.height;var g=i.glTexture;if(g===undefined)return TurbulenzEngine.callOnError("Color texture is not a Texture"),h.bindFramebuffer(h.FRAMEBUFFER,null),h.deleteFramebuffer(d),null;i.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,0):h.framebufferTexture2D(h.FRAMEBUFFER,p,h.TEXTURE_2D,g,0),s&&(g=s.glTexture,s.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p+1,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,0):h.framebufferTexture2D(h.FRAMEBUFFER,p+1,h.TEXTURE_2D,g,0),o&&(g=o.glTexture,s.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p+2,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,0):h.framebufferTexture2D(h.FRAMEBUFFER,p+2,h.TEXTURE_2D,g,0),u&&(g=u.glTexture,s.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p+3,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,0):h.framebufferTexture2D(h.FRAMEBUFFER,p+3,h.TEXTURE_2D,g,0))))}else if(f)v=f.width,m=f.height;else{if(!a)return TurbulenzEngine.callOnError("No RenderBuffers or Textures specified for this RenderTarget"),h.bindFramebuffer(h.FRAMEBUFFER,null),h.deleteFramebuffer(d),null;v=a.width,m=a.height}f?h.framebufferTexture2D(h.FRAMEBUFFER,f.glDepthAttachment,h.TEXTURE_2D,f.glTexture,0):a&&h.framebufferRenderbuffer(h.FRAMEBUFFER,a.glDepthAttachment,h.RENDERBUFFER,a.glBuffer);var y=h.checkFramebufferStatus(h.FRAMEBUFFER);h.bindFramebuffer(h.FRAMEBUFFER,null);if(y!==h.FRAMEBUFFER_COMPLETE)return h.deleteFramebuffer(d),null;r.gd=t,r.glObject=d,r.colorTexture0=i,r.colorTexture1=s,r.colorTexture2=o,r.colorTexture3=u,r.depthBuffer=a,r.depthTexture=f,r.width=v,r.height=m,r.face=l;if(t.drawBuffersExtension){var b;i?(b=[p],s&&(b.push(p+1),o&&(b.push(p+2),u&&b.push(p+3)))):b=[h.NONE],r.buffers=b}return r.id=++t.counters.renderTargets,r},e.version=1,e}();v.prototype.oldViewportBox=[],v.prototype.oldScissorBox=[];var m=function(){function e(){}return e.prototype.map=function(e,t){e===undefined&&(e=0),t===undefined&&(t=this.numIndices);var n=this.gd,r=n.gl,i=this.format,s;i===r.UNSIGNED_BYTE?s=new Uint8Array(t):i===r.UNSIGNED_SHORT?s=new Uint16Array(t):s=new Uint32Array(t);var o=0,u=function(){var t=arguments.length;for(var n=0;n<t;n+=1)s[o]=arguments[n],o+=1};return u.write=u,u.data=s,u.offset=e,u.getNumWrittenIndices=function(){return o},u.write=u,u},e.prototype.unmap=function(e){if(e){var t=this.gd,n=t.gl,r=e.data;delete e.data;var i=e.offset;delete e.write;var s=e.getNumWrittenIndices();if(!s)return;s<r.length&&(r=r.subarray(0,s)),t.setIndexBuffer(this),s<this.numIndices?n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,i,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,r,this.usage)}},e.prototype.setData=function(e,t,n){t===undefined&&(t=0),n===undefined&&(n=this.numIndices);var r=this.gd,i=r.gl,s,o=this.format;o===i.UNSIGNED_BYTE?e instanceof Uint8Array?s=e:s=new Uint8Array(e):o===i.UNSIGNED_SHORT?(e instanceof Uint16Array?s=e:s=new Uint16Array(e),t*=2):o===i.UNSIGNED_INT&&(e instanceof Uint32Array?s=e:s=new Uint32Array(e),t*=4),e=undefined,n<s.length&&(s=s.subarray(0,n)),r.setIndexBuffer(this),n<this.numIndices?i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,t,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,s,this.usage)},e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glBuffer;if(t){var n=e.gl;n&&(e.unsetIndexBuffer(this),n.deleteBuffer(t)),delete this.glBuffer}delete this.gd}},e.create=function(t,n){var r=t.gl,i=new e;i.gd=t;var s=n.numIndices;i.numIndices=s;var o=n.format;typeof o=="string"&&(o=t["INDEXFORMAT_"+o]),i.format=o;var u;return o===r.UNSIGNED_BYTE?u=1:o===r.UNSIGNED_SHORT?u=2:u=4,i.stride=u,i["transient"]=n["transient"]||!1,i.dynamic=n.dynamic||i["transient"],i.usage=i["transient"]?r.STREAM_DRAW:i.dynamic?r.DYNAMIC_DRAW:r.STATIC_DRAW,i.glBuffer=r.createBuffer(),n.data?i.setData(n.data,0,s):(t.setIndexBuffer(i),r.bufferData(r.ELEMENT_ARRAY_BUFFER,s*u,i.usage)),i.id=++t.counters.indexBuffers,i},e.version=1,e}(),g=function(){function e(){}return e.create=function(t,n){var r=new e,i=n.length;r.length=i;for(var s=0;s<i;s+=1){var o=n[s];typeof o=="string"?r[s]=t["SEMANTIC_"+o]:r[s]=o}return r},e.version=1,e}(),y=function(){function e(){}return e.prototype.map=function(e,t){e===undefined&&(e=0),t===undefined&&(t=this.numVertices);var n=this.gd,r=n.gl,i=this.stride,s=this.attributes,o=s.length,u,a,f=0;if(this.hasSingleFormat){var l=t*i,c=s[0].format;c===r.FLOAT?u=new Float32Array(l):c===r.BYTE?u=new Int8Array(l):c===r.UNSIGNED_BYTE?u=new Uint8Array(l):c===r.SHORT?u=new Int16Array(l):c===r.UNSIGNED_SHORT?u=new Uint16Array(l):c===r.INT?u=new Int32Array(l):c===r.UNSIGNED_INT&&(u=new Uint32Array(l)),a=function(){var t=arguments.length,n=0;for(var r=0;r<o;r+=1){var i=s[r],a=i.numComponents,l=0,c;do if(n<t){var h=arguments[n];n+=1;if(typeof h!="number"){if(l===0){var p=h.length;p>a&&(p=a);if(i.normalized){var d=i.normalizationScale;for(c=0;c<p;c+=1)u[f]=h[c]*d,f+=1,l+=1}else for(c=0;c<p;c+=1)u[f]=h[c],f+=1,l+=1;while(l<a)f+=1,l+=1;break}return TurbulenzEngine.callOnError("Missing values for attribute "+r),null}i.normalized&&(h*=i.normalizationScale),u[f]=h,f+=1,l+=1}else f+=1,l+=1;while(l<a)}}}else{var h=0,p=t*this.strideInBytes;u=new ArrayBuffer(p);if(typeof DataView!="undefined"&&"setFloat32"in DataView.prototype){var d=new DataView(u);a=function(){var t=arguments.length,n=0;for(var r=0;r<o;r+=1){var i=s[r],u=i.numComponents,a=i.typedSetter,l=i.componentStride,c=0,p;do if(n<t){var v=arguments[n];n+=1;if(typeof v!="number"){if(c===0){var m=v.length;m>u&&(m=u);if(i.normalized){var g=i.normalizationScale;for(p=0;p<m;p+=1)a.call(d,h,v[p]*g,!0),h+=l,c+=1,f+=1}else for(p=0;p<m;p+=1)a.call(d,h,v[p],!0),h+=l,c+=1,f+=1;while(c<u)f+=1,c+=1;break}return TurbulenzEngine.callOnError("Missing values for attribute "+r),null}i.normalized&&(v*=i.normalizationScale),a.call(d,h,v,!0),h+=l,c+=1,f+=1}else f+=1,c+=1;while(c<u)}}}else a=function(){var t=arguments.length,n=0,r;for(var i=0;i<o;i+=1){var a=s[i],l=a.numComponents;r=new a.typedArray(u,h,l),h+=a.stride;var c=0,p;do if(n<t){var d=arguments[n];n+=1;if(typeof d!="number"){if(c===0){var v=d.length;v>l&&(v=l);if(a.normalized){var m=a.normalizationScale;for(p=0;p<v;p+=1)r[c]=d[p]*m,c+=1,f+=1}else for(p=0;p<v;p+=1)r[c]=d[p],c+=1,f+=1;while(c<l)c+=1,f+=1;break}return TurbulenzEngine.callOnError("Missing values for attribute "+i),null}a.normalized&&(d*=a.normalizationScale),r[c]=d,c+=1,f+=1}else c+=1,f+=1;while(c<l)}}}return a.data=u,a.offset=e,a.getNumWrittenVertices=function(){return Math.floor(f/i)},a.getNumWrittenValues=function(){return f},a.write=a,a},e.prototype.unmap=function(e){if(e){var t=e.data;delete e.data,delete e.write;var n=e.getNumWrittenVertices();if(!n)return;var r=e.offset,i=this.strideInBytes;if(this.hasSingleFormat){var s=e.getNumWrittenValues();s<t.length&&(t=t.subarray(0,s))}else{var o=n*i;o<t.byteLength&&(t=t.slice(0,o))}var u=this.gd,a=u.gl;u.bindVertexBuffer(this.glBuffer),n<this.numVertices?a.bufferSubData(a.ARRAY_BUFFER,r*i,t):a.bufferData(a.ARRAY_BUFFER,t,this.usage)}},e.prototype.setData=function(e,t,n){t===undefined&&(t=0),n===undefined&&(n=this.numVertices);var r=this.gd,i=r.gl,s=this.strideInBytes;if(e.constructor===ArrayBuffer){r.bindVertexBuffer(this.glBuffer),n<this.numVertices?i.bufferSubData(i.ARRAY_BUFFER,t*s,e):i.bufferData(i.ARRAY_BUFFER,e,this.usage);return}var o=this.attributes,u=this.numAttributes,a,f,l,c;if(this.hasSingleFormat){a=o[0],f=a.format,f===i.FLOAT?e instanceof Float32Array||(c=Float32Array):f===i.BYTE?e instanceof Int8Array||(c=Int8Array):f===i.UNSIGNED_BYTE?e instanceof Uint8Array||(c=Uint8Array):f===i.SHORT?e instanceof Int16Array||(c=Int16Array):f===i.UNSIGNED_SHORT?e instanceof Uint16Array||(c=Uint16Array):f===i.INT?e instanceof Int32Array||(c=Int32Array):f===i.UNSIGNED_INT&&(e instanceof Uint32Array||(c=Uint32Array));var h=this.stride,p=n*h;c?(a.normalized&&(e=this.scaleValues(e,a.normalizationScale,p)),l=new c(e),p<l.length&&(l=l.subarray(0,p))):l=e,p<e.length&&(l=l.subarray(0,p))}else{var d=n*s;l=new ArrayBuffer(d);var v=0,m=0,g,y,b,w,E,S;if(typeof DataView!="undefined"&&"setFloat32"in DataView.prototype){var x=new DataView(l);for(g=0;g<n;g+=1)for(b=0;b<u;b+=1){a=o[b],w=a.numComponents,E=a.componentStride;var T=a.typedSetter;if(a.normalized){S=a.normalizationScale;for(y=0;y<w;y+=1)T.call(x,m,e[v]*S,!0),m+=E,v+=1}else for(y=0;y<w;y+=1)T.call(x,m,e[v],!0),m+=E,v+=1}}else for(g=0;g<n;g+=1)for(b=0;b<u;b+=1){a=o[b],w=a.numComponents;var N=new a.typedArray(l,m,w);m+=a.stride;if(a.normalized){S=a.normalizationScale;for(y=0;y<w;y+=1)N[y]=e[v]*S,v+=1}else for(y=0;y<w;y+=1)N[y]=e[v],v+=1}}e=undefined,r.bindVertexBuffer(this.glBuffer),n<this.numVertices?i.bufferSubData(i.ARRAY_BUFFER,t*s,l):i.bufferData(i.ARRAY_BUFFER,l,this.usage)},e.prototype.scaleValues=function(e,t,n){n===undefined&&(n=e.length);var r=new e.constructor(n);for(var i=0;i<n;i+=1)r[i]=e[i]*t;return r},e.prototype.bindAttributes=function(e,t,n){var r=this.gd,i=r.gl,s=this.attributes,o=this.strideInBytes,u=0;for(var a=0;a<e;a+=1){var f=s[a],l=t[a];u|=1<<l,i.vertexAttribPointer(l,f.numComponents,f.format,f.normalized,o,n),n+=f.stride}return u},e.prototype.setAttributes=function(e){var t=this.gd,n=e.length;this.numAttributes=n,this.attributes=[];var r=0,i=0,s=!0;for(var o=0;o<n;o+=1){var u=e[o];typeof u=="string"&&(u=t["VERTEXFORMAT_"+u]),this.attributes[o]=u,r+=u.stride,i+=u.numComponents,s&&o&&u.format!==this.attributes[o-1].format&&(s=!1)}return this.strideInBytes=r,this.stride=i,this.hasSingleFormat=s,r},e.prototype.resize=function(e){if(e!==this.strideInBytes*this.numVertices){var t=this.gd,n=t.gl;t.bindVertexBuffer(this.glBuffer);var r=n.ARRAY_BUFFER;n.bufferData(r,e,this.usage);var i=n.getBufferParameter(r,n.BUFFER_SIZE);this.numVertices=Math.floor(i/this.strideInBytes)}},e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glBuffer;if(t){var n=e.gl;n&&(e.unbindVertexBuffer(t),n.deleteBuffer(t)),delete this.glBuffer}delete this.gd}},e.create=function(t,n){var r=t.gl,i=new e;i.gd=t;var s=n.numVertices;i.numVertices=s;var o=i.setAttributes(n.attributes);i["transient"]=n["transient"]||!1,i.dynamic=n.dynamic||i["transient"],i.usage=i["transient"]?r.STREAM_DRAW:i.dynamic?r.DYNAMIC_DRAW:r.STATIC_DRAW,i.glBuffer=r.createBuffer();var u=s*o;return n.data?i.setData(n.data,0,s):(t.bindVertexBuffer(i.glBuffer),r.bufferData(r.ARRAY_BUFFER,u,i.usage)),i.id=++t.counters.vertexBuffers,i},e.version=1,e}(),b=function(){function e(){}return e.prototype.updateParametersData=function(e){var t=e.gl;this.dirty=!1;var n=this.parameters;for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];if(i.dirty){i.dirty=0;var s=i.info,o=i.location;if(s&&null!==o){var u=s.values,a;s.type==="float"?(a=s.columns,4===a?t.uniform4fv(o,u):3===a?t.uniform3fv(o,u):2===a?t.uniform2fv(o,u):1===s.rows?t.uniform1f(o,u[0]):t.uniform1fv(o,u)):s.sampler!==undefined?e.setTexture(i.textureUnit,u,s.sampler):(a=s.columns,4===a?t.uniform4iv(o,u):3===a?t.uniform3iv(o,u):2===a?t.uniform2iv(o,u):1===s.rows?t.uniform1i(o,u[0]):t.uniform1iv(o,u))}}}},e.prototype.initializeParameters=function(e){var t=e.gl,n=this.glProgram;e.setProgram(n);var r=this.parameters;for(var i in r)if(r.hasOwnProperty(i)){var s=r[i],o=s.info;if(o){var u=t.getUniformLocation(n,i);if(null!==u){s.location=u;if(o.sampler)t.uniform1i(u,s.textureUnit);else{var a=o.values,f;o.type==="float"?(f=o.columns,4===f?t.uniform4fv(u,a):3===f?t.uniform3fv(u,a):2===f?t.uniform2fv(u,a):1===o.rows?t.uniform1f(u,a[0]):t.uniform1fv(u,a)):(f=o.columns,4===f?t.uniform4iv(u,a):3===f?t.uniform3iv(u,a):2===f?t.uniform2iv(u,a):1===o.rows?t.uniform1i(u,a[0]):t.uniform1iv(u,a))}}}}},e.prototype.destroy=function(){delete this.glProgram,delete this.semanticsMask,delete this.parameters,delete this.states,delete this.statesSet},e.create=function(t,n,r){function A(e,t){var n=e.length,r;for(r=0;r<n;r+=1)if(e[r]!==t[r])return!1;return!0}var i=t.gl,s=new e;s.name=r.name||null;var o=n.programs,u=n.parameters,a=r.parameters,f=r.programs,l=r.semantics,c=r.states,h=f.join(":"),p=n.linkedPrograms[h],d,v,m,g;if(p===undefined){d=i.createProgram();var y=f.length;for(m=0;m<y;m+=1){var b=o[f[m]];b&&i.attachShader(d,b)}var w=l.length;v=0;for(g=0;g<w;g+=1){var E=l[g],S=t["SEMANTIC_"+E];S!==undefined&&(v|=1<<S,i.bindAttribLocation(d,S,"ATTR"+S))}i.linkProgram(d),n.linkedPrograms[h]={glProgram:d,semanticsMask:v}}else d=p.glProgram,v=p.semanticsMask;s.glProgram=d,s.semanticsMask=v;var x=0,T={};s.parameters=T;var N=a?a.length:0;for(m=0;m<N;m+=1){var C=a[m],k={};T[C]=k;var L=u[C];k.info=L,L&&(k.location=null,L.sampler?(k.textureUnit=x,x+=1):k.textureUnit=undefined)}s.numTextureUnits=x,s.numParameters=N;var O=t.stateHandlers,M=[],_={};s.states=M,s.statesSet=_;for(g in c)if(c.hasOwnProperty(g)){var D=O[g];if(D){var P=D.parse(c[g]);if(P!==null){if(A(D.defaultValues,P))continue;M.push({name:g,set:D.set,reset:D.reset,values:P}),_[g]=!0}else TurbulenzEngine.callOnError("Unknown value for state "+g+": "+c[g])}}return s},e.version=1,e}(),w=function(){function e(){}return e.prototype.getPass=function(e){var t=this.passes,n=t.length;if(typeof e=="string")for(var r=0;r<n;r+=1){var i=t[r];if(i.name===e)return i}else{e|=0;if(e<n)return t[e]}return null},e.prototype.activate=function(e){this.device=e,this.initialized||(this.shader.initialize(e),this.initialize(e))},e.prototype.deactivate=function(){this.device=null},e.prototype.checkProperties=function(e){var t={},n;for(n in this)n!=="version"&&n!=="name"&&n!=="id"&&n!=="passes"&&n!=="numPasses"&&n!=="device"&&n!=="numParameters"&&(t[n]=this[n]);if(t){var r=this.passes;r.length===1?e.setParametersImmediate(r[0].parameters,t):e.setParametersDeferred(e,r,t);for(n in t)t.hasOwnProperty(n)&&delete this[n]}},e.prototype.initialize=function(e){if(this.initialized)return;var t=this.passes;if(t){var n=t.length,r;for(r=0;r<n;r+=1)t[r].initializeParameters(e)}Object.defineProperty&&this.initializeParametersSetters(e),this.initialized=!0},e.prototype.initializeParametersSetters=function(e){function n(t,n){return function(r){this.device?e.setTexture(n.textureUnit,r,n.info.sampler):(t.dirty=!0,n.dirty=1,n.info.values=r)}}function r(e,n){function s(t){if(typeof t!="number"){var i=r.values,s=Math.min(r.numValues,t.length);for(var o=0;o<s;o+=1)i[o]=t[o];n.dirty=Math.max(s,n.dirty||0)}else r.values[0]=t,n.dirty=n.dirty||1;e.dirty=!0}var r=n.info,i=n.location;switch(r.columns){case 1:if(1===r.numValues)return function(e){this.device?t.uniform1f(i,e):s(e)};return function(e){this.device?t.uniform1fv(i,e):s(e)};case 2:return function(e){this.device?t.uniform2fv(i,e):s(e)};case 3:return function(e){this.device?t.uniform3fv(i,e):s(e)};case 4:return function(e){this.device?t.uniform4fv(i,e):s(e)};default:return null}}function i(e,n){function s(t){if(typeof t!="number"){var i=r.values,s=Math.min(r.numValues,t.length);for(var o=0;o<s;o+=1)i[o]=t[o];n.dirty=Math.max(s,n.dirty||0)}else r.values[0]=t,n.dirty=n.dirty||1;e.dirty=!0}var r=n.info,i=n.location;switch(r.columns){case 1:if(1===r.numValues)return function(e){this.device?t.uniform1i(i,e):s(e)};return function(e){this.device?t.uniform1iv(i,e):s(e)};case 2:return function(e){this.device?t.uniform2iv(i,e):s(e)};case 3:return function(e){this.device?t.uniform3iv(i,e):s(e)};case 4:return function(e){this.device?t.uniform4iv(i,e):s(e)};default:return null}}var t=e.gl,s=this.passes,o=s.length,u,a,f,l,c,h;if(o===1){u=s[0],a=u.parameters;for(f in a)a.hasOwnProperty(f)&&(l=a[f],c=l.info,c&&undefined!==l.location&&(c.sampler?h=n(u,l):c.type==="float"?h=r(u,l):h=i(u,l),Object.defineProperty(this,f,{set:h,enumerable:!1,configurable:!1})));this.checkProperties=null}else Object.defineProperty(this,"device",{writable:!0,enumerable:!1,configurable:!1}),Object.defineProperty(this,"version",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"name",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"id",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"passes",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"numParameters",{writable:!1,enumerable:!1,configurable:!1})},e.prototype.destroy=function(){var e=this.passes;if(e){var t=e.length,n;for(n=0;n<t;n+=1)e[n].destroy();e.length=0,delete this.passes}delete this.device},e.create=function(t,n,r,i){var s=new e;s.initialized=!1,s.shader=n,s.name=r;var o=i.length,u,a=0;s.passes=[],s.numPasses=o;for(u=0;u<o;u+=1){var f=i[u];f.parameters&&(a+=f.parameters.length),s.passes[u]=b.create(t,n,f)}return s.numParameters=a,s.device=null,s.id=++t.counters.techniques,1<o&&t.drawArray!==t.drawArrayMultiPass&&(t.drawArray=t.drawArrayMultiPass),s},e.version=1,e}(),E=function(){function e(){}return e.prototype.getTechnique=function(e){if(typeof e=="string")return this.techniques[e];var t=this.techniques;for(var n in t)if(t.hasOwnProperty(n)){if(e===0)return t[n];e-=1}return null},e.prototype.getParameter=function(e){if(typeof e=="string")return this.parameters[e];e|=0;var t=this.parameters;for(var n in t)if(t.hasOwnProperty(n)){if(e===0)return t[n];e-=1}return null},e.prototype.initialize=function(e){if(this.initialized)return;var t=e.gl,n,r=this.programs;for(n in r)if(r.hasOwnProperty(n)){var i=r[n],s=t.getShaderParameter(i,t.COMPILE_STATUS);if(!s){var o=t.getShaderInfoLog(i);TurbulenzEngine.callOnError('Program "'+n+'" failed to compile: '+o)}}var u=this.linkedPrograms;for(n in u)if(u.hasOwnProperty(n)){var a=u[n],f=a.glProgram;if(f){var l=t.getProgramParameter(f,t.LINK_STATUS);if(!l){var c=t.getProgramInfoLog(f);TurbulenzEngine.callOnError('Program "'+n+'" failed to link: '+c)}}}this.initialized=!0},e.prototype.destroy=function(){var e=this.gd;if(e){var t=e.gl,n,r=this.techniques;if(r){for(n in r)r.hasOwnProperty(n)&&r[n].destroy();delete this.techniques}var i=this.linkedPrograms;if(i){if(t)for(n in i)if(i.hasOwnProperty(n)){var s=i[n],o=s.glProgram;o&&(t.deleteProgram(o),delete s.glProgram)}delete this.linkedPrograms}var u=this.programs;if(u){if(t)for(n in u)u.hasOwnProperty(n)&&t.deleteShader(u[n]);delete this.programs}delete this.samplers,delete this.parameters,delete this.gd}},e.create=function(t,n){var r=t.gl,i=new e;i.initialized=!1;var s=n.techniques,o=n.parameters,u=n.programs,a=n.samplers,f;i.gd=t,i.name=n.name;var l={};i.programs=l;for(f in u)if(u.hasOwnProperty(f)){var c=u[f],h;c.type==="fragment"?h=r.FRAGMENT_SHADER:c.type==="vertex"&&(h=r.VERTEX_SHADER);var p=r.createShader(h);r.shaderSource(p,c.code),r.compileShader(p),l[f]=p}var d={};i.linkedPrograms=d;var v=t.DEFAULT_SAMPLER,m=t.maxAnisotropy;i.samplers={};var g;for(f in a)if(a.hasOwnProperty(f)){g=a[f];var y=g.MaxAnisotropy;y?y>m&&(y=m):y=v.maxAnisotropy,g={minFilter:g.MinFilter||v.minFilter,magFilter:g.MagFilter||v.magFilter,wrapS:g.WrapS||v.wrapS,wrapT:g.WrapT||v.wrapT,wrapR:g.WrapR||v.wrapR,maxAnisotropy:y},g.wrapS===10496&&(g.wrapS=r.CLAMP_TO_EDGE),g.wrapT===10496&&(g.wrapT=r.CLAMP_TO_EDGE),g.wrapR===10496&&(g.wrapR=r.CLAMP_TO_EDGE),i.samplers[f]=t.createSampler(g)}var b=0;i.parameters={};for(f in o)if(o.hasOwnProperty(f)){var E=o[f];E.columns||(E.columns=1),E.rows||(E.rows=1),E.numValues=E.columns*E.rows;var S=E.type;if(S==="float"||S==="int"||S==="bool"){var x=E.values;x?S==="float"?E.values=new Float32Array(x):E.values=new Int32Array(x):S==="float"?E.values=new Float32Array(E.numValues):E.values=new Int32Array(E.numValues),E.sampler=undefined}else g=i.samplers[f],g||(g=v,i.samplers[f]=v),E.sampler=g,E.values=null;E.name=f,i.parameters[f]=E,b+=1}i.numParameters=b;var T={},N=0;i.techniques=T;for(f in s)s.hasOwnProperty(f)&&(T[f]=w.create(t,i,f,s[f]),N+=1);return i.numTechniques=N,i.id=++t.counters.shaders,i},e.version=1,e}(),S=function(){function e(){}return e.create=function(t){var n=new e;if(t)for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n},e}(),x=function(t){return Float32Array.prototype.map===undefined&&(Float32Array.prototype.map=function(t,n){function i(){var e=arguments.length;for(var n=0;n<e;n+=1){var i=arguments[n];typeof i=="number"?(r[t]=i,t+=1):(r.setData(i,t,i.length),t+=i.length)}}t===undefined&&(t=0);var r=this;return n===undefined&&(n=this.length),i},Float32Array.prototype.unmap=function(t){},Float32Array.prototype.setData=function(t,n,r){n===undefined&&(n=0),r===undefined&&(r=this.length);for(var i=0;i<r;i+=1,n+=1)this[n]=t[i]}),new Float32Array(t.numFloats)},T=function(){function e(){return this.endStreams=0,this.endTechniqueParameters=48,this.endInstances=56,this.firstIndex=0,this.count=0,this.sortKey=0,this.technique=null,this.indexBuffer=null,this.primitive=-1,this.userData=null,this[0]=null,this[1]=null,this[2]=0,this[48]=null,this[49]=null,this}return e.prototype.setTechniqueParameters=function(e,t){if(e<8){e+=48,this[e]=t;var n=this.endTechniqueParameters;if(t)n<=e&&(this.endTechniqueParameters=e+1);else{while(48<n&&!this[n-1])n-=1;this.endTechniqueParameters=n}}},e.prototype.setVertexBuffer=function(e,t){if(e<16){e*=3,this[e]=t;var n=this.endStreams;if(t)n<=e&&(this.endStreams=e+3);else{while(0<n&&!this[n-3])n-=3;this.endStreams=n}}},e.prototype.setSemantics=function(e,t){e<16&&(this[e*3+1]=t)},e.prototype.setOffset=function(e,t){e<16&&(this[e*3+2]=t)},e.prototype.getTechniqueParameters=function(e){return e<8?this[e+48]:undefined},e.prototype.getVertexBuffer=function(e){return e<16?this[e*3+0]:undefined},e.prototype.getSemantics=function(e){return e<16?this[e*3+1]:undefined},e.prototype.getOffset=function(e){return e<16?this[e*3+2]:undefined},e.prototype.addInstance=function(e){if(e){var t=this.endInstances;this.endInstances=t+1,this[t]=e}},e.prototype.removeInstances=function(){this.endInstances=56},e.prototype.getNumInstances=function(){return this.endInstances-56},e.create=function(){return new e},e.version=1,e}(),N=function(){function e(){}return e.prototype.drawIndexed=function(e,t,n){var r=this.gl,i=this.activeIndexBuffer,s;n?s=n*i.stride:s=0;var o=i.format,u=this.attributeMask,a=this.activeTechnique,f=a.passes,l=f.length,c;a.checkProperties&&a.checkProperties(this);if(1===l)c=f[0].semanticsMask&u,c!==this.clientStateMask&&this.enableClientState(c),r.drawElements(e,t,o,s);else for(var h=0;h<l;h+=1){var p=f[h];c=p.semanticsMask&u,c!==this.clientStateMask&&this.enableClientState(c),this.setPass(p),r.drawElements(e,t,o,s)}},e.prototype.draw=function(e,t,n){var r=this.gl,i=this.attributeMask,s=this.activeTechnique,o=s.passes,u=o.length,a;s.checkProperties&&s.checkProperties(this);if(1===u)a=o[0].semanticsMask&i,a!==this.clientStateMask&&this.enableClientState(a),r.drawArrays(e,n,t);else for(var f=0;f<u;f+=1){var l=o[f];a=l.semanticsMask&i,a!==this.clientStateMask&&this.enableClientState(a),this.setPass(l),r.drawArrays(e,n,t)}},e.prototype.setTechniqueParameters=function(){var e=this.activeTechnique,t=e.passes,n=arguments.length;if(1===t.length){var r=t[0].parameters;for(var i=0;i<n;i+=1)this.setParametersImmediate(r,arguments[i])}else for(var i=0;i<n;i+=1)this.setParametersDeferred(this,t,arguments[i])},e.prototype.setParametersImmediate=function(e,t){var n=this.gl;for(var r in t){var i=e[r];if(i!==undefined){var s=t[r];if(s!==undefined){var o=i.info,u,a;o.type==="float"?(u=o.columns,a=i.location,4===u?n.uniform4fv(a,s):3===u?n.uniform3fv(a,s):2===u?n.uniform2fv(a,s):1===o.rows?n.uniform1f(a,s):n.uniform1fv(a,s)):o.sampler!==undefined?this.setTexture(i.textureUnit,s,o.sampler):(u=o.columns,a=i.location,4===u?n.uniform4iv(a,s):3===u?n.uniform3iv(a,s):2===u?n.uniform2iv(a,s):1===o.rows?n.uniform1i(a,s):n.uniform1iv(a,s))}else delete t[r]}}},e.prototype.setParametersCaching=function(e,t){var n=this.gl;for(var r in t){var i=e[r];if(i!==undefined){var s=t[r];if(i.value!==s)if(s!==undefined){i.value=s;var o=i.info,u,a;o.type==="float"?(u=o.columns,a=i.location,4===u?n.uniform4fv(a,s):3===u?n.uniform3fv(a,s):2===u?n.uniform2fv(a,s):1===o.rows?n.uniform1f(a,s):n.uniform1fv(a,s)):o.sampler!==undefined?this.setTexture(i.textureUnit,s,o.sampler):(u=o.columns,a=i.location,4===u?n.uniform4iv(a,s):3===u?n.uniform3iv(a,s):2===u?n.uniform2iv(a,s):1===o.rows?n.uniform1i(a,s):n.uniform1iv(a,s))}else delete t[r]}}},e.prototype.setParametersCachingMultiPass=function(e,t,n){e.setParametersCaching(t[0].parameters,n)},e.prototype.setParametersDeferred=function(e,t,n){var r=t.length,i=Math.min,s=Math.max;for(var o=0;o<r;o+=1){var u=t[o],a=u.parameters;u.dirty=!0;for(var f in n){var l=a[f];if(l){var c=n[f];if(c!==undefined){var h=l.info;if(h.sampler)h.values=c,l.dirty=1;else if(typeof c!="number"){var p=h.values,d=i(h.numValues,c.length);for(var v=0;v<d;v+=1)p[v]=c[v];l.dirty=s(d,l.dirty||0)}else h.values[0]=c,l.dirty=l.dirty||1}else delete n[f]}}}},e.prototype.setTechnique=function(e){var t=this.activeTechnique;if(t!==e){t&&t.deactivate(),this.activeTechnique=e,e.activate(this);var n=e.passes;1===n.length&&this.setPass(n[0])}},e.prototype.setTechniqueCaching=function(e){var t=e.passes[0],n=this.activeTechnique;n!==e&&(n&&n.deactivate(),this.activeTechnique=e,e.activate(this),this.setPass(t));var r=t.parameters;for(var i in r)r.hasOwnProperty(i)&&(r[i].value=null)},e.prototype.setStream=function(e,t,n){n?n*=e.strideInBytes:n=0,this.bindVertexBuffer(e.glBuffer);var r=t,i=r.length;i>e.numAttributes&&(i=e.numAttributes),this.attributeMask|=e.bindAttributes(i,r,n)},e.prototype.setIndexBuffer=function(e){if(this.activeIndexBuffer!==e){this.activeIndexBuffer=e;var t;e?t=e.glBuffer:t=null;var n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t)}},e.prototype.drawArray=function(e,t,n){var r=this.gl,i=r.ELEMENT_ARRAY_BUFFER,s=t.length,o=e.length;o>1&&n&&(n>0?e.sort(this._drawArraySortPositive):e.sort(this._drawArraySortNegative));var u=this.activeIndexBuffer,a=this.attributeMask,f=null,l=-1,c=null,h=null,p=0,d=!1,v=null,m=null,g=null,y=null,b=0,w=0,E=0,S=0;u&&(b=u.format,w=u.stride);for(var x=0;x<o;x+=1){var T=e[x],N=T.technique,C=T.endTechniqueParameters,k=T.endStreams,L=T.endInstances,A=T.indexBuffer,O=T.primitive,M=T.count,_=T.firstIndex;if(f!==N){f=N,this.setTechniqueCaching(N),m=N.passes[0],g=m.parameters,E=m.semanticsMask&a,E!==this.clientStateMask&&this.enableClientState(E),N.checkProperties&&N.checkProperties(this);for(S=0;S<s;S+=1)this.setParametersCaching(g,t[S])}for(S=48;S<C;S+=1)h=T[S],h&&this.setParametersCaching(g,h);d=l===k;for(p=0;d&&p<k;p+=3)d=c[p]===T[p]&&c[p+1]===T[p+1]&&c[p+2]===T[p+2];if(!d){l=k;for(p=0;p<k;p+=3)v=T[p],v&&this.setStream(v,T[p+1],T[p+2]);a=this.attributeMask,E=m.semanticsMask&a,E!==this.clientStateMask&&this.enableClientState(E)}c=T;if(A){u!==A&&(u=A,r.bindBuffer(i,A.glBuffer),b=A.format,w=A.stride),_*=
w,S=56;if(S<L){do this.setParametersCaching(g,T[S]),r.drawElements(O,M,b,_),S+=1;while(S<L)}else r.drawElements(O,M,b,_)}else{S=56;if(S<L){do this.setParametersCaching(g,T[S]),r.drawArrays(O,_,M),S+=1;while(S<L)}else r.drawArrays(O,_,M)}}this.activeIndexBuffer=u},e.prototype.drawArrayMultiPass=function(e,t,n){var r=this.gl,i=r.ELEMENT_ARRAY_BUFFER,s=this.setParametersCachingMultiPass,o=this.setParametersDeferred,u=t.length,a=e.length;a>1&&n&&(n>0?e.sort(this._drawArraySortPositive):e.sort(this._drawArraySortNegative));var f=this.activeIndexBuffer,l=this.attributeMask,c=null,h=null,p=-1,d=null,v=null,m=0,g=!1,y=null,b=null,w=null,E=null,S=0,x=0,T=0,N=0,C=0;f&&(S=f.format,x=f.stride);for(var k=0;k<a;k+=1){var L=e[k],A=L.technique,O=L.endTechniqueParameters,M=L.endStreams,_=L.endInstances,D=L.indexBuffer,P=L.primitive,H=L.count,B=L.firstIndex;if(h!==A){h=A,b=A.passes,T=b.length,1===T?(this.setTechniqueCaching(A),c=s,N=b[0].semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N)):(this.setTechnique(A),c=o),A.checkProperties&&A.checkProperties(this);for(C=0;C<u;C+=1)c(this,b,t[C])}for(C=48;C<O;C+=1)v=L[C],v&&c(this,b,v);g=p===M;for(m=0;g&&m<M;m+=3)g=d[m]===L[m]&&d[m+1]===L[m+1]&&d[m+2]===L[m+2];if(!g){p=M;for(m=0;m<M;m+=3)y=L[m],y&&this.setStream(y,L[m+1],L[m+2]);l=this.attributeMask,1===T&&(N=b[0].semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N))}d=L;if(D){f!==D&&(f=D,r.bindBuffer(i,D.glBuffer),S=D.format,x=D.stride),B*=x;if(1===T){C=56;if(C<_){do c(this,b,L[C]),r.drawElements(P,H,S,B),C+=1;while(C<_)}else r.drawElements(P,H,S,B)}else{C=56;if(C<_){do{c(this,b,L[C]);for(w=0;w<T;w+=1)E=b[w],N=E.semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N),this.setPass(E),r.drawElements(P,H,S,B);C+=1}while(C<_)}else for(w=0;w<T;w+=1)E=b[w],N=E.semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N),this.setPass(E),r.drawElements(P,H,S,B)}}else if(1===T){C=56;if(C<_){do c(this,b,L[C]),r.drawArrays(P,B,H),C+=1;while(C<_)}else r.drawArrays(P,B,H)}else{C=56;if(C<_){do{c(this,b,L[C]);for(w=0;w<T;w+=1)E=b[w],N=E.semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N),this.setPass(E),r.drawArrays(P,B,H);C+=1}while(C<_)}else for(w=0;w<T;w+=1)E=b[w],N=E.semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N),this.setPass(E),r.drawArrays(P,B,H)}}this.activeIndexBuffer=f},e.prototype.beginDraw=function(e,t,n,r){this.immediatePrimitive=e;if(t){var i,s=this.immediateSemantics,o=r,u=o.length;s.length=u;for(i=0;i<u;i+=1){var a=o[i];typeof a=="string"&&(a=this["SEMANTIC_"+a]),s[i]=a}var f=this.immediateVertexBuffer,l=f.strideInBytes,c=l*f.numVertices,h=f.setAttributes(n);h!==l&&(f.numVertices=Math.floor(c/h));var p=h*t;return p>c&&f.resize(p),f.map(0,t)}return null},e.prototype.endDraw=function(e){var t=this.immediateVertexBuffer,n=e.getNumWrittenVertices();t.unmap(e);if(n){var r=this.gl,i=t.strideInBytes,s=0,o=t.attributes,u=this.immediateSemantics,a=u.length,f=0;for(var l=0;l<a;l+=1){var c=o[l],h=u[l];f|=1<<h,r.vertexAttribPointer(h,c.numComponents,c.format,c.normalized,i,s),s+=c.stride}this.attributeMask|=f,this.draw(this.immediatePrimitive,n,0)}},e.prototype.setViewport=function(e,t,n,r){var i=this.state.viewportBox;if(i[0]!==e||i[1]!==t||i[2]!==n||i[3]!==r)i[0]=e,i[1]=t,i[2]=n,i[3]=r,this.gl.viewport(e,t,n,r)},e.prototype.setScissor=function(e,t,n,r){var i=this.state.scissorBox;if(i[0]!==e||i[1]!==t||i[2]!==n||i[3]!==r)i[0]=e,i[1]=t,i[2]=n,i[3]=r,this.gl.scissor(e,t,n,r)},e.prototype.clear=function(e,t,n){var r=this.gl,i=this.state,s=0;if(e){s+=r.COLOR_BUFFER_BIT;var o=i.clearColor,u=e[0],a=e[1],f=e[2],l=e[3];if(o[0]!==u||o[1]!==a||o[2]!==f||o[3]!==l)o[0]=u,o[1]=a,o[2]=f,o[3]=l,r.clearColor(u,a,f,l)}typeof t=="number"&&(s+=r.DEPTH_BUFFER_BIT,i.clearDepth!==t&&(i.clearDepth=t,r.clearDepth(t)),typeof n=="number"&&(s+=r.STENCIL_BUFFER_BIT,i.clearStencil!==n&&(i.clearStencil=n,r.clearStencil(n))));if(s){var c=i.colorMask,h=c[0]||c[1]||c[2]||c[3],p=i.depthMask,d=i.program;e&&(h||r.colorMask(!0,!0,!0,!0)),typeof t=="number"&&(p||r.depthMask(!0)),d&&r.useProgram(null),r.clear(s),e&&(h||r.colorMask(!1,!1,!1,!1)),typeof t=="number"&&(p||r.depthMask(!1)),d&&r.useProgram(d)}},e.prototype.beginFrame=function(){var e=this.gl;this.attributeMask=0;var t=this.clientStateMask,n;if(t){for(n=0;n<16;n+=1)t&1<<n&&e.disableVertexAttribArray(n);this.clientStateMask=0}return this.resetStates(),this.setScissor(0,0,this.width,this.height),this.setViewport(0,0,this.width,this.height),!document.hidden&&!document.webkitHidden},e.prototype.beginRenderTarget=function(e){return this.activeRenderTarget=e,e.bind()},e.prototype.endRenderTarget=function(){this.activeRenderTarget.unbind(),this.activeRenderTarget=null},e.prototype.beginOcclusionQuery=function(){return!1},e.prototype.endOcclusionQuery=function(){},e.prototype.endFrame=function(){var e=this.gl;this.activeTechnique&&(this.activeTechnique.deactivate(),this.activeTechnique=null),this.activeIndexBuffer&&this.setIndexBuffer(null);var t=this.state;t.program&&(t.program=null,e.useProgram(null)),this.numFrames+=1;var n=TurbulenzEngine.getTime(),r=n-this.previousFrameTime;r>=1e3&&(this.fps=this.numFrames/(r*.001),this.numFrames=0,this.previousFrameTime=n);var i=e.canvas,s=e.drawingBufferWidth||i.width,o=e.drawingBufferHeight||i.height;if(this.width!==s||this.height!==o)this.width=s,this.height=o,this.setViewport(0,0,s,o),this.setScissor(0,0,s,o);this.checkFullScreen()},e.prototype.createTechniqueParameters=function(e){return S.create(e)},e.prototype.createSemantics=function(e){return g.create(this,e)},e.prototype.createVertexBuffer=function(e){return y.create(this,e)},e.prototype.createIndexBuffer=function(e){return m.create(this,e)},e.prototype.createTexture=function(e){return h.create(this,e)},e.prototype.createVideo=function(e){return p.create(e)},e.prototype.createShader=function(e){return E.create(this,e)},e.prototype.createTechniqueParameterBuffer=function(e){return x(e)},e.prototype.createRenderBuffer=function(e){return d.create(this,e)},e.prototype.createRenderTarget=function(e){return v.create(this,e)},e.prototype.createOcclusionQuery=function(){return null},e.prototype.createDrawParameters=function(){return T.create()},e.prototype.isSupported=function(e){var t=this.gl;if("OCCLUSION_QUERIES"===e)return!1;if("NPOT_MIPMAPPED_TEXTURES"===e)return!1;if("TEXTURE_DXT1"===e||"TEXTURE_DXT3"===e||"TEXTURE_DXT5"===e){var n=this.compressedTexturesExtension;if(n){var r=t.getParameter(t.COMPRESSED_TEXTURE_FORMATS);if(r){var i;"TEXTURE_DXT1"===e?i=n.COMPRESSED_RGBA_S3TC_DXT1_EXT:"TEXTURE_DXT3"===e?i=n.COMPRESSED_RGBA_S3TC_DXT3_EXT:i=n.COMPRESSED_RGBA_S3TC_DXT5_EXT;var s=r.length;for(var o=0;o<s;o+=1)if(r[o]===i)return!0}}return!1}return"TEXTURE_ETC1"===e?!1:"INDEXFORMAT_UINT"===e?t.getExtension("OES_element_index_uint")?!0:!1:"FILEFORMAT_WEBM"===e?"webm"in this.supportedVideoExtensions:"FILEFORMAT_MP4"===e?"mp4"in this.supportedVideoExtensions:"FILEFORMAT_JPG"===e?!0:"FILEFORMAT_PNG"===e?!0:"FILEFORMAT_DDS"===e?typeof c!="undefined":"FILEFORMAT_TGA"===e?typeof vt!="undefined":undefined},e.prototype.maxSupported=function(e){var t=this.gl;if("ANISOTROPY"===e)return this.maxAnisotropy;if("TEXTURE_SIZE"===e)return t.getParameter(t.MAX_TEXTURE_SIZE);if("CUBEMAP_TEXTURE_SIZE"===e)return t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE);if("3D_TEXTURE_SIZE"===e)return 0;if("RENDERTARGET_COLOR_TEXTURES"===e)return this.drawBuffersExtension?this.WEBGL_draw_buffers?t.getParameter(this.drawBuffersExtension.MAX_COLOR_ATTACHMENTS_WEBGL):t.getParameter(this.drawBuffersExtension.MAX_COLOR_ATTACHMENTS_EXT):1;if("RENDERBUFFER_SIZE"===e)return t.getParameter(t.MAX_RENDERBUFFER_SIZE);if("TEXTURE_UNITS"===e)return t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);if("VERTEX_TEXTURE_UNITS"===e)return t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS);if("VERTEX_SHADER_PRECISION"===e||"FRAGMENT_SHADER_PRECISION"===e){var n;"VERTEX_SHADER_PRECISION"===e?n=t.VERTEX_SHADER:n=t.FRAGMENT_SHADER;if(!t.getShaderPrecisionFormat)return 0;var r=t.getShaderPrecisionFormat(n,t.HIGH_FLOAT);if(!r||!r.precision){r=t.getShaderPrecisionFormat(n,t.MEDIUM_FLOAT);if(!r||!r.precision){r=t.getShaderPrecisionFormat(n,t.LOW_FLOAT);if(!r||!r.precision)return 0}}return r.precision}return 0},e.prototype.loadTexturesArchive=function(e){var t=e.src;return typeof dt!="undefined"?(dt.create({gd:this,src:t,mipmaps:e.mipmaps,ontextureload:function(n){e.ontextureload(n)},onload:function(n,r){e.onload&&e.onload(n,r)},onerror:function(n){e.onload&&e.onload(!1,n)}}),!0):(TurbulenzEngine.callOnError("Missing archive loader required for "+t),!1)},e.prototype.getScreenshot=function(e,t,n,r,i){var s=this.gl,o=s.canvas;if(e)return o.toDataURL("image/jpeg");t===undefined&&(t=0),n===undefined&&(n=0);var u=this.activeRenderTarget;u||(u=o),r===undefined&&(r=u.width),i===undefined&&(i=u.height);var a=new Uint8Array(4*r*i);return s.readPixels(t,n,r,i,s.RGBA,s.UNSIGNED_BYTE,a),a},e.prototype.flush=function(){this.gl.flush()},e.prototype.finish=function(){this.gl.finish()},e.prototype._drawArraySortPositive=function(e,t){return t.sortKey-e.sortKey},e.prototype._drawArraySortNegative=function(e,t){return e.sortKey-t.sortKey},e.prototype.checkFullScreen=function(){var e=this.fullscreen;this.oldFullscreen!==e&&(this.oldFullscreen=e,this.requestFullScreen(e))},e.prototype.requestFullScreen=function(e){if(e){var t=this.gl.canvas;t.webkitRequestFullScreenWithKeys?t.webkitRequestFullScreenWithKeys():t.requestFullScreenWithKeys?t.requestFullScreenWithKeys():t.webkitRequestFullScreen?t.webkitRequestFullScreen(t.ALLOW_KEYBOARD_INPUT):t.mozRequestFullScreen?t.mozRequestFullScreen():t.requestFullScreen?t.requestFullScreen():t.requestFullscreen&&t.requestFullscreen()}else document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.cancelFullScreen?document.cancelFullScreen():document.exitFullscreen&&document.exitFullscreen();return!0},e.prototype.createSampler=function(e){var t=e.minFilter.toString()+":"+e.magFilter.toString()+":"+e.wrapS.toString()+":"+e.wrapT.toString()+":"+e.wrapR.toString()+":"+e.maxAnisotropy.toString(),n=this.cachedSamplers,r=n[t];return r?r:(n[t]=e,e)},e.prototype.unsetIndexBuffer=function(e){if(this.activeIndexBuffer===e){this.activeIndexBuffer=null;var t=this.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}},e.prototype.bindVertexBuffer=function(e){if(this.bindedVertexBuffer!==e){this.bindedVertexBuffer=e;var t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,e)}},e.prototype.unbindVertexBuffer=function(e){if(this.bindedVertexBuffer===e){this.bindedVertexBuffer=null;var t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,null)}},e.prototype.bindTextureUnit=function(e,t,n){var r=this.state,i=this.gl;r.activeTextureUnit!==e&&(r.activeTextureUnit=e,i.activeTexture(i.TEXTURE0+e)),i.bindTexture(t,n)},e.prototype.bindTexture=function(e,t){var n=this.state,r=this.gl,i=n.maxTextureUnit-1;n.activeTextureUnit!==i&&(n.activeTextureUnit=i,r.activeTexture(r.TEXTURE0+i)),r.bindTexture(e,t)},e.prototype.unbindTexture=function(e){var t=this.state,n=t.lastMaxTextureUnit,r=t.textureUnits;for(var i=0;i<n;i+=1){var s=r[i];s.texture===e&&(s.texture=null,this.bindTextureUnit(i,s.target,null))}},e.prototype.setSampler=function(e,t){if(e){var n=this.gl;n.texParameteri(t,n.TEXTURE_MIN_FILTER,e.minFilter),n.texParameteri(t,n.TEXTURE_MAG_FILTER,e.magFilter),n.texParameteri(t,n.TEXTURE_WRAP_S,e.wrapS),n.texParameteri(t,n.TEXTURE_WRAP_T,e.wrapT),this.TEXTURE_MAX_ANISOTROPY_EXT&&n.texParameteri(t,this.TEXTURE_MAX_ANISOTROPY_EXT,e.maxAnisotropy)}},e.prototype.setPass=function(e){var t=this.gl,n=this.state,r=e.statesSet,i=e.states,s=i.length,o,u;for(o=0;o<s;o+=1)u=i[o],u.set.apply(u,u.values);var a=n.renderStatesToReset,f=a.length;for(o=0;o<f;o+=1)u=a[o],u.name in r||u.reset();n.renderStatesToReset=i;var l=n.lastMaxTextureUnit,c=n.textureUnits,h=e.numTextureUnits;if(h<l){var p=h;do{var d=c[p];d.texture&&(d.texture=null,this.bindTextureUnit(p,d.target,null)),p+=1}while(p<l)}n.lastMaxTextureUnit=h;var v=e.glProgram;n.program!==v&&(n.program=v,t.useProgram(v)),e.dirty&&e.updateParametersData(this)},e.prototype.enableClientState=function(e){var t=this.gl,n=this.clientStateMask;this.clientStateMask=e;var r=n&~e,i=~n&e,s;if(r){(r&255)===0?(r>>=8,s=8):s=0;do 0!==(1&r)&&t.disableVertexAttribArray(s),s+=1,r>>=1;while(r)}if(i){(i&255)===0?(i>>=8,s=8):s=0;do 0!==(1&i)&&t.enableVertexAttribArray(s),s+=1,i>>=1;while(i)}},e.prototype.setTexture=function(e,t,n){var r=this.state,i=this.gl,s=r.textureUnits[e],o=s.target,u=s.texture;if(t){var a=t.target,f=t.glTexture;if(u!==f||o!==a)s.target=a,s.texture=f,r.activeTextureUnit!==e&&(r.activeTextureUnit=e,i.activeTexture(i.TEXTURE0+e)),o!==a&&u&&i.bindTexture(o,null),i.bindTexture(a,f),t.sampler!==n&&(t.sampler=n,this.setSampler(n,a))}else o&&u&&(s.target=0,s.texture=null,r.activeTextureUnit!==e&&(r.activeTextureUnit=e,i.activeTexture(i.TEXTURE0+e)),i.bindTexture(o,null))},e.prototype.setProgram=function(e){var t=this.state;t.program!==e&&(t.program=e,this.gl.useProgram(e))},e.prototype.syncState=function(){var e=this.state,t=this.gl;e.depthTestEnable?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),t.depthFunc(e.depthFunc),t.depthMask(e.depthMask),e.blendEnable?t.enable(t.BLEND):t.disable(t.BLEND),t.blendFunc(e.blendSrc,e.blendDst),e.cullFaceEnable?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),t.cullFace(e.cullFace),t.frontFace(e.frontFace);var n=e.colorMask;t.colorMask(n[0],n[1],n[2],n[3]),e.stencilTestEnable?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),t.stencilFunc(e.stencilFunc,e.stencilRef,e.stencilMask),t.stencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass),e.polygonOffsetFillEnable?t.enable(t.POLYGON_OFFSET_FILL):t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(e.polygonOffsetFactor,e.polygonOffsetUnits),t.lineWidth(e.lineWidth),t.activeTexture(t.TEXTURE0+e.activeTextureUnit);var r=this.state.viewportBox;t.viewport(r[0],r[1],r[2],r[3]),r=this.state.scissorBox,t.scissor(r[0],r[1],r[2],r[3]);var i=e.clearColor;t.clearColor(i[0],i[1],i[2],i[3]),t.clearDepth(e.clearDepth),t.clearStencil(e.clearStencil)},e.prototype.resetStates=function(){var e=this.state,t=e.lastMaxTextureUnit,n=e.textureUnits;for(var r=0;r<t;r+=1){var i=n[r];i.texture&&(this.bindTextureUnit(r,i.target,null),i.texture=null,i.target=0)}},e.prototype.destroy=function(){delete this.activeTechnique,delete this.activeIndexBuffer,delete this.bindedVertexBuffer,this.immediateVertexBuffer&&(this.immediateVertexBuffer.destroy(),delete this.immediateVertexBuffer),delete this.gl,typeof c!="undefined"&&c.destroy()},e.create=function(t,n){function N(e){T.depthTestEnable!==e&&(T.depthTestEnable=e,e?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST))}function C(e){T.depthFunc!==e&&(T.depthFunc=e,i.depthFunc(e))}function k(e){T.depthMask!==e&&(T.depthMask=e,i.depthMask(e))}function L(e){T.blendEnable!==e&&(T.blendEnable=e,e?i.enable(i.BLEND):i.disable(i.BLEND))}function A(e,t){if(T.blendSrc!==e||T.blendDst!==t)T.blendSrc=e,T.blendDst=t,i.blendFunc(e,t)}function O(e){T.cullFaceEnable!==e&&(T.cullFaceEnable=e,e?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE))}function M(e){T.cullFace!==e&&(T.cullFace=e,i.cullFace(e))}function _(e){T.frontFace!==e&&(T.frontFace=e,i.frontFace(e))}function D(e,t,n,r){var s=T.colorMask;if(s[0]!==e||s[1]!==t||s[2]!==n||s[3]!==r)s[0]=e,s[1]=t,s[2]=n,s[3]=r,i.colorMask(e,t,n,r)}function P(e){T.stencilTestEnable!==e&&(T.stencilTestEnable=e,e?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST))}function H(e,t,n){if(T.stencilFunc!==e||T.stencilRef!==t||T.stencilMask!==n)T.stencilFunc=e,T.stencilRef=t,T.stencilMask=n,i.stencilFunc(e,t,n)}function B(e,t,n){if(T.stencilFail!==e||T.stencilZFail!==t||T.stencilZPass!==n)T.stencilFail=e,T.stencilZFail=t,T.stencilZPass=n,i.stencilOp(e,t,n)}function j(e){T.polygonOffsetFillEnable!==e&&(T.polygonOffsetFillEnable=e,e?i.enable(i.POLYGON_OFFSET_FILL):i.disable(i.POLYGON_OFFSET_FILL))}function F(e,t){if(T.polygonOffsetFactor!==e||T.polygonOffsetUnits!==t)T.polygonOffsetFactor=e,T.polygonOffsetUnits=t,i.polygonOffset(e,t)}function I(e){T.lineWidth!==e&&(T.lineWidth=e,i.lineWidth(e))}function q(){T.depthTestEnable||(T.depthTestEnable=!0,i.enable(i.DEPTH_TEST))}function R(){var e=m;T.depthFunc!==e&&(T.depthFunc=e,i.depthFunc(e))}function U(){T.depthMask||(T.depthMask=!0,i.depthMask(!0))}function z(){T.blendEnable&&(T.blendEnable=!1,i.disable(i.BLEND))}function W(){var e=y,t=b;if(T.blendSrc!==e||T.blendDst!==t)T.blendSrc=e,T.blendDst=t,i.blendFunc(e,t)}function X(){T.cullFaceEnable||(T.cullFaceEnable=!0,i.enable(i.CULL_FACE))}function V(){var e=w;T.cullFace!==e&&(T.cullFace=e,i.cullFace(e))}function $(){var e=E;T.frontFace!==e&&(T.frontFace=e,i.frontFace(e))}function J(){var e=T.colorMask;if(e[0]!==!0||e[1]!==!0||e[2]!==!0||e[3]!==!0)e[0]=!0,e[1]=!0,e[2]=!0,e[3]=!0,i.colorMask(!0,!0,!0,!0)}function K(){T.stencilTestEnable&&(T.stencilTestEnable=!1,i.disable(i.STENCIL_TEST))}function Q(){var e=S;if(T.stencilFunc!==e||T.stencilRef!==0||T.stencilMask!==4294967295)T.stencilFunc=e,T.stencilRef=0,T.stencilMask=4294967295,i.stencilFunc(e,0,4294967295)}function G(){var e=x;if(T.stencilFail!==e||T.stencilZFail!==e||T.stencilZPass!==e)T.stencilFail=e,T.stencilZFail=e,T.stencilZPass=e,i.stencilOp(e,e,e)}function Y(){T.polygonOffsetFillEnable&&(T.polygonOffsetFillEnable=!1,i.disable(i.POLYGON_OFFSET_FILL))}function Z(){if(T.polygonOffsetFactor!==0||T.polygonOffsetUnits!==0)T.polygonOffsetFactor=0,T.polygonOffsetUnits=0,i.polygonOffset(0,0)}function et(){T.lineWidth!==1&&(T.lineWidth=1,i.lineWidth(1))}function tt(e){return typeof e!="boolean"?[e?!0:!1]:[e]}function nt(e){return typeof e!="number"?null:[e]}function rt(e){if(typeof e=="object"){var t=e[0],n=e[1];return typeof t!="number"?null:typeof n!="number"?null:[t,n]}return null}function it(e){if(typeof e=="object"){var t=e[0],n=e[1],r=e[2];return typeof t!="number"?null:typeof n!="number"?null:typeof r!="number"?null:[t,n,r]}return null}function st(e){return typeof e!="number"?null:[e]}function ot(e){if(typeof e=="object"){var t=e[0],n=e[1];return typeof t!="number"?null:typeof n!="number"?null:[t,n]}return null}function ut(e){if(typeof e=="object"){var t=e[0],n=e[1],r=e[2],i=e[3];return typeof t!="number"?null:typeof n!="number"?null:typeof r!="number"?null:typeof i!="number"?null:[t,n,r,i]}return null}var r=function(t,n,r){if(t.getContext){var i={alpha:!1,stencil:!0,antialias:!1},s=n.multisample;s!==undefined&&1<s&&(i.antialias=!0);var o=n.alpha;o&&(i.alpha=!0);var u=r.length,a;for(a=0;a<u;a+=1)try{var f=t.getContext(r[a],i);if(f)return f}catch(l){}}return null},i=r(t,n,["webgl","experimental-webgl"]);if(!i)return null;var s=i.drawingBufferWidth||t.width,o=i.drawingBufferHeight||t.height;i.enable(i.SCISSOR_TEST),i.depthRange(0,1),i.pixelStorei(i.UNPACK_ALIGNMENT,1);var u=new e;u.gl=i,u.width=s,u.height=o;var a=i.getSupportedExtensions();a?a=a.join(" "):a="",u.extensions=a,u.shadingLanguageVersion=i.getParameter(i.SHADING_LANGUAGE_VERSION),u.rendererVersion=i.getParameter(i.VERSION),u.renderer=i.getParameter(i.RENDERER),u.vendor=i.getParameter(i.VENDOR),a.indexOf("WEBGL_compressed_texture_s3tc")!==-1?(u.WEBGL_compressed_texture_s3tc=!0,a.indexOf("WEBKIT_WEBGL_compressed_texture_s3tc")!==-1?u.compressedTexturesExtension=i.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"):a.indexOf("MOZ_WEBGL_compressed_texture_s3tc")!==-1?u.compressedTexturesExtension=i.getExtension("MOZ_WEBGL_compressed_texture_s3tc"):u.compressedTexturesExtension=i.getExtension("WEBGL_compressed_texture_s3tc")):a.indexOf("WEBKIT_WEBGL_compressed_textures")!==-1&&(u.compressedTexturesExtension=i.getExtension("WEBKIT_WEBGL_compressed_textures"));var f;a.indexOf("EXT_texture_filter_anisotropic")!==-1&&(a.indexOf("MOZ_EXT_texture_filter_anisotropic")!==-1?f=i.getExtension("MOZ_EXT_texture_filter_anisotropic"):a.indexOf("WEBKIT_EXT_texture_filter_anisotropic")!==-1?f=i.getExtension("WEBKIT_EXT_texture_filter_anisotropic"):f=i.getExtension("EXT_texture_filter_anisotropic")),f?(u.TEXTURE_MAX_ANISOTROPY_EXT=f.TEXTURE_MAX_ANISOTROPY_EXT,u.maxAnisotropy=i.getParameter(f.MAX_TEXTURE_MAX_ANISOTROPY_EXT)):u.maxAnisotropy=1,i.getExtension("OES_element_index_uint"),a.indexOf("WEBGL_draw_buffers")!==-1?(u.WEBGL_draw_buffers=!0,u.drawBuffersExtension=i.getExtension("WEBGL_draw_buffers")):a.indexOf("EXT_draw_buffers")!==-1&&(u.drawBuffersExtension=i.getExtension("EXT_draw_buffers")),u.PRIMITIVE_POINTS=i.POINTS,u.PRIMITIVE_LINES=i.LINES,u.PRIMITIVE_LINE_LOOP=i.LINE_LOOP,u.PRIMITIVE_LINE_STRIP=i.LINE_STRIP,u.PRIMITIVE_TRIANGLES=i.TRIANGLES,u.PRIMITIVE_TRIANGLE_STRIP=i.TRIANGLE_STRIP,u.PRIMITIVE_TRIANGLE_FAN=i.TRIANGLE_FAN,u.INDEXFORMAT_UBYTE=i.UNSIGNED_BYTE,u.INDEXFORMAT_USHORT=i.UNSIGNED_SHORT,u.INDEXFORMAT_UINT=i.UNSIGNED_INT;var l=function(t){return t===i.BYTE?127:t===i.UNSIGNED_BYTE?255:t===i.SHORT?32767:t===i.UNSIGNED_SHORT?65535:t===i.INT?2147483647:t===i.UNSIGNED_INT?4294967295:1},c=function(t,n,r,s,o){var u={numComponents:n,stride:r,componentStride:r/n,format:s,name:o,normalized:undefined,normalizationScale:undefined,typedSetter:undefined,typedArray:undefined};return t?(u.normalized=!0,u.normalizationScale=l(s)):(u.normalized=!1,u.normalizationScale=1),typeof DataView!="undefined"&&"setFloat32"in DataView.prototype?s===i.BYTE?u.typedSetter=DataView.prototype.setInt8:s===i.UNSIGNED_BYTE?u.typedSetter=DataView.prototype.setUint8:s===i.SHORT?u.typedSetter=DataView.prototype.setInt16:s===i.UNSIGNED_SHORT?u.typedSetter=DataView.prototype.setUint16:s===i.INT?u.typedSetter=DataView.prototype.setInt32:s===i.UNSIGNED_INT?u.typedSetter=DataView.prototype.setUint32:u.typedSetter=DataView.prototype.setFloat32:s===i.BYTE?u.typedArray=Int8Array:s===i.UNSIGNED_BYTE?u.typedArray=Uint8Array:s===i.SHORT?u.typedArray=Int16Array:s===i.UNSIGNED_SHORT?u.typedArray=Uint16Array:s===i.INT?u.typedArray=Int32Array:s===i.UNSIGNED_INT?u.typedArray=Uint32Array:u.typedArray=Float32Array,u};u.VERTEXFORMAT_BYTE4=c(0,4,4,i.BYTE,"BYTE4"),u.VERTEXFORMAT_BYTE4N=c(1,4,4,i.BYTE,"BYTE4N"),u.VERTEXFORMAT_UBYTE4=c(0,4,4,i.UNSIGNED_BYTE,"UBYTE4"),u.VERTEXFORMAT_UBYTE4N=c(1,4,4,i.UNSIGNED_BYTE,"UBYTE4N"),u.VERTEXFORMAT_SHORT2=c(0,2,4,i.SHORT,"SHORT2"),u.VERTEXFORMAT_SHORT2N=c(1,2,4,i.SHORT,"SHORT2N"),u.VERTEXFORMAT_SHORT4=c(0,4,8,i.SHORT,"SHORT4"),u.VERTEXFORMAT_SHORT4N=c(1,4,8,i.SHORT,"SHORT4N"),u.VERTEXFORMAT_USHORT2=c(0,2,4,i.UNSIGNED_SHORT,"USHORT2"),u.VERTEXFORMAT_USHORT2N=c(1,2,4,i.UNSIGNED_SHORT,"USHORT2N"),u.VERTEXFORMAT_USHORT4=c(0,4,8,i.UNSIGNED_SHORT,"USHORT4"),u.VERTEXFORMAT_USHORT4N=c(1,4,8,i.UNSIGNED_SHORT,"USHORT4N"),u.VERTEXFORMAT_FLOAT1=c(0,1,4,i.FLOAT,"FLOAT1"),u.VERTEXFORMAT_FLOAT2=c(0,2,8,i.FLOAT,"FLOAT2"),u.VERTEXFORMAT_FLOAT3=c(0,3,12,i.FLOAT,"FLOAT3"),u.VERTEXFORMAT_FLOAT4=c(0,4,16,i.FLOAT,"FLOAT4"),u.DEFAULT_SAMPLER={minFilter:i.LINEAR_MIPMAP_LINEAR,magFilter:i.LINEAR,wrapS:i.REPEAT,wrapT:i.REPEAT,wrapR:i.REPEAT,maxAnisotropy:1},u.cachedSamplers={};var h=1,p=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS);h<p&&(h=p),p=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),h<p&&(h=p);var d=[];d.length=h;for(var v=0;v<h;v+=1)d[v]={texture:null,target:0};var m=i.LEQUAL,y=i.SRC_ALPHA,b=i.ONE_MINUS_SRC_ALPHA,w=i.BACK,E=i.CCW,S=i.ALWAYS,x=i.KEEP,T={depthTestEnable:!0,blendEnable:!1,cullFaceEnable:!0,stencilTestEnable:!1,polygonOffsetFillEnable:!1,depthMask:!0,depthFunc:m,blendSrc:y,blendDst:b,cullFace:w,frontFace:E,colorMask:[!0,!0,!0,!0],stencilFunc:S,stencilRef:0,stencilMask:4294967295,stencilFail:x,stencilZFail:x,stencilZPass:x,polygonOffsetFactor:0,polygonOffsetUnits:0,lineWidth:1,renderStatesToReset:[],viewportBox:[0,0,s,o],scissorBox:[0,0,s,o],clearColor:[0,0,0,1],clearDepth:1,clearStencil:0,activeTextureUnit:0,maxTextureUnit:h,lastMaxTextureUnit:0,textureUnits:d,program:null};u.state=T,u.counters={textures:0,vertexBuffers:0,indexBuffers:0,renderTargets:0,renderBuffers:0,shaders:0,techniques:0};var at={},ft=function(t,n,r,i,s){at[t]={set:n,reset:r,parse:i,defaultValues:s}};ft("DepthTestEnable",N,q,tt,[!0]),ft("DepthFunc",C,R,nt,[m]),ft("DepthMask",k,U,tt,[!0]),ft("BlendEnable",L,z,tt,[!1]),ft("BlendFunc",A,W,rt,[y,b]),ft("CullFaceEnable",O,X,tt,[!0]),ft("CullFace",M,V,nt,[w]),ft("FrontFace",_,$,nt,[E]),ft("ColorMask",D,J,ut,[!0,!0,!0,!0]),ft("StencilTestEnable",P,K,tt,[!1]),ft("StencilFunc",H,Q,it,[S,0,4294967295]),ft("StencilOp",B,G,it,[x,x,x]),ft("PolygonOffsetFillEnable",j,Y,tt,[!1]),ft("PolygonOffset",F,Z,ot,[0,0]),ft("LineWidth",I,et,st,[1]),u.stateHandlers=at,u.syncState(),u.videoRam=0,u.desktopWidth=window.screen.width,u.desktopHeight=window.screen.height,Object.defineProperty?(Object.defineProperty(u,"fullscreen",{get:function(){return document.fullscreenEnabled||document.mozFullScreen||document.webkitIsFullScreen||!1},set:function(t){u.requestFullScreen(t)},enumerable:!0,configurable:!1}),u.checkFullScreen=function(){}):(u.fullscreen=!1,u.oldFullscreen=!1),u.clientStateMask=0,u.attributeMask=0,u.activeTechnique=null,u.activeIndexBuffer=null,u.bindedVertexBuffer=null,u.activeRenderTarget=null,u.immediateVertexBuffer=u.createVertexBuffer({numVertices:16384,attributes:["FLOAT4"],dynamic:!0,"transient":!0}),u.immediatePrimitive=-1,u.immediateSemantics=g.create(u,[]),u.fps=0,u.numFrames=0,u.previousFrameTime=TurbulenzEngine.getTime();var lt=document.createElement("video"),ct={};return lt&&(lt.canPlayType("video/webm")&&(ct.webm=!0),lt.canPlayType("video/mp4")&&(ct.mp4=!0)),u.supportedVideoExtensions=ct,lt=null,u},e.version=1,e}();N.prototype.SEMANTIC_POSITION=0,N.prototype.SEMANTIC_POSITION0=0,N.prototype.SEMANTIC_BLENDWEIGHT=1,N.prototype.SEMANTIC_BLENDWEIGHT0=1,N.prototype.SEMANTIC_NORMAL=2,N.prototype.SEMANTIC_NORMAL0=2,N.prototype.SEMANTIC_COLOR=3,N.prototype.SEMANTIC_COLOR0=3,N.prototype.SEMANTIC_COLOR1=4,N.prototype.SEMANTIC_SPECULAR=4,N.prototype.SEMANTIC_FOGCOORD=5,N.prototype.SEMANTIC_TESSFACTOR=5,N.prototype.SEMANTIC_PSIZE0=6,N.prototype.SEMANTIC_BLENDINDICES=7,N.prototype.SEMANTIC_BLENDINDICES0=7,N.prototype.SEMANTIC_TEXCOORD=8,N.prototype.SEMANTIC_TEXCOORD0=8,N.prototype.SEMANTIC_TEXCOORD1=9,N.prototype.SEMANTIC_TEXCOORD2=10,N.prototype.SEMANTIC_TEXCOORD3=11,N.prototype.SEMANTIC_TEXCOORD4=12,N.prototype.SEMANTIC_TEXCOORD5=13,N.prototype.SEMANTIC_TEXCOORD6=14,N.prototype.SEMANTIC_TEXCOORD7=15,N.prototype.SEMANTIC_TANGENT=14,N.prototype.SEMANTIC_TANGENT0=14,N.prototype.SEMANTIC_BINORMAL0=15,N.prototype.SEMANTIC_BINORMAL=15,N.prototype.SEMANTIC_PSIZE=6,N.prototype.SEMANTIC_ATTR0=0,N.prototype.SEMANTIC_ATTR1=1,N.prototype.SEMANTIC_ATTR2=2,N.prototype.SEMANTIC_ATTR3=3,N.prototype.SEMANTIC_ATTR4=4,N.prototype.SEMANTIC_ATTR5=5,N.prototype.SEMANTIC_ATTR6=6,N.prototype.SEMANTIC_ATTR7=7,N.prototype.SEMANTIC_ATTR8=8,N.prototype.SEMANTIC_ATTR9=9,N.prototype.SEMANTIC_ATTR10=10,N.prototype.SEMANTIC_ATTR11=11,N.prototype.SEMANTIC_ATTR12=12,N.prototype.SEMANTIC_ATTR13=13,N.prototype.SEMANTIC_ATTR14=14,N.prototype.SEMANTIC_ATTR15=15,N.prototype.PIXELFORMAT_A8=0,N.prototype.PIXELFORMAT_L8=1,N.prototype.PIXELFORMAT_L8A8=2,N.prototype.PIXELFORMAT_R5G5B5A1=3,N.prototype.PIXELFORMAT_R5G6B5=4,N.prototype.PIXELFORMAT_R4G4B4A4=5,N.prototype.PIXELFORMAT_R8G8B8A8=6,N.prototype.PIXELFORMAT_R8G8B8=7,N.prototype.PIXELFORMAT_D24S8=8,N.prototype.PIXELFORMAT_D16=9,N.prototype.PIXELFORMAT_DXT1=10,N.prototype.PIXELFORMAT_DXT3=11,N.prototype.PIXELFORMAT_DXT5=12;var C=function(){function e(){}return e.prototype.update=function(){if(!this.isWindowFocused)return;this.updateGamePad()},e.prototype.addEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t)return;i.push(t)}}},e.prototype.removeEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t){i.splice(n,1);break}}}},e.prototype.lockMouse=function(){return this.isHovering&&this.isWindowFocused?(this.isMouseLocked=!0,this.hideMouse(),this.requestBrowserLock(),this.setEventHandlersLock(),!0):!1},e.prototype.unlockMouse=function(){return this.isMouseLocked?(this.isMouseLocked=!1,this.showMouse(),this.requestBrowserUnlock(),this.setEventHandlersUnlock(),this.isOutsideEngine&&(this.isOutsideEngine=!1,this.isHovering=!1,this.setEventHandlersMouseLeave(),this.sendEventToHandlers(this.handlers.mouseleave)),this.sendEventToHandlers(this.handlers.mouselocklost),!0):!1},e.prototype.isLocked=function(){return this.isMouseLocked},e.prototype.hideMouse=function(){return this.isHovering?(this.isCursorHidden||(this.isCursorHidden=!0,this.previousCursor=document.body.style.cursor,document.body.style.cursor="none",this.webkit&&(this.ignoreNextMouseMoves=2)),!0):!1},e.prototype.showMouse=function(){return this.isCursorHidden&&!this.isMouseLocked?(this.isCursorHidden=!1,document.body.style.cursor=this.previousCursor,!0):!1},e.prototype.isHidden=function(){return this.isCursorHidden},e.prototype.isFocused=function(){return this.isWindowFocused},e.prototype.convertToUnicode=function(e){var t=this.keyCodeToUnicode,n={},r=e.length,i,s;for(i=0;i<r;i+=1)s=e[i],n[s]=t[s]||"";return n},e.prototype.sendEventToHandlers=function(e,t,n,r,i,s,o){var u,a=e.length;if(a)for(u=0;u<a;u+=1)e[u](t,n,r,i,s,o)},e.prototype.sendEventToHandlersASync=function(t,n,r,i,s,o,u){var a=e.prototype.sendEventToHandlers;TurbulenzEngine.setTimeout(function(){a(t,n,r,i,s,o,u)},0)},e.prototype.updateGamePad=function(){var e,t,n=navigator.gamepads||navigator.webkitGamepads||navigator.webkitGetGamepads&&navigator.webkitGetGamepads();if(n){var r=this.padAxisDeadZone,i=this.maxAxisRange,s=this.sendEventToHandlersASync,o=this.handlers,u=this.padButtons,a=this.padMap,f=0,l=0,c=0,h=0,p=n.length;for(var d=0;d<p;d+=1){var v=n[d];if(v){var m=v.buttons;if(this.padTimestampUpdate<v.timestamp){this.padTimestampUpdate=v.timestamp;var g=m.length;for(var y=0;y<g;y+=1){var b=m[y];if(u[y]!==b){u[y]=b;var w=a[y];w!==undefined&&(b?s(o.paddown,w):s(o.padup,w))}}}var E=v.axes;if(E.length<=4){var S=E[0],x=-E[1];e=S*S+x*x,e>r*r&&(e=Math.sqrt(e),S/=e,x/=e,e>i&&(e=i),e-=r,t=e/(i-r),f=S*t,l=x*t);var T=E[2],N=-E[3];e=T*T+N*N,e>r*r&&(e=Math.sqrt(e),T/=e,N/=e,e>i&&(e=i),e-=r,t=e/(i-r),c=T*t,h=N*t),s(o.padmove,f,l,m[6],c,h,m[7])}break}}}},e.prototype.getLocale=function(){return""},e.prototype.getCanvasPosition=function(e,t){e.offsetX!==undefined?(t.x=e.offsetX,t.y=e.offsetY):e.layerX!==undefined&&(t.x=e.layerX,t.y=e.layerY)},e.prototype.resetKeyStates=function(){var e,t=this.pressedKeys,n=this.handlers.keyup;for(e in t)t.hasOwnProperty(e)&&t[e]&&(e=parseInt(e,10),t[e]=!1,this.sendEventToHandlers(n,e))},e.prototype.onMouseOver=function(e){var t={},n=this.handlers.mouseover;e.stopPropagation(),e.preventDefault(),this.getCanvasPosition(e,t),this.lastX=e.screenX,this.lastY=e.screenY,this.sendEventToHandlers(n,t.x,t.y)},e.prototype.onMouseMove=function(e){var t=this.handlers.mousemove,n,r;e.stopPropagation(),e.preventDefault();if(this.ignoreNextMouseMoves){this.ignoreNextMouseMoves-=1;return}if(e.movementX!==undefined)n=e.movementX,r=e.movementY;else if(e.mozMovementX!==undefined)n=e.mozMovementX,r=e.mozMovementY;else if(e.webkitMovementX!==undefined)n=e.webkitMovementX,r=e.webkitMovementY;else{n=e.screenX-this.lastX,r=e.screenY-this.lastY;if(0===n&&0===r)return}this.lastX=e.screenX,this.lastY=e.screenY,this.sendEventToHandlers(t,n,r)},e.prototype.onWheel=function(e){var t=this.handlers.mousewheel,n;e.stopPropagation(),e.preventDefault(),e.wheelDelta?window.opera?n=e.wheelDelta<0?1:-1:n=e.wheelDelta>0?1:-1:n=e.detail<0?1:-1,this.sendEventToHandlers(t,n)},e.prototype.emptyEvent=function(e){e.stopPropagation(),e.preventDefault()},e.prototype.onWindowFocus=function(){this.isHovering&&window.document.activeElement===this.canvas&&this.addInternalEventListener(window,"mousedown",this.onMouseDown)},e.prototype.onFocus=function(){var e=this.canvas,t=this.handlers,n=t.focus;this.isWindowFocused||(this.isWindowFocused=!0,window.focus(),e.focus(),this.setEventHandlersFocus(),e.oncontextmenu=function(){return!1},this.sendEventToHandlers(n))},e.prototype.onBlur=function(){if(this.ignoreNextBlur){this.ignoreNextBlur=!1;return}var e=this.canvas,t=this.handlers,n=t.blur;this.isMouseLocked&&this.unlockMouse(),this.isWindowFocused&&(this.isWindowFocused=!1,this.resetKeyStates(),this.setEventHandlersBlur(),e.oncontextmenu=null,this.sendEventToHandlers(n))},e.prototype.onMouseDown=function(e){var t=this.handlers;if(this.isHovering){var n=t.mousedown,r=e.button,i={};this.onFocus(),e.stopPropagation(),e.preventDefault(),r<3&&(r=this.mouseMap[r]),this.getCanvasPosition(e,i),this.sendEventToHandlers(n,r,i.x,i.y)}else this.onBlur()},e.prototype.onMouseUp=function(e){var t=this.handlers.mouseup;if(this.isHovering){var n=e.button,r={};e.stopPropagation(),e.preventDefault(),n<3&&(n=this.mouseMap[n]),this.getCanvasPosition(e,r),this.sendEventToHandlers(t,n,r.x,r.y)}},e.prototype.onKeyDown=function(e){var t=
this.handlers.keydown,n=this.pressedKeys,r=this.keyCodes;e.stopPropagation(),e.preventDefault();var i=e.keyCode;i=this.keyMap[i];var s=e.keyLocation||e.location;undefined!==i&&r.ESCAPE!==i&&(2===s&&(i+=1),n[i]||(n[i]=!0,this.sendEventToHandlers(t,i)))},e.prototype.onKeyUp=function(e){var t=this.handlers.keyup,n=this.pressedKeys,r=this.keyCodes;e.stopPropagation(),e.preventDefault();var i=e.keyCode;i=this.keyMap[i];var s=e.keyLocation||e.location;if(i===r.ESCAPE){this.unlockMouse();if(document.fullscreenEnabled||document.mozFullScreen||document.webkitIsFullScreen)document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.cancelFullScreen?document.cancelFullScreen():document.exitFullscreen&&document.exitFullscreen()}else undefined!==i&&(2===s&&(i+=1),n[i]&&(n[i]=!1,this.sendEventToHandlers(t,i),(627===i||628===i)&&this.macosx&&this.resetKeyStates()))},e.prototype.onTouchStart=function(e){var t=this.handlers.touchstart;e.preventDefault(),this.addTouches(e.changedTouches),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.sendEventToHandlers(t,e)},e.prototype.onTouchEnd=function(e){var t=this.handlers.touchend;e.preventDefault(),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.removeTouches(e.changedTouches),this.sendEventToHandlers(t,e)},e.prototype.onTouchMove=function(e){var t=this.handlers.touchmove;e.preventDefault(),this.addTouches(e.changedTouches),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.sendEventToHandlers(t,e)},e.prototype.onTouchEnter=function(e){var t=this.handlers.touchenter;e.preventDefault(),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.sendEventToHandlers(t,e)},e.prototype.onTouchLeave=function(e){var t=this.handlers.touchleave;e.preventDefault(),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.sendEventToHandlers(t,e)},e.prototype.onTouchCancel=function(e){var t=this.handlers.touchcancel;e.preventDefault(),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.removeTouches(e.changedTouches),this.sendEventToHandlers(t,e)},e.prototype.convertW3TouchEventToTurbulenzTouchEvent=function(e){var t=this.convertW3TouchListToTurbulenzTouchList(e.changedTouches),n=this.convertW3TouchListToTurbulenzTouchList(e.targetTouches),r=this.convertW3TouchListToTurbulenzTouchList(e.touches),i={changedTouches:t,gameTouches:n,touches:r};return gt.create(i)},e.prototype.convertW3TouchListToTurbulenzTouchList=function(e){var t=e.length,n=[],r,i;n.length=t;for(i=0;i<t;i+=1)r=this.getTouchById(e[i].identifier),n[i]=r;return n},e.prototype.convertW3TouchToTurbulenzTouch=function(e){var t=this.canvas,n=t.getBoundingClientRect(),r={force:e.force||e.webkitForce||0,identifier:e.identifier,isGameTouch:e.target===t,positionX:e.pageX-n.left,positionY:e.pageY-n.top,radiusX:e.radiusX||e.webkitRadiusX||1,radiusY:e.radiusY||e.webkitRadiusY||1,rotationAngle:e.rotationAngle||e.webkitRotationAngle||0};return mt.create(r)},e.prototype.addTouches=function(e){var t=e.length,n,r;for(n=0;n<t;n+=1)r=this.convertW3TouchToTurbulenzTouch(e[n]),this.addTouch(r)},e.prototype.removeTouches=function(e){var t=e.length,n,r;for(n=0;n<t;n+=1)r=e[n].identifier,this.removeTouchById(r)},e.prototype.addTouch=function(e){this.touches[e.identifier]=e},e.prototype.getTouchById=function(e){return this.touches[e]},e.prototype.removeTouchById=function(e){delete this.touches[e]},e.prototype.canvasOnMouseOver=function(e){var t=this.handlers.mouseenter;this.isMouseLocked?this.isOutsideEngine=!1:(this.isHovering=!0,this.lastX=e.screenX,this.lastY=e.screenY,this.setEventHandlersMouseEnter(),this.sendEventToHandlers(t))},e.prototype.canvasOnMouseOut=function(){var e=this.handlers.mouseleave;this.isMouseLocked?this.isOutsideEngine=!0:(this.isHovering=!1,this.isCursorHidden&&this.showMouse(),this.setEventHandlersMouseLeave(),this.sendEventToHandlers(e))},e.prototype.canvasOnMouseDown=function(e){var t=this.handlers.mouseenter;return this.canvas.onmousedown=null,this.isHovering||(this.isHovering=!0,this.lastX=e.screenX,this.lastY=e.screenY,this.setEventHandlersMouseEnter(),this.sendEventToHandlers(t),this.onMouseDown(e)),!1},e.prototype.onFullscreenChanged=function(){this.isMouseLocked&&(document.fullscreenEnabled||document.mozFullScreen||document.webkitIsFullScreen?(this.ignoreNextMouseMoves=2,this.requestBrowserLock()):this.unlockMouse())},e.prototype.setEventHandlersMouseEnter=function(){this.isFocused()||this.addInternalEventListener(window,"mousedown",this.onMouseDown),this.addInternalEventListener(window,"mouseup",this.onMouseUp),this.addInternalEventListener(window,"mousemove",this.onMouseOver),this.addInternalEventListener(window,"DOMMouseScroll",this.onWheel),this.addInternalEventListener(window,"mousewheel",this.onWheel),this.addInternalEventListener(window,"click",this.emptyEvent)},e.prototype.setEventHandlersMouseLeave=function(){this.isFocused()||this.removeInternalEventListener(window,"mousedown",this.onMouseDown),this.removeInternalEventListener(window,"mouseup",this.onMouseUp),this.removeInternalEventListener(window,"mousemove",this.onMouseOver),this.removeInternalEventListener(window,"DOMMouseScroll",this.onWheel),this.removeInternalEventListener(window,"mousewheel",this.onWheel),this.removeInternalEventListener(window,"click",this.emptyEvent)},e.prototype.setEventHandlersFocus=function(){this.addInternalEventListener(window,"keydown",this.onKeyDown),this.addInternalEventListener(window,"keyup",this.onKeyUp)},e.prototype.setEventHandlersBlur=function(){this.removeInternalEventListener(window,"keydown",this.onKeyDown),this.removeInternalEventListener(window,"keyup",this.onKeyUp),this.removeInternalEventListener(window,"mousedown",this.onMouseDown)},e.prototype.setEventHandlersLock=function(){this.removeInternalEventListener(window,"mousemove",this.onMouseOver),this.addInternalEventListener(window,"mousemove",this.onMouseMove),this.addInternalEventListener(document,"fullscreenchange",this.onFullscreenChanged),this.addInternalEventListener(document,"mozfullscreenchange",this.onFullscreenChanged),this.addInternalEventListener(document,"webkitfullscreenchange",this.onFullscreenChanged)},e.prototype.setEventHandlersUnlock=function(){this.removeInternalEventListener(document,"webkitfullscreenchange",this.onFullscreenChanged),this.removeInternalEventListener(document,"mozfullscreenchange",this.onFullscreenChanged),this.removeInternalEventListener(document,"fullscreenchange",this.onFullscreenChanged),this.removeInternalEventListener(window,"mousemove",this.onMouseMove),this.addInternalEventListener(window,"mousemove",this.onMouseOver)},e.prototype.setEventHandlersCanvas=function(){var e=this.canvas;this.addInternalEventListener(e,"mouseover",this.canvasOnMouseOver),this.addInternalEventListener(e,"mouseout",this.canvasOnMouseOut),this.addInternalEventListener(e,"mousedown",this.canvasOnMouseDown)},e.prototype.setEventHandlersWindow=function(){this.addInternalEventListener(window,"blur",this.onBlur),this.addInternalEventListener(window,"focus",this.onWindowFocus)},e.prototype.removeEventHandlersWindow=function(){this.removeInternalEventListener(window,"blur",this.onBlur),this.removeInternalEventListener(window,"focus",this.onWindowFocus)},e.prototype.setEventHandlersTouch=function(){var e=this.canvas;this.addInternalEventListener(e,"touchstart",this.onTouchStart),this.addInternalEventListener(e,"touchend",this.onTouchEnd),this.addInternalEventListener(e,"touchenter",this.onTouchEnter),this.addInternalEventListener(e,"touchleave",this.onTouchLeave),this.addInternalEventListener(e,"touchmove",this.onTouchMove),this.addInternalEventListener(e,"touchcancel",this.onTouchCancel)},e.prototype.addInternalEventListener=function(e,t,n){var r=this.elementEventFlags[e];r||(this.elementEventFlags[e]=r={});if(!r[t]){r[t]=!0;var i=this.boundFunctions[n];i||(this.boundFunctions[n]=i=n.bind(this)),e.addEventListener(t,i,!1)}},e.prototype.removeInternalEventListener=function(e,t,n){var r=this.elementEventFlags[e];if(r&&r[t]){r[t]=!1;var i=this.boundFunctions[n];e.removeEventListener(t,i,!1)}},e.prototype.destroy=function(){this.isLocked()&&this.setEventHandlersUnlock(),this.isHovering&&this.setEventHandlersMouseLeave(),this.isWindowFocused&&this.setEventHandlersBlur(),this.removeEventHandlersWindow();var e=this.canvas;e.onmouseover=null,e.onmouseout=null,e.onmousedown=null},e.prototype.isSupported=function(e){var t=this.canvas;if(t&&e==="POINTER_LOCK"){var n="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document,r=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;if(n&&r)return!0}return!1},e.create=function(t){var n=new e;n.lastX=0,n.lastY=0,n.touches={},n.boundFunctions={},n.elementEventFlags={},n.canvas=t,n.isMouseLocked=!1,n.isHovering=!1,n.isWindowFocused=!1,n.isCursorHidden=!1,n.isOutsideEngine=!1,n.previousCursor="",n.ignoreNextMouseMoves=0,n.ignoreNextBlur=!1,n.pressedKeys={},n.handlers={keydown:[],keyup:[],mousedown:[],mouseup:[],mousewheel:[],mouseover:[],mousemove:[],paddown:[],padup:[],padmove:[],mouseenter:[],mouseleave:[],focus:[],blur:[],mouselocklost:[],touchstart:[],touchend:[],touchenter:[],touchleave:[],touchmove:[],touchcancel:[]};var r={},i=n.keyCodes;for(var s in i)if(i.hasOwnProperty(s)){var o=i[s];r[o]=s}r[i.SPACE]=" ",r[i.NUMBER_0]="0",r[i.NUMBER_1]="1",r[i.NUMBER_2]="2",r[i.NUMBER_3]="3",r[i.NUMBER_4]="4",r[i.NUMBER_5]="5",r[i.NUMBER_6]="6",r[i.NUMBER_7]="7",r[i.NUMBER_8]="8",r[i.NUMBER_9]="9",r[i.GRAVE]="`",r[i.MINUS]="-",r[i.EQUALS]="=",r[i.LEFT_BRACKET]="[",r[i.RIGHT_BRACKET]="]",r[i.SEMI_COLON]=";",r[i.APOSTROPHE]="'",r[i.COMMA]=",",r[i.PERIOD]=".",r[i.SLASH]="/",r[i.BACKSLASH]="\\";var u={};u[65]=0,u[66]=1,u[67]=2,u[68]=3,u[69]=4,u[70]=5,u[71]=6,u[72]=7,u[73]=8,u[74]=9,u[75]=10,u[76]=11,u[77]=12,u[78]=13,u[79]=14,u[80]=15,u[81]=16,u[82]=17,u[83]=18,u[84]=19,u[85]=20,u[86]=21,u[87]=22,u[88]=23,u[89]=24,u[90]=25,u[48]=100,u[49]=101,u[50]=102,u[51]=103,u[52]=104,u[53]=105,u[54]=106,u[55]=107,u[56]=108,u[57]=109,u[37]=200,u[39]=201,u[38]=202,u[40]=203,u[16]=300,u[17]=302,u[18]=304,u[0]=305,u[27]=400,u[9]=401,u[32]=402,u[8]=403,u[13]=404,u[223]=500,u[173]=501,u[189]=501,u[61]=502,u[187]=502,u[219]=503,u[221]=504,u[59]=505,u[186]=505,u[192]=500,u[188]=507,u[190]=508,u[222]=506,navigator.appVersion.indexOf("Mac")!==-1&&(u[0]=500),u[112]=600,u[113]=601,u[114]=602,u[115]=603,u[116]=604,u[117]=605,u[118]=606,u[119]=607,u[120]=608,u[121]=609,u[122]=610,u[123]=611,u[96]=612,u[97]=613,u[98]=614,u[99]=615,u[100]=616,u[12]=617,u[101]=617,u[144]=617,u[102]=618,u[103]=619,u[104]=620,u[105]=621,u[111]=623,u[191]=623,u[106]=624,u[107]=625,u[109]=626,u[91]=627,u[224]=627,u[92]=628,u[93]=628,u[20]=631,u[45]=632,u[46]=633,u[36]=634,u[35]=635,u[33]=636,u[34]=637,n.keyMap=u;var a={0:0,1:2,2:1};n.mouseMap=a;var f={0:4,1:5,2:6,3:7,4:10,5:11,8:19,9:18,10:12,11:15,12:0,13:2,14:1,15:3};n.padMap=f,n.keyCodeToUnicode=r,n.padButtons=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n.padMap=f,n.padAxisDeadZone=.26,n.maxAxisRange=1,n.padTimestampUpdate=0;var l=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;if(l){var c=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;n.onPointerLockChanged=function(){var t=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement;t!==n.canvas&&n.unlockMouse()},n.onPointerLockError=function(){n.unlockMouse()},"mozPointerLockElement"in document?(n.setEventHandlersPointerLock=function(){this.ignoreNextBlur=!0,document.addEventListener("mozpointerlockchange",this.onPointerLockChanged,!1),document.addEventListener("mozpointerlockerror",this.onPointerLockError,!1)},n.setEventHandlersPointerUnlock=function(){this.ignoreNextBlur=!1,document.removeEventListener("mozpointerlockchange",this.onPointerLockChanged,!1),document.removeEventListener("mozpointerlockerror",this.onPointerLockError,!1)}):"webkitPointerLockElement"in document?(n.setEventHandlersPointerLock=function(){document.addEventListener("webkitpointerlockchange",this.onPointerLockChanged,!1),document.addEventListener("webkitpointerlockerror",this.onPointerLockError,!1)},n.setEventHandlersPointerUnlock=function(){document.removeEventListener("webkitpointerlockchange",this.onPointerLockChanged,!1),document.removeEventListener("webkitpointerlockerror",this.onPointerLockError,!1)}):"pointerLockElement"in document&&(n.setEventHandlersPointerLock=function(){document.addEventListener("pointerlockchange",this.onPointerLockChanged,!1),document.addEventListener("pointerlockerror",this.onPointerLockError,!1)},n.setEventHandlersPointerUnlock=function(){document.removeEventListener("pointerlockchange",this.onPointerLockChanged,!1),document.removeEventListener("pointerlockerror",this.onPointerLockError,!1)}),n.requestBrowserLock=function(){var n=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement;n!==t&&(this.setEventHandlersPointerLock(),l.call(t))},n.requestBrowserUnlock=function(){this.setEventHandlersPointerUnlock();var n=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement;n===t&&c.call(document)}}else{var h=navigator.pointer||navigator.webkitPointer;h?(n.requestBrowserLock=function(){h.isLocked||h.lock(t)},n.requestBrowserUnlock=function(){h.isLocked&&h.unlock()}):(n.requestBrowserLock=function(){},n.requestBrowserUnlock=function(){})}n.setEventHandlersCanvas(),n.setEventHandlersWindow(),n.setEventHandlersTouch();var p=TurbulenzEngine.getSystemInfo();return n.macosx="Darwin"===p.osName,n.webkit=/WebKit/.test(navigator.userAgent),n},e.version=1,e}();C.prototype.keyCodes={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,NUMBER_0:100,NUMBER_1:101,NUMBER_2:102,NUMBER_3:103,NUMBER_4:104,NUMBER_5:105,NUMBER_6:106,NUMBER_7:107,NUMBER_8:108,NUMBER_9:109,LEFT:200,RIGHT:201,UP:202,DOWN:203,LEFT_SHIFT:300,RIGHT_SHIFT:301,LEFT_CONTROL:302,RIGHT_CONTROL:303,LEFT_ALT:304,RIGHT_ALT:305,ESCAPE:400,TAB:401,SPACE:402,BACKSPACE:403,RETURN:404,GRAVE:500,MINUS:501,EQUALS:502,LEFT_BRACKET:503,RIGHT_BRACKET:504,SEMI_COLON:505,APOSTROPHE:506,COMMA:507,PERIOD:508,SLASH:509,BACKSLASH:510,F1:600,F2:601,F3:602,F4:603,F5:604,F6:605,F7:606,F8:607,F9:608,F10:609,F11:610,F12:611,NUMPAD_0:612,NUMPAD_1:613,NUMPAD_2:614,NUMPAD_3:615,NUMPAD_4:616,NUMPAD_5:617,NUMPAD_6:618,NUMPAD_7:619,NUMPAD_8:620,NUMPAD_9:621,NUMPAD_ENTER:622,NUMPAD_DIVIDE:623,NUMPAD_MULTIPLY:624,NUMPAD_ADD:625,NUMPAD_SUBTRACT:626,LEFT_WIN:627,RIGHT_WIN:628,LEFT_OPTION:629,RIGHT_OPTION:630,CAPS_LOCK:631,INSERT:632,DELETE:633,HOME:634,END:635,PAGE_UP:636,PAGE_DOWN:637,BACK:638},C.prototype.mouseCodes={BUTTON_0:0,BUTTON_1:1,BUTTON_2:2,DELTA_X:100,DELTA_Y:101,MOUSE_WHEEL:102},C.prototype.padCodes={UP:0,LEFT:1,DOWN:2,RIGHT:3,A:4,B:5,X:6,Y:7,LEFT_TRIGGER:8,RIGHT_TRIGGER:9,LEFT_SHOULDER:10,RIGHT_SHOULDER:11,LEFT_THUMB:12,LEFT_THUMB_X:13,LEFT_THUMB_Y:14,RIGHT_THUMB:15,RIGHT_THUMB_X:16,RIGHT_THUMB_Y:17,START:18,BACK:19},WebGLMathDevice=t;var k=function(){function e(){}return e.prototype.createWebSocket=function(e,t){var n=this.WebSocketConstructor;if(n){var r;return t?r=new n(e,t):r=new n(e),typeof r.destroy=="undefined"&&(r.destroy=function(){this.onopen=null,this.onerror=null,this.onclose=null,this.onmessage=null,this.close()}),r}return null},e.prototype.update=function(){},e.create=function(t){var n=new e;return n},e.version=1,e}();k.prototype.WebSocketConstructor=window.WebSocket?window.WebSocket:window.MozWebSocket;var L=function(){function e(){}return e.version=1,e}(),A={CONTACT_SLOP:.015,CONTACT_BAUMGRAUTE:.35,CONTACT_STATIC_BAUMGRAUTE:.65,CONTACT_MAX_Y_SEPERATION:.05,CONTACT_MAX_SQ_XZ_SEPERATION:2*.245*.245,CONTACT_INHERIT_SQ_SEPERATION:1.6875,CONTACT_EQUAL_SQ_SEPERATION:3e-6,GJK_EPA_DISTANCE_THRESHOLD:1e-4,GJK_FRACTIONAL_THRESHOLD:1e-4,CONTINUOUS_LINEAR_SQ:.35,CONTINUOUS_ANGULAR_SQ:.25,CONTINUOUS_LINEAR_BULLET:.75,CONTINUOUS_ANGULAR_BULLET:.5,CONTINUOUS_SLOP:.015,SLEEP_LINEAR_SQ:.01,SLEEP_ANGULAR_SQ:.1,SLEEP_DELAY:60,MAX_ANGULAR:Math.PI,QUADRATIC_THRESHOLD:1e-8,DONT_NORMALIZE_THRESHOLD:1e-8,COLLINEAR_THRESHOLD:1e-10,COPLANAR_THRESHOLD:1e-16},O=function(t,n){for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];if(i===null||i===undefined)continue;typeof i=="object"&&r!=="shape"&&r!=="userData"&&r!=="world"&&r!=="object"&&r!=="arbiters"&&r!=="islandRoot"&&r!=="island"&&r!=="bodyA"&&r!=="bodyB"&&r!=="triangleArray"&&("slice"in i?i=i.slice():i=O({},i)),t[r]=i}return t},M=function(n,r,i){i||Object.defineProperty(n,"margin",{get:function(){return this._private.collisionRadius},set:function(t){var n=this._private;n.halfExtents[0]+=t-n.collisionRadius,n.halfExtents[1]+=t-n.collisionRadius,n.halfExtents[2]+=t-n.collisionRadius,n.radius+=t-n.collisionRadius,n.collisionRadius=t},enumerable:!0}),Object.defineProperty(n,"halfExtents",{get:function(){return t.v3Copy(this._private.halfExtents)},enumerable:!0}),Object.defineProperty(n,"inertia",{get:function(){return t.v3Copy(this._private.inertia)},enumerable:!0}),Object.defineProperty(n,"radius",{get:function(){return this._private.radius},enumerable:!0}),Object.defineProperty(n,"type",{value:r,enumerable:!0})},_=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.direction,r=e.origin,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=this.normal,c=l[0],h=l[1],p=l[2],d=i*c+s*h+o*p;if(d*d<A.COPLANAR_THRESHOLD)return null;var v=(this.distance-(u*c+a*h+f*p))/d;if(0<=v&&v<=e.maxFactor){d>0&&(c=-c,h=-h,p=-p);var m=u+i*v,g=a+s*v,y=f+o*v;return{factor:v,hitPoint:t.v3Build(m,g,y),hitNormal:t.v3Build(c,h,p)}}return null},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r,i.collisionRadius=n.margin!==undefined?n.margin:.04,i.distance=n.distance;var s=i.normal=t.v3Copy(n.normal),o=Math.abs,u=Number.MAX_VALUE;return i.radius=u,o(s[0])===1?i.halfExtents=t.v3Build(o(i.distance),u,u):o(s[1])===1?i.halfExtents=t.v3Build(u,o(i.distance),u):o(s[2])===1&&(i.halfExtents=t.v3Build(u,u,o(i.distance))),i.center=undefined,i.inertia=t.v3BuildZero(),M(r,"PLANE"),r},e.version=1,e}();_.prototype.type="PLANE";var D=function(){function e(){}return e.prototype.rayTestCap=function(e,n,r){var i=e.origin,s=e.direction,o=i[0],u=i[1],a=i[2],f=s[0],l=s[1],c=s[2],h=this.capsuleRadius,p=f*f+l*l+c*c,d=u-n,v=2*(f*o+l*d+c*a),m=o*o+d*d+a*a-h*h,g=v*v-4*p*m;if(g<0)return null;var y,b=1,w,E=1/(2*p),S=Math.sqrt(g);y=(-v-S)*E,w=u+l*y;if(y<0||r*(w-n)<0)y+=2*S*E,w=u+l*y,b=-1;if(r*(w-n)>=0&&0<=y&&y<=e.maxFactor){var x=o+f*y,T=a+c*y,N=b/h;return{factor:y,hitPoint:t.v3Build(x,w,T),hitNormal:t.v3Build(x*N,(w-n)*N,T*N)}}return null},e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=e.maxFactor,c=this.capsuleRadius,h=this.halfHeight,p=c*c,d,v=1,m,g,y,b=u*u+f*f;if(b>=A.QUADRATIC_THRESHOLD){var w=2*(i*u+o*f),E=i*i+o*o-p,S=w*w-4*b*E,x=1/(2*b);if(S<A.QUADRATIC_THRESHOLD)d=-w*x;else if(S>0){var T=Math.sqrt(S);d=(-w-T)*x,d<0&&(d+=T*2*x,v=-1)}var N;g=s+a*d;if(-h<=g&&g<=h)return 0<=d&&d<=l?(m=i+u*d,y=o+f*d,N=v/c,{factor:d,hitPoint:t.v3Build(m,g,y),hitNormal:t.v3Build(m*N,0,y*N)}):null}return this.rayTestCap(e,h,1)||this.rayTestCap(e,-h,-1)},e.prototype.localSupportWithoutMargin=function(e,t){t[0]=0,t[1]=e[1]>=0?this.halfHeight:-this.halfHeight,t[2]=0},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.radius,u=n.height,a=.5*u,f=o+a,l=o+s,c=f+s,h=o+s,p=2*l,d=2*c,v=2*h;p*=p,d*=d,v*=v;var m=1/12;return i.radius=f+s,i.capsuleRadius=o,i.halfHeight=a,i.halfExtents=t.v3Build(l,c,h),i.inertia=t.v3Build(m*(d+v),m*(p+v),m*(p+d)),i.collisionRadius=o+s,i.center=undefined,Object.defineProperty(r,"margin",{get:function(){return this._private.collisionRadius-this._private.capsuleRadius},set:function(t){var n=this._private;n.collisionRadius=n.capsuleRadius+t,n.halfExtents[0]=n.capsuleRadius+t,n.halfExtents[1]=n.capsuleRadius+n.halfHeight+t,n.halfExtents[2]=n.capsuleRadius+t,n.radius=n.capsuleRadius+n.halfHeight+t},enumerable:!0}),M(r,"CAPSULE",!0),r},e.version=1,e}();L.prototype.type="CAPSULE";var P=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=this.sphereRadius,s=r[0],o=r[1],u=r[2],a=n[0],f=n[1],l=n[2],c=s*s+o*o+u*u,h=2*(a*s+f*o+l*u),p=a*a+f*f+l*l-i*i,d,v=h*h-4*c*p;if(v<=0)return null;var m=1,g=1/(2*c),y=Math.sqrt(v);d=(-h-y)*g,d<0&&(d+=y*2*g,m=-1);if(0<=d&&d<e.maxFactor){var b=a+s*d,w=f+o*d,E=l+u*d,S=m/i;return{factor:d,hitPoint:t.v3Build(b,w,E),hitNormal:t.v3Build(b*S,w*S,E*S)}}return null},e.prototype.localSupportWithoutMargin=function(e,t){t[0]=t[1]=t[2]=0},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.radius,u=.4*o*o;return i.sphereRadius=o,i.radius=i.sphereRadius+s,i.collisionRadius=o+s,i.halfExtents=t.v3Build(o+s,o+s,o+s),i.inertia=t.v3Build(u,u,u),i.center=undefined,Object.defineProperty(r,"margin",{get:function(){return this._private.collisionRadius-this._private.radius},set:function(t){var n=this._private;n.collisionRadius=n.radius+t,n.halfExtents[0]=n.collisionRadius,n.halfExtents[1]=n.collisionRadius,n.halfExtents[2]=n.collisionRadius,n.radius=n.collisionRadius},enumerable:!0}),M(r,"SPHERE",!0),r},e.version=1,e}();P.prototype.type="SPHERE";var H=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=this.halfExtents,c=l[0],h=l[1],p=l[2],d,v,m,g,y,b;if(u!==0&&(u>0&&i<=-c||u<0&&i>=c)){g=u>0?i>=-c?c:-c:i<=c?-c:c,m=(g-i)/u;if(d===undefined||m<d)y=s+a*m,b=o+f*m,-h<=y&&y<=h&&-p<=b&&b<=p&&(d=m,v=0)}if(a!==0&&(a>0&&s<=-h||a<0&&s>=h)){g=a>0?s>=-h?h:-h:s<=h?-h:h,m=(g-s)/a;if(d===undefined||m<d)y=i+u*m,b=o+f*m,-c<=y&&y<=c&&-p<=b&&b<=p&&(d=m,v=1)}if(f!==0&&(f>0&&o<=-p||f<0&&o>=p)){g=f>0?o>=-p?p:-p:o<=p?-p:p,m=(g-o)/f;if(d===undefined||m<d)y=s+a*m,b=i+u*m,-h<=y&&y<=h&&-c<=b&&b<=c&&(d=m,v=2)}return d!==undefined&&d<e.maxFactor?{hitPoint:t.v3Build(i+u*d,s+a*d,o+f*d),hitNormal:t.v3Build(v===0?u>0?-1:1:0,v===1?a>0?-1:1:0,v===2?f>0?-1:1:0),factor:d}:null},e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[1],i=e[2],s=this.halfExtents,o=s[0],u=s[1],a=s[2];t[0]=n<0?-o:o,t[1]=r<0?-u:u,t[2]=i<0?-a:a},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.halfExtents,u=o[0]+s,a=o[1]+s,f=o[2]+s,l=2*u,c=2*a,h=2*f;return l*=l,c*=c,h*=h,i.center=undefined,i.radius=Math.sqrt(u*u+a*a+f*f),i.halfExtents=t.v3Build(u,a,f),i.inertia=t.v3Build(1/12*(c+h),1/12*(l+h),1/12*(l+c)),i.collisionRadius=s,M(r,"BOX"),r},e.version=1,e}();H.prototype.type="BOX";var B=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=e.maxFactor,c=this.cylinderRadius,h=this.halfHeight,p=c*c,d=u*u+f*f,v=2*(i*u+o*f),m=i*i+o*o-p,g,y=1,b,w,E,S,x,T=v*v-4*d*m;if(T>=0){x=1/(2*d);var N=Math.sqrt(T);g=(-v-N)*x,g<0&&(g+=N*2*x,y=-1),w=s+a*g;if(-h<=w&&w<=h)return 0<=g&&g<=l?(b=i+u*g,E=o+f*g,S=y/c,{factor:g,hitPoint:t.v3Build(b,w,E),hitNormal:t.v3Build(b*S,0,E*S)}):null}if(a*a>=A.COPLANAR_THRESHOLD){S=a<0?-1:1,w=-S*h,x=1/a,g=(w-s)*x,g<0&&(w=S*h,g=(w-s)*x);if(0<=g&&g<=l){b=i+u*g,E=o+f*g;if(b*b+E*E<=p)return{factor:g,hitPoint:t.v3Build(b,w,E),hitNormal:t.v3Build(0,-S,0)}}}return null},e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[2],i=n*n+r*r;if(i===0){e[1]>0?(t[0]=this.cylinderRadius,t[1]=this.halfHeight,t[2]=0):(t[0]=0,t[1]=-this.halfHeight,t[2]=-this.cylinderRadius);return}var s=this.cylinderRadius/Math.sqrt(i);t[0]=n*s,t[1]=(e[1]>0?1:-1)*this.halfHeight,t[2]=r*s},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.halfExtents,u=o[0]+s,a=o[1]+s,f=o[2]+s,l=u*u,c=4*a*a,h=1/12*c+.25*l,p=.5*l;return i.center=undefined,i.radius=Math.sqrt(u*u+a*a+f*f),i.halfExtents=t.v3Build(u,a,f),i.cylinderRadius=o[0],i.halfHeight=o[1],i.inertia=t.v3Build(h,p,h),i.collisionRadius=s,M(r,"CYLINDER"),r},e.version=1,e}();B.prototype.type="CYLINDER";var j=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=e.maxFactor,c=this.coneRadius,h=this.halfHeight,p=c/(2*h);p*=p;var d=s-h,v=u*u+f*f-p*a*a,m=2*(i*u+o*f-p*d*a),g=i*i+o*o-p*d*d,y,b=1,w,E,S,x=m*m-4*v*g;if(x>=0){var T=1/(2*v),N=Math.sqrt(x);y=(-m-N)*T,E=s+a*y;if(y<0||E<-h||E>h){y+=2*N*T,b=-1,E=s+a*y;if(y<0||E<-h||E>h)y=undefined}}var C;if(a!==0){C=(-h-s)/a,w=i+u*C,S=o+f*C;if(C<0||w*w+S*S>c*c)C=undefined}if(C===undefined&&y===undefined)return null;if(C===undefined||y!==undefined&&y<C){if(y>=l)return null;w=i+u*y,E=s+a*y,S=o+f*y;var k=p*(E-h),L=b/Math.sqrt(w*w+k*k+S*S);return{hitPoint:t.v3Build(w,E,S),hitNormal:t.v3Build(L*w,L*k,L*S),factor:y}}return C>=l?null:(w=i+u*C,E=s+a*C,S=o+f*C,{hitPoint:t.v3Build(w,E,S),hitNormal:t.v3Build(0,s<-h?-1:1,0),factor:C})},e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[1],i=e[2],s=Math.sqrt(n*n+i*i);-this.coneRadius*s+2*this.halfHeight*r>0?(t[0]=t[2]=0,t[1]=this.halfHeight):(s===0?(t[0]=this.coneRadius,t[2]=0):(t[0]=n*this.coneRadius/s,t[2]=i*this.coneRadius/s),t[1]=-this.halfHeight)},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.radius,u=n.height,a=.5*u,f=o+s,l=a+s,c=o+s,h=2*f,p=2*l,d=2*c;h*=h,p*=p,d*=d;var v=1/12;return i.halfHeight=a,i.coneRadius=o,i.radius=Math.sqrt(f*f+l*l+c*c),i.halfExtents=t.v3Build(f,l,c),i.inertia=t.v3Build(v*(p+d),v*(h+d),v*(h+p)),i.collisionRadius=s,i.center=undefined,M(r,"CONE"),r},e.version=1,e}();j.prototype.type="CONE";var F=function(){function e(){}return e.create=function(t){var n=new e,r=new I;n._private=r,r._public=n;var i=t.vertices,s=i.length/3,o=t.indices,u=o.length/3,a=t.minExtent,l=t.maxExtent,c,h,p;if(!a||!l){var d=i[0],v=i[1],m=i[2],g=d,y=v,b=m,w=i.length;for(var E=3;E<w;E+=3)c=i[E],h=i[E+1],p=i[E+2],d>c?d=c:g<c&&(g=c),v>h?v=h:y<h&&(y=h),m>p?m=p:b<p&&(b=p);a=[d,v,m],l=[g,y,b]}var S=new Float32Array(6);S[0]=a[0],S[1]=a[1],S[2]=a[2],S[3]=l[0],S[4]=l[1],S[5]=l[2],r.vertices=t.dontCopy?i:new Float32Array(i),r.numVertices=s,r.indices=t.dontCopy?o:s<65536?new Uint16Array(o):new Uint32Array(o),r.numTriangles=u,r.extents=S,Object.defineProperty(n,"vertices",{value:r.vertices,enumerable:!0}),Object.defineProperty(n,"indices",{value:r.indices,enumerable:!0});var x=new Float32Array(I.prototype.TRIANGLE_SIZE*u),T=null;u>=8&&(T=f.create(!0));var N;for(N=0;N<u;N+=1){var C=N*3,k=N*I.prototype.TRIANGLE_SIZE,L=o[C]*3,A=o[C+1]*3,O=o[C+2]*3,M=i[L],_=i[L+1],D=i[L+2],P=i[A],H=i[A+1],B=i[A+2],j=i[O],F=i[O+1],q=i[O+2],R=P-M,U=H-_,z=B-D;c=j-M,h=F-_,p=q-D;var W=U*p-z*h,X=z*c-R*p,V=R*h-U*c,$=1/Math.sqrt(W*W+X*X+V*V),J=(W*M+X*_+V*D)*$,K=R*c+U*h+z*p,Q=R*R+U*U+z*z,G=c*c+h*h+p*p,Y=K*K-Q*G;x[k]=W*$,x[k+1]=X*$,x[k+2]=V*$,x[k+3]=M,x[k+4]=_,x[k+5]=D,x[k+6]=R,x[k+7]=U,x[k+8]=z,x[k+9]=c,x[k+10]=h,x[k+11]=p,x[k+12]=Q,x[k+13]=G,x[k+14]=K,x[k+15]=Y,x[k+16]=J;if(T){S=new Float32Array(6),S[0]=Math.min(M,P,j),S[1]=Math.min(_,H,F),S[2]=Math.min(D,B,q),S[3]=Math.max(M,P,j),S[4]=Math.max(_,H,F),S[5]=Math.max(D,B,q);var Z={index:k};T.add(Z,S)}}return T&&T.finalize(),r.triangles=x,r.spatialMap=T,n},e.version=1,e}(),I=function(){function e(){}return e.prototype.rayTest=function(n){function s(e,n,i,s,o){var u=i.direction,a=u[0],f=u[1],l=u[2],c=i.origin,h=c[0],p=c[1],d=c[2],v=n.index,m=r[v],g=r[v+1],y=r[v+2],b=a*m+f*g+l*y;if(b*b<A.COPLANAR_THRESHOLD)return null;var w=r[v+16],E=r[v+3],S=r[v+4],x=r[v+5],T=(w-(h*m+p*g+d*y))/b;if(T<0||T>=o)return null;b>0&&(m=-m,g=-g,y=-y,b=-b);var N=h+a*T,C=p+f*T,k=d+l*T,L=N-E,O=C-S,M=k-x,_=r[v+12],D=r[v+13],P=r[v+14],H=r[v+15],B=r[v+6],j=r[v+7],F=r[v+8],I=r[v+9],q=r[v+10],R=r[v+11],U=L*B+O*j+M*F,z=L*I+O*q+M*R,W=P*z-D*U;if(W>0||W<H)return null;var X=P*U-_*z;return X>0||W+X<H?null:{factor:T,hitPoint:t.v3Build(N,C,k),hitNormal:t.v3Build(m,g,y)}}var r=this.triangles,i=this.spatialMap;if(i)return f.rayTest([i],n,s);var o=null,u=n.maxFactor,a={index:0},l,c=this.numTriangles*e.prototype.TRIANGLE_SIZE;for(l=0;l<c;l+=e.prototype.TRIANGLE_SIZE){a.index=l;var h=s(null,a,n,0,u);h&&(o=h,u=o.factor)}return o},e.version=1,e}();I.prototype.TRIANGLE_SIZE=17;var q={isPlanar:function(t){var n=A.COPLANAR_THRESHOLD,r=t[0],i=t[1],s=t[2],o=t[3]-r,u=t[4]-i,a=t[5]-s,f=t[6]-r,l=t[7]-i,c=t[8]-s,h=u*c-a*l,p=a*f-o*c,d=o*l-u*f,v=1/Math.sqrt(h*h+p*p+d*d);h*=v,p*=v,d*=v;var m=-(r*h+i*p+s*d),g,y=t.length;for(g=0;g<y;g+=3){var b=t[g]*h+t[g+1]*p+t[g+2]*d+m;if(b*b>n)return!1}return!0},makePlanarConvexHull:function(t){var n=1e-6,r=t[0],i=t[1],s=t[2],o=t[3]-r,u=t[4]-i,a=t[5]-s,f=t[6]-r,l=t[7]-i,c=t[8]-s,h=u*c-a*l,p=a*f-o*c,d=o*l-u*f,v,m,g;h*h+d*d<n?(v=1,m=g=0):(v=-d,m=0,g=h);var y=p*g-d*m,b=d*v-h*g,w=h*m-p*v,E=t.length/3,S=new Float32Array(E*2),x,T,N,C;for(C=0;C<E;C+=1)x=t[C*3],T=t[C*3+1],N=t[C*3+2],S[C*2]=x*v+T*m+N*g,S[C*2+1]=x*y+T*b+N*w;var k=0;r=S[0],i=S[1];for(C=2;C<E*2;C+=2){x=S[C],T=S[C+1];if(x<r||x===r&&T<i)k=C/2,r=x,i=T}var L={};L[k]=0;var A=1,O=[],M=k;for(;;){var _,D,P,H=-1;for(C=0;C<E*2;C+=2){if(C===k*2)continue;x=S[C],T=S[C+1];var B=(x-r)*(x-r)+(T-i)*(T-i);if(H===-1){H=C/2,_=x,D=T,P=B;continue}var j=(_-r)*(T-i)-(D-i)*(x-r);if(j<0||j===0&&B>P)H=C/2,_=x,D=T,P=B}if(H in L)break;L[H]=A,A+=1,k!==M&&(O.push(M),O.push(k),O.push(H)),k=H,r=S[H*2],i=S[H*2+1]}return this.createArray(t,O,L,A)},makeConvexHull:function(t){var n=0,r=t[0],i=t[1],s=t[2],o,u,a,f,l=t.length/3;for(o=3;o<l*3;o+=3){u=t[o],a=t[o+1],f=t[o+2];if(u<r||u===r&&(a<i||a===i&&f<s))n=o/3,r=u,i=a,s=f}var c=-1,h=-2,p=0,d,v;for(o=0;o<l*3;o+=3){if(o===n*3)continue;u=t[o],a=t[o+1],d=u-r,v=a-i;var m=d*d+v*v;if(m===0){c===-1&&(c=o/3);continue}var g=v/Math.sqrt(m);if(g>h||g===h&&m>p)h=g,p=m,c=o/3}var y={},b=[n,c,c,n],w={};w[n]=0,w[c]=1;var E=2,S=[];while(b.length>0){c=b.pop(),n=b.pop();if(n+":"+c in y)continue;var x=-1,T,N,C,k,L;r=t[n*3],i=t[n*3+1],s=t[n*3+2];var O=t[c*3]-r,M=t[c*3+1]-i,_=t[c*3+2]-s,D=1/(O*O+M*M*_*_);for(o=0;o<l*3;o+=3){if(o===n*3||o===c*3)continue;u=t[o],a=t[o+1],f=t[o+2];var P=((u-r)*O+(a-i)*M+(f-s)*_)*D,H=u-(r+O*P),B=a-(i+M*P),j=f-(s+_*P),F=H*H+B*B+j*j;if(F<=A.COLLINEAR_THRESHOLD)continue;if(x===-1){x=o/3,T=H,N=B,C=j,k=F,L=P;continue}var I=B*C-j*N,q=j*T-H*C,R=H*N-B*T,U=H*(M*C-_*N)+B*(_*T-O*C)+j*(O*N-M*T);if(U*U<A.COPLANAR_THRESHOLD)if(H*T+B*N+j*C>=0){if(F>k||F===k&&P>L)x=o/3,T=H,N=B,C=j,k=F,L=P}else{d=u-r,v=a-i;var z=f-s;I=v*_-z*M,q=z*O-d*_,R=d*M-v*O;var W=!0,X;for(X=0;X<l*3;X+=3)if(I*(t[X]-r)+q*(t[X+1]-i)+R*(t[X+2]-s)<0){W=!1;break}W&&(x=o/3,T=H,N=B,C=j,k=F,L=P)}else{var V=I*O+q*M+R*_;if(V<0||V<=A.COLLINEAR_THRESHOLD&&F>k)x=o/3,T=H,N=B,C=j,k=F,L=P}}x in w||(w[x]=E,E+=1),n+":"+c in y||c+":"+x in y||x+":"+n in y||(S.push(n),S.push(c),S.push(x),y[n+":"+c]=!0,y[c+":"+x]=!0,y[x+":"+n]=!0,b.push(x),b.push(c),b.push(n),b.push(x))}return this.createArray(t,S,w,E)},createArray:function(t,n,r,i){var s=new Float32Array(i*3),o=n.length,u=i<65536?new Uint16Array(o):new Uint32Array(o),a=t.length/3,f;for(f=0;f<a;f+=1){if(!(f in r))continue;var l=r[f]*3;s[l]=t[f*3],s[l+1]=t[f*3+1],s[l+2]=t[f*3+2]}for(f=0;f<o;f+=1)u[f]=r[n[f]];return F.create({vertices:s,indices:u,dontCopy:!0})._private}},R=function(){function e(){}return e.prototype.rayTest=function(e){return this.triangleArray.rayTest(e)},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.triangleArray._private,u=o.extents,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d=.5*(c-a)+s,v=.5*(h-f)+s,m=.5*(p-l)+s,g=.5*(a+c),y=.5*(f+h),b=.5*(l+p);return i.triangleArray=o,i.radius=Math.sqrt(d*d+v*v+m*m),i.halfExtents=t.v3Build(d,v,m),g!==0||y!==0||b!==0?i.center=t.v3Build(g,y,b):i.center=undefined,i.inertia=t.v3Build(0,0,0),i.collisionRadius=s,M(r,"TRIANGLE_MESH"),Object.defineProperty(r,"triangleArray",{get:function(){return this._private.triangleArray},enumerable:!0}),r},e.version=1,e}();R.prototype.type="TRIANGLE_MESH";var U=function(){function e(){}return e.prototype.rayTest=function(e){var t=this.triangleArray;return t===undefined?null:t.rayTest(e)},e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[1],i=e[2],s=this.supportTopology,o=this.triangleArray.vertices;this.lastSupport===undefined&&(this.lastSupport=0);var u=this.lastSupport,a=s[u],f=o[a]*n+o[a+1]*r+o[a+2]*i;for(;;){var l=-1,c,h=s[u+1];for(c=0;c<h;c+=1){var p=s[u+2+c];a=s[p];var d=o[a]*n+o[a+1]*r+o[a+2]*i;d>f&&(f=d,l=p)}if(l!==-1){u=l;continue}break}this.lastSupport=u,a=s[u],t[0]=o[a],t[1]=o[a+1],t[2]=o[a+2]},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.points,u=o[0],a=o[1],f=o[2],l=u,c=a,h=f,p=o.length,d,v,m,g;for(d=3;d<p;d+=3)v=o[d],m=o[d+1],g=o[d+2],u>v?u=v:l<v&&(l=v),a>m?a=m:c<m&&(c=m),f>g?f=g:h<g&&(h=g);var y=.5*(l-u)+s,b=.5*(c-a)+s,w=.5*(h-f)+s,E=.5*(u+l),S=.5*
(a+c),x=.5*(f+h),T=2*y,N=2*b,C=2*w;T*=T,N*=N,C*=C;var k=1/12;i.points=new Float32Array(o),i.radius=Math.sqrt(y*y+b*b+w*w),i.halfExtents=t.v3Build(y,b,w),E!==0||S!==0||x!==0?i.center=t.v3Build(E,S,x):i.center=undefined,i.inertia=t.v3Build(k*(N+C),k*(T+C),k*(T+N)),i.collisionRadius=s;if(o.length<9)throw"At present time, WebGL PhysicsDevice does not permit a convex hull to contain less than 3 vertices";var A=q.isPlanar(o);A?i.triangleArray=q.makePlanarConvexHull(o):i.triangleArray=q.makeConvexHull(o);var O=[];o=i.triangleArray.vertices,p=o.length;for(d=0;d<p;d+=3)O[d/3]=[];var _;if(A)for(d=0;d<p/3;d+=1)_=(d+1)%(p/3),O[d].push(_),O[_].push(d);else{var D=i.triangleArray.indices;p=D.length;for(d=0;d<p;d+=3){var P=D[d],H=D[d+1],B=D[d+2];O[P].push(H),O[H].push(B),O[B].push(P)}}p=o.length;if(A&&p>=18||!A&&p>=30)for(d=0;d<p;d+=3){var j=Number.MAX_VALUE;v=o[d],m=o[d+1],g=o[d+2];var F;for(_=0;_<p;_+=3){var I=v*o[_]+m*o[_+1]+g*o[_+2];I<j&&(j=I,F=_)}O[d/3].push(F/3)}var R=[],U=0;for(d=0;d<p/3;d+=1)R.push(U),U+=O[d].length+2;i.supportTopology=U>65536?new Int32Array(U):new Int16Array(U);var z=0;for(d=0;d<p/3;d+=1){i.supportTopology[z]=d*3,z+=1;var W=O[d];i.supportTopology[z]=W.length,z+=1;for(_=0;_<W.length;_+=1)i.supportTopology[z]=R[W[_]],z+=1}return M(r,"CONVEX_HULL"),r},e.version=1,e}();U.prototype.type="CONVEX_HULL";var z=function(){function e(n,r){this._public=r,this.id=e.uniqueId,e.uniqueId+=1,this.world=null,this.shape=n.shape._private,this.friction=n.friction!==undefined?n.friction:.5,this.restitution=n.restitution!==undefined?n.restitution:0;var i=n.transform;this.transform=i?t.m43Copy(i):t.m43BuildIdentity(),this.arbiters=[],this.constraints=[],this.velocity=new Float32Array(12);var s=n.linearVelocity;s&&(this.velocity[0]=s[0],this.velocity[1]=s[1],this.velocity[2]=s[2]),s=n.angularVelocity,s&&(this.velocity[3]=s[0],this.velocity[4]=s[1],this.velocity[5]=s[2]),this.linearDamping=n.linearDamping!==undefined?n.linearDamping:0,this.angularDamping=n.angularDamping!==undefined?n.angularDamping:0,this.extents=new Float32Array(6),this.startTransform=t.m43BuildIdentity(),this.endTransform=t.m43BuildIdentity(),this.prevTransform=t.m43Copy(this.transform),this.newTransform=t.m43BuildIdentity(),this.island=null,this.islandRoot=this,this.islandRank=0,this.delaySleep=!0,this.group=0,this.mask=0,this.kinematic=!1,this.fixedRotation=!1,this.mass=0,this.inverseMass=0,this.inverseInertiaLocal=null,this.inverseInertia=null,this.collisionObject=!1,this.permitSleep=!1,this.sweepFrozen=!1,this.active=!1,this.contactCallbacks=null}return e.prototype.computeDeltaVelocity=function(e,n,r,i){var s=i||this.velocity,o=!1;s[0]=r[9]-n[9],s[1]=r[10]-n[10],s[2]=r[11]-n[11];if(s[0]!==0||s[1]!==0||s[2]!==0)o=!0;s[0]/=e,s[1]/=e,s[2]/=e;var u=n[0]*r[0]+n[3]*r[3]+n[6]*r[6],a=n[0]*r[1]+n[3]*r[4]+n[6]*r[7],f=n[0]*r[2]+n[3]*r[5]+n[6]*r[8],l=n[1]*r[0]+n[4]*r[3]+n[7]*r[6],c=n[1]*r[1]+n[4]*r[4]+n[7]*r[7],h=n[1]*r[2]+n[4]*r[5]+n[7]*r[8],p=n[2]*r[0]+n[5]*r[3]+n[8]*r[6],d=n[2]*r[1]+n[5]*r[4]+n[8]*r[7],v=n[2]*r[2]+n[5]*r[5]+n[8]*r[8],m,g,y,b,w,E=u+c+v+1;E>t.precision?(b=Math.sqrt(E)/2,m=(h-d)/(4*b),g=(p-f)/(4*b),y=(a-l)/(4*b)):u>c&&u>v?(w=Math.sqrt(1+u-c-v)*2,b=(h-d)/w,m=.25*w,g=(l+a)/w,y=(p+f)/w):c>v?(w=Math.sqrt(1+c-u-v)*2,b=(p-f)/w,m=(l+a)/w,g=.25*w,y=(d+h)/w):(w=Math.sqrt(1+v-u-c)*2,b=(a-l)/w,m=(p+f)/w,g=(d+h)/w,y=.25*w);var S=Math.acos(b)*2,x=1-b*b;if(x<t.precision||S===0)s[3]=s[4]=s[5]=0;else{var T=S/(e*Math.sqrt(x));s[3]=m*T,s[4]=g*T,s[5]=y*T,o=!0}return o},e.prototype.calculateSweptExtents=function(e){var t=this.shape,n=t.radius,r=this.startTransform,i=r[9],s=r[10],o=r[11],u=this.transform,a=u[9],f=u[10],l=u[11],c;i>a&&(c=i,i=a,a=c),s>f&&(c=s,s=f,f=c),o>l&&(c=o,o=l,l=c),e[0]=i-n,e[1]=s-n,e[2]=o-n,e[3]=a+n,e[4]=f+n,e[5]=l+n},e.prototype.calculateExtents=function(e){var t=this.shape,n=t.center,r=t.halfExtents,i=r[0],s=r[1],o=r[2],u=this.transform,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d=u[6],v=u[7],m=u[8],g=u[9],y=u[10],b=u[11];if(n){var w=n[0],E=n[1],S=n[2];if(w!==0||E!==0||S!==0)g+=a*w+c*E+d*S,y+=f*w+h*E+v*S,b+=l*w+p*E+m*S}var x=(a<0?-a*i:a>0?a*i:0)+(c<0?-c*s:c>0?c*s:0)+(d<0?-d*o:d>0?d*o:0),T=(f<0?-f*i:f>0?f*i:0)+(h<0?-h*s:h>0?h*s:0)+(v<0?-v*o:v>0?v*o:0),N=(l<0?-l*i:l>0?l*i:0)+(p<0?-p*s:p>0?p*s:0)+(m<0?-m*o:m>0?m*o:0);e[0]=g-x,e[1]=y-T,e[2]=b-N,e[3]=g+x,e[4]=y+T,e[5]=b+N},e.prototype.rayTest=function(e){var n=this.transform,r={origin:at.prototype.m43InverseOrthonormalTransformPoint(n,e.origin),direction:at.prototype.m43InverseOrthonormalTransformVector(n,e.direction),maxFactor:e.maxFactor},i=this.shape.rayTest(r);return i!==null&&(i.hitPoint=t.m43TransformPoint(n,i.hitPoint,i.hitPoint),i.hitNormal=t.m43TransformVector(n,i.hitNormal,i.hitNormal)),i},e.prototype.integratePositionWithVelocities=function(e,t,n,r){var i=this.velocity,s=Math.sqrt;t[9]=e[9]+n*i[r],t[10]=e[10]+n*i[r+1],t[11]=e[11]+n*i[r+2];var o=i[r+3]*n,u=i[r+4]*n,a=i[r+5]*n,f=e[0],l=e[1],c=e[2],h=e[3],p=e[4],d=e[5],v=e[6],m=e[7],g=e[8],y=f-a*l+u*c,b=l+a*f-o*c,w=c-u*f+o*l,E=h-a*p+u*d,S=p+a*h-o*d,x=d-u*h+o*p,T=v-a*m+u*g,N=m+a*v-o*g,C=g-u*v+o*m,k=1/s(y*y+b*b+w*w);y*=k,b*=k,w*=k,k=-(y*E+b*S+w*x),E+=y*k,S+=b*k,x+=w*k,k=1/s(E*E+S*S+x*x),E*=k,S*=k,x*=k,k=-(y*T+b*N+w*C),T+=y*k,N+=b*k,C+=w*k,k=-(E*T+S*N+x*C),T+=E*k,N+=S*k,C+=x*k,k=1/s(T*T+N*N+C*C),T*=k,N*=k,C*=k,t[0]=y,t[1]=b,t[2]=w,t[3]=E,t[4]=S,t[5]=x,t[6]=T,t[7]=N,t[8]=C},e.prototype.applyBiasVelocities=function(e){var t=this.velocity;this.integratePositionWithVelocities(this.transform,this.startTransform,e,6),t[6]=t[7]=t[8]=0,t[9]=t[10]=t[11]=0},e.prototype.integratePosition=function(e){this.integratePositionWithVelocities(this.startTransform,this.transform,e,0)},e.prototype.refreshInertiaTensor=function(){var e=this.transform,t=this.inverseInertiaLocal,n=t[0],r=t[1],i=t[2],s=e[0],o=e[1],u=e[2],a=e[3],f=e[4],l=e[5],c=e[6],h=e[7],p=e[8],d=this.inverseInertia;d[0]=s*s*n+a*a*r+c*c*i,d[1]=s*o*n+a*f*r+c*h*i,d[2]=s*u*n+a*l*r+c*p*i,d[3]=o*s*n+f*a*r+h*c*i,d[4]=o*o*n+f*f*r+h*h*i,d[5]=o*u*n+f*l*r+h*p*i,d[6]=u*s*n+l*a*r+p*c*i,d[7]=u*o*n+l*f*r+p*h*i,d[8]=u*u*n+l*l*r+p*p*i},e.prototype.integrateVelocity=function(e,t){var n=this.velocity,r=Math.pow,i=r(1-this.linearDamping,t);n[0]=(n[0]+t*e[0])*i,n[1]=(n[1]+t*e[1])*i,n[2]=(n[2]+t*e[2])*i;var s=r(1-this.angularDamping,t),o=n[3]*s,u=n[4]*s,a=n[5]*s,f=A.MAX_ANGULAR/t,l=o*o+u*u+a*a;if(l>f*f){var c=f/Math.sqrt(l);o*=c,u*=c,a*=c}n[3]=o,n[4]=u,n[5]=a},e.prototype.isActiveVelocity=function(e,t){var n=this.shape.radius,r=this.velocity,i=r[0],s=r[1],o=r[2],u=i*i+s*s+o*o;return u>e*n*n?!0:(i=r[3],s=r[4],o=r[5],i*i+s*s+o*o>t?!0:!1)},e.prototype.isActive=function(){return this.permitSleep?this.isActiveVelocity(A.SLEEP_LINEAR_SQ,A.SLEEP_ANGULAR_SQ)?(this.wakeTimeStamp=this.world.timeStamp,!0):this.wakeTimeStamp+A.SLEEP_DELAY>this.world.timeStamp:!0},e.version=1,e.uniqueId=0,e}(),W=function(){function e(){}return e.prototype.calculateExtents=function(e){this._private.calculateExtents(e)},e.prototype.calculateTransform=function(e,n){var r=this._private.transform;n?t.m43NegOffset(r,n,e):(e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11])},e.prototype.clone=function(){return e.create(this)},e.create=function(n){var r=new e,i=new z(n,r);r._private=i,r.userData="userData"in n?n.userData:null,Object.defineProperty(r,"shape",{value:n.shape,enumerable:!0});var s=n.kinematic!==undefined?n.kinematic:!1;Object.defineProperty(r,"transform",{get:function(){return t.m43Copy(this._private.transform)},set:function(n){var r=this._private;if(r.kinematic||!r.world)t.m43Copy(n,r.transform),r.world&&r.world.wakeBody(r)},enumerable:!0});var o=n.group!==undefined?n.group:ft.prototype.FILTER_STATIC;Object.defineProperty(r,"group",{value:o,enumerable:!0});var u=n.mask!==undefined?n.mask:ft.prototype.FILTER_ALL^ft.prototype.FILTER_STATIC;return Object.defineProperty(r,"mask",{value:u,enumerable:!0}),Object.defineProperty(r,"friction",{get:function(){return this._private.friction},set:function(t){var n=this._private;n.friction=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"restitution",{get:function(){return this._private.restitution},set:function(t){var n=this._private;n.restitution=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"kinematic",{value:s,enumerable:!0}),i.group=o,i.mask=u,i.kinematic=s,i.fixedRotation=!s,i.mass=0,i.inverseMass=0,i.inverseInertiaLocal=e.sharedInverseInertiaLocal,i.inverseInertia=e.sharedInverseInertia,i.collisionObject=!0,i.permitSleep=!1,i.sweepFrozen=!0,i.active=s,n.onPreSolveContact||n.onAddedContacts||n.onProcessedContacts||n.onRemovedContacts?i.contactCallbacks=new X(n,u):i.contactCallbacks=null,r},e.version=1,e.sharedInverseInertiaLocal=t.v3BuildZero(),e.sharedInverseInertia=new Float32Array([0,0,0,0,0,0,0,0,0]),e}(),X=function(){function e(e,t){return this.mask=e.contactCallbacksMask!==undefined?e.contactCallbacksMask:t,this.added=!1,this.deferred=e.onAddedContacts||e.onProcessedContacts||e.onRemovedContacts,this.onPreSolveContact=e.onPreSolveContact||null,this.onAddedContacts=e.onAddedContacts||null,this.onProcessedContacts=e.onProcessedContacts||null,this.onRemovedContacts=e.onRemovedContacts||null,this.trigger=e.trigger||!1,this}return e}(),V=function(){function e(){this.calculateExtents=W.prototype.calculateExtents,this.calculateTransform=W.prototype.calculateTransform}return e.prototype.clone=function(){return e.create(this)},e.create=function(n){var r=new e,i=new z(n,r);r._private=i,r.userData="userData"in n?n.userData:null,Object.defineProperty(r,"shape",{value:n.shape,enumerable:!0}),Object.defineProperty(r,"linearVelocity",{get:function(){var n=this._private.velocity;return t.v3Build(n[0],n[1],n[2])},set:function(t){var n=this._private.velocity;n[0]=t[0],n[1]=t[1],n[2]=t[2]},enumerable:!0}),Object.defineProperty(r,"angularVelocity",{get:function(){var n=this._private.velocity;return t.v3Build(n[3],n[4],n[5])},set:function(t){var n=this._private.velocity;n[3]=t[0],n[4]=t[1],n[5]=t[2]},enumerable:!0}),Object.defineProperty(r,"transform",{get:function(){return t.m43Copy(this._private.transform)},set:function(n){var r=this._private;t.m43Copy(n,r.transform);var i=r.arbiters,s,o=i.length;for(s=0;s<o;s+=1)i[s].skipDiscreteCollisions=!1},enumerable:!0}),Object.defineProperty(r,"active",{get:function(){return this._private.active},set:function(t){var n=this._private;if(t===n.active)n.world&&t&&(n.wakeTimeStamp=n.world.timeStamp);else if(n.world)if(t)n.world.wakeBody(n);else{var r=n.world.activeBodies;r[r.indexOf(n)]=r[r.length-1],r.pop(),n.active=!1;var i=n.arbiters,s,o=i.length;for(s=0;s<o;s+=1){var u=i[s];if(!u.active)continue;u.active=!1;var a=n.world.activeArbiters;a[a.indexOf(u)]=a[a.length-1],a.pop()}n.world.syncBody(n)}else n.active=t},enumerable:!0});var s=n.group!==undefined?n.group:ft.prototype.FILTER_DYNAMIC;Object.defineProperty(r,"group",{value:s,enumerable:!0});var o=n.mask!==undefined?n.mask:ft.prototype.FILTER_ALL;Object.defineProperty(r,"mask",{value:o,enumerable:!0}),Object.defineProperty(r,"friction",{get:function(){return this._private.friction},set:function(t){var n=this._private;n.friction=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"restitution",{get:function(){return this._private.restitution},set:function(t){var n=this._private;n.restitution=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"linearDamping",{get:function(){return this._private.linearDamping},set:function(t){this._private.linearDamping=t},enumerable:!0}),Object.defineProperty(r,"angularDamping",{get:function(){return this._private.angularDamping},set:function(t){this._private.angularDamping=t},enumerable:!0});var u=n.kinematic!==undefined?n.kinematic:!1;Object.defineProperty(r,"kinematic",{value:u,enumerable:!0});var a=n.mass!==undefined?n.mass:1;Object.defineProperty(r,"mass",{value:a,enumerable:!0});var f=n.inertia?t.v3Copy(n.inertia):t.v3ScalarMul(n.shape.inertia,a);return Object.defineProperty(r,"inertia",{get:function(){return t.v3Copy(f)},enumerable:!0}),i.group=s,i.mask=o,i.active=n.active!==undefined?n.active:n.frozen!==undefined?!n.frozen:!0,i.kinematic=u,i.fixedRotation=u||(n.fixedRotation!==undefined?n.fixedRotation:!1),i.inverseInertiaLocal=i.fixedRotation?t.v3BuildZero():t.v3Build(1/f[0],1/f[1],1/f[2]),i.inverseInertia=t.m33BuildIdentity(),i.mass=a,i.inverseMass=u?0:1/i.mass,i.collisionObject=!1,i.permitSleep=n.permitSleep!==undefined?n.permitSleep:!u,i.sweepFrozen=u,n.onPreSolveContact||n.onAddedContacts||n.onProcessedContacts||n.onRemovedContacts?i.contactCallbacks=new X(n,o):i.contactCallbacks=null,r},e.version=1,e}(),$=function(){function e(){}return e.prototype.preStep=function(e,t){},e.prototype.applyCachedImpulses=function(){},e.prototype.computeAndApplyImpulses=function(){},e.create=function(t,n){var r=new e;return r.world=null,r.userData=null,O(r,n),r.type=t,r},e.version=1,e}(),J=function(t,n){t.userData=n.userData;var r=t._private;r.world=null,r.bodyA=n.bodyA._private,Object.defineProperty(t,"bodyA",{value:n.bodyA,enumerable:!0}),r.bodyB=n.bodyB?n.bodyB._private:null,Object.defineProperty(t,"bodyB",{value:n.bodyB,enumerable:!0}),r.active=n.active!==undefined?n.active:!0,Object.defineProperty(t,"active",{get:function(){return this._private.active},set:function(t){var n=this._private;if(t===n.active)n.world&&t&&(n.wakeTimeStamp=n.world.timeStamp);else if(n.world)if(t)n.world.wakeConstraint(n);else{var r=n.world.activeConstraints;r[r.indexOf(n)]=r[r.length-1],r.pop(),n.active=!1}else n.active=t},enumerable:!0})},K=function(){function e(){}return e.create=function(n){var r=new e,i=new Q;r._private=i,J(r,n);var s=i.data;s[0]=n.pivotA[0],s[1]=n.pivotA[1],s[2]=n.pivotA[2],Object.defineProperty(r,"pivotA",{get:function(){var n=this._private.data;return t.v3Build(n[0],n[1],n[2])},set:function(t){var n=this._private.data;n[0]=t[0],n[1]=t[1],n[2]=t[2]},enumerable:!0});if(n.pivotB)s[3]=n.pivotB[0],s[4]=n.pivotB[1],s[5]=n.pivotB[2];else{var o=t.m43TransformPoint(i.bodyA.transform,n.pivotA);s[3]=o[0],s[4]=o[1],s[5]=o[2]}return Object.defineProperty(r,"pivotB",{get:function(){var n=this._private.data;return t.v3Build(n[3],n[4],n[5])},set:function(t){var n=this._private.data;n[3]=t[0],n[4]=t[1],n[5]=t[2]},enumerable:!0}),s[30]=n.force!==undefined?n.force:.3,Object.defineProperty(r,"force",{get:function(){return this._private.data[30]},set:function(t){this._private.data[30]=t},enumerable:!0}),s[31]=n.damping!==undefined?n.damping:1,Object.defineProperty(r,"damping",{get:function(){return this._private.data[31]},set:function(t){this._private.data[31]=t},enumerable:!0}),s[32]=n.impulseClamp!==undefined?n.impulseClamp:0,Object.defineProperty(r,"impulseClamp",{get:function(){return this._private.data[32]},set:function(t){this._private.data[32]=t},enumerable:!0}),r},e.version=1,e}();K.prototype.type="POINT2POINT";var Q=function(){function e(){return this.bodyA=null,this.bodyB=null,this.data=new Float32Array(46),this}return e.prototype.preStep=function(e,t){var n=this.bodyA,r=this.bodyB,i=this.data,s=i[0],o=i[1],u=i[2],a=i[3],f=i[4],l=i[5],c=n.transform,h=i[6]=c[0]*s+c[3]*o+c[6]*u,p=i[7]=c[1]*s+c[4]*o+c[7]*u,d=i[8]=c[2]*s+c[5]*o+c[8]*u,v,m,g,y;r&&(y=r.transform,v=i[9]=y[0]*a+y[3]*f+y[6]*l,m=i[10]=y[1]*a+y[4]*f+y[7]*l,g=i[11]=y[2]*a+y[5]*f+y[8]*l);var b=n.inverseInertia;i[12]=-d*b[3]+p*b[6],i[13]=-d*b[4]+p*b[7],i[14]=-d*b[5]+p*b[8],i[15]=d*b[0]+ -h*b[6],i[16]=d*b[1]+ -h*b[7],i[17]=d*b[2]+ -h*b[8],i[18]=-p*b[0]+h*b[3],i[19]=-p*b[1]+h*b[4],i[20]=-p*b[2]+h*b[5];var w=n.inverseMass+(r?r.inverseMass:0),E=w+i[13]*-d+i[14]*p,S=w+i[15]*d+i[17]*-h,x=w+i[18]*-p+i[19]*h,T=i[12]*d+i[14]*-h,N=i[12]*-p+i[13]*h,C=i[15]*-p+i[16]*h;r&&(b=r.inverseInertia,i[21]=-g*b[3]+m*b[6],i[22]=-g*b[4]+m*b[7],i[23]=-g*b[5]+m*b[8],i[24]=g*b[0]+ -v*b[6],i[25]=g*b[1]+ -v*b[7],i[26]=g*b[2]+ -v*b[8],i[27]=-m*b[0]+v*b[3],i[28]=-m*b[1]+v*b[4],i[29]=-m*b[2]+v*b[5],E+=i[22]*-g+i[23]*m,S+=i[24]*g+i[26]*-v,x+=i[27]*-m+i[28]*v,T+=i[21]*g+i[23]*-v,N+=i[21]*-m+i[22]*v,C+=i[24]*-m+i[25]*v);var k=i[30],L=2/t*k*i[31]/(1-k),A=k/(L*L),O=1/(1+A);i[33]=1-A*O;var M=S*x-C*C,_=N*C-T*x,D=T*C-N*S,P=O/(E*M+T*_+N*D);i[34]=P*M,i[35]=P*_,i[36]=P*D,i[37]=P*(E*x-N*N),i[38]=P*(T*N-E*C),i[39]=P*(E*S-T*T);var H=h+c[9],B=p+c[10],j=d+c[11];r?(H-=v+y[9],B-=m+y[10],j-=g+y[11]):(H-=a,B-=f,j-=l);var F=-k/t;i[43]=H*F,i[44]=B*F,i[45]=j*F,i[40]*=e,i[41]*=e,i[42]*=e},e.prototype.applyCachedImpulses=function(){var e=this.data,t=e[40],n=e[41],r=e[42],i=this.bodyA,s=i.velocity,o=i.inverseMass;s[0]+=t*o,s[1]+=n*o,s[2]+=r*o,s[3]-=e[12]*t+e[15]*n+e[18]*r,s[4]-=e[13]*t+e[16]*n+e[19]*r,s[5]-=e[14]*t+e[17]*n+e[20]*r;var u=this.bodyB;u&&(s=u.velocity,o=u.inverseMass,s[0]-=t*o,s[1]-=n*o,s[2]-=r*o,s[3]+=e[21]*t+e[24]*n+e[27]*r,s[4]+=e[22]*t+e[25]*n+e[28]*r,s[5]+=e[23]*t+e[26]*n+e[29]*r)},e.prototype.computeAndApplyImpulses=function(){var e=this.bodyA,t=this.bodyB,n=this.data,r=n[40],i=n[41],s=n[42],o=e.velocity,u=n[43]-(o[0]+o[4]*n[8]-o[5]*n[7]),a=n[44]-(o[1]+o[5]*n[6]-o[3]*n[8]),f=n[45]-(o[2]+o[3]*n[7]-o[4]*n[6]),l;t&&(l=t.velocity,u+=l[0]+l[4]*n[11]-l[5]*n[10],a+=l[1]+l[5]*n[9]-l[3]*n[11],f+=l[2]+l[3]*n[10]-l[4]*n[9]);var c=n[33];r=r*c+n[34]*u+n[35]*a+n[36]*f,i=i*c+n[35]*u+n[37]*a+n[38]*f,s=s*c+n[36]*u+n[38]*a+n[39]*f;var h=n[32];if(h!==0){var p=r*r+i*i+s*s;p>h*h&&(p=h/Math.sqrt(p),r*=p,i*=p,s*=p)}var d=r-n[40],v=i-n[41],m=s-n[42];n[40]=r,n[41]=i,n[42]=s;var g=e.inverseMass;o[0]+=d*g,o[1]+=v*g,o[2]+=m*g,o[3]-=n[12]*d+n[15]*v+n[18]*m,o[4]-=n[13]*d+n[16]*v+n[19]*m,o[5]-=n[14]*d+n[17]*v+n[20]*m,t&&(g=t.inverseMass,l[0]-=d*g,l[1]-=v*g,l[2]-=m*g,l[3]+=n[21]*d+n[24]*v+n[27]*m,l[4]+=n[22]*d+n[25]*v+n[28]*m,l[5]+=n[23]*d+n[26]*v+n[29]*m)},e}(),G=function(){function e(){}return e.prototype.jump=function(){var e=this._private,t=e.rigidBody._private,n=t.world;n&&(t.velocity[1]=Math.sqrt(-2*(this.maxJumpHeight-this.stepHeight)*n.gravity[1]),t.transform[10]+=this.stepHeight,n.wakeBody(t))},e.prototype.calculateExtents=function(e){this._private.rigidBody.calculateExtents(e)},e.prototype.calculateTransform=function(e,t){this._private.rigidBody.calculateTransform(e,t)},e.create=function(n){var r=new e,i=new Y;r._private=i,r.userData=n.userData!==undefined?n.userData:null,Object.defineProperty(r,"crouch",{get:function(){return this._private.crouch},set:function(t){var n=this._private;if(!n.dead&&t!==n.crouch){var r=n.rigidBody._private,i=r.shape;n.crouch=t,t?(i.halfHeight=this.crouchHeight*.5-this.radius,r.transform[10]-=(this.height-this.crouchHeight)*.5):(i.halfHeight=this.height*.5-this.radius,r.transform[10]+=(this.height-this.crouchHeight)*.5),r.world&&r.world.wakeBody(r)}},enumerable:!0}),Object.defineProperty(r,"dead",{get:function(){return this._private.dead},set:function(t){var n=this._private;if(n.dead!==t){var r=n.rigidBody._private,i=r.shape;n.dead=t,t?(i.halfHeight=0,r.transform[10]-=(this.height-this.radius)*.5):(i.halfHeight=this.height*.5-this.radius,r.transform[10]+=(this.height-this.radius)*.5),r.world&&r.world.wakeBody(r)}},enumerable:!0}),Object.defineProperty(r,"height",{value:n.height,enumerable:!0}),Object.defineProperty(r,"radius",{value:n.radius,enumerable:!0}),Object.defineProperty(r,"stepHeight",{value:n.stepHeight!==undefined?n.stepHeight:.35,enumerable:!0}),r.maxJumpHeight=n.maxJumpHeight!==undefined?n.maxJumpHeight:1,Object.defineProperty(r,"crouchHeight",{value:n.crouchHeight!==undefined?n.crouchHeight:.5*n.height,enumerable:!0}),Object.defineProperty(r,"onGround",{get:function(){var t=this._private,n=t.rigidBody._private;if(n.world){var r=n.transform,i=t.start,s=t.end;i[9]=r[9],i[10]=r[10],i[11]=r[11],s[9]=r[9],s[10]=r[10]-this.stepHeight*.5,s[11]=r[11];var o=n.world.convexSweepTest({shape:n.shape._public,from:i,to:s,group:ft.prototype.FILTER_CHARACTER},this.onGroundConvexCallback);return o!==null}return!1},enumerable:!0}),Object.defineProperty(r,"position",{get:function(){var n=this._private.rigidBody;return t.m43Pos(n._private.transform)},set:function(t){var n=this._private.rigidBody,r=n._private.transform;r[9]=t[0],r[10]=t[1],r[11]=t[2],n.transform=n._private.transform,n.active=!0},enumerable:!0}),Object.defineProperty(r,"velocity",{get:function(){var t=this._private.rigidBody;return t.linearVelocity},set:function(t){var n=this._private.rigidBody;n.linearVelocity=t,n.active=!0},enumerable:!0});var s=n.group!==undefined?n.group:ft.prototype.FILTER_CHARACTER;Object.defineProperty(r,"group",{value:s,enumerable:!0});var o=n.mask!==undefined?n.mask:ft.prototype.FILTER_ALL;Object.defineProperty(r,"mask",{value:o,enumerable:!0});var u=D.create({radius:r.radius,height:2*(r.height*.5-r.radius),margin:0}),a=V.create({shape:u,mass:n.mass,transform:n.transform,linearVelocity:n.velocity,group:s,mask:o,friction:n.friction,restitution:n.restitution,linearDamping:n.linearDamping,angularDamping:n.angularDamping,fixedRotation:!0});return i.rigidBody=a,a._private._public=r,r},e.version=1,e}(),Y=function(){function e(){return this.crouch=!1,this.dead=!1,this.start=t.m43BuildIdentity(),this.end=t.m43BuildIdentity(),this.rigidBody=null,this}return e.prototype.onGroundConvexCallback=function(e){return e.hitNormal[1]>=.26},e.version=1,e}(),Z=function(){function e(){}return e.prototype.removeVertex=function(e){this.numVertices-=1;var t=this.simplex,n=e*9,r=this.numVertices*9;t[n]=t[r],t[n+1]=t[r+1],t[n+2]=t[r+2],t[n+3]=t[r+3],t[n+4]=t[r+4],t[n+5]=t[r+5],t[n+6]=t[r+6],t[n+7]=t[r+7],t[n+8]=t[r+8]},e.prototype.reduceVertices=function(e){this.numVertices>=4&&e[3]===0&&(this.numVertices-=1);var t=this.simplex,n;this.numVertices>=3&&e[2]===0&&(this.numVertices-=1,n=this.numVertices*9,t[18]=t[n],t[19]=t[n+1],t[20]=t[n+2],t[21]=t[n+3],t[22]=t[n+4],t[23]=t[n+5],t[24]=t[n+6],t[25]=t[n+7],t[26]=t[n+8]),this.numVertices>=2&&e[1]===0&&(this.numVertices-=1,n=this.numVertices*9,t[9]=t[n],t[10]=t[n+1],t[11]=t[n+2],t[12]=t[n+3],t[13]=t[n+4],t[14]=t[n+5],t[15]=t[n+6],t[16]=t[n+7],t[17]=t[n+8]),this.numVertices>=1&&e[0]===0&&(this.numVertices-=1,n=this.numVertices*9,t[0]=t[n],t[1]=t[n+1],t[2]=t[n+2],t[3]=t[n+3],t[4]=t[n+4],t[5]=t[n+5],t[6]=t[n+6],t[7]=t[n+7],t[8]=t[n+8])},e.prototype.updateClosestPoints=function(){var e=this.numVertices;if(e===0)return!1;var t=this.simplex,n=this.closest,r;if(e===1)return n[0]=t[3],n[1]=t[4],n[2]=t[5],n[3]=t[6],n[4]=t[7],n[5]=t[8],!0;var i=t[0],s=t[1],o=t[2],u=t[9],a=t[10],f=t[11];if(e===2){var l=i-u,c=s-a,h=o-f,p=i*l+s*c+o*h;if(p>0){var d=l*l+c*c+h*h;if(p<d){p/=d;var v=1-p;return n[0]=t[3]*v+t[12]*p,n[1]=t[4]*v+t[13]*p,n[2]=t[5]*v+t[14]*p,n[3]=t[6]*v+t[15]*p,n[4]=t[7]*v+t[16]*p,n[5]=t[8]*v+t[17]*p,!0}this.removeVertex(0)}else this.removeVertex(1);for(r=0;r<6;r+=1)n[r]=t[r+3];return!0}var m=this.cachedCoords,g,y,b;if(e===3)return this.closestPointTriangle(0,9,18,m),this.reduceVertices(m),g=m[0],y=m[1],b=m[2],n[0]=g*t[3]+y*t[12]+b*t[21],n[1]=g*t[4]+y*t[13]+b*t[22],n[2]=g*t[5]+y*t[14]+b*t[23],n[3]=g*t[6]+y*t[15]+b*t[24],n[4]=g*t[7]+y*t[16]+b*t[25],n[5]=g*t[8]+y*t[17]+b*t[26],!0;if(e===4){var w=this.closestPointTetrahedron(m);if(w){this.reduceVertices(m),g=m[0],y=m[1],b=m[2];var E=m[3];return n[0]=g*t[3]+y*t[12]+b*t[21]+E*t[30],n[1]=g*t[4]+y*t[13]+b*t[22]+E*t[31],n[2]=g*t[5]+y*t[14]+b*t[23]+E*t[32],n[3]=g*t[6]+y*t[15]+b*t[24]+E*t[33],n[4]=g*t[7]+y*t[16]+b*t[25]+E*t[34],n[5]=g*t[8]+y*t[17]+b*t[26]+E*t[35],!0}return!1}return!1},e.prototype.closestPointTetrahedron=function(e){var t=this.simplex,n=t[0],r=t[1],i=t[2],s=t[9],o=t[10],u=t[11],a=t[18],f=t[19],l=t[20],c=t[27],h=t[28],p=t[29],d=s-n,v=o-r,m=u-i,g=a-n,y=f-r,b=l-i,w=c-n,E=h-r,S=p-i,x=a-s,T=f-o,N=l-u,C=c-s,k=h-o,L=p-u,A,O,M,_,D;A=v*b-m*y,O=m*g-d*b,M=d*y-v*g,_=w*A+E*O+S*M,D=-(n*A+r*O+i*M);var P=D*_<=0;A=y*S-b*E,O=b*w-g*S,M=g*E-y*w,_=d*A+v*O+m*M,D=-(n*A+r*O+i*M);var H=D*_<=0;A=E*m-S*v,O=S*d-w*m,M=w*v-E*d,_=g*A+y*O+b*M,D=-(n*A+r*O+i*M);var B=D*_<=0;A=k*N-L*T,O=L*x-C*N,M=C*T-k*x,_=d*A+v*O+m*M,D=s*A+o*O+u*M;var j=D*_<=0;e[0]=e[1]=e[2]=e[3]=0;if(!P&&!H&&!B&&!j)return!1;var F=this.tempCoords,I=Number.MAX_VALUE,q;return P&&(q=this.closestPointTriangle(0,9,18,F,!0),q<I&&(I=q,e[0]=F[0],e[1]=F[1],e[2]=F[2],e[3]=0)),H&&(q=this.closestPointTriangle(0,18,27,F,!0),q<I&&(I=q,e[0]=F[0],e[1]=0,e[2]=F[1],e[3]=F[2])),B&&(q=this.closestPointTriangle(0,27,9,F,!0),q<I&&(I=q,e[0]=F[0],e[1]=F[2],e[2]=0,e[3]=F[1])),j&&(q=this.closestPointTriangle(9,27,18,F,!0),q<I&&(I=q,e[0]=0,e[1]=F[0],e[2]=F[2],e[3]=F[1])),!0},e.prototype.closestPointTriangle=function(e,t,n,r,i){var s=this.simplex,o=s[e],u=s[e+1],a=s[e+2],f=s[t],l=s[t+1],c=s[t+2],h=s[n],p=s[n+1],d=s[n+2],v=o-f,m=u-l,g=a-c,y=o-h,b=u-p,w=a-d,E=o*v+u*m+a*g,S=o*y+u*b+a*w;if(E<=0&&S<=0)return r[0]=1,r[1]=r[2]=0,i?o*o+u*u+a*a:undefined;var x=f*v+l*m+c*g,T=f*y+l*b+c*w;if(x>=0&&T<=x)return r[1]=1,r[0]=r[2]=0,i?f*f+l*l+c*c:undefined;var N,C,k,L,A=E*T-x*S;if(A<=0&&E>=0&&x<=0)return N=E/(E-x),r[0]=1-N,r[1]=N,r[2]=0,i?(C=o-N*v,k=u-N*m,L=a-N*g,C*C+k*k+L*L):undefined;var O=h*v+p*m+d*g,M=h*y+p*b+d*w;if(M>=0&&O<=M)return r[0]=r[1]=0,r[2]=1,i?h*h+p*p+d*d:undefined;var _=O*S-E*M;if(_<=0&&S>=0&&M<=0)return N=S/(S-M),r[0]=1-N,r[1]=0,r[2]=N,i?(C=o-N*y,k=u-N*b,L=a-N*w,C*C+k*k+L*L):undefined;var D=x*M-O*T;if(D<=0&&T-x>=0&&O-M>=0)return N=(T-x)/(T-x+(O-M)),r[0]=0,r[1]=1-N,r[2]=N,i?(C=f*(1-N)+h*N,k=l*(1-N)+p*N,L=c*(1-N)+d*N,C*C+k*k+L*L):undefined;var P=1/(D+_+A);N=_*P;var H=A*P;return r[0]=1-N-H,r[1]=N,r[2]=H,i?(C=o-v*N-y*H,k=u-m*N-b*H,L=a-g*N-w*H,C*C+k*k+L*L):undefined},e.prototype.evaluate=function(e,t,n){var r=e.axis,i=e.shapeA,s=e.shapeB;this.numVertices=0;var o,u,a;o=u=a=Number.MAX_VALUE;var f=0,l=100,c=!1,h=Number.MAX_VALUE,p=t[0],d=t[1],v=t[2],m=t[3],g=t[4],y=t[5],b=t[6],w=t[7],E=t[8],S=t[9],x=t[10],T=t[11],N=n[0],C=n[1],k=n[2],L=n[3],O=n[4],M=n[5],_=n[6],D=n[7],P=n[8],H=n[9],B=n[10],j=n[11],F=r[0],I=r[1],q=r[2],R,U=e.closestA,z=e.closestB,W=this.closest,X=this.simplex,V=1e-4;for(;;){f+=1,U[0]=-(p*F+d*I+v*q),U[1]=-(m*F+g*I+y*q),U[2]=-(b*F+w*I+E*q),z[0]=N*F+C*I+k*q,z[1]=L*F+O*I+M*q,z[2]=_*F+D*I+P*q,i.localSupportWithoutMargin(U,U),s.localSupportWithoutMargin(z,z);var $=U[0],J=U[1],K=U[2],Q=U[0]=p*$+m*J+b*K+S,G=U[1]=d*$+g*J+w*K+x,Y=U[2]=v*$+y*J+E*K+T;$=z[0],J=z[1],K=z[2];var Z=z[0]=N*$+L*J+_*K+H,et=z[1]=C*$+O*J+D*K+B,tt=z[2]=k*$+M*J+P*K+j,nt=Q-Z,rt=G-et,it=Y-tt,st=!1,ot=this.numVertices*9,ut;for(ut=0;ut<ot;ut+=9)$=nt-X[ut],J=rt-X[ut+1],K=it-X[ut+2],$*$+J*J+K*K<V&&(st=!0);st||($=nt-o,J=rt-u,K=it-a,st=$*$+J*J+K*K<V);if(st){c=!0;break}var at=F*nt+I*rt+q*it;if(h-at<=h*A.GJK_FRACTIONAL_THRESHOLD){c=!0;break}o=X[ot]=nt,u=X[ot+1]=rt,a=X[ot+2]=it,X[ot+3]=Q,X[ot+4]=G,X[ot+5]=Y,X[ot+6]=Z,X[ot+7]=et,X[ot+8]=tt,this.numVertices+=1;if(!this.updateClosestPoints()){c=!1;break}$=W[0]-W[3],J=W[1]-W[4],K=W[2]-W[5],R=$*$+J*J+K*K;if(R<=A.GJK_EPA_DISTANCE_THRESHOLD){c=!0;break}F=$,I=J,q=K;var ft=h;h=R;if(ft-h<=A.GJK_FRACTIONAL_THRESHOLD*ft){c=!0;break}if(f>=l){c=!0;break}if(this.numVertices===4)break}R=F*F+I*I+q*q;if(R<A.DONT_NORMALIZE_THRESHOLD)return r[0]=F,r[1]=I,r[2]=q,undefined;var lt=1/Math.sqrt(R);return r[0]=F*lt,r[1]=I*lt,r[2]=q*lt,c?(U[0]=W[0],U[1]=W[1],U[2]=W[2],z[0]=W[3],z[1]=W[4],z[2]=W[5],Math.sqrt(h)):undefined},e.create=function(){var t=new e;return t.simplex=new Float32Array(36),t.numVertices=0,t.closest=new Float32Array(6),t.cachedCoords=new Float32Array(4),t.tempCoords=new Float32Array(4),t},e.version=1,e}(),et=function(){function e(){}return e.prototype.bind=function(e,t,n,r){e.edge[t]=r,e.adjFace[t]=n,n.edge[r]=t,n.adjFace[r]=e},e.prototype.append=function(e,t){t.leaf0=null,t.leaf1=e.root,e.root&&(e.root.leaf0=t),e.root=t,e.count+=1},e.prototype.remove=function(e,t){var n=t.leaf0,r=t.leaf1;r&&(r.leaf0=n),n&&(n.leaf1=r),t===e.root&&(e.root=r),e.count-=1},e.prototype.findBest=function(){var e=this.hull.root,t=e.distance*e.distance,n;for(n=e.leaf1;n!==null;n=n.leaf1){var r=n.distance*n.distance;r<t&&(e=n,t=r)}return e},e.prototype.getEdgeDistance=function(e,t,n){var r=this.vertex_store,i=r[t],s=r[t+1],o=r[t+2],u=r[n],a=r[n+1],f=r[n+2],l=u-i,c=a-s,h=f-o,p=e.normal,d=p[0],v=p[1],m=p[2],g=c*m-h*v,y=h*d-l*m,b=l*v-c*d,w=i*g+s*y+o*b;if(w<=0){var E=l*l+c*c+h*h,S=i*l+s*c+o*h,x=u*l+a*h+f*h;if(S>=0)return Math.sqrt(i*i+s*s+o*o);if(x<=0)return Math.sqrt(u*u+a*a+f*f);var T=i*u+s*a+o*f,N=(i*i+s*s+o*o)*(u*u+a*a+f*f)-T*T;return N>=0?Math.sqrt(N/E):0}return undefined},e.prototype.buildNewFace=function(e,t,n,r){var i=this.stock.root;if(i===null)return null;i.pass=0,i.vertex[0]=e,i.vertex[1]=t,i.vertex[2]=n;var s=this.vertex_store,o=s[e],u=s[e+1],a=s[e+2],f=s[t],l=s[t+1],c=s[t+2],h=s[n],p=s[n+1],d=s[n+2],v=f-o,m=l-u,g=c-a,y=h-o,b=p-u,w=d-a,E=i.normal,S=E[0]=m*w-g*b,x=E[1]=g*y-v*w,T=E[2]=v*b-m*y,N=S*S+x*x+T*T;if(N>A.DONT_NORMALIZE_THRESHOLD){i.distance=this.getEdgeDistance(i,e,t),i.distance===undefined&&(i.distance=this.getEdgeDistance(i,t,n)),i.distance===undefined&&(i.distance=this.getEdgeDistance(i,n,e));var C=1/Math.sqrt(N);i.distance===undefined&&(i.distance=(o*S+u*x+a*T)*C);if(r||i.distance>=-0.000001)return E[0]*=C,E[1]*=C,E[2]*=C,this.remove(this.stock,i),this.append(this.hull,i),i}return null},e.prototype.expandFace=function(e,t,n,r,i){if(n.pass!==e){var s=n.normal,o=s[0],u=s[1],a=s[2],f=this.vertex_store,l=f[t],c=f[t+1],h=f[t+2],p=(r+1)%3;if(o*l+u*c+a*h-n.distance<-0.000001){var d=this.buildNewFace(n.vertex[p],n.vertex[r],t,!1);if(d)return this.bind(d,0,n,r),i.cf?this.bind(i.cf,1,d,2):i.ff=d,i.cf=d,i.numFaces+=1,!0}else{var v=(r+2)%3;n.pass=e;if(this.expandFace(e,t,n.adjFace[p],n.edge[p],i)&&this.expandFace(e,t,n.adjFace[v],n.edge[v],i))return this.remove(this.hull,n),this.append(this.stock,n),!0}}return!1},e.prototype.evaluate=function(e,n,r,i){var s=n.shapeA,o=n.shapeB,u=this.hull,a=this.stock;while(u.root){var f=u.root;this.remove(u,f),this.append(a,f)}var l=e[27],c=e[28],h=e[29],p,d,v=e[0]-l,m=e[1]-c,g=e[2]-h,y=e[9]-l,b=e[10]-c,w=e[11]-h,E=e[18]-l,S=e[19]-c,x=e[20]-h;v*(b*x-w*S)+m*(w*E-y*x)+g*(y*S-b*E)<0?(p=9,d=0):(p=0,d=9);var T=this.vertex_store,N;for(N=0;N<9;N+=1)T[N]=e[p+N],T[9+N]=e[d+N],T[18+N]=e[18+N],T[27+N]=e[27+N];var C=this.buildNewFace(0,9,18,!0),k=this.buildNewFace(9,0,27,!0),L=this.buildNewFace(18,9,27,!0),O=this.buildNewFace(0,18,27,!0),M=36;if(u.count!==4)return t.v3Build(e[3],e[4],e[5],n.closestA),t.v3Build(e[6],e[7],e[8],n.closestB),0;var _=this.findBest(),D=0,P=0;this.bind(C,0,k,0),this.bind(C,1,L,0),this.bind(C,2,O,0),this.bind(k,1,O,2),this.bind(k,2,L,1),this.bind(L,2,O,1);var H=r[0],B=r[1],j=r[2],F=r[3],I=r[4],q=r[5],R=r[6],U=r[7],z=r[8],W=r[9],X=r[10],V=r[11],$=i[0],J=i[1],K=i[2],Q=i[3],G=i[4],Y=i[5],Z=i[6],et=i[7],tt=i[8],nt=i[9],rt=i[10],it=i[11],st=n.closestA,ot=n.closestB,ut=this.horizon,at,ft,lt,ct;for(;P<100;P+=1){if(M>=this.MAX_VERTICES*9)break;ut.cf=ut.ff=null,ut.numFaces=0;var ht=M;M+=9,D+=1,_.pass=D,at=_.normal,ft=at[0],lt=at[1],ct=at[2],st[0]=H*ft+B*lt+j*ct,st[1]=F*ft+I*lt+q*ct,st[2]=R*ft+U*lt+z*ct,ot[0]=-($*ft+J*lt+K*ct),ot[1]=-(Q*ft+G*lt+Y*ct),ot[2]=-(Z*ft+et*lt+tt*ct),s.localSupportWithoutMargin(st,st),o.localSupportWithoutMargin(ot,ot),l=st[0],c=st[1],h=st[2],v=H*l+F*c+R*h+W,m=B*l+I*c+U*h+X,g=j*l+q*c+z*h+V,l=ot[0],c=ot[1],h=ot[2],y=$*l+Q*c+Z*h+nt,b=J*l+G*c+et*h+rt,w=K*l+Y*c+tt*h+it;var pt,dt,vt;T[ht+3]=v,T[ht+4]=m,T[ht+5]=g,T[ht+6]=y,T[ht+7]=b,T[ht+8]=w,T[ht]=pt=v-y,T[ht+1]=dt=m-b,T[ht+2]=vt=g-w;var mt=ft*pt+lt*dt+ct*vt-_.distance;if(!(mt>A.GJK_EPA_DISTANCE_THRESHOLD))break;var gt,yt=!0;for(gt=0;gt<3&&yt;gt+=1)yt=yt&&this.expandFace(D,ht,_.adjFace[gt],_.edge[gt],ut);if(!(yt&&ut.numFaces>=3))break;this.bind(ut.cf,1,ut.ff,2),this.remove(u,_),this.append(a,_),_=this.findBest()}at=_.normal,ft=at[0],lt=at[1],ct=at[2];var bt=_.distance,wt=ft*bt,Et=lt*bt,St=ct*bt;E=_.vertex[0],S=_.vertex[1],x=_.vertex[2];var xt=T[E]-wt,Tt=T[E+1]-Et,Nt=T[E+2]-St,Ct=T[S]-wt,kt=T[S+1]-Et,Lt=T[S+2]-St,At=T[x]-wt,Ot=T[x+1]-Et,Mt=T[x+2]-St;l=kt*Mt-Lt*Ot,c=Lt*At-Ct*Mt,h=Ct*Ot-kt*At;var _t=Math.sqrt(l*l+c*c+h*h);l=Ot*Nt-Mt*Tt,c=Mt*xt-At*Nt,h=At*Tt-Ot*xt;var Dt=Math.sqrt(l*l+c*c+h*h);l=Tt*Lt-Nt*kt,c=Nt*Ct-xt*Lt,h=xt*kt-Tt*Ct;var Pt=Math.sqrt(l*l+c*c+h*h),Ht=1/(_t+Dt+Pt);_t*=Ht,Dt*=Ht,Pt*=Ht,st[0]=st[1]=st[2]=0,ot[0]=ot[1]=ot[2]=0;for(N=0;N<3;N+=1)st[N]+=_t*T[E+3+N]+Dt*T[S+3+N]+Pt*T[x+3+N],ot[N]+=_t*T[E+6+N]+Dt*T[S+6+N]+Pt*T[x+6+N];var Bt=n.axis;return Bt[0]=-ft,Bt[1]=-lt,Bt[2]=-ct,-_.distance},e.create=function(){var n=new e,r;n.vertex_store=new Float32Array(n.MAX_VERTICES*9);var i=[];for(r=0;r<n.MAX_FACES;r+=1)i[r]={normal:t.v3BuildZero(),distance:0,vertex:new Int16Array(3),adjFace:[null,null,null],edge:new Int16Array(3),leaf0:null,leaf1:null,pass:0};n.hull={root:null,count:0},n.stock={root:null,count:0},n.horizon={cf:null,ff:null,numFaces:0};for(r=0;r<n.MAX_FACES;r+=1)n.append(n.stock,i[n.MAX_FACES-r-1]);return n},e.version=1,e}();et.prototype.MAX_VERTICES=64,et.prototype.MAX_FACES=128;var tt=function(){function e(){return this
._private=null,this}return e.create=function(){var n=new e;return Object.defineProperty(n,"localPointOnA",{get:function(){var n=this._private;return t.v3Build(n[0],n[1],n[2])},set:function(t){var n=this._private;n[0]=t[0],n[1]=t[1],n[2]=t[2]},enumerable:!0}),Object.defineProperty(n,"localPointOnB",{get:function(){var n=this._private;return t.v3Build(n[3],n[4],n[5])},set:function(t){var n=this._private;n[3]=t[0],n[4]=t[1],n[5]=t[2]},enumerable:!0}),Object.defineProperty(n,"worldNormalOnB",{get:function(){var n=this._private;return t.v3Build(n[12],n[13],n[14])},set:function(t){var n=this._private;n[12]=t[0],n[13]=t[1],n[14]=t[2]},enumerable:!0}),Object.defineProperty(n,"added",{get:function(){var t=this._private;return 0<t[51]},enumerable:!0}),Object.defineProperty(n,"distance",{get:function(){var t=this._private;return t[21]},enumerable:!0}),n},e}(),nt={contactPool:[],contactPoolSize:0,publicContacts:[tt.create(),tt.create(),tt.create()],callbackContacts:[],allocate:function(){var t;return this.contactPoolSize===0?t=new Float32Array(52):(this.contactPoolSize-=1,t=this.contactPool[this.contactPoolSize]),t[51]=1,t},deallocate:function(t){this.contactPool[this.contactPoolSize]=t,this.contactPoolSize+=1,t[40]=0}},rt=function(){function e(){return this.objectA=null,this.objectB=null,this.shapeA=null,this.shapeB=null,this.friction=0,this.restitution=0,this.contacts=[],this.activeContacts=[],this.active=!0,this.skipDiscreteCollisions=!1,this.contactFlags=0,this.trigger=!1,this}return e.prototype.insertContact=function(e,t,n,r,i){var s=n[0],o=n[1],u=n[2],a=s*s+o*o+u*u;if(a<A.DONT_NORMALIZE_THRESHOLD)return;var f=1/Math.sqrt(a);s*=f,o*=f,u*=f;var l=this.objectA,c=this.objectB,h=l.transform,p=c.transform,d=e[0]-h[9],v=e[1]-h[10],m=e[2]-h[11],g=h[0]*d+h[1]*v+h[2]*m,y=h[3]*d+h[4]*v+h[5]*m,b=h[6]*d+h[7]*v+h[8]*m,w=0,E=0,S=Number.MAX_VALUE,x=this.contacts,T,N,C;while(E<x.length){var k=x[E];if(!i&&s*k[12]+o*k[13]+u*k[14]<.9){x[E]=x[x.length-1],x.pop(),nt.deallocate(k),this.contactFlags|=4;continue}T=g-k[0],N=y-k[1],C=b-k[2];var L=T*T+N*N+C*C;if(L<A.CONTACT_EQUAL_SQ_SEPERATION){w=k[40],x[E]=x[x.length-1],x.pop(),nt.deallocate(k),this.contactFlags|=4,S=L;continue}L<A.CONTACT_INHERIT_SQ_SEPERATION&&L<S&&(w=k[40],S=L),E+=1}var O=nt.allocate();O[0]=g,O[1]=y,O[2]=b,O[6]=d,O[7]=v,O[8]=m,O[9]=d=t[0]-p[9],O[10]=v=t[1]-p[10],O[11]=m=t[2]-p[11],O[3]=p[0]*d+p[1]*v+p[2]*m,O[4]=p[3]*d+p[4]*v+p[5]*m,O[5]=p[6]*d+p[7]*v+p[8]*m,O[21]=r,O[12]=s,O[13]=o,O[14]=u;var M,_;a=s*s+u*u,a<A.DONT_NORMALIZE_THRESHOLD?(O[15]=M=1,O[16]=0,O[17]=_=0):(f=1/Math.sqrt(a),O[15]=M=-u*f,O[16]=0,O[17]=_=s*f),O[18]=o*_,O[19]=u*M-s*_,O[20]=-(o*M),O[40]=w;var D,P;D=l.contactCallbacks,null!==D&&0!==(D.mask&c.group)&&(D.onPreSolveContact&&(P=nt.publicContacts[0],P._private=O,D.onPreSolveContact(l._public,c._public,P)),!D.added&&D.deferred&&(D.added=!0,l.world.contactCallbackObjects.push(l)),D.trigger&&(this.trigger=!0,l.sweepFrozen=!1,c.sweepFrozen=!1)),D=c.contactCallbacks,null!==D&&0!==(D.mask&l.group)&&(D.onPreSolveContact&&(P=nt.publicContacts[0],P._private=O,D.onPreSolveContact(l._public,c._public,P)),!D.added&&D.deferred&&(D.added=!0,c.world.contactCallbackObjects.push(c)),D.trigger&&(this.trigger=!0,l.sweepFrozen=!1,c.sweepFrozen=!1)),this.contactFlags|=1,x.push(O);if(x.length===4){var H=x[0][21],B=0;for(E=1;E<4;E+=1)O=x[E],O[21]<H&&(H=O[21],B=E);var j,F=-Number.MAX_VALUE,I=x[0],q=x[1],R=x[2],U=x[3],z=I[6]+I[9],W=I[7]+I[10],X=I[8]+I[11],V=q[6]+q[9],$=q[7]+q[10],J=q[8]+q[11],K=R[6]+R[9],Q=R[7]+R[10],G=R[8]+R[11];T=U[6]+U[9],N=U[7]+U[10],C=U[8]+U[11];var Y=V-z,Z=$-W,et=J-X,tt=K-z,rt=Q-W,it=G-X,st=T-z,ot=N-W,ut=C-X,at,ft,lt,ct;B!==1&&(at=rt*ut-it*ot,ft=it*st-tt*ut,lt=tt*ot-rt*st,ct=at*at+ft*ft+lt*lt,ct>F&&(F=ct,j=1)),B!==2&&(at=Z*ut-et*ot,ft=et*st-Y*ut,lt=Y*ot-Z*st,ct=at*at+ft*ft+lt*lt,ct>F&&(F=ct,j=2)),B!==3&&(at=Z*it-et*rt,ft=et*tt-Y*it,lt=Y*rt-Z*tt,ct=at*at+ft*ft+lt*lt,ct>F&&(F=ct,j=3));if(B!==0){var ht=K-V,pt=Q-$,dt=G-J,vt=T-V,mt=N-$,gt=C-J;at=pt*gt-dt*mt,ft=dt*vt-ht*gt,lt=ht*mt-pt*vt,ct=at*at+ft*ft+lt*lt,ct>F&&(F=ct,j=0)}O=x[j],x[j]=x[3],x.pop(),nt.deallocate(O),this.contactFlags|=4}},e.prototype.refreshContacts=function(){var e=this.contacts,t=this.objectA,n=this.objectB,r=t.transform,i=n.transform,s=r[0],o=r[1],u=r[2],a=r[3],f=r[4],l=r[5],c=r[6],h=r[7],p=r[8],d=r[9],v=r[10],m=r[11],g=i[0],y=i[1],b=i[2],w=i[3],E=i[4],S=i[5],x=i[6],T=i[7],N=i[8],C=i[9],k=i[10],L=i[11],O,M=0;while(M<e.length){O=e[M];var _=O[0],D=O[1],P=O[2],H=O[6]=s*_+a*D+c*P,B=O[7]=o*_+f*D+h*P,j=O[8]=u*_+l*D+p*P;_=O[3],D=O[4],P=O[5];var F=O[9]=g*_+w*D+x*P,I=O[10]=y*_+E*D+T*P,q=O[11]=b*_+S*D+N*P;_=H+d-(F+C),D=B+v-(I+k),P=j+m-(q+L);var R=O[12],U=O[13],z=O[14],W=O[21]=R*_+U*D+z*P;if(W>A.CONTACT_MAX_Y_SEPERATION){e[M]=e[e.length-1],e.pop(),nt.deallocate(O),this.contactFlags|=4;continue}_-=R*W,D-=U*W,P-=z*W;if(_*_+D*D+P*P>A.CONTACT_MAX_SQ_XZ_SEPERATION){e[M]=e[e.length-1],e.pop(),nt.deallocate(O),this.contactFlags|=4;continue}M+=1}return this.contactFlags|=2,e.length===0},e.prototype.preStep=function(e,t){if(this.trigger){this.activeContacts.length=0;return}var n=this.objectA,r=this.objectB,i=n.inverseMass+r.inverseMass,s=n.velocity,o=r.velocity,u=n.inverseInertia,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d=u[6],v=u[7],m=u[8];u=r.inverseInertia;var g=u[0],y=u[1],b=u[2],w=u[3],E=u[4],S=u[5],x=u[6],T=u[7],N=u[8],C=this.activeContacts;C.length=0;var k=n.collisionObject||r.collisionObject?A.CONTACT_STATIC_BAUMGRAUTE:A.CONTACT_BAUMGRAUTE,L=this.contacts,O,M=L.length;for(O=0;O<M;O+=1){var _=L[O];if(_[21]>0)continue;C[C.length]=_,_[41]=_[42]=0;var D,P,H,B,j,F,I=_[12],q=_[13],R=_[14],U=_[6],z=_[7],W=_[8],X=_[9],V=_[10],$=_[11],J,K,Q,G=i;D=z*R-W*q,P=W*I-U*R,H=U*q-z*I,_[22]=J=a*D+c*P+d*H,_[23]=K=f*D+h*P+v*H,_[24]=Q=l*D+p*P+m*H,G+=D*J+P*K+H*Q,B=V*R-$*q,j=$*I-X*R,F=X*q-V*I,_[25]=J=-(g*B+w*j+x*F),_[26]=K=-(y*B+E*j+T*F),_[27]=Q=-(b*B+S*j+N*F),G-=B*J+j*K+F*Q,_[45]=1/G,_[43]=k*Math.min(0,_[21]+A.CONTACT_SLOP)/t,_[44]=0;var Y=s[0]-o[0],Z=s[1]-o[1],et=s[2]-o[2];Y+=s[4]*W-s[5]*z,Z+=s[5]*U-s[3]*W,et+=s[3]*z-s[4]*U,Y-=o[4]*$-o[5]*V,Z-=o[5]*X-o[3]*$,et-=o[3]*V-o[4]*X;var tt=(Y*I+Z*q+et*R)*this.restitution;tt*tt<.01&&(tt=0),_[50]=tt;var nt=i;I=_[15],q=_[16],R=_[17],D=z*R-W*q,P=W*I-U*R,H=U*q-z*I,_[28]=J=a*D+c*P+d*H,_[29]=K=f*D+h*P+v*H,_[30]=Q=l*D+p*P+m*H,nt+=D*J+P*K+H*Q,B=V*R-$*q,j=$*I-X*R,F=X*q-V*I,_[31]=J=-(g*B+w*j+x*F),_[32]=K=-(y*B+E*j+T*F),_[33]=Q=-(b*B+S*j+N*F),nt-=B*J+j*K+F*Q;var rt=i;I=_[18],q=_[19],R=_[20],D=z*R-W*q,P=W*I-U*R,H=U*q-z*I,_[34]=J=a*D+c*P+d*H,_[35]=K=f*D+h*P+v*H,_[36]=Q=l*D+p*P+m*H,rt+=D*J+P*K+H*Q,B=V*R-$*q,j=$*I-X*R,F=X*q-V*I,_[37]=J=-(g*B+w*j+x*F),_[38]=K=-(y*B+E*j+T*F),_[39]=Q=-(b*B+S*j+N*F),rt-=B*J+j*K+F*Q;var it=0;it+=D*_[28]+P*_[29]+H*_[30],it-=B*_[31]+j*_[32]+F*_[33];var st=1/(nt*rt-it*it);_[46]=rt*st,_[47]=-it*st,_[48]=nt*st,_[40]*=e}},e.prototype.applyCachedImpulses=function(){if(this.trigger)return;var e=this.objectA,t=this.objectB,n=e.velocity,r=t.velocity,i=e.inverseMass,s=t.inverseMass,o=this.activeContacts,u;for(u=0;u<o.length;u+=1){var a=o[u],f=a[40],l=a[12]*f,c=a[13]*f,h=a[14]*f;n[0]+=l*i,n[1]+=c*i,n[2]+=h*i,r[0]-=l*s,r[1]-=c*s,r[2]-=h*s,n[3]+=a[22]*f,n[4]+=a[23]*f,n[5]+=a[24]*f,r[3]+=a[25]*f,r[4]+=a[26]*f,r[5]+=a[27]*f}},e.prototype.computeAndApplyBiasImpulses=function(){if(this.trigger)return;var e=this.objectA,t=this.objectB,n=e.velocity,r=n[6],i=n[7],s=n[8],o=n[9],u=n[10],a=n[11];n=t.velocity;var f=n[6],l=n[7],c=n[8],h=n[9],p=n[10],d=n[11],v=e.inverseMass,m=t.inverseMass,g=this.activeContacts,y=g.length,b,w;for(w=0;w<y;w+=1){b=g[w];var E=b[12],S=b[13],x=b[14],T=b[6],N=b[7],C=b[8],k=b[9],L=b[10],A=b[11],O=b[45]*(E*(f+(p*A-d*L)-(r+(u*C-a*N)))+S*(l+(d*k-h*A)-(i+(a*T-o*C)))+x*(c+(h*L-p*k)-(s+(o*N-u*T)))-b[43]),M=b[44],_=M+O;_<0&&(_=0),O=_-M,b[44]=_,E*=O,S*=O,x*=O,r+=E*v,i+=S*v,s+=x*v,f-=E*m,l-=S*m,c-=x*m,o+=b[22]*O,u+=b[23]*O,a+=b[24]*O,h+=b[25]*O,p+=b[26]*O,d+=b[27]*O}n=e.velocity,n[6]=r,n[7]=i,n[8]=s,n[9]=o,n[10]=u,n[11]=a,n=t.velocity,n[6]=f,n[7]=l,n[8]=c,n[9]=h,n[10]=p,n[11]=d},e.prototype.computeAndApplyImpulses=function(){if(this.trigger)return;var e=this.objectA,t=this.objectB,n=e.velocity,r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5];n=t.velocity;var f=n[0],l=n[1],c=n[2],h=n[3],p=n[4],d=n[5],v=e.inverseMass,m=t.inverseMass,g=this.friction,y=this.activeContacts,b=y.length,w,E;for(E=0;E<b;E+=1){w=y[E];var S=w[12],x=w[13],T=w[14],N=w[15],C=w[16],k=w[17],L=w[18],A=w[19],O=w[20],M=w[6],_=w[7],D=w[8],P=w[9],H=w[10],B=w[11],j=w[45]*(S*(f+(p*B-d*H)-(r+(u*D-a*_)))+x*(l+(d*P-h*B)-(i+(a*M-o*D)))+T*(c+(h*H-p*P)-(s+(o*_-u*M)))-w[50]),F=w[40],I=F+j;I<0&&(I=0,j=-F),w[40]=I,S*=j,x*=j,T*=j,r+=S*v,i+=x*v,s+=T*v,f-=S*m,l-=x*m,c-=T*m,o+=w[22]*j,u+=w[23]*j,a+=w[24]*j,h+=w[25]*j,p+=w[26]*j,d+=w[27]*j,S=f-r+(p*B-d*H)-(u*D-a*_),x=l-i+(d*P-h*B)-(a*M-o*D),T=c-s+(h*H-p*P)-(o*_-u*M);var q=N*S+C*x+k*T,R=L*S+A*x+O*T;j=q*w[46]+R*w[47];var U=q*w[47]+R*w[48];F=w[41];var z=w[42];I=F+j;var W=z+U,X=g*w[40],V=I*I+W*W;V>X*X&&(V=X/Math.sqrt(V),I*=V,W*=V,j=I-F,U=W-z),w[41]=I,w[42]=W,S=N*j+L*U,x=C*j+A*U,T=k*j+O*U,r+=S*v,i+=x*v,s+=T*v,f-=S*m,l-=x*m,c-=T*m,o+=w[28]*j+w[34]*U,u+=w[29]*j+w[35]*U,a+=w[30]*j+w[36]*U,h+=w[31]*j+w[37]*U,p+=w[32]*j+w[38]*U,d+=w[33]*j+w[39]*U}n=e.velocity,n[0]=r,n[1]=i,n[2]=s,n[3]=o,n[4]=u,n[5]=a,n=t.velocity,n[0]=f,n[1]=l,n[2]=c,n[3]=h,n[4]=p,n[5]=d},e.prototype.invalidateParameters=function(){this.restitution=this.objectA.restitution*this.objectB.restitution,this.friction=this.objectA.friction*this.objectB.friction},e.allocate=function(t,n,r,i){var s;return this.arbiterPoolSize===0?s=new e:(s=this.arbiterPool[this.arbiterPoolSize-1],this.arbiterPoolSize-=1),s.active=!0,s.shapeA=t,s.shapeB=n,s.objectA=r,s.objectB=i,s.invalidateParameters(),s},e.deallocate=function(e){e.shapeA=null,e.shapeB=null,e.objectA=null,e.objectB=null,e.skipDiscreteCollisions=!1,e.activeContacts.length=0,e.contactFlags=0,e.trigger=!1,this.arbiterPool[this.arbiterPoolSize]=e,this.arbiterPoolSize+=1},e.version=1,e.arbiterPool=[],e.arbiterPoolSize=0,e}(),it=function(){function e(){return this.bodies=[],this.constraints=[],this.wakeTimeStamp=0,this.active=!1,this}return e.allocate=function(){var t;return this.islandPoolSize===0?t=new e:(t=this.islandPool[this.islandPoolSize-1],this.islandPoolSize-=1),t},e.deallocate=function(e){this.islandPool[this.islandPoolSize]=e,this.islandPoolSize+=1,e.wakeTimeStamp=0},e.version=1,e.islandPool=[],e.islandPoolSize=0,e}(),st=function(){function e(){return this.index=0,this.collisionRadius=0,this.triangleArray=null,this}return e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[1],i=e[2],s=this.triangleArray.triangles,o=this.index,u=s[o+3],a=s[o+4],f=s[o+5],l=s[o+6],c=s[o+7],h=s[o+8],p=s[o+9],d=s[o+10],v=s[o+11],m=n*l+r*c+i*h,g=n*p+r*d+i*v;m<=0&&g<=0?(t[0]=u,t[1]=a,t[2]=f):m>=g?(t[0]=u+l,t[1]=a+c,t[2]=f+h):(t[0]=u+p,t[1]=a+d,t[2]=f+v)},e.allocate=function(){var t;return this.trianglePoolSize===0?t=new e:(t=this.trianglePool[this.trianglePoolSize-1],this.trianglePoolSize-=1),t},e.deallocate=function(e){this.trianglePool[this.trianglePoolSize]=e,this.trianglePoolSize+=1,e.triangleArray=null},e.version=1,e.trianglePool=[],e.trianglePoolSize=0,e}();st.prototype.type="TRIANGLE_MESH_TRIANGLE";var ot=function(){function e(){return this.objectA=null,this.objectB=null,this.shapeA=null,this.shapeB=null,this.closestA=t.v3BuildZero(),this.closestB=t.v3BuildZero(),this.axis=t.v3BuildZero(),this.distance=0,this.toi=0,this.frozenA=!1,this.frozenB=!1,this.concave=!1,this}return e.allocate=function(){var t;return this.eventPoolSize===0?t=new e:(t=this.eventPool[this.eventPoolSize-1],this.eventPoolSize-=1),t},e.deallocate=function(e){this.eventPool[this.eventPoolSize]=e,this.eventPoolSize+=1,e.concave&&(st.deallocate(e.shapeB),e.concave=!1),e.objectA=null,e.objectB=null,e.shapeA=null,e.shapeB=null},e.version=1,e.eventPool=[],e.eventPoolSize=0,e}(),ut=function(){function e(){}return e.prototype.update=function(){this._private.update()},e.prototype.rayTest=function(e){return this._private.rayTest(e)},e.prototype.convexSweepTest=function(e){return this._private.convexSweepTest(e)},e.prototype.addCollisionObject=function(e){return this._private.addBody(e._private)},e.prototype.removeCollisionObject=function(e){return this._private.removeBody(e._private)},e.prototype.addRigidBody=function(e){return this._private.addBody(e._private)},e.prototype.removeRigidBody=function(e){return this._private.removeBody(e._private)},e.prototype.addConstraint=function(e){return this._private.addConstraint(e._private)},e.prototype.removeConstraint=function(e){return this._private.removeConstraint(e._private)},e.prototype.addCharacter=function(e){return this._private.addBody(e._private.rigidBody._private)},e.prototype.removeCharacter=function(e){return this._private.removeBody(e._private.rigidBody._private)},e.prototype.wakeBody=function(e){this._private.wakeBody(e)},e.prototype.flush=function(){this._private.flush()},e.create=function(n){var r=new e,i=new at;return r._private=i,i._public=r,i.gravity=n.gravity!==undefined?t.v3Copy(n.gravity):t.v3Build(0,-10,0),i.maxSubSteps=n.maxSubSteps!==undefined?n.maxSubSteps:10,i.fixedTimeStep=n.fixedTimeStep!==undefined?n.fixedTimeStep:1/60,i.variableMinStep=n.minimumTimeStep!==undefined?n.minimumTimeStep:1/70,i.variableMaxStep=n.maximumTimeStep!==undefined?n.maximumTimeStep:.02,i.variableStep=n.variableTimeSteps!==undefined?n.variableTimeSteps:!1,i.maxGiveUpTimeStep=n.maxGiveUpTimeStep!==undefined?n.maxGiveUpTimeStep:.05,Object.defineProperty(r,"maxSubSteps",{value:i.maxSubSteps,enumerable:!0}),Object.defineProperty(r,"maxGiveUpTimeStep",{value:i.maxGiveUpTimeStep,enumerable:!0}),i.variableStep?(Object.defineProperty(r,"minimumTimeStep",{value:i.variableMinStep,enumerable:!0}),Object.defineProperty(r,"maximumTimeStep",{value:i.variableMaxStep,enumerable:!0})):Object.defineProperty(r,"fixedTimeStep",{value:i.fixedTimeStep,enumerable:!0}),Object.defineProperty(r,"gravity",{get:function(){return t.v3Copy(this._private.gravity)},enumerable:!0}),i.staticSpatialMap=f.create(!0),i.dynamicSpatialMap=f.create(),i.collisionObjects=[],i.rigidBodies=[],i.constraints=[],i.kinematicBodies=[],i.activeArbiters=[],i.activeBodies=[],i.activeKinematics=[],i.activeConstraints=[],i.persistantObjectsList=[],i.persistantObjectsList2=[],i.persistantTrianglesList=[],i.persistantTOIEventList=[],i.timeStamp=0,i.performanceData={discrete:0,sleepComputation:0,prestepContacts:0,prestepConstraints:0,integrateVelocities:0,warmstartContacts:0,warmstartConstraints:0,physicsIterations:0,integratePositions:0,continuous:0},Object.defineProperty(r,"performanceData",{value:i.performanceData,enumerable:!0}),i.syncExtents=new Float32Array(6),i.contactCallbackObjects=[],i.contactCallbackRemovedArbiters=[],r},e.version=1,e}(),at=function(){function e(){}return e.prototype.m43InverseOrthonormalTransformVector=function(e,t,n){n===undefined&&(n=new Float32Array(3));var r=t[0],i=t[1],s=t[2];return n[0]=e[0]*r+e[1]*i+e[2]*s,n[1]=e[3]*r+e[4]*i+e[5]*s,n[2]=e[6]*r+e[7]*i+e[8]*s,n},e.prototype.m43InverseOrthonormalTransformPoint=function(e,t,n){n===undefined&&(n=new Float32Array(3));var r=t[0]-e[9],i=t[1]-e[10],s=t[2]-e[11];return n[0]=e[0]*r+e[1]*i+e[2]*s,n[1]=e[3]*r+e[4]*i+e[5]*s,n[2]=e[6]*r+e[7]*i+e[8]*s,n},e.prototype.trianglePlaneDiscard=function(e,n,r,i,s){this.planeAxis===undefined&&(this.planeAxis=t.v3BuildZero(),this.planeSA=t.v3BuildZero(),this.planeSB=t.v3BuildZero());var o=this.planeAxis,u=this.planeSA,a=this.planeSB,f=r.triangles,l=f[i],c=f[i+1],h=f[i+2],p=f[i+16],d=s[0],v=s[1],m=s[2],g=s[3],y=s[4],b=s[5],w=s[6],E=s[7],S=s[8],x=s[9],T=s[10],N=s[11],C=l*d+c*g+h*w,k=l*v+c*y+h*E,L=l*m+c*b+h*S;d=n[0],v=n[1],m=n[2],g=n[3],y=n[4],b=n[5],w=n[6],E=n[7],S=n[8],x-=n[9],T-=n[10],N-=n[11],l=d*C+v*k+m*L,c=g*C+y*k+b*L,h=w*C+E*k+S*L,p+=C*x+k*T+L*N,o[0]=l,o[1]=c,o[2]=h,e.localSupportWithoutMargin(o,u),o[0]=-l,o[1]=-c,o[2]=-h,e.localSupportWithoutMargin(o,a);var A=u[0]*l+u[1]*c+u[2]*h-p,O=a[0]*l+a[1]*c+a[2]*h-p;if(A*O<=0)return!1;var M;return A*A<O*O?M=A:M=O,M<0!=A*O<0&&(M=-M),M-e.collisionRadius>0},e.prototype.filtered=function(e,t){return e===t?!0:(e.collisionObject||e.kinematic)&&(t.collisionObject||t.kinematic)?!0:(e.mask&t.group)===0||(t.mask&e.group)===0?!0:!1},e.prototype.narrowPhase=function(e,n,r,i){this.narrowTriangle===undefined&&(this.narrowTriangle=st.allocate(),this.narrowCache={axis:t.v3Build(1,0,0),shapeA:null,shapeB:null,closestA:t.v3BuildZero(),closestB:t.v3BuildZero()},this.narrowCache2={axis:this.narrowCache.axis,shapeA:null,shapeB:null,closestA:this.narrowCache.closestA,closestB:this.narrowCache.closestB},this.narrowFakeBody={transform:t.m43BuildIdentity(),shape:null},this.narrowTransform=t.m43BuildIdentity(),this.narrowExtents=new Float32Array(6));var s=null,o=r.arbiters,u=i.arbiters,a=o.length<=u.length?o:u,f=0,l=a.length;for(f=0;f<l;f+=1){var c=a[f];if(c.shapeA===e&&c.shapeB===n&&c.objectA===r&&c.objectB===i){s=c;break}}if(s!==null&&s.skipDiscreteCollisions){s.skipDiscreteCollisions=!1;return}var h=s===null;h&&(s=rt.allocate(e,n,r,i));var p=this.narrowCache;p.shapeA=e,p.shapeB=n;if(s.contacts.length!==0){var d=s.contacts[0];p.axis[0]=d[12],p.axis[1]=d[13],p.axis[2]=d[14]}var v,m=!1;if(e.type==="TRIANGLE_MESH"||n.type==="TRIANGLE_MESH"){var g,y,b,w,E=this.narrowTriangle,S=this.narrowCache2;e.type==="TRIANGLE_MESH"?(g=e,b=r.transform,y=n,w=i.transform,S.shapeA=E,S.shapeB=p.shapeB):(g=n,b=i.transform,y=e,w=r.transform,S.shapeA=p.shapeA,S.shapeB=E);var x=g.triangleArray;E.triangleArray=x,E.collisionRadius=g.collisionRadius;var T;if(x.spatialMap){var N=this.narrowTransform,C=this.narrowFakeBody,k=this.narrowExtents;t.m43InverseOrthonormal(b,N),t.m43Mul(w,N,C.transform),C.shape=y,z.prototype.calculateExtents.call(C,k);var L=this.persistantTrianglesList;T=x.spatialMap.getOverlappingNodes(k,L,0);for(f=0;f<T;f+=1){var A=L[f].index;E.index=A,L[f]=undefined,this.trianglePlaneDiscard(y,w,x,A,b)||(v=this.contactPairTest(S,r.transform,i.transform),v<0&&(s.insertContact(S.closestA,S.closestB,S.axis,v,!0),m=!0))}}else{T=x.numTriangles;for(f=0;f<T;f+=1)E.index=f*I.prototype.TRIANGLE_SIZE,this.trianglePlaneDiscard(y,w,x,E.index,b)||(v=this.contactPairTest(S,r.transform,i.transform),v<0&&(s.insertContact(S.closestA,S.closestB,S.axis,v,!0),m=!0))}}else v=this.contactPairTest(p,r.transform,i.transform),v<0&&(s.insertContact(p.closestA,p.closestB,p.axis,v,!1),m=!0);m?(h&&(this.activeArbiters.push(s),s.active=!0,r.arbiters.push(s),i.arbiters.push(s)),r.permitSleep&&!r.active&&this.wakeBody(r),i.permitSleep&&!i.active&&this.wakeBody(i),s.active||(s.active=!0,this.activeArbiters.push(s))):h&&rt.deallocate(s)},e.prototype.computeSleeping=function(e){function t(e,t){var r=n(e),i=n(t);r!==i&&(r.islandRank<i.islandRank?r.islandRoot=i:r.islandRank>i.islandRank?i.islandRoot=r:(i.islandRoot=r,r.islandRank+=1))}function n(e){if(e===e.islandRoot)return e;var t=e,n=null,r;while(t!==t.islandRoot)r=t.islandRoot,t.islandRoot=n,n=t,t=r;while(n!==null)r=n.islandRoot,n.islandRoot=t,n=r;return t}var r,i,s=this.activeArbiters,o=this.activeBodies,u=this.activeConstraints,a,f=s.length;for(a=0;a<f;a+=1){var l=s[a];r=l.objectA,i=l.objectB,r.permitSleep&&i.permitSleep&&t(r,i)}f=u.length;var c;for(a=0;a<f;a+=1)c=u[a],r=c.bodyA,i=c.bodyB,r&&r.permitSleep&&t(r,c),i&&i.permitSleep&&t(i,c);var h=[],p,d,v;while(o.length>0)d=o.pop(),v=n(d),p=v.island,p||(p=v.island=it.allocate(),h.push(p),p.active=!1),d.island=p,p.bodies.push(d),p.active=p.active||d.isActive(e),d.wakeTimeStamp>p.wakeTimeStamp&&(p.wakeTimeStamp=d.wakeTimeStamp);while(u.length>0)c=u.pop(),v=n(c),p=v.island,p||(p=v.island=it.allocate(),h.push(p),p.active=!0),c.island=p,p.constraints.push(c),c.wakeTimeStamp>p.wakeTimeStamp&&(p.wakeTimeStamp=c.wakeTimeStamp);while(h.length>0){p=h.pop();if(p.active){while(p.bodies.length>0)d=p.bodies.pop(),d.wakeTimeStamp=p.wakeTimeStamp,o.push(d),d.islandRoot=d,d.islandRank=0,d.island=null;while(p.constraints.length>0)c=p.constraints.pop(),c.wakeTimeStamp=p.wakeTimeStamp,u.push(c),c.islandRoot=c,c.islandRank=0,c.island=null;it.deallocate(p)}else{f=p.bodies.length;for(a=0;a<f;a+=1)d=p.bodies[a],d.velocity[0]=d.velocity[1]=d.velocity[2]=0,d.velocity[3]=d.velocity[4]=d.velocity[5]=0,d.active=!1,this.syncBody(d),d.islandRoot=d,d.islandRank=0;f=p.constraints.length;for(a=0;a<f;a+=1)c=p.constraints[a],c.active=!1,c.islandRoot=c,c.islandRank=0}}},e.prototype.wakeIsland=function(e){while(e.bodies.length>0){var t=e.bodies.pop();t.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),this.activeBodies.push(t);var n,r=t.arbiters,i=r.length;for(n=0;n<i;n+=1){var s=r[n];s.active||(s.active=!0,this.activeArbiters.push(s))}t.active=!0,t.island=null,this.syncBody(t)}while(e.constraints.length>0){var o=e.constraints.pop();o.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),this.activeConstraints.push(o),o.active=!0,o.island=null}it.deallocate(e)},e.prototype.wakeRelated=function(e){var t=e.constraints,n,r=t.length;for(n=0;n<r;n+=1)this.wakeConstraint(t[n]);var i=e.arbiters;r=i.length;for(n=0;n<r;n+=1){var s=i[n];s.active||(s.active=!0,this.activeArbiters.push(s)),s.objectA.permitSleep&&!s.objectA.active&&this.wakeBody(s.objectA),s.objectB.permitSleep&&!s.objectB.active&&this.wakeBody(s.objectB)}},e.prototype.wakeBody=function(e){e.collisionObject&&!e.kinematic?(this.wakeRelated(e),this.syncBody(e)):e.kinematic?(e.delaySleep=!0,e.active||(e.active=!0,this.activeKinematics.push(e),this.wakeRelated(e),this.syncBody(e))):(e.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),e.active||(e.island?this.wakeIsland(e.island):(e.active=!0,this.activeBodies.push(e),this.wakeRelated(e),this.syncBody(e)),this.syncBody(e)))},e.prototype.syncBody=function(e){var t=this.syncExtents;e.calculateExtents(t),e.collisionObject&&!e.kinematic?this.staticSpatialMap.update(e,t):(e.active?e.previouslyActive?this.dynamicSpatialMap.update(e,t):(this.staticSpatialMap.remove(e),this.dynamicSpatialMap.add(e,t)):e.previouslyActive?(this.dynamicSpatialMap.remove(e),this.staticSpatialMap.add(e,t)):this.staticSpatialMap.update(e,t),e.previouslyActive=e.active)},e.prototype.wakeConstraint=function(e){e.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),e.active||(e.island?this.wakeIsland(e.island):(e.active=!0,this.activeConstraints.push(e),e.bodyA&&this.wakeBody(e.bodyA),e.bodyB&&this.wakeBody(e.bodyB)))},e.prototype.dynamicSweep=function(e,t,n,r){var i=e.objectA,s=e.objectB,o=e.axis,u=i.velocity,a=-u[0],f=-u[1],l=-u[2],c=s.velocity;a+=c[0],f+=c[1],l+=c[2];if(a*a+f*f+l*l<A.DONT_NORMALIZE_THRESHOLD){e.toi=undefined;return}o[0]=a,o[1]=f,o[2]=l;var h=-a,p=-f,d=-l,v=0,m,g;i.fixedRotation||(m=i.shape.radius,v+=m*Math.sqrt(u[3]*u[3]+u[4]*u[4]+u[5]*u[5])),s.fixedRotation||(g=s.shape.radius,v+=g*Math.sqrt(c[3]*c[3]+c[4]*c[4]+c[5]*c[5]));if(v<A.CONTINUOUS_ANGULAR_BULLET/t){var y=m<g?m:g;y*=A.CONTINUOUS_LINEAR_BULLET/t;if(h*h+p*p+d*d<y*y){e.toi=undefined;return}}var b=0,w=100,E=n;for(;;){i.integratePosition(E*t),s.integratePosition(E*t);var S=this.contactPairTest(e,i.transform,s.transform),x=S;S!==undefined&&(x+=r);if(x===undefined||x<A.GJK_EPA_DISTANCE_THRESHOLD){this.seperatingTOI(e)?E=undefined:e.distance=S;break}var T=o[0]*h+o[1]*p+o[2]*d,N=(v-T)*t;if(N<=0){E=undefined;break}E+=x/N;if(E>=1){E=undefined;break}b+=1;if(b>w){E=undefined;break}}e.toi=E},e.prototype.seperatingTOI=function(e){var t=e.objectA,n=e.objectB,r=e.closestA,i=e.closestB,s=t.velocity,o=n.velocity,u=s[0]-o[0],a=s[1]-o[1],f=s[2]-o[2];if(!t.fixedRotation){var l=r[0]-t.transform[9],c=r[1]-t.transform[10],h=r[2]-t.transform[11];u+=s[4]*h-s[5]*c,a+=s[5]*l-s[3]*h,f+=s[3]*c-s[4]*l}if(!n.fixedRotation){var p=i[0]-n.transform[9],d=i[1]-n.transform[10],v=i[2]-n.transform[11];u-=o[4]*v-o[5]*d,a-=o[5]*p-o[3]*v,f-=o[3]*d-o[4]*p}var m=e.axis,g=u*m[0]+a*m[1]+f*m[2];return g>=0},e.prototype.staticSweep=function(e,t,n,r){var i=e.objectA,s=e.objectB,o=e.axis,u=i.velocity,a=-u[0],f=-u[1],l=-u[2];if(a*a+f*f+l*l<A.DONT_NORMALIZE_THRESHOLD){e.toi=undefined;return}o[0]=a,o[1]=f,o[2]=l;var c=-a,h=-f,p=-l,d=0;i.fixedRotationtype||(d+=i.shape.radius*Math.sqrt(u[3]*u[3]+u[4]*u[4]+u[5]*u[5]));var v=0,m=100,g=n;for(;;){i.integratePosition(g*t);var y=this.contactPairTest(e,i.transform,s.transform),b=y;y!==undefined&&(b+=r);if(b===undefined||b<A.GJK_EPA_DISTANCE_THRESHOLD){this.seperatingTOI(e)?g=undefined:e.distance=y;break}var w=o[0]*c+o[1]*h+o[2]*p,E=(d-w)*t;if(E<=0){g=undefined;break}g+=b/E;if(g>=1){g=undefined;break}v+=1;if(v>m){g=undefined;break}}e.toi=g},e.prototype.performStaticTOIBase=function(e,n,r,i,s,o){var u=this.persistantTrianglesList;this.continuousFakeBody===undefined&&(this.continuousFakeBody={shape:null,transform:t.m43BuildIdentity(),startTransform:t.m43BuildIdentity()},this.continuousInvTransform=t.m43BuildIdentity(),this.continuousExtents=new Float32Array(6));var a=this.continuousFakeBody,f=this.continuousInvTransform,l=this.continuousExtents,c;if(o.shape.type==="TRIANGLE_MESH"){var h=o.shape.triangleArray,p,d;if(h.spatialMap){a.shape=s.shape,t.m43InverseOrthonormal(o.transform,f),t.m43Mul(s.startTransform,f,a.startTransform),t.m43Mul(s.endTransform,f,a.transform),z.prototype.calculateSweptExtents.call(a,l),p=h.spatialMap.getOverlappingNodes(l,u,0);for(d=0;d<p;d+=1){c=ot.allocate(),c.objectA=s,c.objectB=o,c.shapeA=s.shape,c.shapeB=st.allocate(),c.shapeB.index=u[d].index,u[d]=undefined,c.shapeB.triangleArray=o.shape.triangleArray,c.shapeB.collisionRadius=o.shape.collisionRadius,c.concave=!0,this.staticSweep(c,n,0,e);if(c.toi===undefined){ot.deallocate(c);continue}c.frozenA=!1,c.frozenB=!0,r[i]=c,i+=1}}else{p=h.numTriangles;for(d=0;d<p;d+=1){c=ot.allocate(),c.objectA=s,c.objectB=o,c.shapeA=s.shape,c.shapeB=st.allocate(),c.shapeB.index=d*I.prototype.TRIANGLE_SIZE,c.shapeB.triangleArray=o.shape.triangleArray,c.shapeB.collisionRadius=o.shape.collisionRadius,c.concave=!0,this.staticSweep(c,n,0,e);if(c.toi===undefined){ot.deallocate(c);continue}c.frozenA=!1,c.frozenB=!0,r[i]=c,i+=1}}}else{c=ot.allocate(),c.objectA=s,c.objectB=o,c.shapeA=s.shape,c.shapeB=o.shape,this.staticSweep(c,n,0,e);if(c.toi===undefined)return ot.deallocate(c),i;c.frozenA=!1,c.frozenB=!0,r[i]=c,i+=1}return i},e.prototype.update=function(){var e=this.dynamicSpatialMap,n=this.staticSpatialMap,r=this.activeBodies,i=this.activeKinematics,s=this.activeConstraints,o=this.activeArbiters,u=this.gravity,a=this.performanceData;a.discrete=0,a.sleepComputation=0,a.prestepContacts=0,a.prestepConstraints=0,a.integrateVelocities=0,a.warmstartContacts=0,a.warmstartConstraints=0,a.physicsIterations=0,a.integratePositions=0,a.continuous=0;var f=this.prevTimeStamp;if(f===undefined){this.prevTimeStamp=TurbulenzEngine.getTime()*.001;return}var l=TurbulenzEngine.getTime()*.001,c=l-f,h,p;if(this.variableStep){var d=this.variableMinStep,v=this.variableMaxStep;h=Math.ceil(c/v),p=c/h,p<d&&(p=d,h=Math.floor(c/p)),h>this.maxSubSteps&&this.maxGiveUpTimeStep!==0&&(h=Math.ceil(c/this.maxGiveUpTimeStep),p=c/h)}else p=this.fixedTimeStep,h=Math.floor(c/p),h>this.maxSubSteps&&this.maxGiveUpTimeStep!==0&&(h=Math.ceil(c/this.maxGiveUpTimeStep),p=c/h);if(h<=0)return;this.prevTimeStamp+=p*h,h>this.maxSubSteps&&(h=this.maxSubSteps),this.midStep=!0;var m,g,y;m=i.length;for(g=0;g<m;)y=i[g],!y.computeDeltaVelocity(p*h,y.prevTransform,y.transform)&&!y.delaySleep?(y.active=!1,m-=1,i[g]=i[m],i.pop(),this.syncBody(y)):(t.m43Copy(y.transform,y.newTransform),t.m43Copy(y.prevTransform,y.transform),g+=1),y.delaySleep=!1;var b;for(b=0;b<h;b+=1){var w,E;this.timeStamp+=1;var S;this.prevTimeStep===undefined&&(this.prevTimeStep=p);var x=p/this.prevTimeStep;this.prevTimeStep=p,m=r.length;for(g=0;g<m;g+=1)y=r[g],E=y.extents,y.calculateExtents(E),e.update(y,E),y.refreshInertiaTensor();m=i.length;for(g=0;g<m;g+=1)y=i[g],E=y.extents,y.calculateExtents(E),e.update(y,E);S=TurbulenzEngine.getTime()*.001,n.finalize(),e.finalize();var T=this.persistantObjectsList,N=e.getOverlappingPairs(T,0),C=N,k;m=r.length;for(g=0;g<m;g+=1)y=r[g],k=n.getOverlappingNodes(y.extents,T,C+1),k!==0&&(T[C]=y,C+=1+k,T[C]=y,C+=1);m=i.length;for(g=0;g<m;g+=1)y=i[g],k=n.getOverlappingNodes(y.extents,T,C+1),k!==0&&(T[C]=y,C+=1+k,T[C]=y,C+=1);var L,O;for(g=0;g<N;g+=2)L=T[g],O=T[g+1],T[g]=undefined,T[g+1]=undefined,this.filtered(L,O)||(L.id<O.id?this.narrowPhase(L.shape,O.shape,L,O):this.narrowPhase(O.shape,L.shape,O,L));for(g=N;g<C;){L=T[g],T[g]=undefined,g+=1;for(;;){O=T[g],T[g]=undefined,g+=1;if(L===O)break;this.filtered(L,O)||(L.id<O.id?this.narrowPhase(L.shape,O.shape,L,O):this.narrowPhase(O.shape,L.shape,O,L))}}a.discrete+=TurbulenzEngine.getTime()*.001-S,S=TurbulenzEngine.getTime()*.001,this.computeSleeping(p),a.sleepComputation+=TurbulenzEngine.getTime()*.001-S,S=TurbulenzEngine.getTime()*.001,g=0;var M;while(g<o.length){M=o[g];if(!M.objectA.active&&!M.objectB.active){M.active=!1,o[g]=o[o.length-1],o.pop();continue}if(M.refreshContacts()){o[g]=o[o.length-1],o.pop(),L=M.objectA,O=M.objectB;var _=L.arbiters;_[_.indexOf(M)]=_[_.length-1],_.pop(),_=O.arbiters,_[_.indexOf(M)]=_[_.length-1],_.pop(),L.contactCallbacks&&L.contactCallbacks.onRemovedContacts||O.contactCallbacks&&O.contactCallbacks.onRemovedContacts?this.contactCallbackRemovedArbiters.push(M):rt.deallocate(M);continue}M.preStep(x,p),g+=1}a.prestepContacts+=TurbulenzEngine.getTime()*.001-S,S=TurbulenzEngine.getTime()*.001,m=s.length;for(g=0;g<m;g+=1)s[g].preStep(x,p);a.prestepConstraints+=TurbulenzEngine.getTime()*.001-S,S=TurbulenzEngine.getTime()*.001,m=r.length;for(g=0;g<m;g+=1)y=r[g],y.integrateVelocity(u,p);a.integrateVelocities+=TurbulenzEngine.getTime()*.001-S,S=TurbulenzEngine.getTime()*.001,m=o.length;for(g=0;g<m;g+=1)o[g].applyCachedImpulses();a.warmstartContacts+=TurbulenzEngine.getTime()*.001-S,S=TurbulenzEngine.getTime()*.001,m=s.length;for(g=0;g<m;g+=1)s[g].applyCachedImpulses();a.warmstartConstraints+=TurbulenzEngine.getTime()*.001-S,S=TurbulenzEngine.getTime()*.001;var D=10;for(g=0;g<D;g+=1){m=o.length;for(w=0;w<m;w+=1)o[w].computeAndApplyImpulses();m=s.length;for(w=0;w<m;w+=1)s[w].computeAndApplyImpulses()}D=3,m=o.length;for(g=0;g<D;g+=1)for(w=0;w<m;w+=1)o[w].computeAndApplyBiasImpulses();a.physicsIterations+=TurbulenzEngine.getTime()*.001-S;var P=this.persistantObjectsList2,H=0;S=TurbulenzEngine.getTime()*.001,m=r.length;var B,j=p*p,F,I;for(g=0;g<m;g+=1){y=r[g],y.applyBiasVelocities(p),y.integratePosition(p);if(!y.isActiveVelocity(A.CONTINUOUS_LINEAR_SQ/p,A.CONTINUOUS_ANGULAR_SQ/p)){y.sweepFrozen=!0,y.bullet=!1;continue}F=y.transform,I=y.endTransform,I[0]=F[0],I[1]=F[1],I[2]=F[2],I[3]=F[3],I[4]=F[4],I[5]=F[5],I[6]=F[6],I[7]=F[7],I[8]=F[8],I[9]=F[9],I[10]=F[10],I[11]=F[11],B=y.shape.radius*A.CONTINUOUS_LINEAR_BULLET;var q=y.velocity,R=(q[0]*q[0]+q[1]*q[1]+q[2]*q[2])*j,U=(q[3]*q[3]+q[4]*q[4]+q[5]*q[5])*j;y.bullet=R>B*B||U>A.CONTINUOUS_ANGULAR_BULLET,E=y.extents,y.calculateSweptExtents(E),e.update(y,E),y.sweepFrozen=!1,P[H]=y,H+=1}m=i.length;for(g=0;g<m;g+=1)y=i[g],t.m43Copy(y.transform,y.startTransform),y.integratePosition(p),E=y.extents,y.calculateSweptExtents(E),e.update(y,E);a.integratePositions+=TurbulenzEngine.getTime()*.001-S,S=TurbulenzEngine.getTime()*.001,n.finalize(),e.finalize();var z=A.CONTINUOUS_SLOP+A.CONTACT_SLOP,W=this.persistantTOIEventList,X=0,V;N=e.getOverlappingPairs(T,0);for(g=0;g<N;g+=2){L=T[g],O=T[g+1],T[g]=undefined,T[g+1]=undefined;if(!(L.bullet||L.kinematic||O.bullet||O.kinematic)||L.sweepFrozen&&O.sweepFrozen||this.filtered(L,O))continue;L.kinematic||O.kinematic?L.kinematic?X=this.performStaticTOIBase(z,p,W,X,O,L):X=this.performStaticTOIBase(z,p,W,X,L,O):(V=ot.allocate(),V.objectA=L,V.objectB=O,V.shapeA=L.shape,V.shapeB=O.shape,this.dynamicSweep(V,p,0,z),V.frozenA=L.sweepFrozen,V.frozenB=O.sweepFrozen,W[X]=V,X+=1)}for(g=0;g<H;g+=1){L=P[g],k=n.getOverlappingNodes(L.extents,T,0);for(w=0;w<k;w+=1){O=T[w],T[w]=undefined;if(this.filtered(L,O))continue;X=this.performStaticTOIBase(z,p,W,X,L,O)}}var $=0;while($<1&&X>0){var J=null,K;for(g=0;g<X;){V=W[g],L=V.objectA,O=V.objectB;if(L.sweepFrozen&&O.sweepFrozen){X-=1,g!==X&&(W[g]=W[X],W[X]=undefined),ot.deallocate(V);continue}if(V.frozenA!==L.sweepFrozen||V.frozenB!==O.sweepFrozen){V.frozenA=L.sweepFrozen,V.frozenB=O.sweepFrozen,V.frozenA&&(V.objectA=O,V.objectB=L,V.shapeA=O.shape,V.shapeB=L.shape,V.frozenA=!1,V.frozenB=!0),this.staticSweep(V,p,$,z);if(V.toi===undefined){X-=1,g!==X&&(W[g]=W[X],W[X]=undefined),ot.deallocate(V);continue}}V.toi!==undefined&&(J===null||V.toi<J.toi)&&(J=V,K=g),g+=1}if(J===null)break;X-=1,K!==X&&(W[K]=W[X],W[X]=undefined),$=J.toi,L=J.objectA,O=J.objectB,L.collisionObject||(L.sweepFrozen||(L.integratePosition(p*$),L.sweepFrozen=!0),L.permitSleep&&!L.active&&this.wakeBody(L)),O.collisionObject||(O.sweepFrozen||(O.integratePosition(p*$),O.sweepFrozen=!0),O.permitSleep&&!O.active&&this.wakeBody(O));if(L.id>O.id){var Q=L;L=O,O=Q;var G=J.closestA;J.closestA=J.closestB,J.closestB=G,G=J.axis,G[0]=-G[0],G[1]=-G[1],G[2]=-G[2]}var Y=L.shape,Z=O.shape;M=null;var et=L.arbiters,tt=
O.arbiters,nt=et.length<=tt.length?et:tt,it=nt.length;for(g=0;g<it;g+=1){var st=nt[g];if(st.shapeA===Y&&st.shapeB===Z&&st.objectA===L&&st.objectB===O){M=st;break}}var ut=M===null;ut&&(M=rt.allocate(Y,Z,L,O)),M.insertContact(J.closestA,J.closestB,J.axis,J.distance,J.concave),ut&&(o.push(M),M.active=!0,L.arbiters.push(M),O.arbiters.push(M)),L.kinematic&&L.active||O.kinematic&&O.active||(M.skipDiscreteCollisions=!0),ot.deallocate(J)}while(X>0)X-=1,ot.deallocate(W[X]),W[X]=undefined;while(H>0)H-=1,L=P[H],P[H]=undefined,L.sweepFrozen||L.integratePosition(p);a.continuous+=TurbulenzEngine.getTime()*.001-S}m=i.length;for(g=0;g<m;g+=1)y=i[g],t.m43Copy(y.newTransform,y.transform),t.m43Copy(y.newTransform,y.prevTransform);this.updateContactCallbacks(),this.midStep=!1},e.prototype.rayTest=function(e){function o(e,t,s,o,u){var a=t._public;if(a===i||(t.mask&n)===0||(t.group&r)===0)return null;s.maxFactor=u;var f=t.rayTest(s);return f!==null&&(t.collisionObject?(f.collisionObject=a,f.body=null):(f.collisionObject=null,f.body=a)),f}var n=e.group,r=e.mask;n===undefined&&(n=ft.prototype.FILTER_DYNAMIC),r===undefined&&(r=ft.prototype.FILTER_ALL);var i=e.exclude,s={origin:e.from,direction:t.v3Sub(e.to,e.from),maxFactor:1};this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize();var u=f.rayTest([this.staticSpatialMap,this.dynamicSpatialMap],s,o);return u!==null&&delete u.factor,u},e.prototype.contactPairTest=function(e,t,n){var r=e.axis,i=e.shapeA,s=e.shapeB,o=e.closestA,u=e.closestB;this.contactGJK===undefined&&(this.contactGJK=Z.create(),this.contactEPA=et.create());if(i.type==="PLANE"||s.type==="PLANE"){var a,f,l,c;i.type==="PLANE"?(a=i,l=t,f=s,c=n):(a=s,l=n,f=i,c=t);var h=l[0],p=l[1],d=l[2],v=l[3],m=l[4],g=l[5],y=l[6],b=l[7],w=l[8],E=l[9],S=l[10],x=l[11],T=a.normal,N=T[0],C=T[1],k=T[2],L=a.distance,A=N*h+C*v+k*y,O=N*p+C*m+k*b,M=N*d+C*g+k*w;h=c[0],p=c[1],d=c[2],v=c[3],m=c[4],g=c[5],y=c[6],b=c[7],w=c[8];var _=c[9],D=c[10],P=c[11];N=h*A+p*O+d*M,C=v*A+m*O+g*M,k=y*A+b*O+w*M,L+=A*(E-_)+O*(S-D)+M*(x-P),r[0]=N,r[1]=C,r[2]=k,f.localSupportWithoutMargin(r,o),r[0]=-N,r[1]=-C,r[2]=-k,f.localSupportWithoutMargin(r,u);var H=o[0]*N+o[1]*C+o[2]*k-L,B=u[0]*N+u[1]*C+u[2]*k-L,j,F,I,q;H*H<B*B?(F=o[0],I=o[1],q=o[2],j=H):(F=u[0],I=u[1],q=u[2],j=B),j<0!=H*B<0&&(j=-j,A=-A,O=-O,M=-M);var R=f.collisionRadius,U=a.collisionRadius,z=h*F+v*I+y*q+_,W=p*F+m*I+b*q+D,X=d*F+g*I+w*q+P,V=U-j,$=z+A*V,J=W+O*V,K=X+M*V;return z-=A*R,W-=O*R,X-=M*R,j-=R+U,i.type==="PLANE"?(r[0]=-A,r[1]=-O,r[2]=-M,o[0]=$,o[1]=J,o[2]=K,u[0]=z,u[1]=W,u[2]=X):(r[0]=A,r[1]=O,r[2]=M,o[0]=z,o[1]=W,o[2]=X,u[0]=$,u[1]=J,u[2]=K),j}var Q=this.contactGJK,G=Q.evaluate(e,t,n);G===undefined&&(G=this.contactEPA.evaluate(Q.simplex,e,t,n));if(G!==undefined){var Y=r[0],tt=r[1],nt=r[2],rt=i.collisionRadius,it=s.collisionRadius;return o[0]-=Y*rt,o[1]-=tt*rt,o[2]-=nt*rt,u[0]+=Y*it,u[1]+=tt*it,u[2]+=nt*it,G-rt-it}return undefined},e.prototype.convexSweepTest=function(e,n){function p(e,n,i,s,o,u){var a=i[0],f=i[1],l=i[2],c=r.axis,p=r.closestA,d=r.closestB;c[0]=-a,c[1]=-f,c[2]=-l,r.shapeA=e,r.shapeB=s;var v=0,m=0,g=100,y,b=Number.MAX_VALUE,w=!1;for(;;){var E=h.contactPairTest(r,n,o);if(E===undefined||E<A.GJK_EPA_DISTANCE_THRESHOLD){if(y!==undefined||E!==undefined)y===undefined&&(y=E),w=!0;break}if(E-b>=1)break;b=E;var S=d[0]-p[0],x=d[1]-p[1],T=d[2]-p[2],N=a*S+f*x+l*T;if(N<=A.COPLANAR_THRESHOLD)break;var C=E*E/N;v+=C;if(v>=u){y=undefined;break}y=E,n[9]+=a*C,n[10]+=f*C,n[11]+=l*C;if(y<=A.GJK_EPA_DISTANCE_THRESHOLD){w=!0;break}m+=1;if(m>g)break}return y===undefined||!w?null:{hitPoint:t.v3Copy(d),hitNormal:t.v3Copy(c),distance:v}}this.sweepCache===undefined&&(this.sweepCache={axis:t.v3BuildZero(),shapeA:null,shapeB:null,closestA:t.v3BuildZero(),closestB:t.v3BuildZero()},this.sweepTriangle=st.allocate(),this.sweepDelta=t.v3BuildZero(),this.sweepFromExtents=new Float32Array(6),this.sweepToExtents=new Float32Array(6),this.sweepExtents=new Float32Array(6),this.sweepFakeBody={shape:null,transform:null},this.sweepTransform=t.m43BuildIdentity(),this.sweepTransform2=t.m43BuildIdentity());var r=this.sweepCache,i=this.sweepTriangle,s=this.sweepDelta,o=this.sweepFromExtents,u=this.sweepToExtents,a=this.sweepExtents,f=this.sweepFakeBody,l=this.sweepTransform,c=this.sweepTransform2,h=this,d=e.shape._private,v=e.from,m=e.to,g=m[9]-v[9],y=m[10]-v[10],b=m[11]-v[11],w=Math.sqrt(g*g+y*y+b*b),E=1/w;s[0]=g*E,s[1]=y*E,s[2]=b*E;var S=e.group===undefined?ft.prototype.FILTER_DYNAMIC:e.group,x=e.mask===undefined?ft.prototype.FILTER_ALL:e.mask,T=e.exclude;f.shape=d,f.transform=v,z.prototype.calculateExtents.call(f,o),f.transform=m,z.prototype.calculateExtents.call(f,u),a[0]=o[0]<u[0]?o[0]:u[0],a[1]=o[1]<u[1]?o[1]:u[1],a[2]=o[2]<u[2]?o[2]:u[2],a[3]=o[3]>u[3]?o[3]:u[3],a[4]=o[4]>u[4]?o[4]:u[4],a[5]=o[5]>u[5]?o[5]:u[5],this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize();var N=this.persistantObjectsList,C=this.persistantTrianglesList,k=this.staticSpatialMap.getOverlappingNodes(a,N,0),L=k+this.dynamicSpatialMap.getOverlappingNodes(a,N,k),O=null,M,_;for(M=0;M<L;M+=1){var D=N[M];N[M]=undefined;var P=D._public;if(P===T||D.shape===d||(D.mask&S)===0||(D.group&x)===0)continue;var H,B=D.shape;if(B.type==="TRIANGLE_MESH"){var j=B.triangleArray;i.triangleArray=j,i.collisionRadius=B.collisionRadius;var F;if(j.spatialMap){t.m43InverseOrthonormal(D.transform,c),t.m43Mul(v,c,l),f.transform=l,z.prototype.calculateExtents.call(f,o),t.m43Mul(m,c,l),z.prototype.calculateExtents.call(f,u),a[0]=o[0]<u[0]?o[0]:u[0],a[1]=o[1]<u[1]?o[1]:u[1],a[2]=o[2]<u[2]?o[2]:u[2],a[3]=o[3]>u[3]?o[3]:u[3],a[4]=o[4]>u[4]?o[4]:u[4],a[5]=o[5]>u[5]?o[5]:u[5],F=j.spatialMap.getOverlappingNodes(a,C,0);for(_=0;_<F;_+=1){i.index=C[_].index,C[_]=undefined,t.m43Copy(v,c),H=p(d,c,s,i,D.transform,w);if(H){H.collisionObject=P,H.body=null;if(!n||n(H))O=H,w=H.distance}}}else{F=j.numTriangles;for(_=0;_<F;_+=1){i.index=_*I.prototype.TRIANGLE_SIZE,t.m43Copy(v,c),H=p(d,c,s,i,D.transform,w);if(H){H.collisionObject=P,H.body=null;if(!n||n(H))O=H,w=H.distance}}}}else{t.m43Copy(v,c),H=p(d,c,s,B,D.transform,w);if(H){D.collisionObject?(H.collisionObject=P,H.body=null):(H.collisionObject=null,H.body=P);if(!n||n(H))O=H,w=H.distance}}if(w<1e-4){for(_=M;_<L;_+=1)N[_]=undefined;break}}return O&&delete O.distance,O},e.prototype.addBody=function(e){if(e.world)return!1;e.world=this;if(e.collisionObject&&!e.kinematic)return this.collisionObjects.push(e),this.syncBody(e),!0;e.kinematic?this.kinematicBodies.push(e):this.rigidBodies.push(e);var t=!e.active;return e.previouslyActive=!0,e.active=!1,e.islandRoot=e,e.islandRank=0,t?this.syncBody(e):this.wakeBody(e),!0},e.prototype.removeBody=function(e){if(e.world!==this)return!1;var t,n;e.collisionObject&&!e.kinematic?t=this.collisionObjects:e.kinematic?(t=this.kinematicBodies,n=this.activeKinematics):(t=this.rigidBodies,n=this.activeBodies),e.world=null,t[t.indexOf(e)]=t[t.length-1],t.pop(),n&&e.active?(n[n.indexOf(e)]=n[n.length-1],n.pop(),this.dynamicSpatialMap.remove(e)):this.staticSpatialMap.remove(e),this.removeArbitersFromObject(e),this.removeFromContactCallbacks(e);var r=e.island;if(r){var i=r.bodies,s=i.indexOf(e);s!==-1&&(i[s]=i[i.length-1],i.pop()),e.island=null}return!0},e.prototype.addConstraint=function(e){if(e.world)return!1;e.world=this,this.constraints.push(e),e.bodyA&&e.bodyA.constraints.push(e),e.bodyB&&e.bodyB.constraints.push(e);var t=!e.active;return e.active=!1,e.islandRoot=e,e.islandRank=0,t||this.wakeConstraint(e),!0},e.prototype.removeConstraint=function(e){if(e.world!==this)return!1;e.world=null;var t=this.constraints;t[t.indexOf(e)]=t[t.length-1],t.pop(),e.bodyA&&(t=e.bodyA.constraints,t[t.indexOf(e)]=t[t.length-1],t.pop()),e.bodyB&&(t=e.bodyA.constraints,t[t.indexOf(e)]=t[t.length-1],t.pop()),e.active&&(t=this.activeConstraints,t[t.indexOf(e)]=t[t.length-1],t.pop());var n=e.island;if(n){var r=n.constraints,i=r.indexOf(e);i!==-1&&(r[i]=r[r.length-1],r.pop()),e.island=null}return!0},e.prototype.flush=function(){while(this.rigidBodies.length>0)this.removeBody(this.rigidBodies[0]);while(this.collisionObjects.length>0)this.removeBody(this.collisionObjects[0]);while(this.kinematicBodies.length>0)this.removeBody(this.kinematicBodies[0]);while(this.constraints.length>0)this.removeConstraint(this.constraints[0]);this.timeStamp=0},e.prototype.removeArbitersFromObject=function(e){var t=e.arbiters,n=this.activeArbiters;while(t.length>0){var r=t.pop(),i=r.objectA===e?r.objectB.arbiters:r.objectA.arbiters;i[i.indexOf(r)]=i[i.length-1],i.pop(),r.active&&(n[n.indexOf(r)]=n[n.length-1],n.pop());while(r.contacts.length>0){var s=r.contacts.pop();nt.deallocate(s)}rt.deallocate(r)}},e.prototype.removeFromContactCallbacks=function(e){var t=this.contactCallbackObjects,n=t.length,r;for(r=0;r<n;r+=1)if(t[r]===e){n-=1,r<n&&(t[r]=t[n]),t.length=n;break}e.addedToContactCallbacks=!1},e.prototype.updateContactCallbacks=function(){var e=this.contactCallbackObjects,t=e.length,n=nt.publicContacts,r=nt.callbackContacts,i,s,o,u,a,f=0;while(f<t){var l=e[f],c=l.arbiters,h=c.length;if(0===h)l.contactCallbacks.added=!1,t-=1,f<t&&(e[f]=e[t]),e.length=t;else{var p,d;for(p=0;p<h;p+=1){i=c[p];if(0!==i.contactFlags){var v=i.contacts,m=v.length;while(n.length<m)n[n.length]=tt.create();r.length=m;for(d=0;d<m;d+=1){var g=n[d];g._private=v[d],r[d]=g}s=i.objectA,o=i.objectB,u=s.contactCallbacks,a=o.contactCallbacks,i.contactFlags&1&&(null!==u&&u.onAddedContacts&&u.onAddedContacts(s._public,o._public,r),null!==a&&a.onAddedContacts&&a.onAddedContacts(s._public,o._public,r)),i.contactFlags&2&&(null!==u&&u.onProcessedContacts&&u.onProcessedContacts(s._public,o._public,r),null!==a&&a.onProcessedContacts&&a.onProcessedContacts(s._public,o._public,r)),i.contactFlags&4&&(null!==u&&u.onRemovedContacts&&u.onRemovedContacts(s._public,o._public,r),null!==a&&a.onRemovedContacts&&a.onRemovedContacts(s._public,o._public,r)),i.contactFlags=0;for(d=0;d<m;d+=1)v[d][51]=0}}f+=1}}var y=this.contactCallbackRemovedArbiters;t=y.length,r.length=0;for(f=0;f<t;f+=1)i=y[f],s=i.objectA,o=i.objectB,u=s.contactCallbacks,a=o.contactCallbacks,null!==u&&u.onRemovedContacts&&u.onRemovedContacts(s._public,o._public,r),null!==a&&a.onRemovedContacts&&a.onRemovedContacts(s._public,o._public,r),rt.deallocate(i);y.length=0},e.version=1,e}(),ft=function(){function e(){this.vendor="Turbulenz",this.genObjectId=0}return e.create=function(){return new e},e.prototype.createDynamicsWorld=function(e){return ut.create(e)},e.prototype.createPlaneShape=function(e){return _.create(e)},e.prototype.createBoxShape=function(e){return H.create(e)},e.prototype.createSphereShape=function(e){return P.create(e)},e.prototype.createCapsuleShape=function(e){return D.create(e)},e.prototype.createCylinderShape=function(e){return B.create(e)},e.prototype.createConeShape=function(e){return j.create(e)},e.prototype.createTriangleMeshShape=function(e){return R.create(e)},e.prototype.createConvexHullShape=function(e){return U.create(e)},e.prototype.createTriangleArray=function(e){return F.create(e)},e.prototype.createCollisionObject=function(e){return W.create(e)},e.prototype.createRigidBody=function(e){return V.create(e)},e.prototype.createPoint2PointConstraint=function(e){return K.create(e)},e.prototype.createHingeConstraint=function(e){return $.create("HINGE",e)},e.prototype.createConeTwistConstraint=function(e){return $.create("CONETWIST",e)},e.prototype.create6DOFConstraint=function(e){return $.create("D6",e)},e.prototype.createSliderConstraint=function(e){return $.create("SLIDER",e)},e.prototype.createCharacter=function(e){return G.create(e)},e.version=1,e}();ft.prototype.FILTER_DYNAMIC=1,ft.prototype.FILTER_STATIC=2,ft.prototype.FILTER_KINEMATIC=4,ft.prototype.FILTER_DEBRIS=8,ft.prototype.FILTER_TRIGGER=16,ft.prototype.FILTER_CHARACTER=32,ft.prototype.FILTER_PROJECTILE=64,ft.prototype.FILTER_USER_MIN=128,ft.prototype.FILTER_USER_MAX=32768,ft.prototype.FILTER_ALL=65535;var lt=function(){function e(){}return e.prototype.destroy=function(){var e=this.audioContext;e?(delete this.audioContext,delete this.buffer):delete this.audio},e.create=function(t,n){var r=new e,i=n.src;r.name=n.name||i,r.frequency=0,r.channels=0,r.bitrate=0,r.length=0,r.compressed=!n.uncompress;var s=n.onload,o,u,a,f,l=t.audioContext;if(l){r.audioContext=l;var c;if(i){if(!t.isResourceSupported(i))return s&&s(null),null;var h=function(t){t?(r.buffer=t,r.frequency=t.sampleRate,r.channels=t.numberOfChannels,r.bitrate=r.frequency*r.channels*2*8,r.length=t.duration,s&&s(r,200)):s&&s(null)},p=function(){s&&s(null)};o=n.data;if(o)l.decodeAudioData?l.decodeAudioData(o,h,p):(c=l.createBuffer(o,!1),h(c));else{var d;if(window.XMLHttpRequest)d=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return s&&s(null),null;d=new window.ActiveXObject("Microsoft.XMLHTTP")}d.onreadystatechange=function(){if(d.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=d.status,t=e!==0&&d.statusText||"No connection",n=d.response;if(d.getAllResponseHeaders()===""&&!n)s&&s(null,0);else if(e===200||e===0)if(l.decodeAudioData)l.decodeAudioData(n,h,p);else{var r=l.createBuffer(n,!1);h(r)}else s&&s(null,e)}d.onreadystatechange=null,d=null}},d.open("GET",i,!0),d.responseType="arraybuffer",d.setRequestHeader("Content-Type","text/plain"),d.send(null)}return r}o=n.data;if(o){u=o.length,a=n.channels||1,f=n.frequency;var v=Math.min(l.sampleRate,96e3),m,g,y,b;if(v===f){c=l.createBuffer(a,u/a,f);for(m=0;m<a;m+=1){g=c.getChannelData(m);for(y=m,b=0;y<u;y+=a,b+=1)g[b]=o[y]}}else{var w=f/v,E=u/(w*a)|0;c=l.createBuffer(a,E,v);for(m=0;m<a;m+=1){g=c.getChannelData(m);for(b=0;b<E;b+=1)g[b]=o[m+(b*w|0)*a]}}if(c)return r.buffer=c,r.frequency=f,r.channels=a,r.bitrate=f*a*2*8,r.length=u/(f*a),s&&s(r,200),r}}else{var S;if(i){var x=i.slice(-3);o=n.data;if(o){var T;o instanceof Uint8Array?T=o:T=new Uint8Array(o),T[0]===79&&T[1]===103&&T[2]===103&&T[3]===83?(x="ogg",i="data:audio/ogg;base64,"):T[0]===82&&T[1]===73&&T[2]===70&&T[3]===70?(x="wav",i="data:audio/wav;base64,"):(x="mp3",i="data:audio/mpeg;base64,"),i+=TurbulenzEngine.base64Encode(T)}return t.supportedExtensions[x]?(S=new Audio,S.preload="auto",S.autobuffer=!0,S.src=i,S.onerror=function(){s&&(s(null),s=null)},t.addLoadingSound(function(){if(3<=S.readyState){r.frequency=S.sampleRate||S.mozSampleRate,r.channels=S.channels||S.mozChannels,r.bitrate=r.frequency*r.channels*2*8,r.length=S.duration;if(S.buffered&&S.buffered.length&&0<S.buffered.end(0)){if(isNaN(r.length)||r.length===Number.POSITIVE_INFINITY)r.length=S.buffered.end(0);s&&(s(r,200),s=null)}else{var t=function(){S.pause(),S.removeEventListener("play",t,!1),s&&(s(r,200),s=null)};S.addEventListener("play",t,!1),S.volume=0,S.play()}return!0}return!1}),r.audio=S,r):(s&&s(null),null)}o=n.data;if(o){S=new Audio;if(S.mozSetup)return u=o.length,a=n.channels||1,f=n.frequency,S.mozSetup(a,f),r.data=o,r.frequency=f,r.channels=a,r.bitrate=f*a*2*8,r.length=u/(f*a),r.audio=S,s&&s(r,200),r;S=null}}return s&&s(null),null},e.version=1,e}(),ct=function(){function e(){}return e.prototype.play=function(e,t){var n=this.audioContext;if(n){var r=this.bufferNode;if(this.sound!==e)r&&r.stop(0);else if(r)return this.seek(t);r=this.createBufferNode(e),this.sound=e,this.playing||(this.playing=!0,this.paused=!1,this.sd.addPlayingSource(this)),t===undefined&&(t=0);if(0<t){var i=e.buffer;r.loop?r.start(0,t,i.duration):r.start(0,t,i.duration-t),this.playStart=n.currentTime-t}else r.start(0),this.playStart=n.currentTime}else{var s;if(this.sound!==e)this.stop(),e.data?(s=new Audio,s.mozSetup(e.channels,e.frequency)):s=e.audio.cloneNode(!0),this.sound=e,this.audio=s,s.loop=this.looping,s.addEventListener("ended",this.loopAudio,!1);else{if(this.playing&&!this.paused&&this.looping)return!0;s=this.audio}this.playing||(this.playing=!0,this.paused=!1,this.sd.addPlayingSource(this)),t===undefined&&(t=0);if(.05<Math.abs(s.currentTime-t))try{s.currentTime=t}catch(o){}e.data?s.mozWriteAudio(e.data):s.play()}return!0},e.prototype.stop=function(){var e=this.playing;if(e){this.playing=!1,this.paused=!1;var t=this.audioContext;if(t){this.sound=null;var n=this.bufferNode;n&&(n.stop(0),n.disconnect(),this.bufferNode=null)}else{var r=this.audio;r&&(this.sound=null,this.audio=null,r.pause(),r.removeEventListener("ended",this.loopAudio,!1),r=null)}this.sd.removePlayingSource(this)}return e},e.prototype.pause=function(){if(this.playing){if(!this.paused){this.paused=!0;var e=this.audioContext;e?(this.playPaused=e.currentTime,this.bufferNode.stop(0),this.bufferNode.disconnect(),this.bufferNode=null):this.audio.pause(),this.sd.removePlayingSource(this)}return!0}return!1},e.prototype.resume=function(e){if(this.paused){this.paused=!1;var t=this.audioContext;if(t){e===undefined&&(e=this.playPaused-this.playStart);var n=this.createBufferNode(this.sound);if(0<e){var r=this.sound.buffer;n.loop?n.start(0,e,r.duration):n.start(0,e,r.duration-e),this.playStart=t.currentTime-e}else n.start(0),this.playStart=t.currentTime}else{var i=this.audio;if(e!==undefined&&.05<Math.abs(i.currentTime-e))try{i.currentTime=e}catch(s){}i.play()}return this.sd.addPlayingSource(this),!0}return!1},e.prototype.rewind=function(){if(this.playing){var e=this.audioContext;if(e){var t=this.bufferNode;return t&&t.stop(0),t=this.createBufferNode(this.sound),t.start(0),this.playStart=e.currentTime,!0}var n=this.audio;if(n)return n.currentTime=0,!0}return!1},e.prototype.seek=function(e){if(this.playing){var t=this.audioContext;if(t){if(.05<Math.abs(t.currentTime-this.playStart-e)){var n=this.bufferNode;n&&n.stop(0),n=this.createBufferNode(this.sound);if(0<e){var r=this.sound.buffer;n.loop?n.start(0,e,r.duration):n.start(0,e,r.duration-e),this.playStart=t.currentTime-e}else n.start(0),this.playStart=t.currentTime}return!0}var i=this.audio;if(i){if(i.currentTime>e)try{i.currentTime=e}catch(s){}return!0}}return!1},e.prototype.clear=function(){this.stop()},e.prototype.setAuxiliarySendFilter=function(e,t,n){return!1},e.prototype.setDirectFilter=function(e){return!1},e.prototype.destroy=function(){this.stop();var e=this.audioContext;if(e){var t=this.pannerNode;t&&(t.disconnect(),delete this.pannerNode),delete this.audioContext}},e.create=function(n,r,i){var s=new e;s.sd=n,s.id=r,s.sound=null,s.playing=!1,s.paused=!1;var o=typeof i.gain=="number"?i.gain:1,u=i.looping||!1,a=i.pitch||1,f,l,c,h=n.audioContext;if(h){s.audioContext=h,s.bufferNode=null,s.playStart=-1,s.playPaused=-1;var p=n.gainNode,d=h.createPanner();s.pannerNode=d,d.connect(p);var v=h.createGain?h.createGain():h.createGainNode();s.gainNode=v,n.linearDistance&&(typeof d.distanceModel=="string"?d.distanceModel="linear":typeof d.LINEAR_DISTANCE=="number"&&(d.distanceModel=d.LINEAR_DISTANCE)),typeof d.panningModel=="string"?d.panningModel="equalpower":d.panningModel=d.EQUALPOWER,Object.defineProperty(s,"position",{get:function(){return f.slice()},set:function(n){f=t.v3Copy(n,f),s.relative||this.pannerNode.setPosition(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),Object.defineProperty(s,"direction",{get:function(){return l.slice()},set:function(n){l=t.v3Copy(n,l),this.pannerNode.setOrientation(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),Object.defineProperty(s,"velocity",{get:function(){return c.slice()},set:function(n){c=t.v3Copy(n,c),this.pannerNode.setVelocity(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),Object.defineProperty(s,"gain",{get:function(){return o},set:function(t){o=t,this.gainNode.gain.value=t},enumerable:!0,configurable:!1}),s.createBufferNode=function(t){var n=t.buffer,r=h.createBufferSource();return r.buffer=n,r.loop=u,r.playbackRate&&(r.playbackRate.value=a),r.connect(v),v.disconnect(),1<t.channels?v.connect(p):v.connect(d),r.start||(r.start=function(t,n,r){arguments.length<=1?this.noteOn(t):this.noteGrainOn(t,n,r)}),r.stop||(r.stop=function(t){this.noteOff(t)}),this.bufferNode=r,r},s.updateRelativePosition=function(t,n,r){1>=this.sound.channels&&d.setPosition(f[0]+t,f[1]+n,f[2]+r)},Object.defineProperty(s,"looping",{get:function(){return u},set:function(t){u=t;var n=this.bufferNode;n&&(n.loop=t)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"pitch",{get:function(){return a},set:function(t){a=t;var n=this.bufferNode;n&&n.playbackRate&&(n.playbackRate.value=t)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"tell",{get:function(){return this.playing?this.paused?this.playPaused-this.playStart:h.currentTime-this.playStart:0},enumerable:!0,configurable:!1}),Object.defineProperty(s,"minDistance",{get:function(){return d.refDistance},set:function(t){this.pannerNode.maxDistance===t&&(t=this.pannerNode.maxDistance*.999),this.pannerNode.refDistance=t},enumerable:!0,configurable:!1}),Object.defineProperty(s,"maxDistance",{get:function(){return d.maxDistance},set:function(t){this.pannerNode.refDistance===t&&(t=this.pannerNode.refDistance*1.001),this.pannerNode.maxDistance=t},enumerable:!0,configurable:!1}),Object.defineProperty(s,"rollOff",{get:function(){return d.rolloffFactor},set:function(t){this.pannerNode.rolloffFactor=t},enumerable:!0,configurable:!1})}else s.audio=null,s.gainFactor=1,s.pitch=a,s.updateAudioVolume=function(){var t=this.audio;if(t){var n=Math.min(this.gainFactor*o,1);t.volume=n,0>=n?t.muted=!0:t.muted=!1}},Object.defineProperty(s,"position",{get:function(){return f.slice()},set:function(n){f=t.v3Copy(n,f)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"direction",{get:function(){return l.slice()},set:function(n){l=t.v3Copy(n,l)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"velocity",{get:function(){return c.slice()},set:function(n){c=t.v3Copy(n,c)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"gain",{get:function(){return o},set:function(t){o=t,s.gainFactor=-1},enumerable:!0,configurable:!1}),n.loopingSupported?(Object.defineProperty(s,"looping",{get:function(){return u},set:function(t){u=t;var n=s.audio;n&&(n.loop=t)},enumerable:!0,configurable:!1}),s.loopAudio=function(){var t=s.audio;t&&(s.playing=!1,s.sd.removePlayingSource(s))}):(s.looping=u,s.loopAudio=function(){var t=s.audio;t&&(s.looping?(t.currentTime=0,t.play()):(s.playing=!1,s.sd.removePlayingSource(s)))}),Object.defineProperty(s,"tell",{get:function(){var t=s.audio;return t?t.currentTime:0},enumerable:!0,configurable:!1}),s.updateRelativePosition=function(t,n,r){var i=this.minDistance,s=this.maxDistance,o=f[0],u=f[1],a=f[2],l;if(this.relative)l=o*o+u*u+a*a;else{var c=t-o,h=n-u,p=r-a;l=c*c+h*h+p*p}var d;if(l<=i*i)d=1;else if(l>=s*s)d=0;else{var v=Math.sqrt(l);this.sd.linearDistance?d=(s-v)/(s-i):d=i/(i+this.rollOff*(v-i))}d*=this.sd.listenerGain,this.gainFactor!==d&&(this.gainFactor=d,this.updateAudioVolume())};return s.relative=i.relative,s.position=i.position||t.v3BuildZero(),s.direction=i.direction||t.v3BuildZero(),s.velocity=i.velocity||t.v3BuildZero(),s.minDistance=i.minDistance||1,s.maxDistance=i.maxDistance||3.402823466e38,s.rollOff=i.rollOff||1,s},e.version=1,e}(),ht=function(){function e(){}return e.prototype.createSource=function(e){return this.lastSourceID+=1,ct.create(this,this.lastSourceID,e)},e.prototype.createSound=function(e){return lt.create(this,e)},e.prototype.loadSoundsArchive=function(e){var t=e.src;return typeof pt!="undefined"?(pt.create({sd:this,src:t,uncompress:e.uncompress,onsoundload:function(n){e.onsoundload(n)},onload:function(n,r){e.onload&&e.onload(n,r)},onerror:function(n){e.onload&&e.onload(!1,n)}}),!0):(TurbulenzEngine.callOnError("Missing archive loader required for "+t),!1)},e.prototype.createEffect=function(e){return null},e.prototype.createEffectSlot=function(e){return null},e.prototype.createFilter=function(e){return null},e.prototype.update=function(){var e=this.listenerTransform,t=e[9],n=e[10],r=e[11],i=this.playingSources,s;for(s in i)if(i.hasOwnProperty(s)){var o=i[s];o.updateRelativePosition(t,n,r)}},e.prototype.isSupported=function(e){return"FILEFORMAT_OGG"===e?this.supportedExtensions.ogg:"FILEFORMAT_MP3"===e?this.supportedExtensions.mp3:"FILEFORMAT_WAV"===e?this.supportedExtensions.wav:!1},e.prototype.addLoadingSound=function(e){var t=this.loadingSounds;t[t.length]=e;var n=this.loadingInterval,r=this;n===null&&(this.loadingInterval=n=window.setInterval(function(){var i=t.length,s=0;do{var o=t[s];o()?(i-=1,s<i&&(t[s]=t[i]),t.length=i):s+=1}while(s<i);i===0&&(window.clearInterval(n),r.loadingInterval=null)},100))},e.prototype.addPlayingSource=function(e){this.playingSources[e.id]=e},e.prototype.removePlayingSource=function(e){delete this.playingSources[e.id]},e.prototype.isResourceSupported=function(e){var t=e.slice(-3).toLowerCase();return this.supportedExtensions[t]},e.prototype.destroy=function(){var e=this.loadingInterval;e!==null&&(window.clearInterval(e),this.loadingInterval=null);var t=this.loadingSounds;t&&(t.length=0,this.loadingSounds=null);var n=this.playingSources,r;if(n){for(r in n)if(n.hasOwnProperty(r)){var i=n[r];i&&i.stop()}this.playingSources=null}},e.create=function(n){var r=new e;r.extensions="",r.renderer="HTML5 Audio",r.alcVersion="0",r.alcExtensions="",r.alcEfxVersion="0",r.alcMaxAuxiliarySends=0,r.deviceSpecifier=n.deviceSpecifier||null,r.frequency=n.frequency||44100,r.dopplerFactor=n.dopplerFactor||1,r.dopplerVelocity=n.dopplerVelocity||1,r.speedOfSound=n.speedOfSound||343.29998779296875,r.linearDistance=n.linearDistance!==undefined?n.linearDistance:!0,r.loadingSounds=[],r.loadingInterval=null,r.playingSources={},r.lastSourceID=0;var i=window.AudioContext||window.webkitAudioContext;if(i){var s;try{s=new i}catch(o){return TurbulenzEngine.callOnError("Failed to create AudioContext:"+o),null}if(s.sampleRate===0)return null;r.renderer="WebAudio",r.audioContext=s,r.frequency=s.sampleRate,r.gainNode=s.createGain?s.createGain():s.createGainNode(),r.gainNode.connect(s.destination);var u=s.listener;u.dopplerFactor=r.dopplerFactor,u.speedOfSound=r.speedOfSound;var a,f;Object.defineProperty(r,"listenerTransform",{get:function(){return a.slice()},set:function(n){a=t.m43Copy(n,a);var r=n[9],i=n[10],s=n[11];u.setPosition(r,i,s),u.setOrientation(-n[6],-n[7],-n[8],n[3],n[4],n[5])},enumerable:!0,configurable:!1}),Object.defineProperty(r,"listenerVelocity",{get:function(){return f.slice()},set:function(n){f=t.v3Copy(n,f),u.setVelocity(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),r.update=function(){this.gainNode.gain.value=this.listenerGain;var t=a[9],n=a[10],r=a[11],i=this.playingSources,o=[],u;for(u in i)if(i.hasOwnProperty(u)){var f=i[u],l=s.currentTime-f.playStart;if(f.bufferNode.buffer.duration<l){if(!f.looping){f.playing=!1,f.sound=null,f.bufferNode.disconnect(),f.bufferNode=null,o[o.length]=u;continue}f.playStart=s.currentTime-(l-f.bufferNode.buffer.duration)}f.relative&&f.updateRelativePosition(t,n,r)}var c=o.length,h;for(h=0;h<c;h+=1)delete i[o[h]]}}r.listenerTransform=n.listenerTransform||t.m43BuildIdentity(),r.listenerVelocity=n.listenerVelocity||t.v3BuildZero(),r.listenerGain=typeof n.listenerGain=="number"?n.listenerGain:1;var l=new Audio;if(r.audioContext)r.loopingSupported=!0;else{if(l.mozSetup)try{l.mozSetup(1,22050)}catch(c){return null}r.loopingSupported=typeof l.loop=="boolean"}var h={ogg:!1,mp3:!1,wav:!1};return l.canPlayType("application/ogg")&&(h.ogg=!0),l.canPlayType("audio/mp3")&&(h.mp3=!0),l.canPlayType("audio/wav")&&(h.wav=!0),r.supportedExtensions=h,l=null,r},e.version=1,e}();ht.prototype.vendor="Turbulenz",typeof ArrayBuffer!="undefined"&&ArrayBuffer.prototype!==undefined&&ArrayBuffer.prototype.slice===undefined&&(ArrayBuffer.prototype.slice=function(t,n){var r=this.byteLength;t===undefined?t=0:t<0&&(t+=r),n===undefined?n=r:n<0&&(n+=r),r=n-t;if(0<r){var i=new Uint8Array(this,t,r),s=new Uint8Array(i);return s.buffer}return new ArrayBuffer(0)});var pt=function(){function e(){}return e.prototype.processBytes=function(e){function r(e){t+=e}function i(n){var r=t,i=r+n,s=e[r],o;if(s&&0<n){r+=1;var u=new Array(n),a=0;do u[a]=s,a+=1,s=e[r],r+=1;while(s&&a<n);while(u[a-1]===32)a-=1;u.length=a,o=String.fromCharCode.apply(null,u)}else o="";return t=i,o}function s(e){return e=e.replace(/[^\d]/g,""),parseInt("0"+e,8)}function u(e){e.fileName=i(100),r(8),r(8),r(8),e.length=s(i(12)),r(12),r(8),e.fileType=i(1),r(100),e.ustarSignature=i(6),r(2),r(32),r(32),r(8),r(8),e.fileNamePrefix=i(155),t+=12}function p(e){h.soundsLoading-=1,e?l(e):c=!1}var t=0,n=e.length,o={fileName:null,length:0,fileType:null,ustarSignature:null,fileNamePrefix:null},a=this.sd,f=this.uncompress,l=this.onsoundload,c=!0;this.soundsLoading=0;var h=this;while(t+512<=n){u(o);if(0<o.length){var d;o.fileName==="././@LongLink"?(d=i(256),t+=256,u(o)):o.fileNamePrefix&&o.ustarSignature==="ustar"?d=o.fileNamePrefix+o.fileName:d=o.fileName;if(""===o.fileType||"0"===o.fileType)this.soundsLoading+=1,a.createSound({src:d,data:a.audioContext?e.buffer.slice(t,t+o.length):e.subarray(t,t+o.length),uncompress:f,onload:p});t+=Math.floor((o.length+511)/512)*512}}return e=null,c},e.prototype.isValidHeader=function(e){return!0},e.create=function(t){var n=new e;n.sd=t.sd,n.uncompress=t.uncompress,n.onsoundload=t.onsoundload,n.onload=t.onload,n.onerror=t.onerror,n.soundsLoading=0;var r=t.src;if(r){n.src=r;var i;if(window.XMLHttpRequest)i=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror(0),null;i=new window.ActiveXObject("Microsoft.XMLHTTP")}i.onreadystatechange=function(){if(i.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=i.status,t=i.status!==0&&i.statusText||"No connection";e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200);if(i.getAllResponseHeaders()===""){var r;i.responseType==="arraybuffer"?r=!i.response:i.mozResponseArrayBuffer?r=!i.mozResponseArrayBuffer:r=!i.responseText;if(r){n.onerror&&n.onerror(0),i.onreadystatechange=null,i=null;return}}if(e===200||e===0){var s;if(i.responseType==="arraybuffer")s=i.response;else if(i.mozResponseArrayBuffer)s=i.mozResponseArrayBuffer;else{var o=i.responseText,u=o.length,a;s=[],s.length=u;for(a=0;a<u;a+=1)s[a]=o.charCodeAt(a)&255}var f=n.processBytes(new Uint8Array(s));if(n.onload){var l=function(){0<n.soundsLoading?(!TurbulenzEngine||!TurbulenzEngine.isUnloading())&&window.setTimeout(l,100):n.onload(f,e)};l()}}else n.onerror&&n.onerror(e)}i.onreadystatechange=null,i=null}},i.open("GET",t.src,!0),i.hasOwnProperty&&i.hasOwnProperty("responseType")?i.responseType="arraybuffer":i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),i.send(null)}return n},e.version=1,e}(),dt=function(){function e(){}return e.prototype.processBytes=function(e){function r(e){t+=e}function i(n){var r=t,i=r+n,s=e[r],o;if(s&&0<n){r+=1;var u=new Array(n),a=0;do u[a]=s,a+=1,s=e[r],r+=1;while(s&&a<n);while(u[a-1]===32)a-=1;u.length=a,o=String.fromCharCode.apply(null,u)}else o="";return t=i,o}function s(e){return e=e.replace(/[^\d]/g,""),parseInt("0"+e,8)}function u(e){e.fileName=i(100),r(8),r(8),r(8),e.length=s(i(12)),r(12),r(8),e.fileType=i(1),r(100),e.ustarSignature=i(6),r(2),r(32),r(32),r(8),r(8),e.fileNamePrefix=i(155),t+=12}function p(e){h.texturesLoading-=1,e?l(e):(t=n,c=!1)}var t=0,n=e.length,o={fileName:null,length:0,fileType:null,ustarSignature:null,fileNamePrefix:null},a=this.gd,f=this.mipmaps,l=this.ontextureload,c=!0;this.texturesLoading=0;var h=this;while(t+512<=n){u(o);if(0<o.length){var d;o.fileName==="././@LongLink"?(d=i(256),t+=256,u(o)):o.fileNamePrefix&&o.ustarSignature==="ustar"?d=o.fileNamePrefix+o.fileName:d=o.fileName;if(""===o.fileType||"0"===o.fileType)this.texturesLoading+=1,a.createTexture({src:d,data:e.subarray(t,t+o.length),mipmaps:f,onload:p});t+=Math.floor((o.length+511)/512)*512}}return e=null,c},e.prototype.isValidHeader=function(){return!0},e.create=function(t){var n=new e;n.gd=t.gd,n.mipmaps=t.mipmaps,n.ontextureload=t.ontextureload,n.onload=t.onload,n.onerror=t.onerror,n.texturesLoading=0;var r=t.src;if(r){n.src=r;var i;if(window.XMLHttpRequest)i=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror(0),null;i=new window.ActiveXObject("Microsoft.XMLHTTP")}i.onreadystatechange=function(){if(i.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=i.status,t=i.status!==0&&i.statusText||"No connection";e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200);if(i.getAllResponseHeaders()===""){var r;i.responseType==="arraybuffer"?r=!i.response:i.mozResponseArrayBuffer?r=!i.mozResponseArrayBuffer:r=!i.responseText;if(r){n.onerror&&n.onerror(0),i.onreadystatechange=null,i=null;return}}if(e===200||e===0){var s;if(i.responseType==="arraybuffer")s=i.response;else if(i.mozResponseArrayBuffer)s=i.mozResponseArrayBuffer;else{var o=i.responseText,u=o.length;s=[],s.length=u;for(var a=0;a<u;a+=1)s[a]=o.charCodeAt(a)&255}if(n.processBytes(new Uint8Array
(s))){if(n.onload){var f=function(){0<n.texturesLoading?(!TurbulenzEngine||!TurbulenzEngine.isUnloading())&&window.setTimeout(f,100):n.onload(!0,e)};f()}}else n.onerror&&n.onerror(e)}else n.onerror&&n.onerror(e)}i.onreadystatechange=null,i=null}},i.open("GET",t.src,!0),i.hasOwnProperty&&i.hasOwnProperty("responseType")?i.responseType="arraybuffer":i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),i.send(null)}return n},e.version=1,e}(),vt=function(){function e(){}return e.prototype.processBytes=function(e){var t=this.parseHeader(e);if(!this.isValidHeader(t))return;var n=18;this.width=t.width,this.height=t.height,this.bytesPerPixel=Math.floor(t.bpp/8),this.horzRev=t.descriptor&this.DESC_HORIZONTAL,this.vertRev=!(t.descriptor&this.DESC_VERTICAL);var r=!1,i=this.gd;switch(t.imageType){case this.TYPE_MAPPED_RLE:r=!0,t.colorMapSize>24?this.format=i.PIXELFORMAT_R8G8B8A8:t.colorMapSize>16?this.format=i.PIXELFORMAT_R8G8B8:this.format=i.PIXELFORMAT_R5G5B5A1;break;case this.TYPE_MAPPED:t.colorMapSize>24?this.format=i.PIXELFORMAT_R8G8B8A8:t.colorMapSize>16?this.format=i.PIXELFORMAT_R8G8B8:this.format=i.PIXELFORMAT_R5G5B5A1;break;case this.TYPE_GRAY_RLE:r=!0,this.format=i.PIXELFORMAT_L8;break;case this.TYPE_GRAY:this.format=i.PIXELFORMAT_L8;break;case this.TYPE_COLOR_RLE:r=!0;switch(this.bytesPerPixel){case 4:this.format=i.PIXELFORMAT_R8G8B8A8;break;case 3:this.format=i.PIXELFORMAT_R8G8B8;break;case 2:this.format=i.PIXELFORMAT_R5G5B5A1;break;default:return}break;case this.TYPE_COLOR:switch(this.bytesPerPixel){case 4:this.format=i.PIXELFORMAT_R8G8B8A8;break;case 3:this.format=i.PIXELFORMAT_R8G8B8;break;case 2:this.format=i.PIXELFORMAT_R5G5B5A1;break;default:return}break;default:return}if(t.idLength){n+=t.idLength;if(n>e.length)return}if(this.TYPE_MAPPED_RLE===t.imageType||this.TYPE_MAPPED===t.imageType){if(t.colorMapType!==1)return}else if(t.colorMapType!==0)return;if(t.colorMapType===1){var s=t.colorMapIndex,o=t.colorMapLength;if(o===0)return;var u=Math.floor(t.colorMapSize/8),a=o+s,f=[];f.length=a*u,this.colorMap=f,this.colorMapBytesPerPixel=u;var l;for(l=0;l<s*u;l+=1)f[l]=0;for(l=s*u;l<s*u;l+=1,n+=1)f[l]=e[n];n+=o*u;if(n>e.length)return;if(u>=3)for(l=s*u;l<o*u;l+=u){var c=f[l];f[l]=f[l+2],f[l+2]=c}}var h=e.subarray(n);e=null,r&&(h=this.expandRLE(h));var p=this.width*this.height*this.bytesPerPixel;if(h.length<p)return;this.horzRev&&this.flipHorz(h),this.vertRev&&this.flipVert(h),this.colorMap?h=this.expandColorMap(h):2<this.bytesPerPixel?this.convertBGR2RGB(h):2===this.bytesPerPixel&&(h=this.convertARGB2RGBA(h)),this.data=h},e.prototype.parseHeader=function(e){var t={idLength:e[0],colorMapType:e[1],imageType:e[2],colorMapIndex:e[4]<<8|e[3],colorMapLength:e[6]<<8|e[5],colorMapSize:e[7],xOrigin:e[9]<<8|e[8],yOrigin:e[11]<<8|e[10],width:e[13]<<8|e[12],height:e[15]<<8|e[14],bpp:e[16],descriptor:e[17]};return t},e.prototype.isValidHeader=function(e){if(this.TYPE_MAPPED_RLE===e.imageType||this.TYPE_MAPPED===e.imageType){if(e.colorMapType!==1)return!1}else if(e.colorMapType!==0)return!1;if(e.colorMapType===1&&e.colorMapLength===0)return!1;switch(e.imageType){case this.TYPE_MAPPED_RLE:case this.TYPE_MAPPED:break;case this.TYPE_GRAY_RLE:case this.TYPE_GRAY:break;case this.TYPE_COLOR_RLE:case this.TYPE_COLOR:switch(Math.floor(e.bpp/8)){case 4:case 3:case 2:break;default:return!1}break;default:return!1}return 16384<e.width?!1:16384<e.height?!1:!0},e.prototype.expandRLE=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=t,s=n*r*t,o=this.RLE_PACKETSIZE,u=new Uint8Array(s),a=0,f=0,l,c;do{var h=e[a];a+=1;var p=((h&~o)+1)*i;if(h&o)if(i===1){var d=e[a];a+=1;for(l=0;l<p;l+=1)u[f+c]=d}else{for(l=0;l<i;l+=1)u[f+l]=e[a+l];a+=i;for(c=i;c<p;c+=i)for(l=0;l<i;l+=1)u[f+c+l]=u[f+l]}else{for(l=0;l<p;l+=1)u[f+l]=e[a+l];a+=p}f+=p}while(f<s);return u},e.prototype.expandColorMap=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=n*r*t,s=new Uint8Array(i),o=0,u=0,a=this.colorMap;delete this.colorMap;if(t===2||t===3||t===4)do{var f=e[u]*t;u+=1;for(var l=0;l<t;l+=1)s[o]=a[f+l],o+=1}while(o<i);return t===2&&(s=this.convertARGB2RGBA(s)),s},e.prototype.flipHorz=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=Math.floor(n/2),s=n*t;for(var o=0;o<r;o+=1){for(var u=0;u<i;u+=1)for(var a=0;a<t;a+=1){var f=e[u*t+a];e[u*t+a]=e[(n-u-1)*t+a],e[(n-u-1)*t+a]=f}e+=s}},e.prototype.flipVert=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=Math.floor(r/2),s=n*t;for(var o=0;o<i;o+=1){var u=o*s,a=(r-o-1)*s;for(var f=0;f<s;f+=1){var l=e[u+f];e[u+f]=e[a+f],e[a+f]=l}}},e.prototype.convertBGR2RGB=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=n*r*t,s=0;do{var o=e[s];e[s]=e[s+2],e[s+2]=o,s+=t}while(s<i)},e.prototype.convertARGB2RGBA=function(e){var t=this.bytesPerPixel;if(t===2){var n=this.width,r=this.height,i=n*r*t,s=new Uint16Array(n*r),o=0,u=0,a,f,l,c,h=31,p=h,d=h<<5,v=h<<10;do{var m=o[1]<<8|o[0];o+=2,l=(m&p)<<1,f=(m&d)<<1,a=(m&v)<<1,c=m>>15,s[u]=a|f|l|c,u+=1}while(o<i);return s}return e},e.create=function(t){var n=new e;n.gd=t.gd,n.onload=t.onload,n.onerror=t.onerror;var r=t.src;if(r){n.src=r;var i;if(window.XMLHttpRequest)i=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror(0),null;i=new window.ActiveXObject("Microsoft.XMLHTTP")}i.onreadystatechange=function(){if(i.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=i.status,t=i.status!==0&&i.statusText||"No connection";e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200);if(i.getAllResponseHeaders()===""){var r;i.responseType==="arraybuffer"?r=!i.response:i.mozResponseArrayBuffer?r=!i.mozResponseArrayBuffer:r=!i.responseText;if(r){n.onerror&&n.onerror(0),i.onreadystatechange=null,i=null;return}}if(e===200||e===0){var s;if(i.responseType==="arraybuffer")s=i.response;else if(i.mozResponseArrayBuffer)s=i.mozResponseArrayBuffer;else{var o=i.responseText,u=o.length;s=[],s.length=u;for(var a=0;a<u;a+=1)s[a]=o.charCodeAt(a)&255}n.processBytes(new Uint8Array(s)),n.data?n.onload&&n.onload(n.data,n.width,n.height,n.format,e):n.onerror&&n.onerror(e)}else n.onerror&&n.onerror(e)}i.onreadystatechange=null,i=null}},i.open("GET",t.src,!0),i.hasOwnProperty&&i.hasOwnProperty("responseType")?i.responseType="arraybuffer":i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),i.send(null)}else n.processBytes(t.data),n.data?n.onload&&n.onload(n.data,n.width,n.height,n.format,200):n.onerror&&n.onerror(0);return n},e.version=1,e}();vt.prototype.TYPE_MAPPED=1,vt.prototype.TYPE_COLOR=2,vt.prototype.TYPE_GRAY=3,vt.prototype.TYPE_MAPPED_RLE=9,vt.prototype.TYPE_COLOR_RLE=10,vt.prototype.TYPE_GRAY_RLE=11,vt.prototype.DESC_ABITS=15,vt.prototype.DESC_HORIZONTAL=16,vt.prototype.DESC_VERTICAL=32,vt.prototype.SIGNATURE="TRUEVISION-XFILE",vt.prototype.RLE_PACKETSIZE=128;var mt=function(){function e(){}return e.create=function(t){var n=new e;return n.force=t.force,n.identifier=t.identifier,n.isGameTouch=t.isGameTouch,n.positionX=t.positionX,n.positionY=t.positionY,n.radiusX=t.radiusX,n.radiusY=t.radiusY,n.rotationAngle=t.rotationAngle,n},e}(),gt=function(){function e(){}return e.create=function(t){var n=new e;return n.changedTouches=t.changedTouches,n.gameTouches=t.gameTouches,n.touches=t.touches,n},e}(),yt=function(){function e(){this.version="0.27.0.0"}return e.prototype.setInterval=function(e,t){var n=this;return window.setInterval(function(){n.updateTime(),e()},t)},e.prototype.clearInterval=function(e){window.clearInterval(e)},e.prototype.createGraphicsDevice=function(e){if(this.graphicsDevice)return this.callOnError("GraphicsDevice already created"),null;var t=N.create(this.canvas,e);return this.graphicsDevice=t,t},e.prototype.createPhysicsDevice=function(e){if(this.physicsDevice)return this.callOnError("PhysicsDevice already created"),null;var t,n=this.getPluginObject();return n?t=n.createPhysicsDevice(e):t=ft.create(),this.physicsDevice=t,t},e.prototype.createSoundDevice=function(e){if(this.soundDevice)return this.callOnError("SoundDevice already created"),null;var t,n=this.getPluginObject();return n?t=n.createSoundDevice(e):t=ht.create(e),this.soundDevice=t,t},e.prototype.createInputDevice=function(e){if(this.inputDevice)return this.callOnError("InputDevice already created"),null;var t=C.create(this.canvas);return this.inputDevice=t,t},e.prototype.createNetworkDevice=function(e){if(this.networkDevice)throw"NetworkDevice already created";var t=k.create(e);return this.networkDevice=t,t},e.prototype.createMathDevice=function(e){try{var n=new Float32Array([1,2,3]);t.v3Build.apply(t,n),n[0]=t.FLOAT_MAX,t.FLOAT_MAX=n[0]}catch(r){}return WebGLMathDevice},e.prototype.createNativeMathDevice=function(e){return WebGLMathDevice},e.prototype.getGraphicsDevice=function(){var e=this.graphicsDevice;return e===null&&this.callOnError("GraphicsDevice not created yet."),e},e.prototype.getPhysicsDevice=function(){return this.physicsDevice},e.prototype.getSoundDevice=function(){return this.soundDevice},e.prototype.getInputDevice=function(){return this.inputDevice},e.prototype.getNetworkDevice=function(){return this.networkDevice},e.prototype.getMathDevice=function(){return WebGLMathDevice},e.prototype.getNativeMathDevice=function(){return WebGLMathDevice},e.prototype.getObjectStats=function(){return null},e.prototype.flush=function(){},e.prototype.run=function(){},e.prototype.encrypt=function(e){return e},e.prototype.decrypt=function(e){return e},e.prototype.generateSignature=function(e){return null},e.prototype.verifySignature=function(e,t){return!0},e.prototype.onerror=function(e){console.error(e)},e.prototype.onwarning=function(e){console.warn(e)},e.prototype.onperformancewarning=function(e){},e.prototype.getSystemInfo=function(){return this.systemInfo},e.prototype.request=function(e,t){var n=this,r;if(window.XMLHttpRequest)r=new window.XMLHttpRequest;else{if(!window.ActiveXObject){n.callOnError("No XMLHTTPRequest object could be created");return}r=new window.ActiveXObject("Microsoft.XMLHTTP")}var i=function(){if(r.readyState===4){if(!n.isUnloading()){var i=r.responseText,s=r.status;""===i&&(i=null);if(s===0&&i&&window.location.protocol==="file:")s=200;else if(null===r.getResponseHeader("Content-Type")&&""===r.getAllResponseHeaders()){t(null,0);return}s!==0?(404===s&&(i=null),t(i,s)):t(i,0)}r.onreadystatechange=null,r=null,t=null}};r.open("GET",e,!0),t&&(r.onreadystatechange=i),r.send()},e.prototype.destroy=function(){this.networkDevice&&delete this.networkDevice,this.inputDevice&&(this.inputDevice.destroy(),delete this.inputDevice),this.physicsDevice&&delete this.physicsDevice,this.soundDevice&&(this.soundDevice.destroy&&this.soundDevice.destroy(),delete this.soundDevice),this.graphicsDevice&&(this.graphicsDevice.destroy(),delete this.graphicsDevice),this.canvas&&delete this.canvas,this.resizeCanvas&&window.removeEventListener("resize",this.resizeCanvas,!1)},e.prototype.getPluginObject=function(){return!this.plugin&&this.pluginId&&(this.plugin=document.getElementById(this.pluginId)),this.plugin},e.prototype.unload=function(){this.unloading||(this.unloading=!0,this.onunload&&this.onunload(),this.destroy&&this.destroy())},e.prototype.isUnloading=function(){return this.unloading},e.prototype.enableProfiling=function(){},e.prototype.startProfiling=function(){console&&console.profile&&console.profileEnd&&console.profile("turbulenz")},e.prototype.stopProfiling=function(){var e;return console&&console.profile&&console.profileEnd&&(console.profileEnd(),console.profiles&&(e=console.profiles[console.profiles.length-1])),e},e.prototype.callOnError=function(e){var t=this.onerror;t&&t(e)},e.create=function(t){var n=new e,r=t.canvas,i=t.fillParent;window.TurbulenzEngineCanvas=n,n.pluginId=t.pluginId,n.plugin=null;var s=Date.now,o=window.performance;o&&(o.now?s=function(){return o.now()}:o.webkitNow&&(s=function(){return o.webkitNow()})),n.getTime=s;var u=s(),a=!0,f=navigator.userAgent,l=f.indexOf("Version/6.0");-1!==l&&-1!==f.substring(l).indexOf("Safari/")&&(a=!1),a&&Object.defineProperty?(Object.defineProperty(n,"time",{get:function(){return(s()-u)*.001},set:function(e){typeof e=="number"?u=s()-e*1e3:n.callOnError("Must set 'time' attribute to a number")},enumerable:!1,configurable:!1}),n.updateTime=function(){}):n.updateTime=function(){this.time=(s()-u)*.001};if(window.postMessage){var c="0-timeout-message",h=[],p=0,d=function(t){p+=1;var n={id:p,fn:t};return h.push(n),window.postMessage(c,"*"),n},v=function(t){var n=t,r=h.length;for(var i=0;i<r;i+=1)if(h[i].id===n){h.splice(i,1);return}},m=function(t){if(t.source===window&&t.data===c){t.stopPropagation();if(h.length&&!n.isUnloading()){var r=h.shift(),i=r.fn;i()}}};window.addEventListener("message",m,!0),n.setTimeout=function(e,t){if(t<1)return d(e);var n=this;return window.setTimeout(function(){n.updateTime(),n.isUnloading()||e()},t)},n.clearTimeout=function(e){return typeof e=="object"?v(e):window.clearTimeout(e)}}else n.setTimeout=function(e,t){var n=this;return window.setTimeout(function(){n.updateTime(),n.isUnloading()||e()},t)},n.clearTimeout=function(e){return window.clearTimeout(e)};var g=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame;g&&(n.setInterval=function(e,t){var n=this;if(Math.abs(t-1e3/60)<=1){var r={enabled:!0},i=s()+16.6,o=function a(){if(r.enabled){var t=s(),o=t-i;0<=o&&(o>50?i=t+16.6:i+=16.6,n.updateTime(),n.isUnloading()||e()),g(a,n.canvas)}};return g(o,n.canvas),r}var u=function(){n.updateTime(),n.isUnloading()||e()};return window.setInterval(u,t)},n.clearInterval=function(e){typeof e=="object"?e.enabled=!1:window.clearInterval(e)}),n.canvas=r,n.networkDevice=null,n.inputDevice=null,n.physicsDevice=null,n.soundDevice=null,n.graphicsDevice=null,i&&(n.resizeCanvas=function(){if(document.fullscreenElement===r||document.mozFullScreenElement===r||document.webkitFullscreenElement===r)r.width=window.innerWidth,r.height=window.innerHeight;else{var e=r.parentNode;r.width=e.clientWidth,r.height=e.clientHeight}},n.resizeCanvas(),window.addEventListener("resize",n.resizeCanvas,!1));try{var y=window.onbeforeunload;window.onbeforeunload=function(){n.unload(),y&&y.call(this)}}catch(b){}n.time=0;var w={architecture:"",cpuDescription:"",cpuVendor:"",numPhysicalCores:1,numLogicalCores:1,ramInMegabytes:0,frequencyInMegaHZ:0,osVersionMajor:0,osVersionMinor:0,osVersionBuild:0,osName:navigator.platform,platformProfile:"desktop",userLocale:(navigator.language||navigator.userLanguage).replace("-","_")},E=function(){var t=Math.min(window.screen.height,window.screen.width);return t<900},S=navigator.userAgent,x=S.indexOf("Windows");x!==-1?(w.osName="Windows",navigator.platform==="Win64"?w.architecture="x86_64":navigator.platform==="Win32"&&(w.architecture="x86"),x+=7,S.slice(x,x+4)===" NT "&&(x+=4,w.osVersionMajor=parseInt(S.slice(x,x+1),10),w.osVersionMinor=parseInt(S.slice(x+2,x+4),10)),E()&&(w.platformProfile="tablet")):(x=S.indexOf("Mac OS X"),x!==-1?(w.osName="Darwin",navigator.platform.indexOf("Intel")!==-1&&(w.architecture="x86"),x+=9,w.osVersionMajor=parseInt(S.slice(x,x+2),10),w.osVersionMinor=parseInt(S.slice(x+3,x+4),10),w.osVersionBuild=parseInt(S.slice(x+5,x+6),10)||0):(x=S.indexOf("Linux"),x!==-1?(w.osName="Linux",navigator.platform.indexOf("64")!==-1?w.architecture="x86_64":navigator.platform.indexOf("x86")!==-1&&(w.architecture="x86"),E()&&(w.platformProfile="tablet")):(x=S.indexOf("Android"),-1!==x?(w.osName="Android",navigator.platform.indexOf("arm")?w.architecture="arm":navigator.platform.indexOf("x86")&&(w.architecture="x86"),-1!==S.indexOf("Mobile")?w.platformProfile="smartphone":w.platformProfile="tablet"):-1!==S.indexOf("iPhone")||-1!==S.indexOf("iPod")?(w.osName="iOS",w.architecture="arm",w.platformProfile="smartphone"):-1!==S.indexOf("iPad")&&(w.osName="iOS",w.architecture="arm",w.platformProfile="tablet")))),n.systemInfo=w;var T="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".split("");return n.base64Encode=function(t){var n="",r=t.length,i=T,s,o,u,a,f,l,c,h;s=0;while(s<r)o=t[s],s+=1,f=o>>2,s<r?(u=t[s],s+=1,s<r?(a=t[s],s+=1,l=(o&3)<<4|u>>4,c=(u&15)<<2|a>>6,h=a&63):(l=(o&3)<<4|u>>4,c=(u&15)<<2,h=64)):(l=(o&3)<<4,c=64,h=64),n+=i[f],n+=i[l],n+=i[c],n+=i[h];return n},n},e}();window.WebGLTurbulenzEngine=yt;var bt=function(){function e(){this.reasonConnectionLost=0,this.reasonServiceBusy=1}return e.prototype.retryExponential=function(e,t,n){if(!this.notifiedConnectionLost&&TurbulenzEngine.time-this.connectionLostTime>this.notifyTime*.001){this.notifiedConnectionLost=!0;var r;n===0?r=this.reasonConnectionLost:r=this.reasonServiceBusy,e.reason=r,this.onRequestTimeout(r,e)}if(this.connected)this.connectionLostTime=TurbulenzEngine.time,this.notifiedConnectionLost=!1,this.connected=!1,this.reconnectTest=e,e.status=n;else if(this.reconnectTest!==e){var i=this.reconnectedObserver,s=function(){i.unsubscribe(s),t()};i.subscribe(s);return}e.expTime?(e.expTime=2*e.expTime,e.expTime>this.maxRetryTime&&(e.expTime=this.maxRetryTime)):e.expTime=this.initialRetryTime,e.retries?e.retries+=1:e.retries=1,TurbulenzEngine.setTimeout(t,e.expTime)},e.prototype.retryAfter=function(e,t,n,r){e.retries?e.retries+=1:(e.firstRetry=TurbulenzEngine.time,e.retries=1);if(!e.notifiedMaxRetries&&TurbulenzEngine.time-e.firstRetry+t>this.notifyTime){e.notifiedMaxRetries=!0;var i=this.reasonServiceBusy;e.reason=i,this.onRequestTimeout(i,e)}TurbulenzEngine.setTimeout(n,t*1e3)},e.prototype.request=function(e){var t,n=this,r=function(i,s){if(n.destroyed)return;var o=n.sendEventToHandlers,u=n.handlers;if(s===0||s===408||s===429||s===480){n.retryExponential(e,t,s);return}n.connected||(n.connected=!0,n.reconnectTest===e&&n.notifiedConnectionLost&&n.onReconnected(n.reconnectTest.reason,n.reconnectTest),n.reconnectTest=null,n.reconnectedObserver.notify());if(e.responseFilter&&!e.responseFilter.call(this,e,t,i,s))return;if(n.responseFilter&&!n.responseFilter(e,t,i,s))return;if(e.onload){var a;i&&i.name?a=i.name:a=e.src,o(u.eventOnload,{eventType:"eventOnload",name:a}),e.onload(i,s,e),e.onload=null}e=null};t=function(){if(n.destroyed)return;e.requestFn?e.requestOwner?e.requestFn.call(e.requestOwner,e.src,r,e):e.requestFn(e.src,r,e):e.requestOwner?e.requestOwner.request(e.src,r,e):TurbulenzEngine.request(e.src,r)},t()},e.prototype.addEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t)return;i.push(t)}}},e.prototype.removeEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t){i.splice(n,1);break}}}},e.prototype.sendEventToHandlers=function(e,t){var n,r=e.length;if(r)for(n=0;n<r;n+=1)e[n](t)},e.prototype.destroy=function(){this.destroyed=!0,this.handlers=null,this.onReconnected=null,this.onRequestTimeout=null},e.create=function(t){var n=new e;n.initialRetryTime=t.initialRetryTime||500,n.notifyTime=t.notifyTime||4e3,n.maxRetryTime=t.maxRetryTime||8e3,n.notifiedConnectionLost=!1,n.connected=!0,n.reconnectedObserver=l.create(),n.reconnectTest=null,n.onReconnected=t.onReconnected||function(){},n.onRequestTimeout=t.onRequestTimeout||function(){};var r={eventOnload:[]};return n.handlers=r,n},e}(),wt=function(){function e(){}return e.create=function(){return new e},e}(),Et=function(){function e(){}return e.prototype.push=function(e,t){var n=wt.create();n.key=e,n.value=t,n.timeOffset=TurbulenzEngine.time,this.events.push(n)},e.prototype.length=function(){return this.events.length},e.prototype.clear=function(){this.events.length=0},e.create=function(){var t=new e;return t.events=[],t},e}(),St=function(){function e(){}return e.prototype.request=function(e){var t=function(){e.callback&&e.callback({ok:!1,msg:"Service Unavailable. Discarding request"},503)},n=this,i=this.serviceStatusObserver,s;s=function(o,u){u?e.neverDiscard||(i.unsubscribe(s),t()):o&&(i.unsubscribe(s),n.request(e))};if(!this.running)return this.discardRequests&&!e.neverDiscard?(TurbulenzEngine.setTimeout(t,0),!1):(e.waiting||(e.waiting=!0,i.subscribe(s)),!0);var o=e.responseFilter;return e.responseFilter=function(u,a,f,l){if(l===503){var c=JSON.parse(f),h=c.data,p=h?h.discardRequests:!0;return n.discardRequests=p,p&&!e.neverDiscard?t():i.subscribe(s),xt.serviceUnavailable(n,u),!1}return o?o.call(e.requestHandler,u,a,f,l):!0},r.ajax(e),!0},e.create=function(t,n){var r=new e;return n||(n={}),r.running=!0,r.discardRequests=!1,r.serviceStatusObserver=l.create(),r.serviceName=t,r.onServiceUnavailable=n.onServiceUnavailable,r.onServiceAvailable=n.onServiceAvailable,r},e}(),xt=function(){function e(){}return e.available=function(){return window.gameSlug!==undefined},e.addBridgeEvents=function(){var e=window.top.Turbulenz,t=e&&e.Data||{},n=t.joinMultiplayerSessionId,r=this,i=function(t){r.multiplayerJoinRequestQueue.push(t)},s=function(t){var n=JSON.parse(t);n.mode&&(r.mode=n.mode),n.joinMultiplayerSessionId&&r.multiplayerJoinRequestQueue.push(n.joinMultiplayerSessionId),r.bridgeServices=!!n.bridgeServices};n&&this.multiplayerJoinRequestQueue.push(n),Tt.setOnMultiplayerSessionToJoin(i),Tt.setOnReceiveConfig(s),Tt.triggerRequestConfig(),this.responseHandlers=[null],this.responseIndex=0,Tt.on("bridgeservices.response",function(e){r.routeResponse(e)})},e.callOnBridge=function(e,t,n){var r={data:t,key:undefined};n&&(this.responseIndex+=1,this.responseHandlers[this.responseIndex]=n,r.key=this.responseIndex),Tt.emit("bridgeservices."+e,JSON.stringify(r))},e.addSignature=function(e,t){var n;return e.requestUrl=t,n=TurbulenzEngine.encrypt(JSON.stringify(e)),e.str=n,e.signature=TurbulenzEngine.generateSignature(n),e},e.routeResponse=function(e){var t=JSON.parse(e),n=t.key||0,r=this.responseHandlers[n];r&&(this.responseHandlers[n]=null,r(t.data))},e.onServiceUnavailable=function(e,t){},e.onServiceAvailable=function(e,t){},e.createGameSession=function(e,t,n){return Nt.create(e,t,n)},e.createMappingTable=function(t,n,r,i,s){var o,u=n&&n.mappingTable,a,f,l;u?(a=u.mappingTableURL,f=u.mappingTablePrefix,l=u.assetPrefix):i?(a=i.mappingTableURL||(i.mappingTableURL===""?"":"mapping_table.json"),f=i.mappingTablePrefix||(i.mappingTablePrefix===""?"":"staticmax/"),l=i.assetPrefix||(i.assetPrefix===""?"":"missing/")):(a="mapping_table.json",f="staticmax/",l="missing/");var c=function(n){var r=i&&(i.urnMapping||{}),u=s||e.defaultErrorCallback;o.setMapping(r),u(n)},h={mappingTableURL:a,mappingTablePrefix:f,assetPrefix:l,requestHandler:t,onload:r,errorCallback:c};return o=Ct.create(h),o},e.createLeaderboardManager=function(e,t,n,r){return LeaderboardManager.create(e,t,n,r)},e.createBadgeManager=function(e,t){return BadgeManager.create(e,t)},e.createStoreManager=function(e,t,n,r){return StoreManager.create(e,t,n,r)},e.createNotificationsManager=function(e,t,n,r){return NotificationsManager.create(e,t,n,r)},e.createMultiplayerSessionManager=function(e,t){return MultiPlayerSessionManager.create(e,t)},e.createUserProfile=function(t,n,r){var i={};r||(r=e.defaultErrorCallback);var s=function(t){if(t&&t.ok){t=t.data;var n;for(n in t)t.hasOwnProperty(n)&&(i[n]=t[n])}},o="/api/v1/profiles/user";return e.available()&&this.getService("profiles").request({url:o,method:"GET",callback:function(t,o){o===200?s(t):r&&r("TurbulenzServices.createUserProfile error with HTTP status "+o+": "+t.msg,o),n&&n(i)},requestHandler:t}),i},e.upgradeAnonymousUser=function(e){if(e){var t=function(n){e()};Tt.on("user.upgrade.occurred",t)}Tt.emit("user.upgrade.show")},e.sendCustomMetricEvent=function(t,n,r,i,s){s||(s=e.defaultErrorCallback);if(!e.available()){s("TurbulenzServices.sendCustomMetricEvent failed: Service not available",0);return}if("string"!=typeof t||0===t.length){s("TurbulenzServices.sendCustomMetricEvent failed: Event key must be a non-empty string",0);return}if("number"!=typeof n||isNaN(n)||!isFinite(n)){if("[object Array]"!==Object.prototype.toString.call(n)){s("TurbulenzServices.sendCustomMetricEvent failed: Event value must be a number or an array of numbers",0);return}var o,u=n.length;for(o=0;o<u;o+=1)if("number"!=typeof n[o]||isNaN(n[o])||!isFinite(n[o])){s("TurbulenzServices.sendCustomMetricEvent failed: Event value array elements must be numbers",0);return}}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event/"+i.gameSlug,method:"POST",data:{key:t,value:n,gameSessionId:i.gameSessionId},callback:function(t,n){n!==200&&s("TurbulenzServices.sendCustomMetricEvent error with HTTP status "+n+": "+t.msg,n)},requestHandler:r,encrypt:!0})},e.sendCustomMetricEventBatch=function(t,n,r,i){i||(i=e.defaultErrorCallback);if(!e.available()){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Service not available",0);return}var s=TurbulenzEngine.time,o=t.events,u,a=o.length;for(u=0;u<a;u+=1){var f=o[u].key,l=o[u].value,c=o[u].timeOffset;if("string"!=typeof f||0===f.length){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event key must be a non-empty string",0);return}if("number"!=typeof l||isNaN(l)||!isFinite(l)){if("[object Array]"!==Object.prototype.toString.call(l)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value must be a number or an array of numbers",0);return}var h,p=l.length;for(h=0;h<p;h+=1)if("number"!=typeof l[h]||isNaN(l[h])||!isFinite(l[h])){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value array elements must be numbers",0);return}}if("number"!=typeof c||isNaN(c)||!isFinite(c)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event time offset is corrupted",0);return}o[u].timeOffset=c-s}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event-batch/"+r.gameSlug,method:"POST",data:{batch:o,gameSessionId:r.gameSessionId},callback:function(t,n){n!==200&&i&&i("TurbulenzServices.sendCustomMetricEventBatch error with HTTP status "+n+": "+t.msg,n)},requestHandler:n,encrypt:!0})},e.getService=function(e){var t=this.services;if(t.hasOwnProperty(e))return t[e];var n=St.create(e);return t[e]=n,n},e.serviceUnavailable=function(t,n){var i=this.waitingServices,s=t.serviceName;if(i.hasOwnProperty(s))return;i[s]=t,t.running=!1;var o=function(r){var i=n.onServiceUnavailable;i&&i.call(r,n),r.onServiceUnavailable&&r.onServiceUnavailable(),e.onServiceUnavailable&&e.onServiceUnavailable(r)};t.discardRequests&&o(t);if(this.pollingServiceStatus)return;var u=this,a,f="/api/v1/service-status/game/read/"+window.gameSlug,l=function(r,s){if(s===200){var f=r.data,l=f.services,c=!1,h;for(h in i)if(i.hasOwnProperty(h)){var p=i[h],d=l[h],v=d.running;p.running=v,p.description=d.description;if(v){if(p.discardRequests){var m=n.onServiceAvailable;m&&m.call(p,n),p.onServiceAvailable&&p.onServiceAvailable(),e.onServiceAvailable&&e.onServiceAvailable(p)}delete i[h],p.discardRequests=!1,p.serviceStatusObserver.notify(v,p.discardRequests)}else d.discardRequests&&!p.discardRequests&&(p.discardRequests=!0,o(p),p.serviceStatusObserver.notify(v,p.discardRequests)),c=!0}if(!c){this.pollingServiceStatus=!1;return}TurbulenzEngine.setTimeout(a,f.pollInterval*1e3)}else TurbulenzEngine.setTimeout(a,u.defaultPollInterval)};a=function(){r.ajax({url:f,method:"GET",callback:l})},a()},e.multiplayerJoinRequestQueue={argsQueue:[],handler:function(){},context:undefined,paused:!0,onEvent:function(t,n){this.handler=t,this.context=n},push:function(t){var n=[t];this.paused?this.argsQueue.push(n):this.handler.apply(this.context,n)},shift:function(){var t=this.argsQueue.shift();return t?t[0]:undefined},clear:function(){this.argsQueue=[]},pause:function(){this.paused=!0},resume:function(){this.paused=!1;while(this.argsQueue.length){this.handler.apply(this.context,this.argsQueue.shift());if(this.paused)break}}},e.defaultErrorCallback=function(e,t){},e.services={},e.waitingServices={},e.pollingServiceStatus=!1,e.defaultPollInterval=4e3,e}();typeof Tt!="undefined"&&xt.addBridgeEvents();var Tt=function(){function e(){}return e._initInstance=function(){var e=window.top.Turbulenz;if(e&&e.Services){var t=e.Services.bridge;if(!t)return;this._bridge=t,this.emit=t.emit,this.on=t.gameListenerOn||t.addListener||t.setListener,this.addListener=t.gameListenerOn||t.addListener||t.setListener,this.setListener=t.gameListenerOn||t.setListener}typeof xt!="undefined"&&xt.addBridgeEvents()},e.isInitialised=function(){return this._bridge!==undefined},e.emit=function(e,t,n){},e.on=function(e,t){},e.addListener=function(){},e.setListener=function(e,t){},e.setOnReceiveConfig=function(e){this.on("config.set",e)},e.triggerRequestConfig=function(){this.emit("config.request")},e.startLoading=function(){this.emit("status.loading.start")},e.startSaving=function(){this.emit("status.saving.start")},e.stopLoading=function(){this.emit("status.loading.stop")},e.stopSaving=function(){this.emit("status.saving.stop")},e.createdGameSession=function(e){this.emit("game.session.created",e)},e.destroyedGameSession=function(e){this.emit("game.session.destroyed",e)},e.setGameSessionStatus=function(e,t){this.emit("game.session.status",e,t)},e.setGameSessionInfo=function(e){this.emit("game.session.info",e)},e.updateUserBadge=function(e){this.emit("userbadge.update",e)},e.updateLeaderBoard=function(e){this.emit("leaderboards.update",e)},e.setOnMultiplayerSessionToJoin=function(e){this.on("multiplayer.session.join",e)},e.triggerJoinedMultiplayerSession=function(e){this.emit("multiplayer.session.joined",e)},e.triggerLeaveMultiplayerSession=function(e){this.emit("multiplayer.session.leave",e)},e.triggerMultiplayerSessionMakePublic=function(e){this.emit("multiplayer.session.makepublic",e)},e.setOnBasketUpdate=function(e){this.on("basket.site.update",e)},e.triggerBasketUpdate=function(e){this.emit("basket.game.update.v2",e)},e.triggerUserStoreUpdate=function(e){this.emit("store.user.update",e)},e.setOnPurchaseConfirmed=function(e){this.on("purchase.confirmed",e)},e.setOnPurchaseRejected=function(e){this.on("purchase.rejected",e)},e.triggerShowConfirmPurchase=function(){this.emit("purchase.show.confirm")},e.triggerFetchStoreMeta=function(){this.emit("fetch.store.meta")},e.setOnStoreMeta=function(e){this.on("store.meta.v2",e)},e.triggerSendInstantNotification=function(e){this.emit("notifications.ingame.sendInstant",e)},e.triggerSendDelayedNotification=function(e){this.emit("notifications.ingame.sendDelayed",e)},e.setOnNotificationSent=function(e){this.on("notifications.ingame.sent",e)},e.triggerCancelNotificationByID=function(e){this.emit("notifications.ingame.cancelByID",e)},e.triggerCancelNotificationsByKey=function(e){this.emit("notifications.ingame.cancelByKey",e)},e.triggerCancelAllNotifications=function(e){this.emit("notifications.ingame.cancelAll",e)},e.triggerInitNotificationManager=function(e){this.emit("notifications.ingame.initNotificationManager",e)},e.setOnReceiveNotification=function(e){this.on("notifications.ingame.receive",e)},e.changeAspectRatio=function(e){this.emit("change.viewport.ratio",e)},e.setOnViewportHide=function(e){this.on("change.viewport.hide",e)},e.setOnViewportShow=function(e){this.on("change.viewport.show",e)},e.setOnFullscreenOn=function(e){this.on("change.viewport.fullscreen.on",e)},e.setOnFullscreenOff=function(e){this.on("change.viewport.fullscreen.off",e)},e.setOnMenuStateChange=function(e){this.on("change.menu.state",e)},e.setOnUserStateChange=function(e){this.on("change.user.state",e)},e.triggerOnFullscreen=function(){this.emit("trigger.viewport.fullscreen")},e.triggerOnViewportVisibility=function(){this.emit("trigger.viewport.visibility")},e.triggerOnMenuStateChange=function(){this.emit("trigger.menu.state")},e.triggerOnUserStateChange=function(){this.emit("trigger.user.state")},e.queryFullscreen=function(e){this.emit("query.viewport.fullscreen",e)},e.queryViewportVisibility=function(e){this.emit("query.viewport.visibility",e)},e.queryMenuState=function(e){this.emit("query.menu.state",e)},e.queryUserState=function(e){this.emit("query.user.state",e)},e._bridge=undefined,e}();Tt.isInitialised()||Tt._initInstance();var Nt=function(){function e(){this.post_delay=1e3}return e.prototype.setStatus=function(e){if(this.destroyed||this.status===e)return;this.status=e,Tt.setGameSessionStatus(this.gameSessionId,e)},e.prototype.destroy=function(e){var t;this.pendingUpdate&&(TurbulenzEngine.clearTimeout(this.pendingUpdate),this.pendingUpdate=null),!this.destroyed&&this.gameSessionId?(Tt.destroyedGameSession(this.gameSessionId),this.destroyed=!0,t={gameSessionId:this.gameSessionId},xt.bridgeServices?xt.callOnBridge("gamesession.destroy",t,e):r.ajax({url:"/api/v1/games/destroy-session"
,method:"POST",data:t,callback:e,requestHandler:this.requestHandler})):e&&TurbulenzEngine.setTimeout(e,0)},e.prototype.setTeamInfo=function(e){var t=this.info.sessionData,n=t.teamList||[];e.join("#")!==n.join("#")&&(t.teamList=e,this.update())},e.prototype.setPlayerInfo=function(e,t){var n=this.info.playerSessionData[e],r,i=!1;n||(n={},this.info.playerSessionData[e]=n,i=!0);for(r in t)if(t.hasOwnProperty(r)){if(!this.templatePlayerData.hasOwnProperty(r))throw"unknown session data property "+r;n[r]!==t[r]&&(n[r]=t[r],i=!0)}i&&this.update()},e.prototype.removePlayerInfo=function(e){delete this.info.playerSessionData[e],this.update()},e.prototype.clearAllPlayerInfo=function(){this.info.playerSessionData={},this.update()},e.prototype.update=function(){this.pendingUpdate||(this.pendingUpdate=TurbulenzEngine.setTimeout(this.postData,this.post_delay))},e.create=function(t,n,r){var i=new e,s=window.gameSlug,o=window.top.Turbulenz,u=o&&o.Data||{},a=u.mode||xt.mode,f="/api/v1/games/create-session/"+s,l=function(t,r){r===200?(i.mappingTable=t.mappingTable,i.gameSessionId=t.gameSessionId,n&&n(i),Tt.createdGameSession(i.gameSessionId)):i.errorCallbackFn("TurbulenzServices.createGameSession error with HTTP status "+r+": "+t.msg,r)};return i.info={sessionData:{},playerSessionData:{}},i.templatePlayerData={team:null,color:null,status:null,rank:null,score:null,sortkey:null},i.postData=function(){Tt.setGameSessionInfo(JSON.stringify(i.info)),i.pendingUpdate=null},i.pendingUpdate=null,i.gameSlug=s,i.requestHandler=t,i.errorCallbackFn=r||xt.defaultErrorCallback,i.gameSessionId=null,i.service=xt.getService("gameSessions"),i.status=null,xt.available()?(a&&(f+="/"+a),i.service.request({url:f,method:"POST",callback:l,requestHandler:t,neverDiscard:!0}),i):(n&&TurbulenzEngine.setTimeout(function(){n(i)},0),i)},e.version=1,e}(),Ct=function(){function e(){}return e.prototype.getURL=function(e,t){var n=this.overrides,r=this.currentProfile,i=n[r],s;while(i){s=i.urnmapping[e];if(s)return s;i=n[i.parent]}return s=this.urlMapping[e],s?s:(t&&t(e),this.assetPrefix+e)},e.prototype.setMapping=function(e){this.urlMapping=e},e.prototype.map=function(e,t){this.urlMapping[e]=t},e.prototype.alias=function(e,t){var n=this.urlMapping;n[e]=n[t]},e.prototype.getCurrentProfile=function(){return this.currentProfile},e.prototype.setProfile=function(e){this.overrides.hasOwnProperty(e)?this.currentProfile=e:this.currentProfile=undefined},e.create=function(t){var n=new e;n.mappingTableURL=t.mappingTableURL,n.tablePrefix=t.mappingTablePrefix,n.assetPrefix=t.assetPrefix,n.overrides={},n.errorCallbackFn=t.errorCallback||xt.defaultErrorCallback,n.currentProfile=TurbulenzEngine.getSystemInfo().platformProfile;var r=function(r){var i=r.urnmapping||r.urnremapping||{},s=r.overrides||{};n.urlMapping=i,n.overrides=s;var o=n.tablePrefix;if(o){var u=function(t){var n;for(n in t)t.hasOwnProperty(n)&&(t[n]=o+t[n])};u(i);var a;for(a in s)s.hasOwnProperty(a)&&u(s[a].urnmapping)}t.onload(n)};return n.mappingTableURL?t.requestHandler.request({src:n.mappingTableURL,onload:function(t,i){if(i===200){var s=JSON.parse(t);r(s)}else n.urlMapping={},t=t||{msg:"(no response)"},n.errorCallbackFn("MappingTable.create: HTTP status "+i+": "+t.msg,i)}}):t.mappingTableData?TurbulenzEngine.setTimeout(function(){r(JSON.parse(t.mappingTableData))},0):TurbulenzEngine.setTimeout(function(){n.errorCallbackFn("!! mappingtable params contain no url or data")},0),n},e.version=1,e}(),kt=function(){function e(){}return e.prototype.get=function(e){return null},e.create=function(t,n,r,i,s){function y(e){var t=e.parameters,n=e.techniques,r=e.programs,i,s,o,u,a,f,l,c,h,p,d,v,m,y,b;for(i in t)if(t.hasOwnProperty(i)){s=g[i];if(s!==undefined){t[i].rows=s,o={};for(u in n)if(n.hasOwnProperty(u)){a=n[u],f=a.length;for(l=0;l<f;l+=1){c=a[l];if(c.parameters.indexOf(i)!==-1){h=c.programs,p=h.length;for(d=0;d<p;d+=1)o[h[d]]=!0}}}v=new RegExp("uniform\\s+(\\w+)\\s+"+i+"\\s*\\[[^\\]]+\\]","mg"),m="uniform $1 "+i+"["+s+"]";for(y in o)o.hasOwnProperty(y)&&(b=r[y],b.code=b.code.replace(v,m))}}}i||(i=function(){});var o="default",u;if(r)u=r;else{var a={version:1,name:"default.cgfx",parameters:{worldViewProjection:{type:"float",rows:4,columns:4},diffuse:{type:"sampler2D"}},techniques:{textured3D:[{parameters:["worldViewProjection","diffuse"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!0,DepthFunc:515,DepthMask:!0,CullFaceEnable:!0,CullFace:1029,BlendEnable:!1},programs:["vp","fp"]}]},programs:{fp:{type:"fragment",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];vec4 _ret_0;uniform sampler2D diffuse;void main()\n{_ret_0=texture2D(diffuse,tz_TexCoord[0].xy);gl_FragColor=_ret_0;}"},vp:{type:"vertex",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nvec4 _OUTpos1;vec2 _OUTuv1;uniform vec4 worldViewProjection[4];void main()\n{_OUTpos1=ATTR0.xxxx*worldViewProjection[0]+ATTR0.yyyy*worldViewProjection[1]+ATTR0.zzzz*worldViewProjection[2]+worldViewProjection[3];_OUTuv1=ATTR8.xy;tz_TexCoord[0].xy=ATTR8.xy;gl_Position=_OUTpos1;}"}}};u=t.createShader(a),u||i("Default shader not created.")}var f={},c={},h={},p=0,d=null,v="",m=!1,g={};f[o]=u;var b=function(r,o){r===undefined&&i("Invalid texture path passed to ShaderManager.Load");var a=f[r];if(!a){if(!c[r]){c[r]=!0,p+=1;var g=l.create();h[r]=g,o&&g.subscribe(o);var b=function(n){if(n){var i=JSON.parse(n);m&&y(i);var o=t.createShader(i);o?f[r]=o:delete f[r],g.notify(o),delete h[r]}else s&&(s.innerHTML+="ShaderManager.load:&nbsp;'"+r+"' failed to load<br>"),delete f[r];delete c[r],p-=1};n.request({src:d&&d[r]||v+r,onload:b})}else o&&h[r].subscribe(o);return u}return o&&TurbulenzEngine.setTimeout(function(){o(a)},0),a},w=function(t,n){f[t]=f[n]},E=function(t){var n=f[t];return n?n:u},S=function(t){typeof f[t]!="undefined"&&delete f[t]},x=function(t,n){S(t),b(t,n)},T=new e;return s?(T.load=function(t,n){return s.innerHTML+="ShaderManager.load:&nbsp;'"+t+"'<br>",b(t,n)},T.map=function(t,n){s.innerHTML+="ShaderManager.map:&nbsp;'"+n+"' -> '"+t+"'<br>",w(t,n)},T.get=function(t){return s.innerHTML+="ShaderManager.get:&nbsp;'"+t+"'<br>",E(t)},T.remove=function(t){s.innerHTML+="ShaderManager.remove:&nbsp;'"+t+"'<br>",S(t)},T.reload=function(t,n){s.innerHTML+="ShaderManager. reload:&nbsp;'"+t+"'<br>",x(t,n)}):(T.load=b,T.map=w,T.get=E,T.remove=S,T.reload=x),T.reloadAll=function(){for(var t in f)f.hasOwnProperty(t)&&t!==o&&x(t)},T.getAll=function(){return f},T.getNumPendingShaders=function(){return p},T.isShaderLoaded=function(t){return!c[t]},T.isShaderMissing=function(t){return!f[t]},T.setPathRemapping=function(t,n){d=t,v=n},T.setAutomaticParameterResize=function(t,n){m=!0,g[t]=n},T.destroy=function(){if(f){var r;for(r in f)if(f.hasOwnProperty(r)){var i=f[r];i&&i.destroy()}f=null}u=null,c=null,h=null,p=0,d=null,v=null,n=null,t=null},T},e.version=1,e}(),Lt=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r},At={CONTACT_SLOP:.01,EFF_MASS_EPSILON:1e-10,ILL_THRESHOLD:1e5,CLIP_EPSILON:1.65e-10,BIAS_COEF:.15,STATIC_BIAS_COEF:.75,CONT_BIAS_COEF:.5,CONT_STATIC_BIAS_COEF:.6,BOUNCE_VELOCITY_THRESHOLD:.25,STATIC_FRIC_SQ_EPSILON:1e-4,POINT_BIAS_COEF:.5,POINT_MAX_ERROR:.2,POINT_MAX_ERROR_SQ:.2*.2,POINT_SLOP_SQ:1e-6,POINT_LARGE_ERROR_SQ:.01,POINT_LARGE_ERROR_BIAS:.75,POINT_LARGE_ERROR_MAX:.4,WELD_BIAS_COEF:.5,WELD_MAX_LINEAR_ERROR:.2,WELD_MAX_ANGULAR_ERROR:.5,WELD_MAX_LINEAR_ERROR_SQ:.2*.2,WELD_LINEAR_SLOP_SQ:1e-6,WELD_ANGULAR_SLOP_SQ:1e-6,WELD_LARGE_ERROR_SQ:.01,WELD_LARGE_ERROR_BIAS:.75,WELD_LARGE_ERROR_MAX:.4,ANGLE_BIAS_COEF:.5,ANGLE_SLOP_SQ:1e-6,DIST_BIAS_COEF:.5,DIST_SLOP_SQ:1e-6,DIST_LARGE_ERROR_SQ:.01,DIST_LARGE_ERROR_BIAS:.75,LINE_BIAS_COEF:.8,LINE_SLOP_SQ:1e-6,LINE_LARGE_ERROR_SQ:.01,LINE_LARGE_ERROR_BIAS:.9,PULLEY_BIAS_COEF:.5,PULLEY_SLOP_SQ:1e-6,PULLEY_LARGE_ERROR_SQ:.01,PULLEY_LARGE_ERROR_BIAS:.75,MIN_LINEAR_STATIC_SWEEP:.05,MIN_ANGULAR_STATIC_SWEEP:.005,MIN_LINEAR_BULLET_SWEEP:.5,MIN_ANGULAR_BULLET_SWEEP:.05,SWEEP_LIMIT:5e-4,SWEEP_SLOP:.05,MINIMUM_SWEEP_ADVANCE:1e-6,MAX_SWEEP_ITER:50,EQUAL_SQ_VEL:.2,ZERO_ANG_BIAS:.02,TOI_SLIP_SCALE:.75,DELAYED_DEATH:30,DELTA_ROTATION_EPSILON:1e-4,SLEEP_DELAY:60,SLEEP_LINEAR_SQ:6e-4,SLEEP_ANGULAR_SQ:.001,CONTAINS_EPSILON:1e-6,CONTAINS_SQ_EPSILON:1e-12,COLLINEAR_EPSILON:1e-5,COLLINEAR_SQ_EPSILON:1e-5*1e-5,NORMALIZE_EPSILON:1e-6,NORMALIZE_SQ_EPSILON:1e-12},Ot=function(){function e(){}return e.prototype.getElasticity=function(){return this._data[0]},e.prototype.getStaticFriction=function(){return this._data[1]},e.prototype.getDynamicFriction=function(){return this._data[2]},e.prototype.getRollingFriction=function(){return this._data[3]},e.prototype.getDensity=function(){return this._data[4]},e.create=function(t){var n=new e,r=t&&t.elasticity!==undefined?t.elasticity:0,i=t&&t.staticFriction!==undefined?t.staticFriction:2,s=t&&t.dynamicFriction!==undefined?t.dynamicFriction:1,o=t&&t.rollingFriction!==undefined?t.rollingFriction:.005,u=t&&t.density!==undefined?t.density:1,a=n._data=new tn.prototype.floatArray(5);return a[0]=r,a[1]=i,a[2]=s,a[3]=o,a[4]=u,n.userData=t&&t.userData?t.userData:null,n},e.version=1,e}(),Mt=function(){function e(){}return e.prototype._inWorld=function(){},e.prototype._outWorld=function(){},e.prototype._pairExists=function(e,t){return!1},e.prototype._wakeConnected=function(){},e.prototype._sleepComputation=function(e){},e.prototype._preStep=function(e){return!1},e.prototype._warmStart=function(){},e.prototype._iterateVel=function(){return!1},e.prototype._iteratePos=function(){return!1},e.prototype.init=function(e,t){var n=e._data;n[0]=t.frequency!==undefined?t.frequency:10,n[1]=t.damping!==undefined?t.damping:1,n[2]=t.maxForce!==undefined?t.maxForce:Number.POSITIVE_INFINITY,n[3]=t.maxError!==undefined?t.maxError:Number.POSITIVE_INFINITY,n[4]=-1,e._removeOnBreak=t.removeOnBreak!==undefined?t.removeOnBreak:!0,e._breakUnderError=t.breakUnderError!==undefined?t.breakUnderError:!1,e._breakUnderForce=t.breakUnderForce!==undefined?t.breakUnderForce:!1,e._stiff=t.stiff!==undefined?t.stiff:!0,e._ignoreInteractions=t.ignoreInteractions!==undefined?t.ignoreInteractions:!1,e.sleeping=t.sleeping!==undefined?t.sleeping:!1,e._active=t.disabled!==undefined?!t.disabled:!0,e.world=null,e._islandRoot=null,e._islandRank=0,e._island=null,e._isBody=!1,e._wakeTime=0,e._onBreak=[],e._onWake=[],e._onSleep=[],e.userData=t.userData||null},e.prototype.configure=function(e){var t=this._data;e.frequency!==undefined&&(t[0]=e.frequency),e.damping!==undefined&&(t[1]=e.damping),e.maxForce!==undefined&&(t[2]=e.maxForce),e.maxError!==undefined&&(t[3]=e.maxError),e.removeOnBreak!==undefined&&(this._removeOnBreak=e.removeOnBreak),e.breakUnderError!==undefined&&(this._breakUnderError=e.breakUnderError),e.breakUnderForce!==undefined&&(this._breakUnderForce=e.breakUnderForce),e.ignoreInteractions!==undefined&&(this._ignoreInteractions=e.ignoreInteractions),e.stiff!==undefined&&(this._stiff=e.stiff),this.wake(!0)},e.prototype.addEventListener=function(e,t){var n=e==="wake"?this._onWake:e==="sleep"?this._onSleep:e==="break"?this._onBreak:null;if(n===null)return!1;var r=n.indexOf(t);return r!==-1?!1:(n.push(t),this.wake(),!0)},e.prototype.removeEventListener=function(e,t){var n=e==="wake"?this._onWake:e==="sleep"?this._onSleep:e==="break"?this._onBreak:null;if(n===null)return!1;var r=n.indexOf(t);return r===-1?!1:(n.splice(r,1),this.wake(),!0)},e.prototype.wake=function(e){if(!this.world){this.sleeping=!1;return}this.world._wakeConstraint(this,!e)},e.prototype.sleep=function(){if(!this.world){this.sleeping=!0;return}this.world._forceSleepConstraint(this)},e.prototype.isEnabled=function(){return this._active},e.prototype.isDisabled=function(){return!this._active},e.prototype.enable=function(){this._active||(this._active=!0,this.world&&(this.world._enabledConstraint(this),this.wake(!0)))},e.prototype.disable=function(){this._active&&(this.world&&(this.wake(!1),this.world._disabledConstraint(this)),this._active=!1)},e.prototype.getAnchorA=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data,n=this._ANCHOR_A;return e[0]=t[n],e[1]=t[n+1],e},e.prototype.getAnchorB=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data,n=this._ANCHOR_B;return e[0]=t[n],e[1]=t[n+1],e},e.prototype.setAnchorA=function(e){var t=this._data,n=this._ANCHOR_A,r=e[0],i=e[1];if(r!==t[n]||i!==t[n+1])t[n]=r,t[n+1]=i,this.wake(!0)},e.prototype.setAnchorB=function(e){var t=this._data,n=this._ANCHOR_B,r=e[0],i=e[1];if(r!==t[n]||i!==t[n+1])t[n]=r,t[n+1]=i,this.wake(!0)},e.prototype.rotateAnchor=function(e,t,n,r){var i=e[n],s=e[n+1],o=t[5],u=t[6];e[r]=o*i-u*s,e[r+1]=u*i+o*s},e.prototype.dtRatio=function(e,t){var n=e[4],r=n===-1?1:t/n;return e[4]=t,r},e.prototype.twoBodyInWorld=function(){this.bodyA.constraints.push(this),this.bodyB.constraints.push(this)},e.prototype.twoBodyOutWorld=function(){var e=this.bodyA.constraints,t=e.indexOf(this);e[t]=e[e.length-1],e.pop(),e=this.bodyB.constraints,t=e.indexOf(this),e[t]=e[e.length-1],e.pop()},e.prototype.twoBodyPairExists=function(e,t){return e===this.bodyA&&t===this.bodyB||t===this.bodyA&&e===this.bodyB},e.prototype.twoBodyWakeConnected=function(){var e=this.bodyA;e._type===0&&e.wake(!0),e=this.bodyB,e._type===0&&e.wake(!0)},e.prototype.twoBodySleepComputation=function(e){var t=this.bodyA;t._type===0&&e(t,this),t=this.bodyB,t._type===0&&e(t,this)},e.prototype._clearCache=function(){},e.prototype.clearCache=function(){var e=this._data;e[this._JACC]=0,e[4]=-1},e.prototype.clearCache2=function(){var e=this._data,t=this._JACC;e[t]=e[t+1]=0,e[4]=-1},e.prototype.clearCache3=function(){var e=this._data,t=this._JACC;e[t]=e[t+1]=e[t+2]=0,e[4]=-1},e.prototype.soft_params=function(e,t,n,r,i,s){var o=e[r],u=o*o,a=e[3];if(s&&u>a*a)return!0;var f=2*Math.PI*e[0],l=1/(i*f*(2*e[1]+f*i)),c=1/(1+l),h=i*f*f*l;return e[n]=l*c,e[t]*=c,o*=h,u*=h*h,u>a*a&&(u=a/Math.sqrt(u),o*=u),e[r]=o,!1},e.prototype.soft_params2=function(e,t,n,r,i,s){var o=e[r],u=e[r+1],a=o*o+u*u,f=e[3];if(s&&a>f*f)return!0;var l=2*Math.PI*e[0],c=1/(i*l*(2*e[1]+l*i)),h=1/(1+c),p=i*l*l*c;return e[n]=c*h,e[t]*=h,e[t+1]*=h,e[t+2]*=h,o*=p,u*=p,a*=p*p,a>f*f&&(a=f/Math.sqrt(a),o*=a,u*=a),e[r]=o,e[r+1]=u,!1},e.prototype.soft_params3=function(e,t,n,r,i,s){var o=e[r],u=e[r+1],a=e[r+2],f=o*o+u*u+a*a,l=e[3];if(s&&f>l*l)return!0;var c=2*Math.PI*e[0],h=1/(i*c*(2*e[1]+c*i)),p=1/(1+h),d=i*c*c*h;return e[n]=h*p,e[t]*=p,e[t+1]*=p,e[t+2]*=p,e[t+3]*=p,e[t+4]*=p,e[t+5]*=p,o*=d,u*=d,a*=d,f*=d*d,f>l*l&&(f=l/Math.sqrt(f),o*=f,u*=f,a*=f),e[r]=o,e[r+1]=u,e[r+2]=a,!1},e.prototype.safe_solve=function(e,t,n,r){var i=e[n],s=e[t];e[r]=s!==0?i/s:0},e.prototype.safe_solve2=function(e,t,n,r){var i=e[n],s=e[n+1],o=e[t],u=e[t+1],a=e[t+2],f=o*a-u*u;f===0?(e[r]=o!==0?i/o:0,e[r+1]=a!==0?s/a:0):(f=1/f,e[r]=f*(a*i-u*s),e[r+1]=f*(o*s-u*i))},e.prototype.safe_solve3=function(e,t,n,r){var i=e[n],s=e[n+1],o=e[n+2],u=e[t],a=e[t+1],f=e[t+2],l=e[t+3],c=e[t+4],h=e[t+5],p=l*h-c*c,d=f*c-a*h,v=a*c-f*l,m=u*p+a*d+f*v;if(m===0){m=u*l-a*a;if(m!==0){m=1/m,e[r]=m*(l*i-a*s),e[r+1]=m*(u*s-a*i),e[r+2]=h!==0?o/h:0;return}m=u*h-f*f;if(m!==0){m=1/m,e[r]=m*(h*i-f*o),e[r+1]=l!==0?s/l:0,e[r+2]=m*(u*o-f*i);return}m=l*h-c*c;if(m!==0){m=1/m,e[r]=u!==0?i/u:0,e[r+1]=m*(h*s-c*o),e[r+2]=m*(l*o-c*s);return}e[r]=u!==0?i/u:0,e[r+1]=l!==0?s/l:0,e[r+2]=h!==0?o/h:0}else{m=1/m;var g=u*h-f*f,y=a*f-u*c,b=u*l-a*a;e[r]=m*(p*i+d*s+v*o),e[r+1]=m*(d*i+g*s+y*o),e[r+2]=m*(v*i+y*s+b*o)}},e.prototype.safe_invert=function(e,t,n){var r=e[t];r===0?e[n]=0:e[t]=1/r},e.prototype.safe_invert2=function(e,t,n){var r=e[t],i=e[t+1],s=e[t+2],o=r*s-i*i;o===0?(r!==0?e[t]=1/r:e[n]=0,s!==0?e[t+2]=1/s:e[n+1]=0,e[t+1]=0):(o=1/o,e[t]=o*s,e[t+1]=o*-i,e[t+2]=o*r)},e.prototype.safe_invert3=function(e,t,n){var r=e[t],i=e[t+1],s=e[t+2],o=e[t+3],u=e[t+4],a=e[t+5],f=o*a-u*u,l=s*u-i*a,c=i*u-s*o,h=r*f+i*l+s*c;if(h===0){h=r*o-i*i;if(h!==0){h=1/h,e[t]=h*o,e[t+1]=h*-i,e[t+3]=h*r,a!==0?e[t+5]=1/a:e[n+2]=0,e[t+2]=e[t+4]=0;return}h=r*a-s*s;if(h!==0){h=1/h,e[t]=h*a,e[t+2]=h*-s,e[t+5]=h*r,o!==0?e[t+3]=1/o:e[n+1]=0,e[t+1]=e[t+4]=0;return}h=o*a-u*u;if(h!==0){h=1/h,e[t+3]=h*a,e[t+4]=h*-u,e[t+5]=h*o,r!==0?e[t]=1/r:e[n]=0,e[t+1]=e[t+2]=0;return}r!==0?e[t]=1/r:e[n]=0,o!==0?e[t+3]=1/o:e[n+1]=0,a!==0?e[t+5]=1/a:e[n+2]=0,e[t+1]=e[t+2]=e[t+4]=0}else h=1/h,e[t]=h*f,e[t+1]=h*l,e[t+2]=h*c,e[t+3]=h*(r*a-s*s),e[t+4]=h*(i*s-r*u),e[t+5]=h*(r*o-i*i)},e}(),_t=function(e){function t(){e.apply(this,arguments),this.type="CUSTOM"}return Lt(t,e),t.prototype._inWorld=function(){var e=this.bodies,t=e.length,n;for(n=0;n<t;n+=1)e[n].constraints.push(this)},t.prototype._outWorld=function(){var e=this.bodies,t=e.length,n;for(n=0;n<t;n+=1){var r=e[n].constraints,i=r.indexOf(this);r[i]=r[r.length-1],r.pop()}},t.prototype._pairExists=function(e,t){var n=this.bodies,r=n.length,i;for(i=0;i<r;i+=1){var s=n[i];if(s===e||s===t){var o;for(o=i+1;o<r;o+=1){var u=n[o];if(s===e&&u===t||s===t&&u===e)return!0}}}return!1},t.prototype._wakeConnected=function(){var e=this.bodies,t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r._type===0&&r.wake(!0)}},t.prototype._sleepComputation=function(e){var t=this.bodies,n=t.length,r;for(r=0;r<n;r+=1){var i=t[r];i._type===0&&e(i,this)}},t.prototype._clearCache=function(){var e=this._data,t=this._J_ACC,n=t+this.dimension,r;for(r=t;r<n;r+=1)e[r]=0;e[4]=-1},t.prototype._cholesky=function(){var e=this._data,t=this._K_MASS,n=this._K_CHOLESKY,r=this.dimension,i;for(i=0;i<r;i+=1){var s=0,o;for(o=0;o<=i-1;o+=1){var u=e[n+i*r+o];s+=u*u}var a=e[t]-s,f=a<=0;f&&(a=e[t]),a=a<=0?0:Math.sqrt(a),t+=1,e[n+i*r+i]=a;var l;if(a!==0&&!f){a=1/a;for(l=i+1;l<r;l+=1){s=0;for(o=0;o<=i-1;o+=1)s+=e[n+l*r+o]*e[n+i*r+o];e[n+l*r+i]=a*(e[t]-s),t+=1}}if(f){for(l=i+1;l<r;l+=1)e[n+l*r+i]=0;for(l=0;l<i;l+=1)e[n+i*r+l]=0;t+=r-i-1}}},t.prototype._transform=function(e){var t=this._data,n=this._VECTOR_TMP,r=this._K_CHOLESKY,i=this.dimension,s,o,u,a;for(s=0;s<i;s+=1){u=t[e+s],o=t[r+s*i+s];if(o!==0){for(a=0;a<s;a+=1)u-=t[r+s*i+a]*t[n+a];t[n+s]=u/o}else t[n+s]=0}var f;for(f=0;f<i;f+=1){s=i-1-f,o=t[r+s*i+s];if(o!==0){u=t[n+s];for(a=s+1;a<i;a+=1)u-=t[r+a*i+s]*t[e+a];t[e+s]=u/o}else t[e+s]=0}},t.prototype._effMass=function(){var e=this._data,t=this.dimension,n=this.bodies,r=n.length,i=r*3,s=this._JACOBIAN,o=this._K_MASS,u,a,f;for(u=0;u<t;u+=1){var l=s+u*i;for(a=u;a<t;a+=1){var c=s+a*i,h=0;for(f=0;f<r;f+=1){var p=n[f]._data,d=f*3;h+=p[0]*(e[l+d]*e[c+d]+e[l+d+1]*e[c+d+1]),h+=p[1]*e[l+d+2]*e[c+d+2]}e[o]=h,o+=1}}},t.prototype._preStep=function(e){var t=this.dimension,n=this._data,r,i;this._posConsts&&this._posConsts.call(this);var s=this._JACOBIAN,o=this._K_CHOLESKY,u=this._BIAS;if(!this._stiff&&!this._velocityOnly){this._posError.call(this,n,u),this._jacobian.call(this,n,s),this._effMass(),this._cholesky();var a=0;i=u+t;for(r=u;r<i;r+=1){var f=n[r];a+=f*f}var l=n[3];if(this._breakUnderError&&a>l*l)return!0;var c=2*Math.PI*n[0],h=1/(e*c*(2*n[1]+c*e)),p=1/(1+h),d=-(e*c*c*h);n[6]=h*p,i=o+t*t,p=1/Math.sqrt(p);for(r=o;r<i;r+=1)n[r]*=p;a*=d*d,a>l*l&&(d*=l/Math.sqrt(a)),i=u+t;for(r=u;r<i;r+=1)n[r]*=d}else{this._jacobian.call(this,n,s),this._effMass(),this._cholesky(),i=u+t;for(r=u;r<i;r+=1)n[r]=0;n[6]=0}var v=Mt.prototype.dtRatio(n,e),m=this._J_ACC;i=m+this.dimension;for(r=m;r<i;r+=1)n[r]*=v;return n[5]=n[2]*e,!1},t.prototype._warmStart=function(){this._applyImpulse(this._J_ACC)},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(3));var n=this._data,r=this._JACOBIAN,i=this._J_ACC,s=this.bodies,o=s.length,u=o*3,a=this.dimension,f;for(f=0;f<o;f+=1){var l=s[f];if(l===e){var c=0,h=0,p=0,d;for(d=0;d<a;d+=1)c+=n[i+d]*n[r+u*d],h+=n[i+d]*n[r+u*d+1],p+=n[i+d]*n[r+u*d+2];return t[0]=c,t[1]=h,t[2]=p,t}r+=3}return t[0]=t[1]=t[2]=0,t},t.prototype._applyImpulse=function(e,t){var n=this._data,r=this._JACOBIAN,i=this.bodies,s=i.length,o=s*3,u=this.dimension,a;for(a=0;a<s;a+=1){var f=i[a],l=f._data,c=0,h=0,p=0,d;for(d=0;d<u;d+=1)c+=n[e+d]*n[r+o*d],h+=n[e+d]*n[r+o*d+1],p+=n[e+d]*n[r+o*d+2];var v=l[0],m=p*l[1];t?(l[2]+=c*v,l[3]+=h*v,m!==0&&f._deltaRotation(m)):(l[7]+=c*v,l[8]+=h*v,l[9]+=m),r+=3}},t.prototype._iterateVel=function(){var e=this.dimension,t=this._data,n,r,i=this._VECTOR,s=this._BIAS,o,u=this.bodies,a=u.length,f=this._JACOBIAN;for(n=0;n<e;n+=1){var l=t[s+n];for(o=0;o<a;o+=1){var c=u[o]._data;l-=c[7]*t[f]+c[8]*t[f+1]+c[9]*t[f+2],f+=3}t[i+n]=l}this._transform(i);var h=this._J_ACC,p=this._VECTOR_TMP,d,v=t[6];for(n=0;n<e;n+=1)d=t[p+n]=t[h+n],t[h+n]+=t[i+n]-d*v;this._velClamp&&this._velClamp.call(this,t,h);var m=0;r=h+e;for(n=h;n<r;n+=1)d=t[n],m+=d*d;var g=t[5];if(this._breakUnderForce&&m>g*g)return!0;if(!this._stiff&&m>g*g){m=g/Math.sqrt(m);for(n=h;n<r;n+=1)t[n]*=m}for(n=0;n<e;n+=1)t[i+n]=t[h+n]-t[p+n];return this._applyImpulse(i),!1},t.prototype._iteratePos=function(){if(this._velocityOnly)return!1;this._posConsts&&this._posConsts.call(this);var e=this.dimension,t=this._data,n,r,i=this._BIAS;this._posError.call(this,t,i),r=i+e;var s,o=0;for(n=i;n<r;n+=1)s=t[n],o+=s*s,t[n]=-s;var u=t[3];if(this._breakUnderError&&o>u*u)return!0;var a=this._JACOBIAN;return this._jacobian.call(this,t,a),this._effMass(),this._cholesky(),this._transform(i),this._posClamp&&this._posClamp.call(this,t,i),this._applyImpulse(i,!0),!1},t.create=function(e){var n=new t,r=n.dimension=e.dimension;n.bodies=e.bodies.concat();var i=7+(r*(4+r)+r*(r+1)/2);return i+=r*n.bodies.length*3,n._data=new tn.prototype.floatArray(i),Mt.prototype.init(n,e),n._K_MASS=7,n._K_CHOLESKY=n._K_MASS+r*(r+1)/2,n._BIAS=n._K_CHOLESKY+r*r,n._J_ACC=n._BIAS+r,n._VECTOR=n._J_ACC+r,n._JACOBIAN=n._VECTOR+r,n._VECTOR_TMP=n._JACOBIAN+r*n.bodies.length*3,n._draw=e.debugDraw,n._posConsts=e.positionConstants,n._posError=e.position,n._posClamp=e.positionClamp,n._velClamp=e.velocityClamp,n._jacobian=e.jacobian,n._velocityOnly=n._posError===undefined,n},t}(Mt),Dt=function(e){function t(){e.apply(this,arguments),this.type="PULLEY",this.dimension=1,this._ANCHOR_A=11,this._ANCHOR_B=13,this._ANCHOR_C=15,this._ANCHOR_D=17,this._JACC=9}return Lt(t,e),t.prototype.getRatio=function(){return this._data[7]},t.prototype.setRatio=function(e){var t=this._data;t[7]!==e&&(t[7]=e,this.wake(!0))},t.prototype.getLowerBound=function(){return this._data[5]},t.prototype.getUpperBound=function(){return this._data[6]},t.prototype.setLowerBound=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this._equal=e===t[6],this.wake(!0))},t.prototype.setUpperBound=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this._equal=e===t[5],this.wake(!0))},t.prototype.getAnchorC=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data,n=this._ANCHOR_C;return e[0]=t[n],e[1]=t[n+1],e},t.prototype.setAnchorC=function(e){var t=this._data,n=this._ANCHOR_C,r=e[0],i=e[1];if(r!==t[n]||i!==t[n+1])t[n]=r,t[n+1]=i,this.wake(!0)},t.prototype.getAnchorD=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data,n=this._ANCHOR_D;return e[0]=t[n],e[1]=t[n+1],e},t.prototype.setAnchorD=function(e){var t=this._data,n=this._ANCHOR_D,r=e[0],i=e[1];if(r!==t[n]||i!==t[n+1])t[n]=r,t[n+1]=i,this.wake(!0)},t.prototype._inWorld=function(){this.bodyA.constraints.push(this),this.bodyB.constraints.push(this),this.bodyB!==this.bodyC&&this.bodyC.constraints.push(this),this.bodyD.constraints.push(this)},t.prototype._outWorld=function(){var e=this.bodyA.constraints,t=e.indexOf(this);e[t]=e[e.length-1],e.pop(),e=this.bodyB.constraints,t=e.indexOf(this),e[t]=e[e.length-1],e.pop(),this.bodyB!==this.bodyC&&(e=this.bodyB.constraints,t=e.indexOf(this),e[t]=e[e.length-1],e.pop()),e=this.bodyD.constraints,t=e.indexOf(this),e[t]=e[e.length-1],e.pop()},t.prototype._pairExists=function(e,t){var n=this.bodyA,r=this.bodyB,i=this.bodyC,s=this.bodyD;return e===n&&(t===r||t===i||t===s)||e===r&&(t===n||t===i||t===s)||e===i&&(t===n||t===r||t===s)||e===s&&(t===n||t===r||t===i)},t.prototype._wakeConnected=function(){var e=this.bodyA;e._type===0&&e.wake(!0),e=this.bodyB,e._type===0&&e.wake(!0),e=this.bodyC,e!==this.bodyB&&e._type===0&&e.wake(!0),e=this.bodyD,e._type===0&&e.wake(!0)},t.prototype._sleepComputation=function(e){var t=this.bodyA;t._type===0&&e(t,this),t=this.bodyB,t._type===0&&e(t,this),t=this.bodyC,t!==this.bodyB&&t._type===0&&e(t,this),t=this.bodyD,t._type===0&&e(t,this)},t.prototype._posError=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=this.bodyC._data,i=this.bodyD._data;Mt.prototype.rotateAnchor(e,t,11,19),Mt.prototype.rotateAnchor(e,n,13,21),Mt.prototype.rotateAnchor(e,r,15,23),Mt.prototype.rotateAnchor(e,i,17,25);var s=e[5],o=e[6],u=n[2]+e[21]-(t[2]+e[19]),a=n[3]+e[22]-(t[3]+e[20]),f=i[2]+e[25]-(r[2]+e[23]),l=i[3]+e[26]-(r[3]+e[24]),c=u*u+a*a,h=f*f+l*l,p;c<At.NORMALIZE_SQ_EPSILON?(c=0,u=e[29],a=e[30]):(c=Math.sqrt(c),p=1/c,u*=p,a*=p);var d=e[7];h<At.NORMALIZE_SQ_EPSILON?(h=0,f=e[31],l=e[32]):(h=Math.sqrt(h),p=d/h,f*=p,l*=p);var v=c+h*d;this._equal?(v-=s,this._slack=!1):v<s?(v=s-v,u=-u,a=-a,f=-f,l=-l,this._slack=!1):v>o?(v-=o,this._slack=!1):(u=-u,a=-a,f=-f,l=-l,v=0,this._slack=!0),e[29]=u,e[30]=a,e[31]=f,e[32]=l,e[28]=-v},t.prototype._preStep=function(e){this._posError();if(this._slack)return!1;var t=this._data,n=this.bodyA._data,r=this.bodyB._data,i=this.bodyC._data,s=this.bodyD._data,o=t[7];o*=o;var u=t[29],a=t[30],f=t[31],l=t[32],c=t[33]=t[19]*a-t[20]*u,h=t[34]=t[21]*a-t[22]*u,p=t[35]=t[23]*l-t[24]*f,d=t[36]=t[25]*l-t[26]*f,v=i[0],m=i[1],g=n[0]+r[0]+o*(v+s[0])+c*n[1]*c+h*r[1]*h+p*m*p+d*s[1]*d;r===i&&(g-=2*((u*f+a*l)*v+h*p*m)),t[8]=g,Mt.prototype.safe_invert(t,8,9);if(!this._stiff){if(Mt.prototype.soft_params(t,8,27,28,e,this._breakUnderError))return!0}else t[27]=0,t[28]=0;var y=Mt.prototype.dtRatio(t,e);return t[9]*=y,t[10]=t[2]*e,!1},t.prototype._warmStart=function(){if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=this.bodyC._data,i=this.bodyD._data,s=e[9],o=e[29]*s,u=e[30]*s,a=t[0];t[7]-=o*a,t[8]-=u*a,t[9]-=e[33]*s*t[1],a=n[0],n[7]+=o*a,n[8]+=u*a,n[9]+=e[34]*s*n[1],o=e[31]*s,u=e[32]*s,a=r[0],r[7]-=o*a,r[8]-=u*a,r[9]-=e[35]*s*r[1],a=i[0],i[7]+=o*a,i[8]+=u*a,i[9]+=e[36]*s*i[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(3));var n=r[9],r=this._data;if(e===this.bodyA)t[0]=-(r[29]*n),t[1]=-(r[30]*n),t[2]=-r[33]*n;else if(e===this.bodyD)t[0]=r[31]*n,t[1]=r[32]*n,t[2]=r[36]*n;else{var i=0,s=0,o=0;e===this.bodyB&&(i+=r[29]*n,s+=r[30]*n,o+=r[34]*n),e===this.bodyC&&(i-=r[31]*n,s-=r[32]*n,o-=r[35]*n),t[0]=i,t[1]=s,t[2]=o}return t},t.prototype._iterateVel=function(){if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=this.bodyC._data,i=this.bodyD._data,s=e[29],o=e[30],u=e[31],a=e[32],f=e[33],l=e[34],c=e[35],h=e[36],p=e[28]-(s*(n[7]-t[7])+o*(n[8]-t[8])+u*(i[7]-r[7])+a*(i[8]-r[8])+l*n[9]-f*t[9]+h*i[9]-c*r[9]),d=e[9],v=e[8]*p-d*e[27],m=d+v,g=e[10];!this._equal&&m>0&&(m=0);if(this._breakUnderForce){if(m>g||m<-g)return!0}else this._stiff||(m>g?m=g:m<-g&&(m=-g));v=m-d,e[9]=m;var y=e[29]*v,b=e[30]*v,w=t[0];return t[7]-=y*w,t[8]-=b*w,t[9]-=f*v*t[1],w=n[0],n[7]+=y*w,n[8]+=b*w,n[9]+=l*v*n[1],y=e[31]*v,b=e[32]*v,w=r[0],r[7]-=y*w,r[8]-=b*w,r[9]-=c*v*r[1],w=i[0],i[7]+=y*w,i[8]+=b*w,i[9]+=h*v*i[1],!1},t.prototype._iteratePos=function(){this._posError();if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=this.bodyC._data,i=this.bodyD._data,s=t[0],o=n[0],u=r[0],a=i[0],f=t[1],l=n[1],c=r[1],h=i[1],p=e[28],d=e[3];if(this._breakUnderError&&(p>d||p<-d))return!0;var v=At.PULLEY_SLOP_SQ;if(p*p<v)return!1;p*=At.PULLEY_BIAS_COEF;var m=e[7];m*=m;var g=s+o+m*(u+a),y=e[29],b=e[30],w=e[31],E=e[32];n===r&&(g-=2*(y*w+b*E)*o);var S,x,T;if(p*p>At.PULLEY_LARGE_ERROR_SQ&&g>At.EFF_MASS_EPSILON){S=p*At.PULLEY_LARGE_ERROR_BIAS/g;if(this._equal||S<0)x=y*S,T=b*S,t[2]-=x*s,t[3]-=T*s,n[2]+=x*o,n[3]+=T*o,x=w*S,T=E*S,r[2]-=x*u,r[3]-=T*u,i[2]+=x*a,i[3]+=T*a,this._posError(),y=e[29],b=e[30],w=e[31],E=e[32],p=e[28]*At.PULLEY_BIAS_COEF}var N=e[19]*b-e[20]*y,C=e[21]*b-e[22]*y,k=e[23]*E-e[24]*w,L=e[25]*E-e[26]*w;g+=N*f*N+C*l*C+k*c*k+L*h*L,n===n&&(g-=2*C*l*k),e[8]=g,e[28]=p,Mt.prototype.safe_solve(e,8,28,28),S=e[28];if(this._equal||S<0){var A;x=y*S,T=b*S,t[2]-=x*s,t[3]-=T*s,A=-N*S*f,A!==0&&this.bodyA._deltaRotation(A),n[2]+=x*o,n[3]+=T*o,A=C*S*l,A!==0&&this.bodyB._deltaRotation(A),x=w*S,T=E*S,r[2]-=x*u,r[3]-=T*u,A=-k*S*c,A!==0&&this.bodyC._deltaRotation(A),i[2]+=x*a,i[3]+=T*a,A=L*S*h,A!==0&&this.bodyD._deltaRotation(A)}return!1},t.create=function(e){var n=new t,r=n._data=new tn.prototype.floatArray(37);Mt.prototype.init(n,e);var i=e.anchorA;r[11]=i?i[0]:0,r[12]=i?i[1]:0,i=e.anchorB,r[13]=i?i[0]:0,r[14]=i?i[1]:0,i=e.anchorC,r[15]=i?i[0]:0,r[16]=i?i[1]:0,i=e.anchorD,r[17]=i?i[0]:0,r[18]=i?i[1]:0;var s=r[5]=e.lowerBound!==undefined?e.lowerBound:0,o=r[6]=e.upperBound!==undefined?e.upperBound:0;return n._equal=s===o,r[7]=e.ratio!==undefined?e.ratio:1,n._slack=!1,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n.bodyC=e.bodyC,n.bodyD=e.bodyD,r[29]=1,r[30]=0,r[31]=1,r[32]=0,n},t}(Mt),Pt=function(e){function t(){e.apply(this,arguments),this.type="MOTOR",this.dimension=1,this._JACC=8}return Lt(t,e),t.prototype.getRate=function(){return this._data[5]},t.prototype.getRatio=function(){return this._data[6]},t.prototype.setRate=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this.wake(!0))},t.prototype.setRatio=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this.wake(!0))},t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data,i=t[6];t[7]=n[1]+i*i*r[1],Mt.prototype.safe_invert(t,7,8);var s=Mt.prototype.dtRatio(t,e);return t[8]*=s,t[9]=t[2]*e,!1},t.prototype._warmStart=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[8];t[9]-=r*t[1],n[9]+=e[6]*r*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(3));var n=this._data;return t[0]=t[1]=0,t[2]=(e===this.bodyA?-1:e===this.bodyB?n[6]:0)*n[8],t},t.prototype._iterateVel=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[6],i=e[7]*(e[5]+t[9]-r*n[9]),s=e[8],o=s+i,u=e[9];return this._breakUnderForce&&(o>u||o<-u)?!0:(o>u?o=u:o<-u&&(o=-u),i=o-s,e[8]=o,t[9]-=i*t[1],n[9]+=r*i*n[1],!1)},t.prototype._iteratePos=function(){return!1},t.create=function(e){var n=new t,r=n._data=new tn.prototype.floatArray(10);return Mt.prototype.init(n,e),r[5]=e.rate!==undefined?e.rate:0,r[6]=e.ratio!==undefined?e.ratio:1,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(Mt);Pt.prototype._inWorld=Mt.prototype.twoBodyInWorld,Pt.prototype._outWorld=Mt.prototype.twoBodyOutWorld,Pt.prototype._pairExists=Mt.prototype.twoBodyPairExists,Pt.prototype._wakeConnected=Mt.prototype.twoBodyWakeConnected,Pt.prototype._sleepComputation=Mt.prototype.twoBodySleepComputation;var Ht=function(e){function t(){e.apply(this,arguments),this.type="LINE",this.dimension=2,this._ANCHOR_A=7,this._ANCHOR_B=9,this._JACC=22}return Lt(t,e),t.prototype.getLowerBound=function(){return this._data[5]},t.prototype.getUpperBound=function(){return this._data[6]},t.prototype.setLowerBound=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this._equal=e===t[6],this.wake(!0))},t.prototype.setUpperBound=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this._equal=e===t[5],this.wake(!0))},t.prototype.getAxis=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data;return e[0]=t[11],e[1]=t[12],e},t.prototype.setAxis=function(e){var t=this._data,n=e[0],r=e[1];if(n!==t[11]||r!==t[12]){var i=n*n+r*r;if(i===0)return;i=1/Math.sqrt(i),n*=i,r*=i,t[11]=n,t[12]=r,this.wake(!0)}},t.prototype._posError=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data;Mt.prototype.rotateAnchor(e,t,7,13),Mt.prototype.rotateAnchor(e,n,9,15),Mt.prototype.rotateAnchor(e,t,11,17);var r=e[5],i=e[6],s=e[13],o=e[14],u=e[15],a=e[16],f=e[17],l=e[18],c=e[28]=n[2]+u-(t[2]+s),h=e[29]=n[3]+a-(t[3]+o),p=f*h-l*c,d=f*c+l*h;this._equal?(d-=r,e[32]=1):d>i?(d-=i,e[32]=1):d<r?(d=r-d,e[32]=-1):(d=0,e[32]=0),e[26]=-p,e[27]=-d},t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data;this._posError();var i=t[13],s=t[14],o=t[15],u=t[16],a=t[17],f=t[18],l=t[32],c=t[28]+i,h=t[29]+s,p=t[28]=a*h-f*c,d=t[29]=a*u-f*o,v=t[30]=a*c+f*h,m=t[31]=a*o+f*u,g=n[0]+r[0],y=n[1],b=r[1];t[19]=g+v*y*v+m*b*m,t[20]=-l*(v*y*p+m*b*d),t[21]=l*l*(g+p*y*p+d*b*d),Mt.prototype.safe_invert2(t,19,22);if(!this._stiff){if(Mt.prototype.soft_params2(t,19,25,26,e,this._breakUnderError))return!0}else t[25]=0,t[26]=0,t[27]=0;var w=Mt.prototype.dtRatio(t,e);return t[22]*=w,t[23]*=w,t[24]=t[2]*e,!1},t.prototype._warmStart=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[22],i=e[23],s=e[32],o=e[17],u=e[18],a=s*o*i-u*r,f=o*r+s*u*i,l=t[0];t[7]-=a*l,t[8]-=f*l,t[9]+=(s*e[28]*i-e[30]*r)*t[1],l=n[0],n
[7]+=a*l,n[8]+=f*l,n[9]+=(e[31]*r-s*e[29]*i)*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(3));var n=this._data,r=n[22],i=n[23],s=n[32],o=n[17],u=n[18],a=s*o*i-u*r,f=o*r+s*u*i;return e===this.bodyA?(t[0]=-a,t[1]=-f,t[2]=s*n[28]*i-n[30]*r):e===this.bodyB?(t[0]=a,t[1]=f,t[2]=n[31]*r-s*n[29]*i):t[0]=t[1]=t[2]=0,t},t.prototype._iterateVel=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[32],i=e[17],s=e[18],o=e[28],u=e[29],a=e[30],f=e[31],l=n[7]-t[7],c=n[8]-t[8],h=t[9],p=n[9],d=e[26]-(i*c-s*l+p*f-h*a),v=e[27]-r*(i*l+s*c-p*u+h*o),m=e[22],g=e[23],y=e[25],b=e[20],w=e[19]*d+b*v-m*y,E=b*d+e[21]*v-g*y,S=m+w,x=g+E;!this._equal&&x>0&&(x=0);var T=S*S+x*x,N=e[24];if(this._breakUnderForce){if(T>N*N)return!0}else this._stiff||T>N*N&&(T=N/Math.sqrt(T),S*=T,x*=T);w=S-m,E=x-g,e[22]=S,e[23]=x;var C=r*i*E-s*w,k=i*w+r*s*E,L=t[0];return t[7]-=C*L,t[8]-=k*L,t[9]+=(r*o*E-a*w)*t[1],L=n[0],n[7]+=C*L,n[8]+=k*L,n[9]+=(f*w-r*u*E)*n[1],!1},t.prototype._iteratePos=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data;this._posError();var r=e[26],i=e[27],s=r*r+i*i,o=e[3];if(this._breakUnderError&&s>o*o)return!0;var u=At.LINE_SLOP_SQ;if(s<u)return!1;var a=At.LINE_BIAS_COEF;r*=a,i*=a,s*=a*a;var f=t[0],l=n[0],c=t[1],h=n[1],p=f+l,d=e[17],v=e[18],m=e[32],g,y;if(s>At.LINE_LARGE_ERROR_SQ&&p>At.EFF_MASS_EPSILON){var b=At.LINE_LARGE_ERROR_BIAS/p;g=b*(v*r-m*d*i),y=b*(d*r*m-v*r),t[2]-=g*f,t[3]-=y*f,n[2]+=g*l,n[3]+=y*l,this._posError(),d=e[17],v=e[18],m=e[32],r=e[26]*a,i=e[27]*a}var w=e[13],E=e[14],S=e[15],x=e[16],T=e[28]+w,N=e[29]+E,C=d*N-v*T,k=d*x-v*S,L=d*T+v*N,A=d*S+v*x;e[19]=p+L*c*L+A*h*A,e[20]=-m*(L*c*C+A*h*k),e[21]=m*m*(p+C*c*C+k*h*k),e[26]=r,e[27]=i,Mt.prototype.safe_solve2(e,19,26,26);var O=e[26],M=e[27];!this._equal&&M>0&&(M=0),g=m*d*M-v*O,y=d*O+m*v*M,t[2]-=g*f,t[3]-=y*f;var _=(m*C*M-L*O)*c;return _!==0&&this.bodyA._deltaRotation(_),n[2]+=g*l,n[3]+=y*l,_=(A*O-m*k*M)*h,_!==0&&this.bodyB._deltaRotation(_),!1},t.create=function(e){var n=new t,r=n._data=new tn.prototype.floatArray(33);Mt.prototype.init(n,e);var i=e.anchorA;r[7]=i?i[0]:0,r[8]=i?i[1]:0,i=e.anchorB,r[9]=i?i[0]:0,r[10]=i?i[1]:0,i=e.axis,r[11]=i[0],r[12]=i[1];var s=r[5]=e.lowerBound!==undefined?e.lowerBound:Number.NEGATIVE_INFINITY,o=r[6]=e.upperBound!==undefined?e.upperBound:Number.POSITIVE_INFINITY;return n._equal=s===o,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(Mt);Ht.prototype._inWorld=Mt.prototype.twoBodyInWorld,Ht.prototype._outWorld=Mt.prototype.twoBodyOutWorld,Ht.prototype._pairExists=Mt.prototype.twoBodyPairExists,Ht.prototype._wakeConnected=Mt.prototype.twoBodyWakeConnected,Ht.prototype._sleepComputation=Mt.prototype.twoBodySleepComputation;var Bt=function(e){function t(){e.apply(this,arguments),this.type="DISTANCE",this.dimension=1,this._ANCHOR_A=7,this._ANCHOR_B=9,this._JACC=16}return Lt(t,e),t.prototype.getLowerBound=function(){return this._data[5]},t.prototype.getUpperBound=function(){return this._data[6]},t.prototype.setLowerBound=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this._equal=e===t[6],this.wake(!0))},t.prototype.setUpperBound=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this._equal=e===t[5],this.wake(!0))},t.prototype._posError=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[5],i=e[6];Mt.prototype.rotateAnchor(e,t,7,11),Mt.prototype.rotateAnchor(e,n,9,13);var s=n[2]+e[13]-(t[2]+e[11]),o=n[3]+e[14]-(t[3]+e[12]),u=s*s+o*o;if(u<At.NORMALIZE_SQ_EPSILON)s=e[20],o=e[21],u=0;else{u=Math.sqrt(u);var a=1/u;s*=a,o*=a}this._equal?(u-=r,this._slack=!1):u<r?(u=r-u,s=-s,o=-o,this._slack=!1):u>i?(u-=i,this._slack=!1):(s=-s,o=-o,u=0,this._slack=!0),e[20]=s,e[21]=o,e[19]=-u},t.prototype._preStep=function(e){this._posError();if(this._slack)return!1;var t=this._data,n=this.bodyA._data,r=this.bodyB._data,i=t[20],s=t[21],o=t[22]=t[11]*s-t[12]*i,u=t[23]=t[13]*s-t[14]*i;t[15]=n[0]+o*n[1]*o+r[0]+u*r[1]*u,Mt.prototype.safe_invert(t,15,16);if(!this._stiff){if(Mt.prototype.soft_params(t,15,18,19,e,this._breakUnderError))return!0}else t[18]=0,t[19]=0;var a=Mt.prototype.dtRatio(t,e);return t[16]*=a,t[17]=t[2]*e,!1},t.prototype._warmStart=function(){if(this._slack)return;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[16],i=e[20]*r,s=e[21]*r,o=t[0];t[7]-=i*o,t[8]-=s*o,t[9]-=e[22]*r*t[1],o=n[0],n[7]+=i*o,n[8]+=s*o,n[9]+=e[23]*r*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(3));var n=this._data,r=n[16],i=n[20]*r,s=n[21]*r;return e===this.bodyA?(t[0]=-i,t[1]=-s,t[2]=-(n[22]*r)):e===this.bodyB?(t[0]=i,t[1]=s,t[2]=n[23]*r):t[0]=t[1]=t[2]=0,t},t.prototype._iterateVel=function(){if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[20],i=e[21],s=e[22],o=e[23],u=e[19]-(r*(n[7]-t[7])+i*(n[8]-t[8])+o*n[9]-s*t[9]),a=e[16],f=e[15]*u-a*e[18],l=a+f,c=e[17];!this._equal&&l>0&&(l=0);if(this._breakUnderForce){if(l>c||l<-c)return!0}else this._stiff||(l>c?l=c:l<-c&&(l=-c));f=l-a,e[16]=l;var h=r*f,p=i*f,d=t[0];return t[7]-=h*d,t[8]-=p*d,t[9]-=e[22]*f*t[1],d=n[0],n[7]+=h*d,n[8]+=p*d,n[9]+=e[23]*f*n[1],!1},t.prototype._iteratePos=function(){this._posError();if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=t[0],i=n[0],s=t[1],o=n[1],u=e[19],a=e[3];if(this._breakUnderError&&(u>a||u<-a))return!0;var f=At.DIST_SLOP_SQ;if(u*u<f)return!1;u*=At.DIST_BIAS_COEF;var l=r+i,c=e[20],h=e[21],p,d,v;if(u*u>At.DIST_LARGE_ERROR_SQ&&l>At.EFF_MASS_EPSILON){p=u*At.DIST_LARGE_ERROR_BIAS/l;if(this._equal||p<0)d=c*p,v=h*p,t[2]-=d*r,t[3]-=v*r,n[2]+=d*i,n[3]+=v*i,this._posError(),u=e[19]*At.DIST_BIAS_COEF,c=e[20],h=e[21]}var m=e[11]*h-e[12]*c,g=e[13]*h-e[14]*c;e[15]=l+m*s*m+g*o*g,e[19]=u,Mt.prototype.safe_solve(e,15,19,19),p=e[19];if(this._equal||p<0){d=c*p,v=h*p,t[2]-=d*r,t[3]-=v*r;var y=-m*s*p;y!==0&&this.bodyA._deltaRotation(y),n[2]+=d*i,n[3]+=v*i,y=g*o*p,y!==0&&this.bodyB._deltaRotation(y)}return!1},t.create=function(e){var n=new t,r=n._data=new tn.prototype.floatArray(24);Mt.prototype.init(n,e);var i=e.anchorA;r[7]=i?i[0]:0,r[8]=i?i[1]:0,i=e.anchorB,r[9]=i?i[0]:0,r[10]=i?i[1]:0;var s=r[5]=e.lowerBound!==undefined?e.lowerBound:0,o=r[6]=e.upperBound!==undefined?e.upperBound:0;return n._equal=s===o,n._slack=!1,n.bodyA=e.bodyA,n.bodyB=e.bodyB,r[20]=1,r[21]=0,n},t}(Mt);Bt.prototype._inWorld=Mt.prototype.twoBodyInWorld,Bt.prototype._outWorld=Mt.prototype.twoBodyOutWorld,Bt.prototype._pairExists=Mt.prototype.twoBodyPairExists,Bt.prototype._wakeConnected=Mt.prototype.twoBodyWakeConnected,Bt.prototype._sleepComputation=Mt.prototype.twoBodySleepComputation;var jt=function(e){function t(){e.apply(this,arguments),this.type="ANGLE",this.dimension=1,this._JACC=9}return Lt(t,e),t.prototype.getLowerBound=function(){return this._data[5]},t.prototype.getUpperBound=function(){return this._data[6]},t.prototype.getRatio=function(){return this._data[7]},t.prototype.setLowerBound=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this._equal=e===t[6],this.wake(!0))},t.prototype.setUpperBound=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this._equal=e===t[5],this.wake(!0))},t.prototype.setRatio=function(e){var t=this._data;t[7]!==e&&(t[7]=e,this.wake(!0))},t.prototype._posError=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[7],i=e[5],s=e[6],o=r*n[4]-t[4];this._equal?(o-=s,this._slack=!1,e[13]=1):o<i?(o=i-o,this._slack=!1,e[13]=-1):o>s?(o-=s,this._slack=!1,e[13]=1):(o=0,this._slack=!0,e[13]=0),e[12]=-o},t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data,i=t[7],s=n[1],o=r[1];t[8]=s+i*i*o,Mt.prototype.safe_invert(t,8,9),this._posError();if(this._slack)return!1;if(!this._stiff){if(Mt.prototype.soft_params(t,8,11,12,e,this._breakUnderError))return!0}else t[11]=0,t[12]=0;var u=Mt.prototype.dtRatio(t,e);return t[9]*=u,t[10]=t[2]*e,!1},t.prototype._warmStart=function(){if(this._slack)return;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[9]*e[13];t[9]-=r*t[1],n[9]+=r*e[7]*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(3));var n=this._data,r=n[9]*n[13];return t[0]=t[1]=0,t[2]=(e===this.bodyA?-1:e===this.bodyB?n[7]:0)*r,t},t.prototype._iterateVel=function(){if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[13],i=e[7],s=e[12]-r*(i*n[9]-t[9]),o=e[9],u=e[8]*s-o*e[11],a=o+u,f=e[10];if(this._breakUnderForce){if(a>f||a<-f)return!0;!this._equal&&a>0&&(a=0)}else this._stiff?!this._equal&&a>0&&(a=0):this._equal?a>f?a=f:a<-f&&(a=-f):a>0?a=0:a<-f&&(a=-f);return u=a-o,e[9]=a,u*=r,t[9]-=u*t[1],n[9]+=u*i*n[1],!1},t.prototype._iteratePos=function(){this._posError();if(this._slack)return!1;var e=this._data,t=e[12],n=e[3];if(this._breakUnderError&&(t>n||t<-n))return!0;var r=At.ANGLE_SLOP_SQ;if(t*t<r)return!1;t*=At.ANGLE_BIAS_COEF;var i=t*At.ANGLE_BIAS_COEF*e[8];if(this._equal||i<0){var s=this.bodyA;i*=e[13];var o=-i*s._data[1];o!==0&&s._deltaRotation(o),s=this.bodyB,o=i*s._data[1],o!==0&&s._deltaRotation(o)}return!1},t.create=function(e){var n=new t,r=n._data=new tn.prototype.floatArray(14);Mt.prototype.init(n,e),r[7]=e.ratio!==undefined?e.ratio:1;var i=r[5]=e.lowerBound!==undefined?e.lowerBound:0,s=r[6]=e.upperBound!==undefined?e.upperBound:0;return n._equal=i===s,n._slack=!1,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(Mt);jt.prototype._inWorld=Mt.prototype.twoBodyInWorld,jt.prototype._outWorld=Mt.prototype.twoBodyOutWorld,jt.prototype._pairExists=Mt.prototype.twoBodyPairExists,jt.prototype._wakeConnected=Mt.prototype.twoBodyWakeConnected,jt.prototype._sleepComputation=Mt.prototype.twoBodySleepComputation;var Ft=function(e){function t(){e.apply(this,arguments),this.type="WELD",this.dimension=3,this._ANCHOR_A=5,this._ANCHOR_B=7,this._JACC=20}return Lt(t,e),t.prototype.getPhase=function(){return this._data[13]},t.prototype.setPhase=function(e){var t=this._data;e!==t[13]&&(t[13]=e,this.wake(!0))},t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data;Mt.prototype.rotateAnchor(t,n,5,9);var i=t[9],s=t[10];Mt.prototype.rotateAnchor(t,r,7,11);var o=t[11],u=t[12],a=n[0]+r[0],f=n[1],l=r[1];t[14]=a+s*f*s+u*l*u,t[15]=-(i*f*s)-o*l*u,t[16]=-(s*f)-u*l,t[17]=a+i*f*i+o*l*o,t[18]=i*f+o*l,t[19]=f+l,Mt.prototype.safe_invert3(t,14,20);if(!this._stiff){t[25]=n[2]+i-(r[2]+o),t[26]=n[3]+s-(r[3]+u),t[27]=n[4]+t[13]-r[4];if(Mt.prototype.soft_params3(t,14,24,25,e,this._breakUnderError))return!0}else t[24]=0,t[25]=0,t[26]=0,t[27]=0;var c=Mt.prototype.dtRatio(t,e);return t[20]*=c,t[21]*=c,t[22]*=c,t[23]=t[2]*e,!1},t.prototype._warmStart=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[20],i=e[21],s=e[22],o=t[0];t[7]-=r*o,t[8]-=i*o,t[9]-=(e[9]*i-e[10]*r+s)*t[1],o=n[0],n[7]+=r*o,n[8]+=i*o,n[9]+=(e[11]*i-e[12]*r+s)*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(3));var n=this._data,r=n[20],i=n[21],s=n[22];return e===this.bodyA?(t[0]=-r,t[1]=-i,t[2]=-(n[9]*i-n[10]*r+s)):e===this.bodyB?(t[0]=r,t[1]=i,t[2]=n[11]*i-n[12]*r+s):t[0]=t[1]=t[2]=0,t},t.prototype._iterateVel=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[9],i=e[10],s=e[11],o=e[12],u=t[9],a=n[9],f=e[25]-(n[7]-o*a)+(t[7]-i*u),l=e[26]-(n[8]+s*a)+(t[8]+r*u),c=e[27]-a+u,h=e[20],p=e[21],d=e[22],v=e[24],m=e[15],g=e[16],y=e[18],b=e[14]*f+m*l+g*c-h*v,w=m*f+e[17]*l+y*c-p*v,E=g*f+y*l+e[19]*c-d*v,S=h+b,x=p+w,T=d+E,N=S*S+x*x+T*T,C=e[23];if(this._breakUnderForce){if(N>C*C)return!0}else this._stiff||N>C*C&&(N=C/Math.sqrt(N),S*=N,x*=N,T*=N);b=S-h,w=x-p,E=T-d,e[20]=S,e[21]=x,e[22]=T;var k=t[0];return t[7]-=b*k,t[8]-=w*k,t[9]-=(r*w-i*b+E)*t[1],k=n[0],n[7]+=b*k,n[8]+=w*k,n[9]+=(s*w-o*b+E)*n[1],!1},t.prototype._iteratePos=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=t[0],i=n[0],s=t[1],o=n[1];Mt.prototype.rotateAnchor(e,t,5,9);var u=e[9],a=e[10];Mt.prototype.rotateAnchor(e,n,7,11);var f=e[11],l=e[12],c=t[2]+u-(n[2]+f),h=t[3]+a-(n[3]+l),p=t[4]+e[13]-n[4],d=c*c+h*h,v=p*p,m=e[3];if(this._breakUnderError&&d+v>m*m)return!0;if(d<At.WELD_LINEAR_SLOP_SQ&&v<At.WELD_ANGULAR_SLOP_SQ)return!1;var g=At.WELD_BIAS_COEF;c*=g,h*=g,p*=g,d*=g*g;var y=r+i,b,w;if(d>At.WELD_LARGE_ERROR_SQ&&y>At.EFF_MASS_EPSILON){var E=At.WELD_BIAS_COEF/y;b=c*E,w=h*E;var S=b*b+w*w,x=At.WELD_LARGE_ERROR_MAX;S>x*x&&(S=x/Math.sqrt(S),b*=S,w*=S),t[2]-=b*r,t[3]-=w*r,n[2]+=b*r,n[3]+=w*r,c=t[2]+u-(n[2]+f),h=t[3]+a-(n[3]+l),c*=g,h*=g,d=c*c+h*h}e[14]=y+a*s*a+l*o*l,e[15]=-(u*s*a)-f*o*l,e[16]=-(a*s)-l*o,e[17]=y+u*s*u+f*o*f,e[18]=u*s+f*o,e[19]=s+o,d>At.WELD_MAX_LINEAR_ERROR_SQ&&(d=At.WELD_MAX_LINEAR_ERROR/Math.sqrt(d),c*=d,h*=d);var T=At.WELD_MAX_ANGULAR_ERROR;p>T?p=T:p<-T&&(p=-T),e[25]=c,e[26]=h,e[27]=p,Mt.prototype.safe_solve3(e,14,25,25),b=e[25],w=e[26];var N=e[27];t[2]-=b*r,t[3]-=w*r;var C=-((u*w-a*b+N)*s);return C!==0&&this.bodyA._deltaRotation(C),n[2]+=b*i,n[3]+=w*i,C=(f*w-l*b+N)*o,C!==0&&this.bodyB._deltaRotation(C),!1},t.create=function(e){var n=new t,r=n._data=new tn.prototype.floatArray(28);Mt.prototype.init(n,e);var i=e.anchorA;return r[5]=i?i[0]:0,r[6]=i?i[1]:0,i=e.anchorB,r[7]=i?i[0]:0,r[8]=i?i[1]:0,r[13]=e.phase!==undefined?e.phase:0,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(Mt);Ft.prototype._inWorld=Mt.prototype.twoBodyInWorld,Ft.prototype._outWorld=Mt.prototype.twoBodyOutWorld,Ft.prototype._pairExists=Mt.prototype.twoBodyPairExists,Ft.prototype._wakeConnected=Mt.prototype.twoBodyWakeConnected,Ft.prototype._sleepComputation=Mt.prototype.twoBodySleepComputation;var It=function(e){function t(){e.apply(this,arguments),this.type="POINT",this.dimension=2,this._ANCHOR_A=5,this._ANCHOR_B=7,this._JACC=16}return Lt(t,e),t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data;Mt.prototype.rotateAnchor(t,n,5,9);var i=t[9],s=t[10];Mt.prototype.rotateAnchor(t,r,7,11);var o=t[11],u=t[12],a=n[0]+r[0],f=n[1],l=r[1];t[13]=a+s*f*s+u*l*u,t[14]=-(i*f*s)-o*l*u,t[15]=a+i*f*i+o*l*o,Mt.prototype.safe_invert2(t,13,16);if(!this._stiff){t[20]=n[2]+i-(r[2]+o),t[21]=n[3]+s-(r[3]+u);if(Mt.prototype.soft_params2(t,13,19,20,e,this._breakUnderError))return!0}else t[19]=0,t[20]=0,t[21]=0;var c=Mt.prototype.dtRatio(t,e);return t[16]*=c,t[17]*=c,t[18]=t[2]*e,!1},t.prototype._warmStart=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[16],i=e[17],s=t[0];t[7]-=r*s,t[8]-=i*s,t[9]-=(e[9]*i-e[10]*r)*t[1],s=n[0],n[7]+=r*s,n[8]+=i*s,n[9]+=(e[11]*i-e[12]*r)*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(3));var n=this._data,r=n[16],i=n[17];return e===this.bodyA?(t[0]=-r,t[1]=-i,t[2]=-(n[9]*i-n[10]*r)):e===this.bodyB?(t[0]=r,t[1]=i,t[2]=n[11]*i-n[12]*r):t[0]=t[1]=t[2]=0,t},t.prototype._iterateVel=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[9],i=e[10],s=e[11],o=e[12],u=t[9],a=n[9],f=e[20]-(n[7]-o*a)+(t[7]-i*u),l=e[21]-(n[8]+s*a)+(t[8]+r*u),c=e[16],h=e[17],p=e[14],d=e[19],v=e[13]*f+p*l-c*d,m=p*f+e[15]*l-h*d,g=c+v,y=h+m,b=g*g+y*y,w=e[18];if(this._breakUnderForce){if(b>w*w)return!0}else this._stiff||b>w*w&&(b=w/Math.sqrt(b),g*=b,y*=b);v=g-c,m=y-h,e[16]=g,e[17]=y;var E=t[0];return t[7]-=v*E,t[8]-=m*E,t[9]-=(r*m-i*v)*t[1],E=n[0],n[7]+=v*E,n[8]+=m*E,n[9]+=(s*m-o*v)*n[1],!1},t.prototype._iteratePos=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=t[0],i=n[0],s=t[1],o=n[1];Mt.prototype.rotateAnchor(e,t,5,9);var u=e[9],a=e[10];Mt.prototype.rotateAnchor(e,n,7,11);var f=e[11],l=e[12],c=t[2]+u-(n[2]+f),h=t[3]+a-(n[3]+l),p=c*c+h*h,d=e[3];if(this._breakUnderError&&p>d*d)return!0;if(p<At.POINT_SLOP_SQ)return!1;var v=At.POINT_BIAS_COEF;c*=v,h*=v,p*=v*v;var m=r+i,g,y;if(p>At.POINT_LARGE_ERROR_SQ&&m>At.EFF_MASS_EPSILON){var b=At.POINT_LARGE_ERROR_BIAS/m;g=c*b,y=h*b;var w=g*g+y*y,E=At.POINT_LARGE_ERROR_MAX;w>E*E&&(w=E/Math.sqrt(w),g*=w,y*=w),t[2]-=g*r,t[3]-=y*r,n[2]+=g*r,n[3]+=y*r,c=t[2]+u-(n[2]+f),h=t[3]+a-(n[3]+l),c*=v,h*=v,p=c*c+h*h}e[13]=m+a*s*a+l*o*l,e[14]=-(u*s*a)-f*o*l,e[15]=m+u*s*u+f*o*f,p>At.POINT_MAX_ERROR_SQ&&(p=At.POINT_MAX_ERROR/Math.sqrt(p),c*=p,h*=p),e[20]=c,e[21]=h,Mt.prototype.safe_solve2(e,13,20,20),g=e[20],y=e[21],t[2]-=g*r,t[3]-=y*r;var S=-((u*y-a*g)*s);return S!==0&&this.bodyA._deltaRotation(S),n[2]+=g*i,n[3]+=y*i,S=(f*y-l*g)*o,S!==0&&this.bodyB._deltaRotation(S),!1},t.create=function(e){var n=new t,r=n._data=new tn.prototype.floatArray(22);Mt.prototype.init(n,e);var i=e.anchorA;return r[5]=i?i[0]:0,r[6]=i?i[1]:0,i=e.anchorB,r[7]=i?i[0]:0,r[8]=i?i[1]:0,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(Mt);It.prototype._inWorld=Mt.prototype.twoBodyInWorld,It.prototype._outWorld=Mt.prototype.twoBodyOutWorld,It.prototype._pairExists=Mt.prototype.twoBodyPairExists,It.prototype._wakeConnected=Mt.prototype.twoBodyWakeConnected,It.prototype._sleepComputation=Mt.prototype.twoBodySleepComputation;var qt=function(){function e(){}return e.prototype.computeArea=function(){return 0},e.prototype.computeMasslessInertia=function(){return 0},e.prototype.computeCenterOfMass=function(e){return null},e.prototype.translate=function(e,t){},e.prototype._update=function(e,t,n,r,i){},e.prototype.clone=function(){return undefined},e.prototype.getGroup=function(){return this._group},e.prototype.setGroup=function(e){this._group=e,this.body&&this.body.wake(!0)},e.prototype.getMask=function(){return this._mask},e.prototype.setMask=function(e){this._mask=e,this.body&&this.body.wake(!0)},e.prototype.getMaterial=function(){return this._material},e.prototype.setMaterial=function(e){if(this._material!==e){this._material=e,this.body&&this.body._invalidate();var t=this.arbiters,n=t.length,r;for(r=0;r<n;r+=1)t[r]._invalidate()}},e.prototype.copyCommon=function(t,n){n._type=t._type,n._material=t._material,n._group=t._group,n._mask=t._mask,n.sensor=t.sensor,n.id=e.uniqueId,e.uniqueId+=1,n.arbiters=[],n._bphaseHandle=null,n.userData=t.userData;var r=t._data,i=t._data.length,s=n._data=new tn.prototype.floatArray(i),o;for(o=0;o<i;o+=1)s[o]=r[o];n._onPreSolve=[],n._events=[]},e.prototype.init=function(t,n){t._material=n.material||Ot.create(),t._group=n.group!==undefined?n.group:1,t._mask=n.mask!==undefined?n.mask:4294967295,t.sensor=n.sensor!==undefined?n.sensor:!1,t.arbiters=[],t._bphaseHandle=null,t.userData=n.userData!==undefined?n.userData:null,t.id=e.uniqueId,e.uniqueId+=1,t._onPreSolve=[],t._events=[]},e.eventIndex=function(e,t,n,r){var i=e.length,s;for(s=0;s<i;s+=1){var o=e[s];if(o.callback===n&&o.mask===r&&o.type===t)return s}return-1},e.prototype.addEventListener=function(t,n,r,i){var s,o;t==="preSolve"?(s=this._onPreSolve,o=6):(s=this._events,o=t==="begin"?1:t==="progress"?2:t==="end"?3:null);if(o===null)return!1;t!=="preSolve"?i=undefined:i===undefined&&(i=!1);var u=e.eventIndex(s,o,n,r);return u!==-1?!1:(s.push({callback:n,mask:r,type:o,deterministic:i}),this.body&&this.body.wake(!0),!0)},e.prototype.removeEventListener=function(t,n,r){var i,s;t==="preSolve"?(i=this._onPreSolve,s=6):(i=this._events,s=t==="begin"?1:t==="progress"?2:t==="end"?3:null);if(s===null)return!1;var o=e.eventIndex(i,s,n,r);return o===-1?!1:(i.splice(o,1),this.body&&this.body.wake(!0),!0)},e.uniqueId=0,e}(),Rt=function(e){function t(){e.call(this),this.type="CIRCLE"}return Lt(t,e),t.prototype.computeArea=function(){var e=this._data[6];return Math.PI*e*e},t.prototype.computeMasslessInertia=function(){var e=this._data,t=this._data[6],n=e[7],r=e[8];return.5*t*t+(n*n+r*r)},t.prototype.getRadius=function(){return this._data[6]},t.prototype.setRadius=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=this._data;e!==n[6]&&(n[6]=e,this._validate(),t&&t._invalidate())},t.prototype.getOrigin=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data;return e[0]=t[7],e[1]=t[8],e},t.prototype.setOrigin=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=this._data,r=e[0],i=e[1];if(n[7]!==r||n[8]!==i)n[7]=r,n[8]=i,this._validate(),t&&t._invalidate()},t.prototype.clone=function(){var e=new t;return qt.prototype.copyCommon(this,e),e},t.prototype.scale=function(e){if(e<=0)return;var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=this._data;n[7]*=e,n[8]*=e,n[6]*=e,this._validate(),t&&t._invalidate()},t.prototype.translate=function(e,t){var n=this.body;if(!t&&n&&n.world&&(n._type===2||n.world._midStep))return;var r=this._data;r[7]+=e[0],r[8]+=e[1],this._validate(),!t&&n&&n._invalidate()},t.prototype.rotate=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=Math.cos(e),r=Math.sin(e),i=this._data,s=i[7],o=i[8];i[7]=n*s-r*o,i[8]=r*s+n*o,this._validate(),t&&t._invalidate()},t.prototype.transform=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=e[0],r=e[2],i=e[1],s=e[3],o=this._data,u=n*s-r*i;if(u<=0)return;o[6]*=Math.sqrt(u);var a=o[7],f=o[8];o[7]=n*a+r*f+e[4],o[8]=i*a+s*f+e[5],this._validate(),t&&t._invalidate()},t.prototype._update=function(e,t,n,r,i){var s=this._data,o=s[7],u=s[8],a=s[9]=e+n*o-r*u,f=s[10]=t+r*o+n*u;if(!i){var l=s[6];s[0]=a-l,s[1]=f-l,s[2]=a+l,s[3]=f+l}},t.prototype._validate=function(){var e=this._data,t=e[7],n=e[8],r=e[6],i=Math.sqrt(t*t+n*n);e[4]=r+i,e[5]=e[4]-Math.max(r-i,0)},t.prototype.computeCenterOfMass=function(e){return this.getOrigin(e)},t.create=function(e){var n=new t;n._type=0,qt.prototype.init(n,e);var r=e.radius,i=e.origin?e.origin[0]:0,s=e.origin?e.origin[1]:0,o=n._data=new tn.prototype.floatArray(11);return o[6]=r,o[7]=i,o[8]=s,n._validate(),n},t.version=1,t}(qt),Ut=function(e){function t(){e.call(this),this.type="POLYGON"}return Lt(t,e),t.prototype.computeArea=function(){var e=this._data,t=6,n=e.length,r=0;for(;t<n;t+=13){var i=t+13;i===n&&(i=6),r+=e[t+0]*e[i+0+1]-e[t+0+1]*e[i+0]}return r*.5},t.prototype.computeMasslessInertia=function(){var e=this._data,t=6,n=e.length,r=0,i=0;for(;t<n;t+=13){var s=t+13;s===n&&(s=6);var o=e[t+0],u=e[t+0+1],a=e[s+0],f=e[s+0+1],l=o*f-a*u,c=o*o+u*u+(a*a+f*f)+(o*a+u*f);r+=l*c,i+=l}return r/(6*i)},t.prototype.computeCenterOfMass=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data,n=6,r=t.length,i=0,s=0,o=0;for(;n<r;n+=13){var u=n+13;u===r&&(u=6);var a=t[n+0],f=t[n+0+1],l=t[u+0],c=t[u+0+1],h=a*c-f*l;i+=h,s+=(a+l)*h,o+=(f+c)*h}var p=1/(3*i);return e[0]=s*p,e[1]=o*p,e},t.prototype.setVertices=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;this._validate(e),t&&t._invalidate()},t.prototype.clone=function(){var e=new t;return qt.prototype.copyCommon(this,e),e},t.prototype.scale=function(e,t){var n=this.body;if(n&&n.world&&(n._type===2||n.world._midStep))return;t===undefined&&(t=e);if(e<=0||t<=0)return;var r=1/e,i=1/t,s=this._data,o=s.length,u=6,a=0,f=Number.POSITIVE_INFINITY;for(;u<o;u+=13){var l=s[u+0]*=e,c=s[u+0+1]*=t,h=s[u+4]*r,p=s[u+4+1]*i,d=1/Math.sqrt(h*h+p*p);s[u+4]=h*=d,s[u+4+1]=p*=d;var v=s[u+8]=h*l+p*c;v<f&&(f=v);var m=l*l+c*c;m>a&&(a=m);var g=u+13;g===o&&(g=6);var y=s[g+0]*e-l,b=s[g+0+1]*t-c,w=Math.sqrt(y*y+b*b);s[u+12]=w}s[4]=Math.sqrt(a),s[5]=s[4]-Math.max(f,0),n&&n._invalidate()},t.prototype.translate=function(e,t){var n=this.body;if(!t&&n&&n.world&&(n._type===2||n.world._midStep))return;var r=this._data,i=r.length,s=6,o=e[0],u=e[1],a=0,f=Number.POSITIVE_INFINITY;for(;s<i;s+=13){var l=r[s+0]+=o,c=r[s+0+1]+=u,h=r[s+4],p=r[s+4+1],d=r[s+8]+=h*o+p*u;d<f&&(f=d);var v=l*l+c*c;v>a&&(a=v)}r[4]=Math.sqrt(a),r[5]=r[4]-Math.max(f,0),!t&&n&&n._invalidate()},t.prototype.rotate=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=this._data,r=n.length,i=6,s=Math.cos(e),o=Math.sin(e);for(;i<r;i+=13){var u=n[i+0],a=n[i+0+1];n[i+0]=u*s-a*o,n[i+0+1]=u*o+a*s,u=n[i+4],a=n[i+4+1],n[i+4]=u*s-a*o,n[i+4+1]=u*o+a*s}t&&t._invalidate()},t.prototype.transform=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=e[0],r=e[2],i=e[1],s=e[3],o=e[4],u=e[5];if(n*s-r*i<=0)return;var a=this._data,f=a.length,l=6,c,h;for(;l<f;l+=13)c=a[l+0],h=a[l+0+1],a[l+0]=n*c+r*h+o,a[l+0+1]=i*c+s*h+u;var p=0,d=Number.POSITIVE_INFINITY;l=6;for(;l<f;l+=13){c=a[l+0],h=a[l+0+1];var v=l+13;v===f&&(v=6);var m=-(a[v+0]-c),g=-(a[v+0+1]-h),y=Math.sqrt(m*m+g*g),b=1/y,w=-g*b,E=m*b;a[l+4]=w,a[l+4+1]=E,a[l+12]=y;var S=a[l+8]=w*c+E*h,x=c*c+h*h;x>p&&(p=x),S<d&&(d=S)}a[4]=Math.sqrt(p),a[5]=a[4]-Math.max(d,0),t&&t._invalidate()},t.prototype._update=function(e,t,n,r,i){var s=this._data,o=s.length,u=6,a,f,l,c,h;for(;u<o;u+=13){var p=s[u+0],d=s[u+0+1],v=s[u+2]=e+n*p-r*d,m=s[u+2+1]=t+r*p+n*d;p=s[u+4],d=s[u+4+1];var g=s[u+6]=n*p-r*d,y=s[u+6+1]=r*p+n*d;s[u+9]=g*v+y*m,s[u+10]=g*m-y*v,u!==6?(a=u-13,s[a+11]=s[a+6]*m-s[a+6+1]*v,i||(v<f?f=v:v>c&&(c=v),m<l?l=m:m>h&&(h=m))):i||(f=c=v,l=h=m)}u=6,a=s.length-13,s[a+11]=s[a+6]*s[u+2+1]-s[a+6+1]*s[u+2],i||(s[0]=f,s[1]=l,s[2]=c,s[3]=h)},t.prototype._validate=function(e){var t=e.length,n=this._data,r=6+t*13;if(!n||r!==n.length)n=this._data=new tn.prototype.floatArray(r);var i=0,s=Number.POSITIVE_INFINITY,o=6,u;for(u=0;u<t;u+=1,o+=13){var a=e[u],f=e[u===t-1?0:u+1],l=a[0],c=a[1],h=l-f[0],p=c-f[1],d=Math.sqrt(h*h+p*p),v=1/d,m=-p*v,g=h*v;n[o+0]=l,n[o+0+1]=c,n[o+4]=m,n[o+4+1]=g,n[o+12]=d;var y=n[o+8]=m*l+g*c,b=l*l+c*c;b>i&&(i=b),y<s&&(s=y)}n[4]=Math.sqrt(i),n[5]=n[4]-Math.max(s,0)},t.create=function(e,n){var r=new t;return r._type=1,qt.prototype.init(r,e),r._validate(n||e.vertices),r},t.version=1,t}(qt);Ut;var zt=function(){function e(){}return e.prototype.isDynamic=function(){return this._type===0},e.prototype.setAsDynamic=function(){if(this.world&&this.world._midStep)return;this._setTypeValue(0);var e=this._data,t=e[23],n=e[24];e[0]=t===Number.POSITIVE_INFINITY?0:1/t,e[1]=n===Number.POSITIVE_INFINITY?0:1/n},e.prototype.isStatic=function(){return this._type===2},e.prototype.setAsStatic=function(){if(this.world&&this.world._midStep)return;this._setTypeValue(2);var e=this._data;e[0]=e[1]=0,e[7]=e[8]=e[9]=0},e.prototype.isKinematic=function(){return this._type===1},e.prototype.setAsKinematic=function(){if(this.world&&this.world._midStep)return;this._setTypeValue(1);var e=this._data;e[0]=e[1]=0},e.prototype._setTypeValue=function(e){if(e===this._type)return;if(!this.world){this._type=e;return}this.world._transmitBodyType(this,e)},e.prototype.applyImpulse=function(e,t){if(this._type!==0)return;var n=this._data,r,i;t?(r=t[0]-n[2],i=t[1]-n[3]):(r=0,i=0);var s=e[0],o=e[1],u=n[0];n[7]+=s*u,n[8]+=o*u,n[9]+=(r*o-i*s)*n[1],this.wake(!0)},e.prototype.setVelocityFromPosition=function(e,t,n){if(this._type===2)return;var r=this._data,i=1/n;r[7]=(e[0]-r[2])*i,r[8]=(e[1]-r[3])*i,r[9]=(t-r[4])*i,this.wake(!0)},e.prototype.transformWorldPointToLocal=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(2));var n=this._data,r=n[5],i=n[6],s=e[0]-n[2],o=e[1]-n[3];return t[0]=r*s+i*o,t[1]=r*o-i*s,t},e.prototype.transformWorldVectorToLocal=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(2));var n=this._data,r=n[5],i=n[6],s=e[0],o=e[1];return t[0]=r*s+i*o,t[1]=r*o-i*s,t},e.prototype.transformLocalPointToWorld=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(2));var n=this._data,r=n[5],i=n[6],s=e[0],o=e[1];return t[0]=r*s-i*o+n[2],t[1]=i*s+r*o+n[3],t},e.prototype.transformLocalVectorToWorld=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(2));var n=this._data,r=n[5],i=n[6],s=e[0],o=e[1];return t[0]=r*s-i*o,t[1]=i*s+r*o,t},e.prototype.getPosition=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data;return e[0]=t[2],e[1]=t[3],e},e.prototype.setPosition=function(e){if(this.world&&(this.world._midStep||this._type===2))return;var t=this._data,n=e[0],r=e[1];if(t[2]!==n||t[3]!==r)t[2]=n,t[3]=r,this._invalidated=!0,this.wake(!0)},e.prototype.getRotation=function(){return this._data[4]},e.prototype.setRotation=function(e){if(this.world&&(this.world._midStep||this._type===2))return;var t=this._data;t[4]!==e&&(this._data[4]=e,this._data[5]=Math.cos(e),this._data[6]=Math.sin(e),this._invalidated=!0,this.wake(!0))},e.prototype.getVelocity=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data;return e[0]=t[7],e[1]=t[8],e},e.prototype.setVelocity=function(e){if(this._type===2)return;var t=this._data,n=e[0],r=e[1];if(t[7]!==n||t[8]!==r)t[7]=n,t[8]=r,this.wake(!0)},e.prototype.getAngularVelocity=function(){return this._data[9]},e.prototype.setAngularVelocity=function(e){if(this._type===2)return;var t=this._data;t[9]!==e&&(t[9]=e,this.wake(!0))},e.prototype.getForce=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data;return e[0]=t[10],e[1]=t[11],e},e.prototype.setForce=function(e){var t=this._data,n=e[0],r=e[1];if(t[10]!==n||t[11]!==r)t[10]=n,t[11]=r,this.wake(!0)},e.prototype.getTorque=function(){return this._data[12]},e.prototype.setTorque=function(e){var t=this._data;t[12]!==e&&(t[12]=e,this.wake(!0))},e.prototype.getSurfaceVelocity=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data;return e[0]=t[13],e[1]=t[14],e},e.prototype.setSurfaceVelocity=function(e){var t=this._data;t[13]=e[0],t[14]=e[1],this.wake(!0)},e.prototype.getMass=function(){return this._data[23]},e.prototype.getInertia=function(){return this._data[24]},e.prototype.setMass=function(e){var t=this._data,n=t[23];if(!this._customMass||n!==e)t[23]=e,this._customMass=!0,this._invalidateMassInertia()},e.prototype.setMassFromShapes=function(){this._customMass&&(this._customMass=!1,this._data[23]=this.computeMassFromShapes(),this._invalidateMassInertia())},e.prototype.setInertia=function(e){var t=this._data,n=t[24];if(!this._customInertia||n!==e)t[24]=e,this._customInertia=!0,this._invalidateMassInertia()},e.prototype.setInertiaFromShapes=function(){this._customInertia&&(this._customInertia=!1,this._data[24]=this.computeInertiaFromShapes(),this._invalidateMassInertia())},e.prototype._invalidateMassInertia=function(){var e=this._data,t=e[23],n=e[24],r=this._type!==0,i=Number.POSITIVE_INFINITY;e[0]=r||t===i?0:1/t,e[1]=r||n===i?0:1/n,this.wake(!0)},e.prototype.getLinearDrag=function(){return 1-Math.exp(this._data[21])},e.prototype.setLinearDrag=function(e){this._data[21]=Math.log(1-e),this.wake(!0)},e.prototype.getAngularDrag=function(){return 1-Math.exp(this._data[22])},e.prototype.setAngularDrag=function(e){this._data[22]=Math.log(1-e),this.wake(!0)},e.prototype.addShape=function(e){if(this.world&&(this.world._midStep||this._type===2))return!1;if(e.body)return!1;e.body=this,this.shapes.push(e),this.world&&(this.wake(!0),this.world._addShape(e));var t=e._data[4],n=this._data;return t>n[19]&&(n[19]=t),this._invalidate(),!0},e.prototype.removeShape=function(e){if(this.world&&(this.world._midStep||this._type===2))return!1;if(e.body!==this)return!1;this.world&&(this.wake(!0),this.world._removeShape(e)),e.body=null;var t=this.shapes,n=t.length-1,r=t.indexOf(e);t[r]=t[n],t.pop();var i,s=0;for(i=0;i<n;i+=1){e=t[i];var o=e._data[4];o>s&&(s=o)}return this._data[19]=s,this._invalidate(),!0},e.prototype.computeMassFromShapes=function(){var e=0,t,n=this.shapes,r=n.length;for(t=0;t<r;t+=1){var i=n[t];e+=i._material._data[4]*i.computeArea()}return e},e.prototype.computeInertiaFromShapes=function(){var e=0,t,n=this.shapes,r=n.length;for(t=0;t<r;t+=1){var i=n[t];e+=i._material._data[4]*i.computeMasslessInertia()*i.computeArea()}return e},e.prototype.wake=function(e){if(!this.world){this.sleeping=!1;return}this.world._wakeBody(this,!e)},e.prototype.sleep=function(){if(!this.world){this.sleeping=!0;return}this.world._forceSleepBody(this)},e.prototype.computeLocalCenterOfMass=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=0,n=0,r=0,i=this.shapes,s=i.length,o;for(o=0;o<s;o+=1){var u=i[o];u.computeCenterOfMass(e);var a=u.computeArea()*u._material._data[4];t+=e[0]*a,n+=e[1]*a,r+=a}var f=1/r;return e[0]=t*f,e[1]=n*f,e},e.prototype.computeWorldBounds=function(e){e===undefined&&(e=new tn.prototype.floatArray(4));var t=Number.POSITIVE_INFINITY,n=t,r=t,i=-t,s=-t;this._update();var o=this.shapes,u=o.length,a;for(a=0;a<u;a+=1){var f=o[a]._data,l=f[0],c=f[1],h=f[2],p=f[3];l<n&&(n=l),h>i&&(i=h),c<r&&(r=c),p>s&&(s=p)}return e[0]=n,e[1]=r,e[2]=i,e[3]=s,e},e.prototype.alignWithOrigin=function(){if(this.world&&(this.world._midStep||this._type===2))return;var e=this.computeLocalCenterOfMass();e[0]*=-1,e[1]*=-1;var t=this.shapes,n=t.length,r;for(r=0;r<n;r+=1)t[r].translate(e,!0);this._invalidate()},e.prototype._invalidate=function(){this._invalidated=!0;var e=this._customMass,t=this._customInertia;if(!e||!t)e||(this._data[23]=this.computeMassFromShapes()),t||(this._data[24]=this.computeInertiaFromShapes()),this._invalidateMassInertia();this.wake(!0)},e.prototype._update=function(){if(this._invalidated){this._invalidated=!1;var e=this._data,t=this.shapes,n=t.length,r;for(r=0;r<n;r+=1)t[r]._update(e[2],e[3],e[5],e[6])}},e.prototype._atRest=function(e,t){if(this._type!==0)return this.sleeping;var n=this._data,r;do{var i=n[7],s=n[8],o=At
.SLEEP_LINEAR_SQ;if(i*i+s*s>o){r=!1;break}i=n[2]-n[15],s=n[3]-n[16];var u=e*e*o;if(i*i+s*s>u){r=!1;break}s=n[19],i=n[9]*s,o=At.SLEEP_ANGULAR_SQ;if(i*i>o){r=!1;break}i=(n[4]-n[17])*s,u=e*e*o,r=i*i<=u}while(!1);return r?this._wakeTime+At.SLEEP_DELAY<t:(this._wakeTime=t,!1)},e.prototype._deltaRotation=function(e){var t=this._data,n=t[4]+=e;if(e*e>At.DELTA_ROTATION_EPSILON)t[5]=Math.cos(n),t[6]=Math.sin(n);else{var r=e*e,i=1-.5*r,s=1-r*r*.125,o=t[5],u=t[6],a=(i*u+e*o)*s,f=(i*o-e*u)*s;t[5]=f,t[6]=a}return n},e.prototype._sweepIntegrate=function(e){var t=this._data,n=e-t[18];if(n!==0){t[18]=e,t[2]+=t[7]*n,t[3]+=t[8]*n;var r=t[20];r!==0&&this._deltaRotation(t[20]*n)}},e.prototype.integrate=function(e){if(this.world&&(this.world._midStep||this._type===2))return;var t=this._data;t[18]=0,t[20]=t[9],this._sweepIntegrate(e),t[18]=0,this._invalidated=!0,this.wake(!0)},e.prototype.addEventListener=function(e,t){var n=e==="wake"?this._onWake:e==="sleep"?this._onSleep:null;if(n===null)return!1;var r=n.indexOf(t);return r!==-1?!1:(n.push(t),this.wake(),!0)},e.prototype.removeEventListener=function(e,t){var n=e==="wake"?this._onWake:e==="sleep"?this._onSleep:null;if(n===null)return!1;var r=n.indexOf(t);return r===-1?!1:(n.splice(r,1),this.wake(),!0)},e.create=function(t){var n=new e,r=n._data=new tn.prototype.floatArray(25),i=Number.POSITIVE_INFINITY;n._type=t.type==="dynamic"?0:t.type==="static"?2:t.type==="kinematic"?1:0;var s=t.shapes;n.shapes=[],n.constraints=[],n.world=null;var o=0;if(s){var u=s.length,a;for(a=0;a<u;a+=1){var f=s[a];if(f.body===n)continue;f.body=n,n.shapes.push(f);var l=f._data[4];l>o&&(o=l)}}r[19]=o,n._customMass=t.mass!==undefined,n._customInertia=t.inertia!==undefined;var c=n._customMass?t.mass:n.computeMassFromShapes(),h=n._customInertia?t.inertia:n.computeInertiaFromShapes(),p=n._type===0,d=n._type===2;r[0]=!p||c===i?0:1/c,r[1]=!p||h===i?0:1/h,r[23]=c,r[24]=h;var v=t.position,m=r[2]=v?v[0]:0,g=r[3]=v?v[1]:0,y=r[4]=t.rotation||0;return r[5]=Math.cos(y),r[6]=Math.sin(y),r[15]=m,r[16]=g,r[17]=y,v=t.velocity,r[7]=!d&&v?v[0]:0,r[8]=!d&&v?v[1]:0,r[9]=!d&&t.angularVelocity||0,v=t.force,r[10]=v?v[0]:0,r[11]=v?v[1]:0,r[12]=t.torque||0,v=t.surfaceVelocity,r[13]=v?v[0]:0,r[14]=v?v[1]:0,n.sleeping=t.sleeping||!1,n.bullet=t.bullet||!1,n._sweepFrozen=n._type!==0,n._deferred=!1,n._island=null,n._islandRank=0,n._islandRoot=null,n._isBody=!0,n._wakeTime=0,n._woken=!1,n._invalidated=!0,r[21]=Math.log(1-(t.linearDrag!==undefined?t.linearDrag:.05)),r[22]=Math.log(1-(t.angularDrag!==undefined?t.angularDrag:.05)),n.userData=t.userData||null,n._onWake=[],n._onSleep=[],n},e.version=1,e}(),Wt=function(){function e(){this.thisObject=null,this.callback=null,this.time=0,this.index=0,this.arbiter=null,this.next=null}return e.allocate=function(){if(e.pool){var t=e.pool;return e.pool=t.next,t.next=null,t}return new e},e.deallocate=function(t){t.next=e.pool,e.pool=t,t.thisObject=null,t.callback=null,t.arbiter=null},e.pool=null,e}(),Xt=function(){function e(){this.components=[],this.sleeping=!1,this.wakeTime=0,this.next=null}return e.allocate=function(){if(e.pool){var t=e.pool;return e.pool=t.next,t.next=null,t}return new e},e.deallocate=function(t){t.next=e.pool,e.pool=t,t.wakeTime=0},e.pool=null,e}(),Vt=function(){function e(){this.next=null,this.shapeA=null,this.shapeB=null,this.frozenA=this.frozenB=!1,this.arbiter=null,this.failed=!1,this.slipped=!1,this._data=new tn.prototype.floatArray(7)}return e.allocate=function(){if(e.pool){var t=e.pool;return e.pool=t.next,t.next=null,t}return new e},e.deallocate=function(t){t.next=e.pool,e.pool=t,t.shapeA=t.shapeB=null,t.failed=!1,t.slipped=!1,t.arbiter=null},e.pool=null,e}(),$t=function(){function e(){this.boxTreeIndex=-1,this.data=null,this.isStatic=!1}return e.allocate=function(){return 0<this.pool.length?this.pool.pop():new e},e.deallocate=function(e){this.pool.push(e),e.data=null},e.pool=[],e}(),Jt=function(){function e(){this.staticTree=an.create(!0),this.dynamicTree=an.create(!1),this.overlappingNodes=[]}return e.prototype.sample=function(e,t,n){var r=this.overlappingNodes,i=this.staticTree.getOverlappingNodes(e,r,0);i+=this.dynamicTree.getOverlappingNodes(e,r,i);var s;for(s=0;s<i;s+=1)t.call(n,r[s],e)},e.prototype.insert=function(e,t,n){var r=$t.allocate();return r.data=e,r.isStatic=n,n?this.staticTree.add(r,t):this.dynamicTree.add(r,t),r},e.prototype.update=function(e,t,n){n!==undefined&&e.isStatic!==n?(e.isStatic?(this.staticTree.remove(e),this.dynamicTree.add(e,t)):(this.dynamicTree.remove(e),this.staticTree.add(e,t)),e.isStatic=n):n?this.staticTree.update(e,t):this.dynamicTree.update(e,t)},e.prototype.remove=function(e){e.isStatic?this.staticTree.remove(e):this.dynamicTree.remove(e),$t.deallocate(e)},e.prototype.clear=function(e,t){this._clearTree(this.staticTree,e,t),this._clearTree(this.dynamicTree,e,t)},e.prototype._clearTree=function(e,t,n){var r=e.getNodes(),i=r.length,s;for(s=0;s<i;s+=1){var o=r[s].externalNode;o&&(t&&t.call(n,o),$t.deallocate(o))}e.clear()},e.prototype._validate=function(){this.staticTree.finalize(),this.dynamicTree.finalize()},e.prototype.perform=function(e,t){this._validate();var n=this.overlappingNodes,r=this.staticTree,i=this.dynamicTree,s=i.getNodes(),o=s.length,u;for(u=0;u<o;u+=1){var a=s[u],f=a.externalNode;if(f){var l=r.getOverlappingNodes(a.extents,n,0),c;for(c=0;c<l;c+=1)e.call(t,f,n[c])}}var h=i.getOverlappingPairs(n,0);for(u=0;u<h;u+=2)e.call(t,n[u],n[u+1])},e.create=function(){return new e},e.version=1,e}(),Kt=function(){function e(){this._next=null,this._prev=null,this._aabb=new tn.prototype.floatArray(4),this.data=null,this.isStatic=!1}return e.allocate=function(){if(!this.pool)return new e;var t=this.pool;return this.pool=t._next,t._next=null,t},e.deallocate=function(e){e._prev=null,e._next=this.pool,this.pool=e,e.data=null},e.pool=null,e}(),Qt=function(){function e(){}return e.prototype.sample=function(e,t,n){var r=e[0],i=e[1],s=e[2],o=e[3];this._validate();var u=this._list;while(u){var a=u._aabb;if(a[2]<r){u=u._next;continue}if(a[0]>s)break;a[1]<=o&&i<=a[3]&&t.call(n,u,e),u=u._next}},e.prototype.insert=function(e,t,n){var r=Kt.allocate(),i=r._aabb;i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],r.data=e,r.isStatic=n;var s=this._list;return r._next=s,s&&(s._prev=r),this._list=r,r},e.prototype.update=function(e,t,n){var r=e._aabb;r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],n!==undefined&&(e.isStatic=n)},e.prototype.remove=function(e){e._prev?e._prev._next=e._next:this._list=e._next,e._next&&(e._next._prev=e._prev),Kt.deallocate(e)},e.prototype.clear=function(e,t){var n=this._list;while(n){var r=n._next;e&&e.call(t,n),Kt.deallocate(n),n=r}this._list=null},e.prototype._validate=function(){if(!this._list)return;var e=this._list._next;while(e){var t=e._next,n=e._prev,r=e._aabb[0];if(r>n._aabb[0]){e=t;continue}while(n._prev&&n._prev._aabb[0]>r)n=n._prev;var i=e._prev;i._next=t,t&&(t._prev=i),n._prev?(e._prev=n._prev,n._prev=e,e._prev._next=e,e._next=n):(e._prev=null,this._list=e,e._next=n,n._prev=e),e=t}},e.prototype.perform=function(e,t){this._validate();var n=this._list;while(n){var r=n._next,i=n._aabb,s=n.isStatic,o=i[2];while(r){var u=r._aabb;if(u[0]>o)break;if(s&&r.isStatic){r=r._next;continue}if(i[1]>u[3]||u[1]>i[3]){r=r._next;continue}e.call(t,n,r),r=r._next}n=n._next}},e.create=function(){var t=new e;return t._list=null,t},e.version=1,e}(),Gt=function(){function e(){this._data=new tn.prototype.floatArray(17),this.fresh=!1,this._hash=0,this._timeStamp=0,this._next=null,this.active=!1,this.virtual=!1}return e.allocate=function(){if(!this.pool)return new e;var t=this.pool;return this.pool=t._next,t._next=null,t},e.deallocate=function(e){e._next=this.pool,this.pool=e},e.prototype.getPosition=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));var t=this._data;return e[0]=t[0],e[1]=t[1],e},e.prototype.getPenetration=function(){return-this._data[2]},e.prototype.getNormalImpulse=function(){return this.virtual?0:this._data[11]},e.prototype.getTangentImpulse=function(){return this.virtual?0:this._data[12]},e.version=1,e.pool=null,e}(),Yt=function(){function e(){this.shapeA=null,this.shapeB=null,this.bodyA=null,this.bodyB=null,this._next=null,this._retired=!1,this._lazyRetired=!1,this._static=!1,this._state=0,this.sensor=!1,this._createStamp=0,this._updateStamp=0,this._sleepStamp=0,this._timeStamp=0,this._createContinuous=!1,this._endGenerated=0,this._midStep=!1,this.sleeping=!1,this.active=!1,this._invalidated=!1,this._data=new tn.prototype.floatArray(24),this.contacts=[],this._userdef=0,this._velocity2Contact=!1,this._position2Contact=!1,this._contact1=this._contact2=null,this._faceType=0}return e.prototype.getNormal=function(e){e===undefined&&(e=new tn.prototype.floatArray(2));if(this.sensor)e[0]=e[1]=0;else{var t=this._data;e[0]=t[4],e[1]=t[5]}return e},e.prototype.getRollingImpulse=function(){return this.sensor||this._velocity2Contact||this._contact1._hash!==0?0:this._data[16]},e.prototype.getElasticity=function(){return this.sensor?undefined:(this._validate(),this._data[2])},e.prototype.getDynamicFriction=function(){return this.sensor?undefined:(this._validate(),this._data[0])},e.prototype.getStaticFriction=function(){return this.sensor?undefined:(this._validate(),this._data[1])},e.prototype.getRollingFriction=function(){return this.sensor?undefined:(this._validate(),this._data[3])},e.prototype.setElasticity=function(e){if(this.sensor)return;this._data[2]=e,this._userdef|=4,this._invalidate(!0)},e.prototype.setDynamicFriction=function(e){if(this.sensor)return;this._data[0]=e,this._userdef|=1,this._invalidate(!0)},e.prototype.setStaticFriction=function(e){if(this.sensor)return;this._data[1]=e,this._userdef|=2,this._invalidate(!0)},e.prototype.setRollingFriction=function(e){if(this.sensor)return;this._data[3]=e,this._userdef|=8,this._invalidate(!0)},e.prototype.setElasticityFromShapes=function(){if(this.sensor)return;this._userdef&=-5,this._invalidate(!0)},e.prototype.setDynamicFrictionFromShapes=function(){if(this.sensor)return;this._userdef&=-2,this._invalidate(!0)},e.prototype.setStaticFrictionFromShapes=function(){if(this.sensor)return;this._userdef&=-3,this._invalidate(!0)},e.prototype.setRollingFrictionFromShapes=function(){if(this.sensor)return;this._userdef&=-9,this._invalidate(!0)},e.prototype.isStateAccepted=function(){return this.sensor?!1:(this._state&1)!==0},e.prototype.isStatePersistent=function(){return this.sensor?!1:(this._state&2)!==0},e.prototype.setAcceptedState=function(e){if(this.sensor)return;e?this._state|=1:this._state&=-2,this._invalidate(!0)},e.prototype.setPersistentState=function(e){if(this.sensor)return;e?this._state|=2:this._state&=-3,this._invalidate(!0)},e.prototype._lazyRetire=function(e){this._lazyRetired=!0,this._retired=!0,this.active=!1;var t,n;this.shapeA!==e&&(t=this.shapeA.arbiters,n=t.indexOf(this),t[n]=t[t.length-1],t.pop()),this.shapeB!==e&&(t=this.shapeB.arbiters,n=t.indexOf(this),t[n]=t[t.length-1],t.pop())},e.prototype._assign=function(e,t){this.bodyA=e.body,this.bodyB=t.body,this.shapeA=e,this.shapeB=t,e.arbiters.push(this),t.arbiters.push(this),this._retired=!1,this.sleeping=!1,this._invalidate()},e.prototype._retire=function(){this.shapeA=this.shapeB=null,this.bodyA=this.bodyB=null,this._retired=!0,this._lazyRetired=!1,this.active=!1,this._data[6]=0;var e=this.contacts;while(e.length>0){var t=e.pop();Gt.deallocate(t)}this._contact1=this._contact2=null},e.prototype._invalidate=function(e){this._invalidated=!0,e&&!this._midStep&&(this.shapeA.body.wake(),this.shapeB.body.wake())},e.prototype._validate=function(){this._invalidated=!1;var e=this._data,t=this.shapeA._material._data,n=this.shapeB._material._data,r=this._userdef;if((r&4)===0){var i,s=t[0],o=n[0];s<=Number.NEGATIVE_INFINITY||o<=Number.NEGATIVE_INFINITY?i=0:s>=Number.POSITIVE_INFINITY||o>=Number.POSITIVE_INFINITY?i=1:(i=(s+o)*.5,i<0?i=0:i>1&&(i=1)),e[2]=i}var u=Math.sqrt;(r&1)===0&&(e[0]=u(t[2]*n[2])),(r&2)===0&&(e[1]=u(t[1]*n[1])),(r&8)===0&&(e[3]=u(t[3]*n[3]))},e.prototype._injectContact=function(e,t,n,r,i,s,o){var u,a=this.contacts,f=a.length;f!==0&&(u=a[0],u._hash!==s&&(f!==1?(u=a[1],u._hash!==s&&(u=null)):u=null)),o===undefined&&(o=!1);var l;return u?(u.fresh=!o&&u.virtual,l=u._data):(u=Gt.allocate(),l=u._data,l[11]=l[12]=0,u._hash=s,u.fresh=!o,a.push(u),s===0&&(this._data[16]=0)),l[0]=e,l[1]=t,l[2]=i,u._timeStamp=this._timeStamp,u.virtual=o,l=this._data,l[4]=n,l[5]=r,u},e.prototype._cleanContacts=function(e){var t=!0;this._position2Contact=!1,this._contact2=null;var n=this.contacts,r=n.length,i;for(i=0;i<r;){var s=n[i];if(s._timeStamp+At.DELAYED_DEATH<e){r-=1,n[i]=n[r],n.pop(),Gt.deallocate(s);continue}s.active=s._timeStamp===e,s.active&&(t?(this._contact1=s,t=!1):(this._contact2=s,this._position2Contact=!0)),i+=1}if(this._position2Contact){if(this._contact1.virtual){var o=this._contact1;this._contact1=this._contact2,this._contact2=o}this._velocity2Contact=!this._contact2.virtual}else this._velocity2Contact=!1;return!t},e.prototype._preStep=function(e,t,n){if(!this._cleanContacts(t))return!1;this._invalidated&&this._validate();var r=this._data,i=r[6],s=i===0?1:e/i;r[6]=e;var o=this.bodyA._data,u=this.bodyB._data,a=o[2],f=o[3],l=u[2],c=u[3],h=o[7],p=o[8],d=o[9],v=u[7],m=u[8],g=u[9],y=r[4],b=r[5],w=o[0]+u[0],E=o[1],S=u[1],x=At.EFF_MASS_EPSILON,T=n?this._static?At.CONT_STATIC_BIAS_COEF:At.CONT_BIAS_COEF:this._static?At.STATIC_BIAS_COEF:At.BIAS_COEF;r[15]=T;var N=this._contact1,C,k,L,A,O;for(;;){C=N._data;var M=C[0],_=C[1];k=C[7]=M-a,L=C[8]=_-f,A=C[9]=M-l,O=C[10]=_-c;var D=k*y+L*b,P=A*y+O*b,H=w+S*P*P+E*D*D;C[6]=H<x?0:1/H,D=k*b-L*y,P=A*b-O*y;var B=w+S*P*P+E*D*D;C[5]=B<x?0:1/B;var j=v-O*g-(h-L*d),F=m+A*g-(p+k*d),I=y*j+b*F,q=I*r[2];q>-At.BOUNCE_VELOCITY_THRESHOLD&&(q=0),C[3]=q,I=y*F-b*j,I*I>At.STATIC_FRIC_SQ_EPSILON?C[4]=r[0]:C[4]=r[1],C[11]*=s,C[12]*=s;if(!this._velocity2Contact)break;if(N===this._contact2)break;N=this._contact2}C=this._contact1._data,k=C[7],L=C[8],A=C[9],O=C[10];var R=r[7]=k*b-L*y,U=r[8]=A*b-O*y;r[9]=k*y+L*b,r[10]=A*y+O*b;if(!this._velocity2Contact&&this._contact1._hash===0){r[16]*=s;var z=E+S;r[17]=z<x?0:1/z}else if(this._velocity2Contact){C=this._contact2._data;var W=C[7],X=C[8],V=C[9],$=C[10],J=r[16]=W*b-X*y,K=r[17]=V*b-$*y;r[18]=W*y+X*b,r[19]=V*y+$*b;var Q=r[20]=w+E*R*R+S*U*U,G=r[21]=w+E*R*J+S*U*K,Y=r[22]=w+E*J*J+S*K*K,Z=Q*Y-G*G;Q*Q>At.ILL_THRESHOLD*Z?(this._contact2._data[2]<this._contact1._data[2]&&(this._contact1=this._contact2,r[7]=J,r[8]=K,r[9]=r[18],r[10]=r[19]),this._velocity2Contact=!1,this._position2Contact=!1,this._contact2=null):r[23]=1/Z}return!0},e.prototype._iterateVelocity=function(){var e=this.bodyA._data,t=this.bodyB._data,n=e[0],r=e[1],i=t[0],s=t[1],o=e[7],u=e[8],a=e[9],f=t[7],l=t[8],c=t[9],h=this._data,p=h[4],d=h[5],v=h[7],m=h[8],g=h[9],y=h[10],b=this._contact1._data,w=b[7],E=b[8],S=b[9],x=b[10],T=t[13]-e[13],N=t[14]-e[14],C=f-x*c-(o-E*a),k=l+S*c-(u+w*a),L,A,O,M,_,D;L=(p*k-d*C+T)*b[6],D=b[4]*b[11],A=b[12],O=A-L,O>D?O=D:O<-D&&(O=-D),L=O-A,b[12]=O,M=-d*L,_=p*L,o-=M*n,u-=_*n,a-=g*L*r,f+=M*i,l+=_*i,c+=y*L*s;if(this._velocity2Contact){var P=this._contact2._data,H=P[7],B=P[8],j=P[9],F=P[10],I=h[20],q=h[21],R=h[22],U=h[23],z=h[16],W=h[17],X=h[18],V=h[19],$=f-F*c-(o-B*a),J=l+j*c-(u+H*a);L=(p*J-d*$+T)*P[6],D=P[4]*P[11],A=P[12],O=A-L,O>D?O=D:O<-D&&(O=-D),L=O-A,P[12]=O,M=-d*L,_=p*L,o-=M*n,u-=_*n,a-=X*L*r,f+=M*i,l+=_*i,c+=V*L*s,C=f-x*c-(o-E*a),k=l+S*c-(u+w*a),$=f-F*c-(o-B*a),J=l+j*c-(u+H*a);var K=b[11],Q=P[11],G=C*p+k*d+N+b[3]-(I*K+q*Q),Y=$*p+J*d+N+P[3]-(q*K+R*Q),Z=U*(q*Y-R*G),et=U*(q*G-I*Y);Z>=0&&et>=0?(G=Z-K,Y=et-Q,b[11]=Z,P[11]=et):(Z=-(b[5]*G),Z>=0&&q*Z+Y>=0?(G=Z-K,Y=-Q,b[11]=Z,P[11]=0):(et=-(P[5]*Y),et>=0&&q*et+G>=0?(G=-K,Y=et-Q,b[11]=0,P[11]=et):G>=0&&Y>=0?(G=-K,Y=-Q,b[11]=P[11]=0):(G=0,Y=0))),L=G+Y,M=p*L,_=d*L,o-=M*n,u-=_*n,a-=(v*G+z*Y)*r,f+=M*i,l+=_*i,c+=(m*G+W*Y)*s}else{if(this._contact1._hash===0){var tt=c-a;L=tt*h[17],D=h[3]*b[11],A=h[16],O=A-L,O>D?O=D:O<-D&&(O=-D),L=O-A,h[16]=O,a-=L*r,c+=L*s}C=f-x*c-(o-E*a),k=l+S*c-(u+w*a),L=(b[3]+N+(p*C+d*k))*b[5],A=b[11],O=A-L,O<0&&(O=0),L=O-A,b[11]=O,M=p*L,_=d*L,o-=M*n,u-=_*n,a-=v*L*r,f+=M*i,l+=_*i,c+=m*L*s}e[7]=o,e[8]=u,e[9]=a,t[7]=f,t[8]=l,t[9]=c},e.prototype._refreshContactData=function(){var e=this.bodyA._data,t=this.bodyB._data,n=e[5],r=e[6],i=t[5],s=t[6],o=e[2],u=e[3],a=t[2],f=t[3],l,c,h,p=this._data,d=p[14],v=this._contact1._data;if(this._faceType===0){var m=v[13],g=v[14],y=n*m-r*g+o,b=r*m+n*g+u;m=v[15],g=v[16];var w=i*m-s*g+a,E=s*m+i*g+f,S=w-y,x=E-b,T=Math.sqrt(S*S+x*x);c=p[4],h=p[5];if(T<At.NORMALIZE_EPSILON)S=c,x=h;else{var N=1/T;S*=N,x*=N}l=T-d,S*c+x*h<0&&(l-=d,S=-S,x=-x),p[4]=S,p[5]=x;var C,k,L;this.shapeA._type===0?(L=this.shapeA._data[6]+l*.5,C=v[0]=y+S*L,k=v[1]=b+x*L):(L=this.shapeB._data[6]+l*.5,C=v[0]=w-S*L,k=v[1]=E-x*L),v[2]=l}else{var A=this._position2Contact?this._contact2._data:null,O,M,_,D,P,H=p[11],B=p[12],j=v[13],F=v[14];this._faceType===1?(c=H*n-B*r,h=H*r+B*n,O=p[13]+(c*o+h*u),M=a+j*i-F*s,D=f+j*s+F*i,A&&(j=A[13],F=A[14],_=a+j*i-F*s,P=f+j*s+F*i)):(c=H*i-B*s,h=H*s+B*i,O=p[13]+(c*a+h*f),M=o+j*n-F*r,D=u+j*r+F*n,A&&(j=A[13],F=A[14],_=o+j*n-F*r,P=u+j*r+F*n));var I=this._reverse?-1:1;p[4]=I*c,p[5]=I*h;var q=-O-d;l=M*c+D*h+q;var R=l*.5+d;v[0]=M-c*R,v[1]=D-h*R,v[2]=l,A&&(l=_*c+P*h+q,R=l*.5+d,A[0]=_-c*R,A[1]=P-h*R,A[2]=l)}},e.prototype._iteratePosition=function(){this._refreshContactData();var e=this.bodyA,t=this.bodyB,n=e._data,r=t._data,i=n[0],s=n[1],o=r[0],u=r[1],a=n[2],f=n[3],l=r[2],c=r[3],h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L=this._data,A=this._contact1._data,O=A[2]+At.CONTACT_SLOP;if(this._position2Contact){var M=this._contact2._data,_=M[2]+At.CONTACT_SLOP;if(O<0||_<0){h=A[0],p=A[1],S=h-a,x=p-f,T=h-l,N=p-c,h=M[0],p=M[1];var D=h-a,P=p-f,H=h-l,B=p-c;d=L[4],v=L[5],C=S*v-x*d,k=T*v-N*d;var j=D*v-P*d,F=H*v-B*d,I=i+o;w=I+s*C*C+u*k*k;var q=I+s*C*j+u*k*F,R=I+s*j*j+u*F*F;E=L[15];var U=O*E,z=_*E,W=w*R-q*q,X,V;W===0?(X=w===0?0:-U/w,V=R===0?0:-z/R):(W=1/W,X=W*(q*z-R*U),V=W*(q*U-w*z));if(X<0||V<0){X=-U/w,V=0;if(X<0||q*X+z<0){X=0,V=-z/R;if(V<0||q*V+U<0)X=V=0}}y=X+V,m=d*y,g=v*y,a-=m*i,f-=g*i,b=-(C*X+j*V)*s,b!==0&&e._deltaRotation(b),l+=m*o,c+=g*o,b=(k*X+F*V)*u,b!==0&&t._deltaRotation(b)}}else O<0&&(h=A[0],p=A[1],S=h-a,x=p-f,T=h-l,N=p-c,d=L[4],v=L[5],C=S*v-x*d,k=T*v-N*d,w=o+k*k*u+i+C*C*s,w!==0&&(E=L[15],y=-(E*O/w),m=d*y,g=v*y,a-=m*i,f-=g*i,b=-(C*s*y),b!==0&&e._deltaRotation(b),l+=m*o,c+=g*o,b=k*u*y,b!==0&&t._deltaRotation(b)));n[2]=a,n[3]=f,r[2]=l,r[3]=c},e.prototype._warmStart=function(){var e=this.bodyA._data,t=this.bodyB._data,n=e[0],r=e[1],i=t[0],s=t[1],o=this._data,u=o[4],a=o[5],f=this._contact1._data,l=f[11],c=f[12],h=u*l-a*c,p=a*l+u*c;e[7]-=h*n,e[8]-=p*n,e[9]-=(f[7]*p-f[8]*h)*r,t[7]+=h*i,t[8]+=p*i,t[9]+=(f[9]*p-f[10]*h)*s,this._velocity2Contact?(f=this._contact2._data,l=f[11],c=f[12],h=u*l-a*c,p=a*l+u*c,e[7]-=h*n,e[8]-=p*n,e[9]-=(f[7]*p-f[8]*h)*r,t[7]+=h*i,t[8]+=p*i,t[9]+=(f[9]*p-f[10]*h)*s):this._contact1._hash===0&&(l=o[16],e[9]-=l*r,t[9]+=l*s)},e.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new tn.prototype.floatArray(3));var n=this._data,r=n[4],i=n[5],s=this._contact1._data,o=s[11],u=s[12],a=r*o-i*u,f=i*o+r*u,l=0,c=0,h=0;return e===this.bodyA?(l-=a,c-=f,h-=s[7]*f-s[8]*a):e===this.bodyB&&(l+=a,c+=f,h+=s[9]*f-s[10]*a),this._velocity2Contact?(s=this._contact2._data,o=s[11],u=s[12],a=r*o-i*u,f=i*o+r*u,e===this.bodyA?(l-=a,c-=f,h-=s[7]*f-s[8]*a):e===this.bodyB&&(l+=a,c+=f,h+=s[9]*f-s[10]*a)):this._contact1._hash===0&&(o=n[16],h+=(e===this.bodyA?-1:e===this.bodyB?1:0)*o),t[0]=l,t[1]=c,t[2]=h,t},e.allocate=function(){if(!this.pool)return new e;var t=this.pool;return this.pool=t._next,t._next=null,t},e.deallocate=function(e){e._next=this.pool,this.pool=e,e._userdef=0},e.version=1,e.pool=null,e}(),Zt=function(){function e(){}return e.prototype.getGravity=function(e){return e===undefined&&(e=new tn.prototype.floatArray(2)),e[0]=this._gravityX,e[1]=this._gravityY,e},e.prototype.setGravity=function(e){var t=e[0],n=e[1];if(t!==this._gravityX||n!==this._gravityY){this._gravityX=t,this._gravityY=n;var r=this.rigidBodies,i=r.length,s;for(s=0;s<i;s+=1)this._wakeBody(r[s])}},e.prototype._addShape=function(e){var t=e.body;t._update();var n=t._type===2||t.sleeping;e._bphaseHandle=this.broadphase.insert(e,e._data,n)},e.prototype._removeShape=function(e,t){var n=e.body;this.broadphase.remove(e._bphaseHandle),e._bphaseHandle=null;var r=e.arbiters;while(r.length!==0){var i=r.pop();if(i._retired)continue;i.bodyA!==n&&i.bodyA._type===0&&this._wakeBody(i.bodyA),i.bodyB!==n&&i.bodyB._type===0&&this._wakeBody(i.bodyB),i._lazyRetire(e),t||this._pushInteractionEvents(3,i)}},e.prototype._enabledConstraint=function(e){e._islandRoot=e,e._islandRank=0,e.sleeping||(e.sleeping=!0,this._wakeConstraint(e,!0))},e.prototype._disabledConstraint=function(e){this._wakeConstraint(e);var t=this.liveConstraints,n=t.indexOf(e);t[n]=t[t.length-1],t.pop()},e.prototype.addConstraint=function(e){return e.world?!1:(e.world=this,this.constraints.push(e),e._inWorld(),e._active&&this._enabledConstraint(e),!0)},e.prototype.removeConstraint=function(e){if(e.world!==this)return!1;var t=this.constraints,n=t.indexOf(e);return t[n]=t[t.length-1],t.pop(),e._active&&this._disabledConstraint(e),e.world=null,e._outWorld(),!0},e.prototype.addRigidBody=function(e){if(e.world)return!1;e.world=this,this.rigidBodies.push(e),e._update();var t,n=e.shapes,r=n.length;for(t=0;t<r;t+=1)this._addShape(n[t]);return e._type===2?(e.sleeping=!0,!0):(e._islandRoot=e,e._islandRank=0,e.sleeping||(e.sleeping=!0,this._wakeBody(e,!0)),!0)},e.prototype.removeRigidBody=function(e,t){if(e.world!==this)return!1;this._wakeBody(e),e.world=null;var n=this.rigidBodies,r=n.indexOf(e);n[r]=n[n.length-1],n.pop(),!e.sleeping&&e._type!==2&&(e._type===0?n=this.liveDynamics:n=this.liveKinematics,r=n.indexOf(e),n[r]=n[n.length-1],n.pop());var i,s=e.shapes,o=s.length;for(i=0;i<o;i+=1)this._removeShape(s[i],t);var u=e.constraints;while(u.length>0)this.removeConstraint(u[0]);return!0},e.prototype.clear=function(){var e=this.rigidBodies,t=e.length;while(t>0)t-=1,this.removeRigidBody(e[t],!0);var n=this.constraints;t=n.length;while(t>0)t-=1,this.removeConstraint(n[t]);this._clearArbiters(this.staticArbiters),this._clearArbiters(this.dynamicArbiters);var r=this._callbacks;t=r.length;while(t>0)t-=1,Wt.deallocate(r.pop())},e.prototype._clearArbiters=function(e){var t=e.length;while(t>0){var n=e.pop();t-=1,n._retire(),Yt.deallocate(n)}},e.prototype.shapePointQuery=function(e,t){return this._pointQuery(this._shapePointCallback,e,t)},e.prototype.bodyPointQuery=function(e,t){return this._pointQuery(this._bodyPointCallback,e,t)},e.prototype._pointQuery=function(e,t,n){var r=this._sampleRectangle;return r[0]=r[2]=t[0],r[1]=r[3]=t[1],e.store=n,e.count=0,this.broadphase.sample(r,e.sample,e),e.count},e.prototype.shapeCircleQuery=function(e,t,n){return this._circleQuery(this._shapeCircleCallback,e,t,n)},e.prototype.bodyCircleQuery=function(e,t,n){return this._circleQuery(this._bodyCircleCallback,e,t,n)},e.prototype._circleQuery=function(e,t,n,r){var i=this._circleQueryShape;i.setRadius(n);var s=t[0],o=t[1];i._update(s,o,1,0);var u=this._sampleRectangle;return u[0]=s-n,u[1]=o-n,u[2]=s+n,u[3]=o+n,e.store=r,e.count=0,this.broadphase.sample(u,e.sample,e),e.count},e.prototype.shapeRectangleQuery=function(e,t){return this._rectangleQuery(this._shapeRectangleCallback,e,t)},e.prototype.bodyRectangleQuery=function(e,t){return this._rectangleQuery(this._bodyRectangleCallback,e,t)},e.prototype._rectangleQuery=function(e,t,n){var r=this._rectangleQueryVertices,i=t[0],s=t[1],o=t[2],u=t[3];r[0][0]=r[3][0]=i<o?i:o,r[0][1]=r[1][1]=s<u?s:u,r[1][0]=r[2][0]=i<o?o:i,r[2][1]=r[3][1]=s<u?u:s;var a=this._rectangleQueryShape;return a.setVertices(r),a._update(0,0,1,0),e.store=n,e.count=0,this.broadphase.sample(t,e.sample,e),e.count},e.prototype.rayCast=function(e,t,n,r){var i=e.origin,s=e.direction,o=e.maxFactor,u=i[0],a=i[1],f=u+s[0]*o,l=a+s[1]*o,c=this._sampleRectangle;c[0]=u<f?u:f,c[1]=a<l?a:l,c[2]=u<f?f:u,c[3]=a<l?l:a;var h=this._rayCast;h.ray=e,h.noInner=t||!1,h.minFactor=e.maxFactor,h.userCallback=n,h.userThis=r,h.minShape=null,this.broadphase.sample(c,h.sample,h);if(h.minShape){var p=h.minNormal,d=new tn.prototype.floatArray(2),v=new tn.prototype.floatArray(2);return d[0]=p[0],d[1]=p[1],v[0]=u+s[0]*h.minFactor,v[1]=a+s[1]*h.minFactor,{shape:h.minShape,hitNormal:d,hitPoint:v,factor:h.minFactor}}return null},e.prototype.convexCast=function(e,t,n,r){var i=e.body,s=i._data,o=s[2],u=s[3];i._sweepIntegrate(t);var a=s[2],f=s[3],l=this._sampleRectangle,c=e._data[4];l[0]=(o<a?o:a)-c,l[1]=(u<f?u:f)-c,l[2]=(o<a?a:o)+c,l[3]=(u<f?f:u)+c,i[20]=i[9];var h=this._convexCast;h.deltaTime=t,h.minTOIAlpha=1,h.minShape=null,h.toi.shapeA=e,h.userCallback=n,h.userThis=r,this.broadphase.sample(l,h.sample,h),i._sweepIntegrate(0),e._update(o,u,s[5],s[6],!0);if(h.minShape){var p=h.minData,d=new tn.prototype.floatArray(2),v=new tn.prototype.floatArray(2);return d[0]=-p[0],d[1]=-p[1],v[0]=p[2],v[1]=p[3],{shape:h.minShape,hitNormal:d,hitPoint:v,factor:h.minTOIAlpha*t}}return null},e.prototype.step=function(e){this._midStep=!0,this._eventTime=0,this.timeStamp+=1,this._deltaTime=e,this.simulatedTime+=e,this._validate(),this._discreteCollisions(),this._sleepComputations(e),this._preStep(e),this._sortArbiters(),this._integrateVelocity(e),this._warmStart(),this._iterateVelocity(this.velocityIterations),this._integratePosition(e),this._eventTime=1,this._continuousCollisions(e),this._sortArbiters(),this._iteratePosition(this.positionIterations),this._finalize(),this._midStep=!1,this._eventTime=-1,this._doCallbacks()},e.prototype._discreteCollisions=function(){this.broadphase.perform(this._discreteNarrowPhase,this),this._doDeferredWake(!1)},e.prototype._doDeferredWake=function(e){var t=this._deferredWake,n=t.length;while(n>0){var r=t.pop();r._deferred=!1,this._wakeBody(r,!1,e),n-=1}},e.prototype._collisionType=function(e,t,n,r){if(n===r)return undefined;var i=n.constraints.length<r.constraints.length?n.constraints:r.constraints,s=i.length,o;for(o=0;o<s;o+=1){var u=i[o];if(u._active&&u._ignoreInteractions&&u._pairExists(n,r))return undefined}if((e._group&t._mask)===0||(t._group&e._mask)===0)return undefined;var a=!e.sensor&&!t.sensor;return n._type!==0&&r._type!==0&&a?undefined:a},e.prototype._discreteNarrowPhase=function(e,t,n){var r=e.data,i=t.data,s=r.body,o=i.body,u=this._collisionType(r,i,s,o);if(u===undefined)return null;var a=s._type!==0||o._type!==0,f,l;r.id<i.id?(f=r,l=i):(f=i,l=r);var c=(f.arbiters.length<l.arbiters.length?f:l).arbiters,h=c.length,p,d;for(p=0;p<h;p+=1){var v=c[p];if(v.shapeA===f&&v.shapeB===l){d=v;break}}var m=!d;m&&(d=Yt.allocate());if(m||d._timeStamp!==this.timeStamp||n){d._timeStamp=this.timeStamp;if(u&&this._collisions._collide(f,l,d)||!u&&this._collisions._test(f,l)){m&&(d.sensor=!u,d._assign(f,l),d._static=a,a?this.staticArbiters.push(d):this.dynamicArbiters.push(d));if(m||d._endGenerated===this.timeStamp&&n||d._updateStamp<this.timeStamp-1)d._createContinuous=n,d._createStamp=this.timeStamp,d._state=u?0:3;d._updateStamp=this.timeStamp;var g=!1;if(u&&(d._state&2)===0){d._state=1,d._midStep=!0;var y=f._onPreSolve;h=y.length;var b;for(p=0;p<h;p+=1)b=y[p],b.callback.call(b.thisObject,d,l),b.deterministic||(g=!0);y=l._onPreSolve,h=y.length;for(p=0;p<h;p+=1)b=y[p],b.callback.call(b.thisObject,d,f),b.deterministic||(g=!0);d._midStep=!1,d._indeterminate=g,g&&(d._state&2)===0&&(s._type===0&&!s._deferred&&(s._deferred=!0,this._deferredWake.push(s)),o._type===0&&!s._deferred&&(o._deferred=!0,this._deferredWake.push(o)))}u&&(d._state&1)!==0&&(s._type===0&&s.sleeping&&!s._deferred&&(s._deferred=!0,this._deferredWake.push(s)),o._type===0&&o.sleeping&&!o._deferred&&(o._deferred=!0,this._deferredWake.push(o))),d.sleeping&&this._wakeArbiter(d)}else m&&(Yt.deallocate(d),d=null)}return d},e.prototype._continuousCollisions=function(e){this.broadphase.perform(this._continuousNarrowPhase,this);var t=0,n=this._toiEvents,r=n.length,i,s;while(t<1&&r!==0){var o=Number.POSITIVE_INFINITY,u=!1,a=-1,f,l;for(s=0;s<r;){i=n[s],f=i.shapeA.body,l=i.shapeB.body;if(f._sweepFrozen&&l._sweepFrozen){r-=1,n[s]=n[r],n.pop(),Vt.deallocate(i);continue}if(i.frozenA!==f._sweepFrozen||i.frozenB!==l._sweepFrozen){i.frozenA=f._sweepFrozen,i.frozenB=l._sweepFrozen;if(i.frozenA){var c=i.shapeA;i.shapeA=i.shapeB,i.shapeB=c,i.frozenA=!1,i.frozenB=!0}this._collisions._staticSweep(i,e,At.SWEEP_SLOP);if(i._data[6]<0){r-=1,n[s]=n[r],n.pop(),Vt.deallocate(i);continue}}var h=i._data[6];h>=0&&(h<o||!u&&i.kinematic)&&(o=h,u=i.kinematic,a=s),s+=1}if(a===-1)break;i=n[a],r-=1,n[a]=n[r],n.pop(),t=o;var p=i.shapeA,d=i.shapeB;f=p.body,l=d.body;var v=f._data,m=l._data;if(!f._sweepFrozen||i.kinematic)f._sweepIntegrate(t*e),p._update(v[2],v[3],v[5],v[6],!0);if(!l._sweepFrozen||i.kinematic)l._sweepIntegrate(t*e),d._update(m[2],m[3],m[5],m[6],!0);var g=this._discreteNarrowPhase(p._bphaseHandle,d._bphaseHandle,!0);g&&this._continuousArbiterPrepare(g,e),g&&!g.sensor&&(g._state&1)!==0&&(!f._sweepFrozen&&f._type===0&&(f._sweepFrozen=!0,i.failed?v[20]=0:i.slipped&&(v[20]*=At.TOI_SLIP_SCALE),v[9]=v[20]),!l._sweepFrozen&&l._type===0&&(l._sweepFrozen=!0,i.failed?m[20]=0:i.slipped&&(m[20]*=At.TOI_SLIP_SCALE),m[9]=m[20])),Vt.deallocate(i)}while(r>0)i=n.pop(),Vt.deallocate(i),r-=1;var y=this.liveDynamics;r=y.length;for(s=0;s<r;s+=1){var b=y[s];b._sweepFrozen||b._sweepIntegrate(e)}y=this.liveKinematics,r=y.length;for(s=0;s<r;s+=1)y[s]._sweepIntegrate(e);this._doDeferredWake(!0)},e.prototype._continuousNarrowPhase=function(e,t){var n=e.data,r=t.data,i=n.body,s=r.body;if(i._sweepFrozen&&s._sweepFrozen)return;var o=i._type!==0||s._type!==0;if(o||i._bullet||s._bullet){var u=Vt.allocate(),a=i._type===1||s._type===1;o&&!a?(i._type!==0?(u.shapeB=n,u.shapeA=r):(u.shapeA=n,u.shapeB=r),this._collisions._staticSweep(u,this._deltaTime,At.SWEEP_SLOP)):n.body._sweepFrozen?(u.shapeB=n,u.shapeA=r,this._collisions._staticSweep(u,this._deltaTime,At.SWEEP_SLOP)):r.body._sweepFrozen?(u.shapeA=n,u.shapeB=r,this._collisions._staticSweep(u,this._deltaTime,At.SWEEP_SLOP)):(u.shapeA=n,u.shapeB=r,this._collisions._dynamicSweep(u,this._deltaTime,At.SWEEP_SLOP)),o&&u._data[6]<0||u.failed?Vt.deallocate(u):(this._toiEvents.push(u),u.frozenA=u.shapeA.body._sweepFrozen,u.frozenB=u.shapeB.body._sweepFrozen,u.staticType=o,u.kinematic=a)}},e.prototype.__union=function(e,t){var n,r;while(e!==e._islandRoot)r=e._islandRoot,e._islandRoot=n,n=e,e=r;while(n)r=n._islandRoot,n._islandRoot=e,n=r;while(t!==t._islandRoot)r=t._islandRoot,t._islandRoot=n,n=t,t=r;while(n)r=n._islandRoot,n._islandRoot=t,n=r;e!==t&&(e._islandRank<t._islandRank?e._islandRoot=t:t._islandRank<e._islandRank?t._islandRoot=e:(t._islandRoot=e,e._islandRank+=1))},e.prototype.__find=function(e){if(e===e._islandRoot)return e;var t=null,n;while(e!==e._islandRoot)n=e._islandRoot,e._islandRoot=t,t=e,e=n;while(t)n=t._islandRoot,t._islandRoot=e,t=n;return e},e.prototype._sleepComputations=function(e){var t=this.dynamicArbiters,n,r=t.length,i;for(i=0;i<r;i+=1){n=t[i];if(!n.sensor&&!n._retired&&n._updateStamp===this.timeStamp&&(n._state&1)!==0){var s=n.bodyA,o=n.bodyB;s._type===0&&o._type===0&&this.__union(s,o)}}var u=this.liveConstraints;r=u.length;for(i=0;i<r;i+=1)u[i]._sleepComputation(this.__union);var a=this._islands,f,l,c=this.liveDynamics;r=c.length;while(r>0){r-=1;var h=c.pop();l=this.__find(h),f=l._island,f===null&&(l._island=f=Xt.allocate(),a.push(f),f.sleeping=!0,f.wakeTime=0),h._island=f,f.components.push(h);var p=h._atRest(e,this.timeStamp);f.sleeping=f.sleeping&&p,h._wakeTime>f.wakeTime&&(f.wakeTime=h._wakeTime)}r=u.length;while(r>0){r-=1;var d=u.pop();l=this.__find(d),f=l._island,f===null&&(l._island=f=Xt.allocate(),a.push(f),f.sleeping=!0,f.wakeTime=0),d._island=f,f.components.push(d),d._wakeTime>f.wakeTime&&(f.wakeTime=d._wakeTime)}r=a.length;var v,m=this.broadphase;while(r>0){r-=1,f=a[r],a.pop();var g,y;if(f.sleeping){y=f.components,v=y.length;var b;for(b=0;b<v;b+=1){g=y[b],g.sleeping=!0;if(g._isBody){var w=g.shapes,E=w.length,S;for(S=0;S<E;S+=1){var x=w[S];m.update(x._bphaseHandle,x._data,!0)}var T=g._data;T[7]=0,T[8]=0,T[9]=0}g._onSleep.length>0&&this._pushCallbacks(g,g._onSleep)}}else{y=f.components,v=y.length;while(v>0)v-=1,g=y.pop(),g._wakeTime=f.wakeTime,g._isBody?c.push(g):u.push(g),g._island=null,g._islandRoot=g,g._islandRank=0;Xt.deallocate(f)}}},e.prototype._sortArbiters=function(){this._subSortArbiters(this.dynamicArbiters),this._subSortArbiters(this.staticArbiters)},e.prototype._subSortArbiters=function(e){var t,n=e.length-1;for(t=1;t<n;t+=1){var r=e[t],i=r.shapeA.id,s=r.shapeB.id,o=t;while(o>0){var u=e[o-1],a=u.shapeA.id;if(a<i||a===i&&u.shapeB.id<s)break;e[o]=u,o-=1}e[o]=r}},e.prototype._onWakeCallbacks=function(e){this._midStep?e._onWake.length>0&&this._pushCallbacks(e,e._onWake):e._woken=!0},e.prototype._pushCallbacks=function(e,t)
{var n=this._callbacks,r=t.length,i;for(i=0;i<r;i+=1){var s=Wt.allocate();s.thisObject=e,s.callback=t[i],s.time=this._eventTime,s.index=i,n.push(s)}},e.prototype._pushInteractionEvents=function(e,t){var n=this._callbacks,r=t.shapeA,i=t.shapeB,s=r._group,o=i._group,u=r._events,a=u.length,f,l,c;for(f=0;f<a;f+=1)l=u[f],l.type===e&&(l.mask===undefined||(l.mask&o)!==0)&&(c=Wt.allocate(),c.thisObject=r,c.callback=l.callback,c.time=this._eventTime,c.index=f,c.arbiter=t,n.push(c));u=i._events,a=u.length;for(f=0;f<a;f+=1)l=u[f],l.type===e&&(l.mask===undefined||(l.mask&s)!==0)&&(c=Wt.allocate(),c.thisObject=r,c.callback=l.callback,c.time=this._eventTime,c.index=f,c.arbiter=t,n.push(c))},e.prototype._brokenConstraint=function(e){e._onBreak.length>0&&this._pushCallbacks(e,e._onBreak);if(e._removeOnBreak){e.world=null;var t=this.constraints,n=t.indexOf(e);t[n]=t[t.length-1],t.pop(),e._outWorld()}else e._active=!1;e._clearCache()},e.prototype._preStep=function(e){var t=this.liveConstraints,n=t.length,r;for(r=0;r<n;){var i=t[r];if(i._preStep(e)){n-=1,t[r]=t[n],t.pop(),this._brokenConstraint(i);continue}r+=1}this._preStepArbiters(this.dynamicArbiters,e),this._preStepArbiters(this.staticArbiters,e)},e.prototype._preStepArbiter=function(e,t,n){var r=this.timeStamp;e.active=e._updateStamp===r,e._createContinuous&&e._createStamp===r?this._pushInteractionEvents(1,e):n&&e.active&&this._pushInteractionEvents(2,e),e.active&&((e._state&1)!==0?e._preStep(t,r,!0)||(e.active=!1):!e.sensor&&!e._cleanContacts(r)&&(e.active=!1))},e.prototype._preStepArbiters=function(e,t){var n=this.timeStamp,r=e.length,i;for(i=0;i<r;){var s=e[i];if(!s._retired&&s.bodyA.sleeping&&s.bodyB.sleeping){s._sleepStamp=n,s.sleeping=!0,s.active=!1,this._pushInteractionEvents(2,s),r-=1,e[i]=e[r],e.pop();continue}if(!!s._lazyRetired){s._lazyRetired=!1,i+=1;continue}if(s._retired||s._updateStamp+(s.sensor?1:At.DELAYED_DEATH)<n){s._retire(),r-=1,e[i]=e[r],e.pop(),Yt.deallocate(s);continue}s.active=s._updateStamp===n,s._createStamp===n?this._pushInteractionEvents(1,s):s.active?this._pushInteractionEvents(2,s):s._updateStamp===n-1&&(this._pushInteractionEvents(3,s),s._endGenerated=this.timeStamp),s.active&&((s._state&1)!==0?s._preStep(t,n)||(s.active=!1):!s.sensor&&!s._cleanContacts(n)&&(s.active=!1)),i+=1}},e.prototype._iterateVelocity=function(e){var t=this.liveConstraints;while(e>0){var n=t.length,r;for(r=0;r<n;){var i=t[r];if(i._iterateVel()){n-=1,t[r]=t[n],t.pop(),this._brokenConstraint(i);continue}r+=1}this._iterateVelocityArbiters(this.dynamicArbiters),this._iterateVelocityArbiters(this.staticArbiters),e-=1}},e.prototype._iterateVelocityArbiters=function(e){var t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r.active&&!r.sensor&&(r._state&1)!==0&&r._iterateVelocity()}},e.prototype._iteratePosition=function(e){var t=this.liveConstraints;while(e>0){var n=t.length,r;for(r=0;r<n;){var i=t[r];if(i._stiff&&i._iteratePos()){n-=1,t[r]=t[n],t.pop(),this._brokenConstraint(i);continue}r+=1}this._iteratePositionArbiters(this.dynamicArbiters),this._iteratePositionArbiters(this.staticArbiters),e-=1}},e.prototype._iteratePositionArbiters=function(e){var t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r.active&&!r.sensor&&(r._state&1)!==0&&r._iteratePosition()}},e.prototype._integrateVelocity=function(e){var t=this._gravityX,n=this._gravityY,r=this.liveDynamics,i=r.length,s;for(s=0;s<i;s+=1){var o=r[s],u=o._data,a=u[0],f;a!==0&&(u[7]+=(u[10]*a+t)*e,u[8]+=(u[11]*a+n)*e,f=Math.exp(e*u[21]),u[7]*=f,u[8]*=f);var l=u[1];l!==0&&(u[9]+=u[12]*l*e,u[9]*=Math.exp(e*u[22]))}},e.prototype._integratePosition=function(e){this._integratePositionBodies(this.liveDynamics,e),this._integratePositionBodies(this.liveKinematics,e)},e.prototype._integratePositionBodies=function(e,t){var n=2*Math.PI/t,r=1/(t*t),i=At.MIN_LINEAR_STATIC_SWEEP,s=At.MIN_ANGULAR_STATIC_SWEEP;i*=i*r,s*=s*r;var o=At.MIN_LINEAR_BULLET_SWEEP,u=At.MIN_ANGULAR_BULLET_SWEEP;o*=o*r,u*=u*r;var a=this.broadphase,f=e.length,l;for(l=0;l<f;l+=1){var c=e[l],h=c._data,p=h[15]=h[2],d=h[16]=h[3];h[17]=h[4];var v=h[2]+=h[7]*t,m=h[3]+=h[8]*t,g=h[9];c._deltaRotation(g*t),h[18]=t;var y=h[7],b=h[8],w=h[20]=g%n,E=h[19],S=i*E*E,x=y*y+b*b;if(x>S||w*w>s){var T=p<v?p:v,N=d<m?d:m,C=p<v?v:p,k=d<m?m:d,L=c.shapes,A=L.length,O;for(O=0;O<A;O+=1){var M=L[O],_=M._data;E=_[4],_[0]=T-E,_[1]=N-E,_[2]=C+E,_[3]=k+E,a.update(M._bphaseHandle,_)}c._sweepFrozen=!1,c._type===0&&(c._bullet=c.bullet&&(x>o*E*E||w*w>u))}else c._sweepFrozen=!0,c._bullet=!1}},e.prototype._finalize=function(){this._finalizeBodies(this.liveDynamics),this._finalizeBodies(this.liveKinematics),this._finalizeArbiters(this.dynamicArbiters),this._finalizeArbiters(this.staticArbiters)},e.prototype._finalizeArbiters=function(e){var t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r.active&&!r.sensor&&r._refreshContactData()}},e.prototype._finalizeBodies=function(e){var t=this.broadphase,n=e.length,r;for(r=0;r<n;){var i=e[r],s=i._data,o=i.shapes,u=o.length,a,f;if(s[15]!==s[2]||s[16]!==s[3]||s[17]!==s[4])i._invalidated=!0;else if(i._type===1){n-=1,e[r]=e[n],e.pop(),i.sleeping=!0;for(a=0;a<u;a+=1)f=o[a],t.update(f._bphaseHandle,f._data,!0);continue}r+=1}},e.prototype._doCallbacks=function(){var e=this._callbacks,t,n=[e.length-1,0];do{var r=n.pop(),i=n.pop();if(r>i)continue;var s=r+i>>1,o=e[s],u=r,a=o.index,f=o.time;e[s]=e[i],e[i]=o;for(t=r;t<i;t+=1){var l=e[t];if(l.time<f||l.time===f&&l.index<a)e[t]=e[u],e[u]=l,u+=1}e[i]=e[u],e[u]=o,u+1<i&&(n.push(i),n.push(u+1)),r<u-1&&(n.push(u-1),n.push(r))}while(n.length>0);var c=e.length;for(t=0;t<c;t+=1){var h=e[t];if(h.arbiter){var p=h.arbiter,d=p.shapeA,v=p.shapeB,m=h.thisObject;h.callback.call(m,p,m===d?v:d)}else h.callback.call(h.thisObject);Wt.deallocate(h)}e.length=0},e.prototype._warmStart=function(){var e=this.liveConstraints,t=e.length,n;for(n=0;n<t;n+=1)e[n]._warmStart();this._warmStartArbiters(this.dynamicArbiters),this._warmStartArbiters(this.staticArbiters)},e.prototype._warmStartArbiters=function(e){var t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r.active&&!r.sensor&&(r._state&1)!==0&&r._warmStart()}},e.prototype._forceSleepBody=function(e){if(e.sleeping||e._type!==0)return;e.sleeping=!0;var t=this.liveDynamics,n=t.indexOf(e);t[n]=t[t.length-1],t.pop();var r=e.shapes,i=r.length,s,o=this.broadphase;for(s=0;s<i;s+=1){var u=r[s];o.update(u._bphaseHandle,u._data,!0);var a=u.arbiters,f=a.length,l;for(l=0;l<f;l+=1){var c=a[l];if(c._retired||c.sleeping)continue;c.sleeping=!0,c._sleepStamp=this.timeStamp;var h;c._static?h=this.staticArbiters:h=this.dynamicArbiters,n=h.indexOf(c),h[n]=h[h.length-1],h.pop()}}},e.prototype._forceSleepConstraint=function(e){if(e.sleeping)return;e.sleeping=!0;if(e._active){var t=this.liveConstraints,n=t.indexOf(e);t[n]=t[t.length-1],t.pop()}},e.prototype._wakeConstraint=function(e,t){if(e.world!==this)return;e._active&&(e._wakeTime=this.timeStamp+(this._midStep?0:1),e.sleeping&&(e._island?this._wakeIsland(e._island,t?e:null):(e.sleeping=!1,this.liveConstraints.push(e),e._wakeConnected(),t||this._onWakeCallbacks(e))))},e.prototype._wakeBody=function(e,t,n){if(e.world!==this)return;e._wakeTime=this.timeStamp+(this._midStep?0:1);if(e.sleeping)if(!e._island){var r=this.broadphase;e._type===0?(e.sleeping=!1,this.liveDynamics.push(e)):e._type===1&&(e.sleeping=!1,this.liveKinematics.push(e));var i=e.constraints,s=i.length,o;for(o=0;o<s;o+=1)this._wakeConstraint(i[o]);var u=e._type===2,a=e.shapes;s=a.length;for(o=0;o<s;o+=1){var f=a[o];this._wakeArbiters(f.arbiters,!1,n),u||r.update(f._bphaseHandle,f._data,!1)}!t&&e._type===0&&this._onWakeCallbacks(e)}else this._wakeIsland(e._island,t?e:null,n)},e.prototype._wakeArbiter=function(e,t){e.sleeping=!1;var n=this.timeStamp+(this._midStep?0:1),r=n-e._sleepStamp;e._updateStamp+=r;var i=e.contacts,s=i.length,o;for(o=0;o<s;o+=1)i[o]._timeStamp+=r;e._static?this.staticArbiters.push(e):this.dynamicArbiters.push(e),t&&this._continuousArbiterPrepare(e,this._deltaTime,!0)},e.prototype._continuousArbiterPrepare=function(e,t,n){this._preStepArbiter(e,t,n),e.active&&!e.sensor&&(e._state&1)!==0&&e._iterateVelocity()},e.prototype._wakeArbiters=function(e,t,n){var r=e.length,i,s=this.timeStamp+(this._midStep?0:1);for(i=0;i<r;i+=1){var o=e[i];if(o._retired)continue;o.sleeping&&this._wakeArbiter(o,n);if(!t&&o._updateStamp===s&&!o.sensor&&(o._state&1)!==0){var u=o.bodyA,a=o.bodyB;u._type===0&&u.sleeping&&this._wakeBody(u,!1,n),a._type===0&&a.sleeping&&this._wakeBody(a,!1,n)}}},e.prototype._wakeIsland=function(e,t,n){var r=this.broadphase,i=this.liveDynamics,s=this.liveConstraints,o=this.timeStamp+(this._midStep?0:1),u=e.components,a=u.length;while(a>0){a-=1;var f=u.pop();f._wakeTime=o,f._island=null,f._islandRoot=f,f._islandRank=0,f.sleeping=!1;if(f._isBody){i.push(f);var l=f.shapes,c=l.length,h;for(h=0;h<c;h+=1){var p=l[h];this._wakeArbiters(p.arbiters,!0,n),r.update(p._bphaseHandle,p._data,!1)}}else s.push(f);t!==f&&this._onWakeCallbacks(f)}Xt.deallocate(e)},e.prototype._transmitBodyType=function(e,t){this._wakeBody(e);var n;e._type===0?n=this.liveDynamics:e._type===1&&(n=this.liveKinematics);var r;n&&(r=n.indexOf(e),n[r]=n[n.length-1],n.pop()),e._type=t;var i=t===2;i&&e._update(),t===0&&(e._islandRoot=e,e._islandRank=0);var s=this.broadphase,o=e.shapes,u=o.length,a;for(a=0;a<u;a+=1){var f=o[a];i&&s.update(f._bphaseHandle,f._data,!0);var l=f.arbiters,c=l.length,h;for(h=0;h<c;){var p=l[h];if(p._retired)continue;var d=p.bodyA._type!==0&&p.bodyB._type!==0,v=p.bodyA._type===1||p.bodyB._type===1;if(d&&(!v||!p.sensor)){c-=1,l[h]=l[c],l.pop(),p._lazyRetire(f),this._pushInteractionEvents(3,p);continue}var m=p.bodyA._type!==0||p.bodyB._type!==0;if(m!==p._static){var g=p._static?this.staticArbiters:this.dynamicArbiters;r=g.indexOf(p),g[r]=g[g.length-1],g.pop(),p._static=m,g=m?this.staticArbiters:this.dynamicArbiters,g.push(p)}h+=1}}e.sleeping=!0,this._wakeBody(e)},e.prototype._validate=function(){this._validateBodies(this.liveDynamics),this._validateBodies(this.liveKinematics);var e=this.liveConstraints,t,n=e.length;for(t=0;t<n;t+=1){var r=e[t];r._woken&&r._onWake.length>0&&this._pushCallbacks(r,r._onWake),r._woken=!1}},e.prototype._validateBodies=function(e){var t=this.broadphase,n,r=e.length;for(n=0;n<r;n+=1){var i=e[n],s=i._data,o=s[4];s[5]=Math.cos(o),s[6]=Math.sin(o),i._update(),i._type===0&&i._woken&&i._onWake.length>0&&this._pushCallbacks(i,i._onWake),i._woken=!1;var u=i.shapes,a=u.length,f;for(f=0;f<a;f+=1){var l=u[f];t.update(l._bphaseHandle,l._data)}}},e.create=function(t){var n=new e;n.simulatedTime=0,n.rigidBodies=[],n.constraints=[],n.liveDynamics=[],n.liveKinematics=[],n.liveConstraints=[],n.dynamicArbiters=[],n.staticArbiters=[],n._islands=[],n._toiEvents=[],n._deferredWake=[],n._eventTime=-1,n._callbacks=[],n.broadphase=t.broadphase||Jt.create(),n.velocityIterations=t.velocityIterations||8,n.positionIterations=t.positionIterations||8,n._midStep=!1,n.timeStamp=0;var r=t.gravity;n._gravityX=r?r[0]:0,n._gravityY=r?r[1]:10,n._collisions=en.create(),n._sampleRectangle=new tn.prototype.floatArray(4);var i=function(t){return{store:null,count:0,collisions:n._collisions,sample:function(e,n){var r=e.data;t.call(this,r,n)&&(this.store[this.count]=r,this.count+=1)}}},s=function(t){return{store:null,count:0,collisions:n._collisions,sample:function(e,n){var r=e.data;if(t.call(this,r,n)){var i=!1,s=r.body,o,u=this.count,a=this.store;for(o=0;o<u;o+=1)if(a[o]===s){i=!0;break}i||(a[u]=s,this.count+=1)}}}},o=function(t,n){return this.collisions._contains(t,n[0],n[1])};n._shapePointCallback=i(o),n._bodyPointCallback=s(o);var u=function(t,n){return this.collisions._test(t,this.rectangleShape)};n._shapeRectangleCallback=i(u),n._bodyRectangleCallback=s(u),n._rectangleQueryVertices=[new tn.prototype.floatArray(2),new tn.prototype.floatArray(2),new tn.prototype.floatArray(2),new tn.prototype.floatArray(2)],n._rectangleQueryShape=Ut.create({vertices:n._rectangleQueryVertices}),n._shapeRectangleCallback.rectangleShape=n._rectangleQueryShape,n._bodyRectangleCallback.rectangleShape=n._rectangleQueryShape;var a=function(t,n){return this.collisions._test(t,this.circleShape)};n._shapeCircleCallback=i(a),n._bodyCircleCallback=s(a),n._circleQueryShape=Rt.create({radius:1}),n._shapeCircleCallback.circleShape=n._circleQueryShape,n._bodyCircleCallback.circleShape=n._circleQueryShape;var f={shape:null,hitPoint:new tn.prototype.floatArray(2),hitNormal:new tn.prototype.floatArray(2),factor:0};return n._rayCast={minNormal:new tn.prototype.floatArray(2),minShape:null,minFactor:0,userCallback:null,userThis:null,ray:null,noInner:!1,normal:new tn.prototype.floatArray(2),sample:function(t,r){var i=t.data,s=this.ray,o=this.normal,u=s.maxFactor;s.maxFactor=this.minFactor;var a=n._collisions.rayTest(i,s,o,this.noInner);s.maxFactor=u;if(this.userCallback){var l=f,c=l.hitNormal;c[0]=o[0],c[1]=o[1],c=l.hitPoint;var h=s.origin,p=s.direction;c[0]=h[0]+p[0]*a,c[1]=h[1]+p[1]*a,l.factor=a,l.shape=i;if(!this.userCallback.call(this.userThis,s,l))return}if(a!==undefined){this.minFactor=a,this.minShape=i;var d=this.minNormal;d[0]=o[0],d[1]=o[1]}}},n._convexCast={toi:n._collisions._toi,minData:new tn.prototype.floatArray(4),minShape:null,minTOIAlpha:0,userCallback:null,userThis:null,deltaTime:0,sample:function(t,r){var i=this.toi,s=t.data;if(s===i.shapeA)return;i.shapeB=s,s.body._update();var o=n._collisions._staticSweep(i,this.minTOIAlpha*this.deltaTime,0)*this.minTOIAlpha;if(o<=0)return;var u=i._data;if(this.userCallback){var a=f,l=a.hitNormal;l[0]=-u[0],l[1]=-u[1],l=a.hitPoint,l[0]=u[4],l[1]=u[5],a.factor=o*this.deltaTime,a.shape=s,a.shape=s;if(!this.userCallback.call(this.userThis,i.shapeA,a))return}this.minTOIAlpha=o;var c=this.minData;c[0]=u[0],c[1]=u[1],c[2]=u[4],c[3]=u[5],this.minShape=s}},n},e.version=1,e}(),en=function(){function e(){}return e.prototype.containsPoint=function(e,t){return e.body._update(),this._contains(e,t[0],t[1])},e.prototype.signedDistance=function(e,t,n,r,i){e.body._update(),t.body!==e.body&&t.body._update();var s=this._toi._data,o=this._distance(e,t,s);return n[0]=s[2],n[1]=s[3],r[0]=s[4],r[1]=s[5],i[0]=s[0],i[1]=s[1],o},e.prototype.intersects=function(e,t){return e.body._update(),t.body!==e.body&&t.body._update(),this._test(e,t)},e.prototype.rayTest=function(e,t,n,r){return e.body._update(),this._rayTest(e,t,n,r)},e.prototype.sweepTest=function(e,t,n,r,i){var s=this._toi;s.shapeA=e,s.shapeB=t;var o=e.body,u=t.body,a=o._data,f=u._data;a[18]=0,f[18]=0,a[20]=a[9],f[20]=f[9];var l=this._dynamicSweep(s,n,0,!0);o._sweepIntegrate(0),u._sweepIntegrate(0),e._update(a[2],a[3],a[5],a[6]),t._update(f[2],f[3],f[5],f[6]);if(l<0)return undefined;var c=s._data;return r[0]=.5*(c[2]+c[4]),r[1]=.5*(c[3]+c[5]),i[0]=c[0],i[1]=c[1],l*n},e.prototype._rayTest=function(e,t,n,r){return e._type===0?this._rayTestCircle(e,t,n,r):this._rayTestPolygon(e,t,n,r)},e.prototype._rayTestPolygon=function(e,t,n,r){var i=t.origin,s=t.direction,o=e._data,u=i[0],a=i[1],f=s[0],l=s[1],c=t.maxFactor,h,p,d=6,v=o.length;for(;d<v;d+=13){var m=o[d+6],g=o[d+6+1],y=m*f+g*l;if(y>=0&&r||y*y<At.COLLINEAR_SQ_EPSILON)continue;var b=(o[d+9]-(u*m+a*g))/y;if(b<0||b>=c)continue;var w=u+f*b,E=a+l*b,S=m*E-g*w;if(S<o[d+10]||S>o[d+11])continue;c=b,h=d,p=y>=0}if(h===undefined)return undefined;var x=p?-1:1;return n[0]=o[h+6]*x,n[1]=o[h+6+1]*x,c},e.prototype._rayTestCircle=function(e,t,n,r){var i=t.origin,s=t.direction,o=e._data,u=i[0],a=i[1],f=s[0],l=s[1],c=o[9],h=o[10],p=o[6],d=u-c,v=a-h,m=f*f+l*l,g=2*(d*f+v*l),y=d*d+v*v-p*p,b=g*g-4*m*y;if(b<0)return undefined;var w=1,E=1/(2*m),S=Math.sqrt(b),x=(-g-S)*E;if(x<0){if(r)return undefined;x+=S*2*E,w=-1}if(0<=x&&x<t.maxFactor){var T=u+f*x-c,N=a+l*x-h,C=w/p;return n[0]=T*C,n[1]=N*C,x}return undefined},e.prototype._contains=function(e,t,n){return e._type===0?this._containsCircle(e,t,n):this._containsPolygon(e,t,n)},e.prototype._containsCircle=function(e,t,n){var r=e._data,i=r[9]-t,s=r[10]-n,o=r[6];return i*i+s*s-o*o<=At.CONTAINS_SQ_EPSILON},e.prototype._containsPolygon=function(e,t,n){var r=e._data,i=6,s=r.length,o=At.CONTAINS_EPSILON;for(;i<s;i+=13){var u=r[i+6]*t+r[i+6+1]*n-r[i+9];if(u>o)return!1}return!0},e.prototype._dynamicSweep=function(e,t,n,r){var i=e.shapeA,s=e.shapeB,o=i.body,u=s.body,a=o._data,f=u._data,l=f[7]-a[7],c=f[8]-a[8],h=a[20],p=f[20],d=i._data[5]*(h<0?-h:h)+s._data[5]*(p<0?-p:p);if(!r&&l*l+c*c<At.EQUAL_SQ_VEL&&d<At.ZERO_ANG_BIAS){e._data[6]=undefined,e.failed=!0;return}var v=0,m=0,g=e._data,y=At.SWEEP_LIMIT,b=y*.5,w=At.MINIMUM_SWEEP_ADVANCE,E=At.MAX_SWEEP_ITER;for(;;){o._sweepIntegrate(v*t),u._sweepIntegrate(v*t);var S=a[2],x=a[3];i._update(S,x,a[5],a[6],!0),S=f[2],x=f[3],s._update(S,x,f[5],f[6],!0);var T=this._distance(i,s,g)+n,N=g[0],C=g[1],k=N*l+C*c;if(T<y){if(r)break;var L=g[2]-S,A=g[3]-x,O=k-h*(L*C-A*N);O>0&&(e.slipped=!0);if(O<=0||T<b)break}var M=(d-k)*t;if(M<=0){v=-1;break}var _=T/M;_<w&&(_=w),v+=_;if(v>=1){v=-1;break}m+=1;if(m>=E){T>n?e.failed=!0:r&&(v=-1);break}}return g[6]=v,v},e.prototype._staticSweep=function(e,t,n){var r=e.shapeA,i=e.shapeB,s=r.body,o=s._data,u=-o[7],a=-o[8],f=o[20],l=r._data[5]*(f<0?-f:f),c=0,h=0,p=e._data,d=At.SWEEP_LIMIT,v=d*.5,m=At.MINIMUM_SWEEP_ADVANCE,g=At.MAX_SWEEP_ITER;for(;;){s._sweepIntegrate(c*t);var y=o[2],b=o[3];r._update(y,b,o[5],o[6],!0);var w=this._distance(r,i,p)+n,E=p[0],S=p[1],x=E*u+S*a;if(w<d){var T=p[2]-y,N=p[3]-b,C=x-f*(T*S-N*E);C>0&&(e.slipped=!0);if(C<=0||w<v)break}var k=(l-x)*t;if(k<=0){c=-1;break}var L=w/k;L<m&&(L=m),c+=L;if(c>=1){c=-1;break}h+=1;if(h>=g){w>n&&(e.failed=!0);break}}return p[6]=c,c},e.prototype._distance=function(e,t,n){if(e._type===0)return t._type===0?this._distanceCircle2Circle(e,t,n):this._distanceCircle2Polygon(e,t,n);if(t._type===0){var r=this._distanceCircle2Polygon(t,e,n);n[0]=-n[0],n[1]=-n[1];var i=n[2];return n[2]=n[4],n[4]=i,i=n[3],n[3]=n[5],n[5]=i,r}return this._distancePolygon2Polygon(e,t,n)},e.prototype._distanceCircle2Circle=function(e,t,n){var r=e._data,i=t._data,s=r[9],o=r[10],u=i[9],a=i[10],f=r[6],l=i[6],c=u-s,h=a-o,p=f+l,d=Math.sqrt(c*c+h*h);if(d===0)n[0]=c=1,n[1]=h=0;else{var v=1/d;n[0]=c*=v,n[1]=h*=v}return n[2]=s+c*f,n[3]=o+h*f,n[4]=u-c*l,n[5]=a-h*l,d-p},e.prototype._distanceCircle2Polygon=function(e,t,n){var r=e._data,i=t._data,s=r[9],o=r[10],u=r[6],a=Number.NEGATIVE_INFINITY,f,l,c=6,h=i.length;for(;c<h;c+=13){l=i[c+6]*s+i[c+6+1]*o;var p=l-(u+i[c+9]);p>a&&(a=p,f=c)}var d=i[f+6],v=i[f+6+1];l=d*o-v*s;if(l>=i[f+10]){if(l<=i[f+11])return n[0]=-d,n[1]=-v,n[2]=s-=d*u,n[3]=o-=v*u,n[4]=s-d*a,n[5]=o-v*a,a;f+=13,f===h&&(f=6)}var m=i[f+2],g=i[f+2+1],y=m-s,b=g-o,w=Math.sqrt(y*y+b*b);if(w===0)n[0]=y=-d,n[1]=b=-v;else{var E=1/w;n[0]=y*=E,n[1]=b*=E}return n[2]=s+y*u,n[3]=o+b*u,n[4]=m,n[5]=g,w-u},e.prototype._distancePolygon2Polygon=function(e,t,n){var r=Number.POSITIVE_INFINITY,i=e._data,s=t._data,o=i.length,u=s.length,a,f,l,c,h,p,d=-r,v,m;for(a=6;a<o;a+=13){l=r,h=i[a+6],p=i[a+6+1];for(f=6;f<u;f+=13)c=h*s[f+2]+p*s[f+2+1],c<l&&(l=c);l-=i[a+9],l>d&&(d=l,m=a,v=!0)}for(f=6;f<u;f+=13){l=r,h=s[f+6],p=s[f+6+1];for(a=6;a<o;a+=13)c=h*i[a+2]+p*i[a+2+1],c<l&&(l=c);l-=s[f+9],l>d&&(d=l,m=f,v=!1)}var g=v?1:-1,y,b;v?(y=2,b=4):(i=t._data,s=e._data,o=i.length,u=s.length,y=4,b=2),h=i[m+6],p=i[m+6+1],l=r;var w;for(f=6;f<u;f+=13)c=h*s[f+6]+p*s[f+6+1],c<l&&(l=c,w=f);var E=w+13;E===u&&(E=6);var S,x,T,N,C,k,L,A,O,M=s[w+2],_=s[w+2+1],D=s[E+2],P=s[E+2+1],H=l<At.COLLINEAR_EPSILON-1;if(d<0&&H)return n[0]=h*g,n[1]=p*g,S=i[m+2],x=i[m+2+1],O=i[m+12],T=h*(_-x)-p*(M-S),T>=0&&T<=O?(n[b]=S=M,n[b+1]=x=_):(N=h*(P-x)-p*(M-S),N>=0&&N<=O?(n[b]=S=D,n[b+1]=x=P):(T<0?T=-T:T>O&&(T=O-T),n[b]=S=M-p*T,n[b+1]=x=_+h*T)),n[y]=S-h*d,n[y+1]=x-p*d,d;if(d<=0)return n[0]=h*g,n[1]=p*g,T=h*M+p*_,N=h*D+p*P,N<T&&(w=E),n[b]=S=s[w+2],n[b+1]=x=s[w+2+1],n[y]=S-h*d,n[y+1]=x-p*d,d;O=i[m+12];if(H){var B=s[w+12];if(B>O){O=B,E=m,m=w,w=E,E=w+13,E===o&&(E=6),M=i[w+2],_=i[w+2+1],D=i[E+2],P=i[E+2+1],i=s,h*=-1,p*=-1,g*=-1;var j=y;y=b,b=j}}S=i[m+2],x=i[m+2+1],T=-(h*(x-_)-p*(S-M));var F=!0;T<0?(T=0,F=!1):T>O&&(T=O,F=!1),N=-(h*(x-P)-p*(S-D));var I=!0;N<0?(N=0,I=!1):N>O&&(N=O,I=!1),C=M-(S-p*T),k=_-(x+h*T),L=D-(S-p*N),A=P-(x+h*N),T=C*C+k*k,N=L*L+A*A;var q;return T<N?(n[b]=S=M,n[b+1]=x=_,d=Math.sqrt(T),F||d<At.NORMALIZE_EPSILON?(n[0]=h*=g,n[1]=p*=g):(q=g/d,n[0]=h=C*q,n[1]=p=k*q)):(n[b]=S=D,n[b+1]=x=P,d=Math.sqrt(N),I||d<At.NORMALIZE_EPSILON?(n[0]=h*=g,n[1]=p*=g):(q=g/d,n[0]=h=L*q,n[1]=p=A*q)),n[y]=S-h*d*g,n[y+1]=x-p*d*g,d},e.prototype._collide=function(e,t,n){return e._type===0?t._type===0?this._collideCircle2Circle(e,t,n):this._collideCircle2Polygon(e,t,n,!1):t._type===0?this._collideCircle2Polygon(t,e,n,!0):this._collidePolygon2Polygon(e,t,n)},e.prototype._collideCircle2Polygon=function(e,t,n,r){var i=e._data,s=t._data,o=i[9],u=i[10],a=i[6],f=Number.NEGATIVE_INFINITY,l,c,h=6,p=s.length;for(;h<p;h+=13){c=s[h+6]*o+s[h+6+1]*u-(s[h+9]+a);if(c>0)return!1;c>f&&(f=c,l=h)}var d=n._data,v,m,g=s[l+6],y=s[l+6+1],b,w,E,S,x,T;c=g*u-y*o;if(c>=s[l+10]){if(c<=s[l+11])return c=a+f*.5,x=g*c,T=y*c,v=n._injectContact(o-x,u-T,r?g:-g,r?y:-y,f,0),n._faceType=r?1:2,n._reverse=!r,d[11]=s[l+4],d[12]=s[l+4+1],d[13]=s[l+8],d[14]=a,m=v._data,m[13]=i[7],m[14]=i[8],!0;var N=l+13;N===p&&(N=6),b=s[N+2],w=s[N+2+1],E=s[N+0],S=s[N+0+1]}else b=s[l+2],w=s[l+2+1],E=s[l+0],S=s[l+0+1];x=o-b,T=u-w;var C=x*x+T*T;if(C>a*a)return!1;if(C<At.NORMALIZE_SQ_EPSILON)v=n._injectContact(o,u,r?g:-g,r?y:-y,0,0);else{var k=Math.sqrt(C),L=1/k,A=.5+a*L*.5;r||(L=-L),v=n._injectContact(o-x*A,u-T*A,x*L,T*L,k-a,0)}return m=v._data,r?(m[13]=E,m[14]=S,m[15]=i[7],m[16]=i[8]):(m[13]=i[7],m[14]=i[8],m[15]=E,m[16]=S),d[14]=a,n._faceType=0,n._reverse=!1,!0},e.prototype._collidePolygon2Polygon=function(e,t,n){var r=Number.POSITIVE_INFINITY,i=e._data,s=t._data,o=i.length,u=s.length,a,f,l,c,h,p,d=-r,v,m,g;for(a=6;a<o;a+=13){l=r,h=i[a+6],p=i[a+6+1],g=i[a+9];for(f=6;f<u;f+=13){c=h*s[f+2]+p*s[f+2+1],c<l&&(l=c);if(l-g<=d)break}l-=g;if(l>=0)return!1;l>d&&(d=l,m=a,v=!0)}for(f=6;f<u;f+=13){l=r,h=s[f+6],p=s[f+6+1],g=s[f+9];for(a=6;a<o;a+=13){c=h*i[a+2]+p*i[a+2+1],c<l&&(l=c);if(l-g<=d)break}l-=g;if(l>=0)return!1;l>d&&(d=l,m=f,v=!1)}var y=v?1:-1,b;v?b=t.body._data:(i=t._data,s=e._data,o=i.length,u=s.length,b=e.body._data),h=i[m+6],p=i[m+6+1],l=r;var w;for(f=6;f<u;f+=13)c=h*s[f+6]+p*s[f+6+1],c<l&&(l=c,w=f);var E=w+13;E===u&&(E=6);var S=s[w+2],x=s[w+2+1],T=s[E+2],N=s[E+2+1],C=T-S,k=N-x,L=S*p-x*h,A=T*p-N*h,O=1/(A-L),M=(-i[m+11]-L)*O;M>At.CLIP_EPSILON&&(S+=C*M,x+=k*M),M=(-i[m+10]-A)*O,M<-At.CLIP_EPSILON&&(T+=C*M,N+=k*M);var _=n._data;_[11]=i[m+4],_[12]=i[m+4+1],_[13]=i[m+8],_[14]=0,n._faceType=v?1:2,g=i[m+9];var D=S*h+x*p-g,P=T*h+N*p-g,H=b[2],B=b[3],j=b[5],F=b[6];if(D>0&&P>0)return!1;var I=S-H,q=x-B;S-=h*D*.5,x-=p*D*.5;var R=n._injectContact(S,x,h*y,p*y,D,v?1:2,D>0)._data;return R[13]=j*I+F*q,R[14]=j*q-F*I,I=T-H,q=N-B,T-=h*P*.5,N-=p*P*.5,R=n._injectContact(T,N,h*y,p*y,P,v?2:1,P>0)._data,R[13]=j*I+F*q,R[14]=j*q-F*I,n._reverse=!v,!0},e.prototype._collideCircle2Circle=function(e,t,n){var r=e._data,i=t._data,s=r[9],o=r[10],u=r[6],a=i[9]-s,f=i[10]-o,l=u+i[6],c=a*a+f*f;if(c>l*l)return!1;var h;if(c<At.NORMALIZE_SQ_EPSILON)h=n._injectContact(s+a*.5,o+f*.5,1,0,-l,0);else{var p=Math.sqrt(c),d=1/p,v=.5+(u-.5*l)*d;h=n._injectContact(s+a*v,o+f*v,a*d,f*d,p-l,0)}var m=h._data;return m[13]=r[7],m[14]=r[8],m[15]=i[7],m[16]=i[8],m=n._data,m[14]=l,n._faceType=0,!0},e.prototype._test=function(e,t){return e._type===0?t._type===0?this._testCircle2Circle(e,t):this._testCircle2Polygon(e,t):t._type===0?this._testCircle2Polygon(t,e):this._testPolygon2Polygon(e,t)},e.prototype._testCircle2Circle=function(e,t){var n=e._data,r=t._data,i=n[9]-r[9],s=n[10]-r[10],o=n[6]+r[6];return i*i+s*s<=o*o},e.prototype._testCircle2Polygon=function(e,t){var n=e._data,r=t._data,i=n[9],s=n[10],o=n[6],u=Number.NEGATIVE_INFINITY,a,f,l=6,c=r.length;for(;l<c;l+=13){f=r[l+6]*i+r[l+6+1]*s;var h=f-(o+r[l+9]);if(h>0)return!1;h>u&&(u=h,a=l)}f=r[a+6]*s-r[a+6+1]*i;if(f>=r[a+10]){if(f<=r[a+11])return!0;a+=13,a===c&&(a=6)}var p=i-r[a+2],d=s-r[a+2+1];return p*p+d*d<=o*o},e.prototype._testPolygon2Polygon=function(e,t){var n=Number.POSITIVE_INFINITY,r=e._data,i=t._data,s=r.length,o=i.length,u,a,f,l,c,h;for(u=6;u<s;u+=13){f=n,c=r[u+6],h=r[u+6+1];for(a=6;a<o;a+=13)l=c*i[a+2]+h*i[a+2+1],l<f&&(f=l);if(f>r[u+9])return!1}for(a=6;a<o;a+=13){f=n,c=i[a+6],h=i[a+6+1];for(u=6;u<s;u+=13)l=c*r[u+2]+h*r[u+2+1],l<f&&(f=l);if(f>i[a+9])return!1}return!0},e.create=function(){var t=new e;return t._toi=Vt.allocate(),t},e}(),tn=function(){function e(){this.vendor="Turbulenz"}return e.prototype.getDefaultMaterial=function(){return Ot.defaultMaterial},e.prototype.createCircleShape=function(e){return Rt.create(e)},e.prototype.createPolygonShape=function(e){return Ut.create(e,null)},e.prototype.createRigidBody=function(e){return zt.create(e)},e.prototype.createWorld=function(e){return Zt.create(e)},e.prototype.createMaterial=function(e){return Ot.create(e)},e.prototype.createSweepAndPruneBroadphase=function(){return Qt.create()},e.prototype.createBoxTreeBroadphase=function(){return Jt.create()},e.prototype.createCollisionUtils=function(){return en.create()},e.prototype.createPointConstraint=function(e){return It.create(e)},e.prototype.createWeldConstraint=function(e){return Ft.create(e)},e.prototype.createAngleConstraint=function(e){return jt.create(e)},e.prototype.createDistanceConstraint=function(e){return Bt.create(e)},e.prototype.createLineConstraint=function(e){return Ht.create(e)},e.prototype.createMotorConstraint=function(e){return Pt.create(e)},e.prototype.createPulleyConstraint=function(e){return Dt.create(e)},e.prototype.createCustomConstraint=function(e){return _t.create(e)},e.prototype.createRectangleVertices=function(t,n,r,i){var s;r<t&&(s=t,t=r,r=s),i<n&&(s=n,n=i,i=s);var o=new e.prototype.floatArray(2);o[0]=t,o[1]=n;var u=new e.prototype.floatArray(2);u[0]=r,u[1]=n;var a=new e.prototype.floatArray(2);a[0]=r,a[1]=i;var f=new e.prototype.floatArray(2);return f[0]=t,f[1]=i,[o,u,a,f]},e.prototype.createBoxVertices=function(t,n){var r=t*.5,i=n*.5,s=new e.prototype.floatArray(2);s[0]=-r,s[1]=-i;var o=new e.prototype.floatArray(2);o[0]=r,o[1]=-i;var u=new e.prototype.floatArray(2);u[0]=r,u[1]=i;var a=new e.prototype.floatArray(2);return a[0]=-r,a[1]=i,[s,o,u,a]},e.prototype.createRegularPolygonVertices=function(t,n,r){var i=t*.5,s=n*.5,o=[],u=r,a=Math.PI*2/u,f;for(f=0;f<u;f+=1){var l=a*f,c=o[o.length]=new e.prototype.floatArray(2);c[0]=i*Math.cos(l),c[1]=s*Math.sin(l)}return o},e.create=function(){var t=new e;return t},e.version=1,e}();(function(){tn.prototype.floatArray=function(e){if(arguments.length===0)return[];var t,n;if(typeof e=="number")n=new Array(e);else{n=[];for(t=0;t<e.length;t+=1)n[t]=e[t]}return n},tn.prototype.uint16Array=tn.prototype.floatArray;var e,t;typeof Float32Array!="undefined"&&(e=new Float32Array(4),t=Object.prototype.toString.call(e),t==="[object Float32Array]"&&(tn.prototype.floatArray=Float32Array)),typeof Uint16Array!="undefined"&&(e=new Uint16Array(4),t=Object.prototype.toString.call(e),t==="[object Uint16Array]"&&(tn.prototype.uint16Array=Uint16Array))})(),Ot.defaultMaterial=Ot.create();var nn=function(){function e(){}return e.create=function(){var t=new e;return t.indices=[],t.textures=[],t.numSets=0,t.vertexBufferData=new on.floatArray(1024),t.numVertices=0,t},e}(),rn=function(){function e(){}return e.prototype.getTextureRectangle=function(e){e===undefined&&(e=new on.floatArray(4));var t=this.data,n=this._texture;return n?(e[0]=t[12]*n.width,e[1]=t[13]*n.height,e[2]=t[14]*n.width,e[3]=t[15]*n.height):(e[0]=t[12],e[1]=t[13],e[2]=t[14],e[3]=t[15]),e},e.prototype.setTextureRectangle=function(e){var t=this.data,n=this._texture;if(n){var r=1/n.width,i=1/n.height;t[12]=e[0]*r,t[13]=e[1]*i,t[14]=e[2]*r,t[15]=e[3]*i}else t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=e[3]},e.prototype.getColor=function(e){e===undefined&&(e=new on.floatArray(4));var t=this.data;return e[0]=t[8],e[1]=t[9],e[2]=t[10],e[3]=t[11],e},e.prototype.setColor=function(e){var t=this.data;t[8]=e[0],t[9]=e[1],t[10]=e[2],t[11]=e[3]},e.prototype.getTexture=function(){return this._texture},e.prototype.setTexture=function(e){if(this._texture!==e){var t=(this._texture?this._texture.width:1)/(e?e.width:1),n=(this._texture?this._texture.height:1)/(e?e.height:1);this._texture=e||null;var r=this.data;r[12]*=t,r[13]*=n,r[14]*=t,r[15]*=n}},e.prototype.getWidth=function(){return this.data[17]*2},e.prototype.setWidth=function(e){e*=.5;var t=this.data;t[17]!==e&&(t[17]=e,this._invalidate())},e.prototype.getHeight=function(){return this.data[18]*2},e.prototype.setHeight=function(e){e*=.5;var t=this.data;t[18]!==e&&(t[18]=e,this._invalidate())},e.prototype.getScale=function(e){e===undefined&&(e=new on.floatArray(2));var t=this.data;return e[0]=t[19],e[1]=t[20],e},e.prototype.setScale=function(e){var t=e[0],n=e[1],r=this.data;if(r[19]!==t||r[20]!==n)r[19]=t,r[20]=n,this._invalidate()},e.prototype.getShear=function(e){e===undefined&&(e=new on.floatArray(2));var t=this.data;return e[0]=t[21],e[1]=t[22],e},e.prototype.setShear=function(e){var t=e[0],n=e[1],r=this.data;if(r[21]!==t||r[22]!==n)r[21]=t,r[22]=n,this._invalidate()},e.prototype.getOrigin=function(e){e===undefined&&(e=new on.floatArray(2));var t=this.data;return e[0]=t[23],e[1]=t[24],e},e.prototype.setOrigin=function(e){var t=e[0],n=e[1],r=this.data;if(r[23]!==t||r[24]!==n)r[23]=t,r[24]=n,this._invalidate()},e.prototype._invalidate=function(){var e=this.data,t=e[19],n=e[19]*e[21],r=e[20]*e[22],i=e[20],s=e[17]-e[23],o=e[18]-e[24],u=e[25]=t*s+n*o,a=e[26]=r*s+i*o;s=-e[17],o=-e[18];var f=e[27]=t*s+n*o,l=e[28]=r*s+i*o;s=-s;var c=e[29]=t*s+n*o,h=e[30]=r*s+i*o,p=e[16]=this.rotation,d=Math.cos(p),v=Math.sin(p);e[31]=d*u-v*a,e[32]=v*u+d*a,e[33]=d*f-v*l,e[34]=v*f+d*l,e[35]=d*c-v*h,e[36]=v*c+d*h;var m=2*(u*f+a*l);m<0&&(m=-m);var g=f*f+l*l+m;m=2*(u*c+a*h),m<0&&(m=-m);var y=c*c+h*h+m;y>g&&(g=y),g+=u*u+a*a,e[37]=.25/g},e.prototype._update=function(e){var t=this.data,n,r,i,s;n=this.rotation,r=n-t[16],r*r>t[37]*e&&(t[16]=n,i=Math.cos(n),s=Math.sin(n),n=t[25],r=t[26],t[31]=i*n-s*r,t[32]=s*n+i*r,n=t[27],r=t[28],t[33]=i*n-s*r,t[34]=s*n+i*r,n=t[29],r=t[30],t[35]=i*n-s*r,t[36]=s*n+i*r),i=this.x+t[31],s=this.y+t[32],n=t[33],r=t[34],t[0]=i+n,t[1]=s+r,t[6]=i-n,t[7]=s-r,n=t[35],r=t[36],t[2]=i+n,t[3]=s+r,t[4]=i-n,t[5]=s-r},e.create=function(t){if(t.width!==undefined&&t.height!==undefined||!!t.texture){var n=new e,r=n.data=new on.floatArray(38),i=n._texture=t.texture||null;n.x=t.x||0,n.y=t.y||0,n.rotation=r[16]=t.rotation||0;var s=t.color;r[8]=s?s[0]:1,r[9]=s?s[1]:1,r[10]=s?s[2]:1,r[11]=s?s[3]:1;var o=t.textureRectangle,u=i?1/i.width:1,a=i?1/i.height:1;r[12]=o?o[0]*u:0,r[13]=o?o[1]*a:0,r[14]=o?o[2]*u:1,r[15]=o?o[3]*a:1,r[17]=(t.width!==undefined?t.width:i.width)*.5,r[18]=(t.height!==undefined?t.height:i.height)*.5;var f=t.scale;r[19]=f?f[0]:1,r[20]=f?f[1]:1;var l=t.shear;r[21]=l?l[0]:0,r[22]=l?l[1]:0;var c=t.origin;return r[23]=c?c[0]:r[17],r[24]=c?c[1]:r[18],n._invalidate(),n}return null},e.version=1,e}(),sn={setFromRotatedRectangle:function(t,n,r,i,s,o,u){var a=r[0],f=r[1],l=r[2],c=r[3];if(!o)t[0]=a,t[1]=f,t[2]=l,t[3]=f,t[4]=a,t[5]=c,t[6]=l,t[7]=c;else{var h,p;u?(h=a+u[0],p=f+u[1]):(h=.5*(a+l),p=.5*(f+c));var d=a-h,v=f-p,m=Math.cos(o),g=Math.sin(o),y=l-a,b=c-f;t[0]=a=h+(m*d-g*v),t[1]=f=p+(g*d+m*v),t[2]=a+m*y,t[3]=f+g*y,t[4]=a-g*b,t[5]=f+m*b,t[6]=a+(m*y-g*b),t[7]=f+(g*y+m*b)}s?(t[8]=s[0],t[9]=s[1],t[10]=s[2],t[11]=s[3]):t[8]=t[9]=t[10]=t[11]=1;if(i&&n){var w=1/n.width,E=1/n.height;t[12]=i[0]*w,t[13]=i[1]*E,t[14]=i[2]*w,t[15]=i[3]*E}else t[12]=t[13]=0,t[14]=t[15]=1},create:function(){return new on.floatArray(16)}},on=function(){function e(){this.forceUpdate=!1,this.clearBackBuffer=!1,this.defaultClearColor=e.defaultClearColor,this.sort={deferred:"deferred",immediate:"immediate",texture:"texture"},this.scale={scale:"scale",none:"none"},this.blend={additive:"additive",alpha:"alpha",opaque:"opaque"},this.drawStates={uninit:0,ready:1,draw:2}}return e.prototype.clear=function(e){if(this.state!==this.drawStates.ready)return!1;var t=this.graphicsDevice;if(this.currentRenderTarget){if(!t.beginRenderTarget(this.currentRenderTarget.renderTarget))return!1;t.clear(e||this.defaultClearColor),t.endRenderTarget()}else t.clear(e||this.defaultClearColor);return!0},e.prototype.clearBatch=function(){var e=this.texLists;for(var t in e)e.hasOwnProperty(t)&&(e[t]=undefined);this.currentTextureGroup=undefined,this.numGroups=0},e.prototype.bufferSprite=function(e,t,n){t._update(0),n<<=4;var r=t.data;e[n]=r[0],e[n+1]=r[1],e[n+2]=r[2],e[n+3]=r[3],e[n+4]=r[4],e[n+5]=r[5],e[n+6]=r[6],e[n+7]=r[7],e[n+8]=r[8],e[n+9]=r[9],e[n+10]=r[10],e[n+11]=r[11],e[n+12]=r[12],e[n+13]=r[13],e[n+14]=r[14],e[n+15]=r[15]},e.prototype.update=function(){var e=this.graphicsDevice,t=this.width,n=this.height,r=e.width,i=e.height;if(t!==r||n!==i||this.forceUpdate){var s,o,u,a,f=this.viewportRectangle;f?(u=f[0],a=f[1],s=f[2]-u,o=f[3]-a):(u=0,a=0,s=r,o=i),s===r&&o===i?this.clearBackBuffer=!1:this
.clearBackBuffer=!0;var l=this.currentRenderTarget;if(this.scaleMode==="scale"){var c=s/o,h=r/i,p,d,v,m,g,y;h>c?(p=Math.ceil(i/o*s),v=r-p,g=Math.floor(v*.5),this.scissorX=g,this.scissorY=0,this.scissorWidth=p,this.scissorHeight=i,this.viewScaleX=s/p,this.viewScaleY=o/i,l||(this.clipOffsetX=g/r*2-1,this.clipOffsetY=1,this.clipScaleX=p/r*2/s,this.clipScaleY=-2/o)):(d=Math.ceil(r/s*o),m=i-d,y=Math.floor(m*.5),this.scissorX=0,this.scissorY=y,this.scissorWidth=r,this.scissorHeight=d,this.viewScaleX=s/r,this.viewScaleY=o/d,l||(this.clipOffsetX=-1,this.clipOffsetY=1-y/i*2,this.clipScaleX=2/s,this.clipScaleY=d/i*-2/o))}else this.viewScaleX=1,this.viewScaleY=1,l||(this.clipOffsetX=-1,this.clipOffsetY=1,this.clipScaleX=2/r,this.clipScaleY=-2/i),this.scissorX=0,this.scissorY=i-o,this.scissorWidth=s,this.scissorHeight=o;this.spriteAngleFactor=Math.min(this.viewScaleX,this.viewScaleY),this.spriteAngleFactor*=this.spriteAngleFactor,this.width=r,this.height=i;var b=0,w=this.renderTargetStructs,E=w.length;for(b=0;b<E;b+=1)this.validateTarget(w[b],this.scissorWidth,this.scissorHeight);l&&(this.clipOffsetX=-1,this.clipOffsetY=-1,this.clipScaleX=2*l.actualWidth/l.texture.width/s,this.clipScaleY=2*l.actualHeight/l.texture.height/o),this.clipOffsetX-=u*this.clipScaleX,this.clipOffsetY-=a*this.clipScaleY;var S=this.techniqueParameters.clipSpace;S[0]=this.clipScaleX,S[1]=this.clipScaleY,S[2]=this.clipOffsetX,S[3]=this.clipOffsetY,this.updateRenderTargetVbo(this.scissorX,this.scissorY,this.scissorWidth,this.scissorHeight),this.forceUpdate=!1}},e.prototype.getViewport=function(t){t||(t=new e.floatArray(4));var n=this.viewportRectangle;return n?(t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]):(t[0]=t[1]=0,t[2]=this.graphicsDevice.width,t[3]=this.graphicsDevice.height),t},e.prototype.getScreenSpaceViewport=function(t){return t||(t=new e.floatArray(4)),this.update(),t[0]=this.scissorX,t[1]=this.height-(this.scissorY+this.scissorHeight),t[2]=t[0]+this.scissorWidth,t[3]=t[1]+this.scissorHeight,t},e.prototype.viewportMap=function(t,n,r){r||(r=new e.floatArray(2)),this.update();var i=this.height-this.scissorHeight-this.scissorY;r[0]=(t-this.scissorX)*this.viewScaleX,r[1]=(n-i)*this.viewScaleY;var s=this.viewportRectangle;return s&&(r[0]+=s[0],r[1]+=s[1]),r},e.prototype.viewportUnmap=function(t,n,r){r||(r=new e.floatArray(2)),this.update();var i=this.viewportRectangle;i&&(t-=i[0],n-=i[1]);var s=this.height-this.scissorHeight-this.scissorY;return r[0]=t/this.viewScaleX+this.scissorX,r[1]=n/this.viewScaleY+s,r},e.prototype.viewportClamp=function(e){if(e){var t=e[0],n=e[1],r,i,s,o,u=this.viewportRectangle;u?(r=u[0],i=u[1],s=u[2],o=u[3]):(r=0,i=0,s=this.graphicsDevice.width,o=this.graphicsDevice.height),t<r?t=r:t>s&&(t=s),n<i?n=i:n>o&&(n=o),e[0]=t,e[1]=n}return e},e.prototype.configure=function(e){if(this.state!==this.drawStates.ready)return!1;var t="viewportRectangle"in e?e.viewportRectangle:this.viewportRectangle,n=e.scaleMode;if(n!==undefined){if(!(n in this.scale))return!1;if(n==="scale"&&!t)return!1;this.scaleMode=n}return this.viewportRectangle=t,this.forceUpdate=!0,this.update(),!0},e.prototype.destroy=function(){this.texLists=null,this.state=this.drawStates.uninit,this.graphicsDevice=null,this.vertexBuffer&&this.vertexBuffer.destroy(),this.indexBuffer&&this.indexBuffer.destroy(),this.copyVertexBuffer.destroy();var e=this.renderTargetStructs;while(e.length>0){var t=e.pop();t.texture.destroy(),t.renderTarget.destroy(),t.texture=null,t.renderTarget=null}},e.prototype.begin=function(e,t){if(!t||t in this.sort){if(!e||e in this.blend){var n=!this.sortMode;this.dispatch()&&this.clearBatch();if(n){if(this.state!==this.drawStates.ready)return!1;this.update(),this.currentRenderTarget||this.graphicsDevice.setScissor(this.scissorX,this.scissorY,this.scissorWidth,this.scissorHeight)}return this.state=this.drawStates.draw,t=t?t:n?"deferred":this.sortMode,e=e?e:n?"opaque":this.blendMode,n||(this.sortModeStack.push(this.sortMode),this.blendModeStack.push(this.blendMode)),this.sortMode=t,this.blendMode=e,this.prepareSortMode(t),this.graphicsDevice.setTechnique(this.blendModeTechniques[e]),!0}return!1}return!1},e.prototype._bufferSprite=function(t,n){var r=t.vertexBufferData,i=this.vertexBuffer,s=t.numVertices*i.stride,o=s+4*i.stride;if(o>=r.length){var u=this.bufferSizeAlgorithm(o,this.cpuStride),a=new e.floatArray(u),f;for(f=0;f<s;f+=1)a[f]=r[f];t.vertexBufferData=r=a}var l=n[8],c=n[9],h=n[10],p=n[11],d=n[12],v=n[13],m=n[14],g=n[15];r[s]=n[0],r[s+1]=n[1],r[s+2]=l,r[s+3]=c,r[s+4]=h,r[s+5]=p,r[s+6]=d,r[s+7]=v,r[s+8]=n[2],r[s+9]=n[3],r[s+10]=l,r[s+11]=c,r[s+12]=h,r[s+13]=p,r[s+14]=m,r[s+15]=v,r[s+16]=n[4],r[s+17]=n[5],r[s+18]=l,r[s+19]=c,r[s+20]=h,r[s+21]=p,r[s+22]=d,r[s+23]=g,r[s+24]=n[6],r[s+25]=n[7],r[s+26]=l,r[s+27]=c,r[s+28]=h,r[s+29]=p,r[s+30]=m,r[s+31]=g,t.numVertices+=4,t.indices[t.numSets-1]+=6},e.prototype.bufferMultiSprite=function(t,n,r,i){var s=t.vertexBufferData,o=this.vertexBuffer,u=r===undefined?Math.floor(n.length/16):r;r=u*16,i=(i!==undefined?i:0)*16;var a,f=t.numVertices*o.stride,l=f+u*4*o.stride;if(l>=s.length){var c=this.bufferSizeAlgorithm(l,this.cpuStride),h=new e.floatArray(c);for(a=0;a<f;a+=1)h[a]=s[a];t.vertexBufferData=s=h}var p=i+r;for(a=i;a<p;a+=16){var d=n[a+8],v=n[a+9],m=n[a+10],g=n[a+11],y=n[a+12],b=n[a+13],w=n[a+14],E=n[a+15];s[f]=n[a],s[f+1]=n[a+1],s[f+2]=d,s[f+3]=v,s[f+4]=m,s[f+5]=g,s[f+6]=y,s[f+7]=b,s[f+8]=n[a+2],s[f+9]=n[a+3],s[f+10]=d,s[f+11]=v,s[f+12]=m,s[f+13]=g,s[f+14]=w,s[f+15]=b,s[f+16]=n[a+4],s[f+17]=n[a+5],s[f+18]=d,s[f+19]=v,s[f+20]=m,s[f+21]=g,s[f+22]=y,s[f+23]=E,s[f+24]=n[a+6],s[f+25]=n[a+7],s[f+26]=d,s[f+27]=v,s[f+28]=m,s[f+29]=g,s[f+30]=w,s[f+31]=E,f+=32}t.numVertices+=u*4,t.indices[t.numSets-1]+=u*6},e.prototype.indexData=function(t){var n=new e.uint16Array(t),r,i=0;for(r=0;r<t;r+=6)n[r]=i,n[r+1]=i+1,n[r+2]=i+2,n[r+3]=i+1,n[r+4]=i+2,n[r+5]=i+3,i+=4;return n},e.prototype.uploadBuffer=function(e,t,n){var r=this.vertexBuffer,i=this.vertexBufferParameters,s=this.graphicsDevice,o=e.vertexBufferData,u=this.performanceData;if(t>i.numVertices){var a=this.bufferSizeAlgorithm(t,this.gpuStride);a>this.maxVertices&&(a=this.maxVertices),i.numVertices=a,this.vertexBuffer.destroy(),this.vertexBuffer=r=s.createVertexBuffer(i),u.gpuMemoryUsage=a*35,a*=1.5;var f=this.indexBufferParameters;f.data=this.indexData(a),f.numIndices=a,this.indexBuffer.destroy(),this.indexBuffer=s.createIndexBuffer(f),f.data=null,s.setIndexBuffer(this.indexBuffer)}u.dataTransfers+=1;if(n===0)r.setData(o,0,t);else{var l=r.stride;r.setData(o.subarray(n*l,(n+t)*l),0,t)}},e.prototype.drawRawImmediate=function(e,t,n,r){var i=this.drawGroups[0];i.textures[0]=e||this.defaultTexture,i.indices[0]=0,i.numSets=1,this.numGroups=1,this.bufferMultiSprite(i,t,n,r),this.dispatch()},e.prototype.drawSpriteImmediate=function(e){var t=this.drawGroups[0];t.textures[0]=e._texture||this.defaultTexture,t.indices[0]=0,t.numSets=1,this.numGroups=1,e._update(this.spriteAngleFactor),this._bufferSprite(t,e.data),this.dispatch()},e.prototype.drawImmediate=function(e){var t=e.texture||this.defaultTexture,n=e.destinationRectangle,r=e.sourceRectangle,i=e.color,s=e.rotation,o=this.drawGroups[0];o.textures[0]=t,o.indices[0]=0,o.numSets=1,this.numGroups=1;var u=this.drawSprite;sn.setFromRotatedRectangle(u,t,n,r,i,s,e.origin),this._bufferSprite(o,u),this.dispatch()},e.prototype.drawRawDeferred=function(e,t,n,r){e=e||this.defaultTexture;var i=this.drawGroups[0];this.numGroups=1;var s=i.numSets;if(s===0||i.textures[s-1]!==e)i.textures[s]=e,i.indices[s]=0,i.numSets+=1;this.bufferMultiSprite(i,t,n,r)},e.prototype.drawSpriteDeferred=function(e){var t=e._texture||this.defaultTexture,n=this.drawGroups[0];this.numGroups=1;var r=n.numSets;if(r===0||n.textures[r-1]!==t)n.textures[r]=t,n.indices[r]=0,n.numSets+=1;e._update(this.spriteAngleFactor),this._bufferSprite(n,e.data)},e.prototype.drawDeferred=function(e){var t=e.texture||this.defaultTexture,n=this.drawGroups[0];this.numGroups=1;var r=n.numSets;if(r===0||n.textures[r-1]!==t)n.textures[r]=t,n.indices[r]=0,n.numSets+=1;var i=e.destinationRectangle,s=e.sourceRectangle,o=e.color,u=e.rotation,a=this.drawSprite;sn.setFromRotatedRectangle(a,t,i,s,o,u,e.origin),this._bufferSprite(n,a)},e.prototype.drawRawTextured=function(e,t,n,r){e=e||this.defaultTexture;var i;if(this.currentTextureGroup!==undefined&&this.currentTextureGroup.textures[0]===e)i=this.currentTextureGroup;else{var s=e.name,o=this.texLists;i=o[s],i||(i=this.drawGroups[this.numGroups],i||(i=nn.create()),this.drawGroups[this.numGroups]=o[s]=i,i.textures[0]=e,i.indices[0]=0,i.numSets=1,this.numGroups+=1),this.currentTextureGroup=i}this.bufferMultiSprite(i,t,n,r)},e.prototype.drawSpriteTextured=function(e){var t=e._texture||this.defaultTexture,n;if(this.currentTextureGroup!==undefined&&this.currentTextureGroup.textures[0]===t)n=this.currentTextureGroup;else{var r=t.name,i=this.texLists;n=i[r],n||(n=this.drawGroups[this.numGroups],n||(n=nn.create()),this.drawGroups[this.numGroups]=i[r]=n,n.textures[0]=t,n.indices[0]=0,n.numSets=1,this.numGroups+=1),this.currentTextureGroup=n}e._update(this.spriteAngleFactor),this._bufferSprite(n,e.data)},e.prototype.drawTextured=function(e){var t=e.texture||this.defaultTexture,n;if(this.currentTextureGroup!==undefined&&this.currentTextureGroup.textures[0]===t)n=this.currentTextureGroup;else{var r=t.name,i=this.texLists;n=i[r],n||(n=this.drawGroups[this.numGroups],n||(n=nn.create()),this.drawGroups[this.numGroups]=i[r]=n,n.textures[0]=t,n.indices[0]=0,n.numSets=1,this.numGroups+=1),this.currentTextureGroup=n}var s=e.destinationRectangle,o=e.sourceRectangle,u=e.color,a=e.rotation,f=this.drawSprite;sn.setFromRotatedRectangle(f,t,s,o,u,a,e.origin),this._bufferSprite(n,f)},e.prototype.prepareSortMode=function(e){e==="deferred"?(this.draw=this.drawDeferred,this.drawSprite=this.drawSpriteDeferred,this.drawRaw=this.drawRawDeferred):e==="immediate"?(this.draw=this.drawImmediate,this.drawSprite=this.drawSpriteImmediate,this.drawRaw=this.drawRawImmediate):(this.draw=this.drawTextured,this.drawSprite=this.drawSpriteTextured,this.drawRaw=this.drawRawTextured)},e.prototype.end=function(){return this.state!==this.drawStates.draw?!1:(this.dispatch()&&this.clearBatch(),this.blendModeStack.length!==0?(this.blendMode=this.blendModeStack.pop(),this.sortMode=this.sortModeStack.pop(),this.prepareSortMode(this.sortMode),this.graphicsDevice.setTechnique(this.blendModeTechniques[this.blendMode])):(this.blendMode=undefined,this.sortMode=undefined,this.state=this.drawStates.ready),!0)},e.prototype.dispatch=function(){var e=this.numGroups;if(e===0)return!1;var t=this.graphicsDevice,n=this.techniqueParameters;t.setIndexBuffer(this.indexBuffer);var r=this.drawGroups,i=!1;this.currentRenderTarget&&(i=t.beginRenderTarget(this.currentRenderTarget.renderTarget));var s=this.performanceData,o;for(o=0;o<e;o+=1){var u=r[o],a=u.textures,f=u.indices,l=0,c=0,h=u.numVertices;while(c<h){var p=h-c;p>this.maxVertices&&(p=this.maxVertices),this.uploadBuffer(u,p,c),t.setStream(this.vertexBuffer,this.semantics);var d=p*1.5,v=0;while(v<d){n.texture=a[l];var m=d-v;m>=f[l]?(m=f[l],l+=1):f[l]-=m;var g=m/6;s.batchCount===0?(s.minBatchSize=g,s.maxBatchSize=g,s.avgBatchSize=g,s.batchCount=1):(g<s.minBatchSize&&(s.minBatchSize=g),g>s.maxBatchSize&&(s.maxBatchSize=g),s.avgBatchSize*=s.batchCount,s.avgBatchSize+=g,s.batchCount+=1,s.avgBatchSize/=s.batchCount),t.setTechniqueParameters(n),t.drawIndexed(t.PRIMITIVE_TRIANGLES,m,v),v+=m}c+=p}u.numSets=0,u.numVertices=0}return this.currentRenderTarget&&i&&t.endRenderTarget(),!0},e.prototype.bufferSizeAlgorithm=function(e,t){var n=1.25,r=Math.ceil(Math.log(e)/Math.log(n)),i=Math.floor(Math.pow(n,r));return t*Math.ceil(i/t)},e.prototype.updateRenderTargetVbo=function(e,t,n,r){var i=this.graphicsDevice,s=.5*i.width,o=.5*i.height,u=this.copyVertexBuffer,a=(e-s)/s,f=(e+n-s)/s,l=(t-o)/o,c=(t+r-o)/o,h=this.vertexBufferData;h[0]=a,h[1]=c,h[2]=0,h[3]=1,h[4]=a,h[5]=l,h[6]=0,h[7]=0,h[8]=f,h[9]=c,h[10]=1,h[11]=1,h[12]=f,h[13]=l,h[14]=1,h[15]=0,u.setData(h,0,4)},e.makePow2=function(e){var t=Math.log(e)/Math.log(2);return 1<<Math.ceil(t)},e.prototype.createRenderTarget=function(t){var n=this.graphicsDevice,r=this.renderTargetStructs,i=r.length,s=t&&t.name?t.name:"RenderTarget#"+i,o=t&&t.backBuffer!==undefined?t.backBuffer:!0,u=t.width===undefined||t.height===undefined,a=this.renderTargetTextureParameters;a.name=s;var f=u?n.width:t.width,l=u?n.height:t.height,c=e.makePow2;a.width=c(f),a.height=c(l);var h=n.createTexture(a),p=this.renderTargetParams;p.colorTexture0=h;var d=n.createRenderTarget(p);return r.push({managed:u,renderTarget:d,texture:h,backBuffer:o,actualWidth:o?f:h.width,actualHeight:o?l:h.height}),i},e.prototype.validateTarget=function(t,n,r){if(t.managed){var i=t.texture;t.backBuffer&&(t.actualWidth=n,t.actualHeight=r);var s=e.makePow2;n=s(n),r=s(r),t.backBuffer||(t.actualWidth=n,t.actualHeight=r);if(i.width!==n||i.height!==r){var o=this.renderTargetTextureParameters,u=this.renderTargetParams;o.name=i.name,o.width=n,o.height=r,i.destroy(),t.renderTarget.destroy();var a=this.graphicsDevice;t.texture=a.createTexture(o),u.colorTexture0=t.texture,t.renderTarget=a.createRenderTarget(u)}}},e.prototype.setBackBuffer=function(){return this.state!==this.drawStates.ready?!1:(this.currentRenderTarget=null,this.forceUpdate=!0,!0)},e.prototype.getRenderTargetTexture=function(e){var t=this.renderTargetStructs;return e<0||e>=t.length?null:t[e].texture},e.prototype.getRenderTarget=function(e){var t=this.renderTargetStructs;return e<0||e>=t.length?null:t[e].renderTarget},e.prototype.setRenderTarget=function(e){var t=this.renderTargetStructs;return e<0||e>=t.length?!1:this.state!==this.drawStates.ready?!1:(this.currentRenderTarget=t[e],this.forceUpdate=!0,!0)},e.prototype.copyRenderTarget=function(e){if(this.state!==this.drawStates.ready)return!1;var t=this.renderTargetStructs;if(e<0||e>=t.length)return!1;this.update(),this.currentRenderTarget||this.graphicsDevice.setScissor(this.scissorX,this.scissorY,this.scissorWidth,this.scissorHeight);var n=this.graphicsDevice,r=t[e],i=r.texture,s=this.copyTechnique,o=this.copyTechniqueParameters,u=o.copyUVScale;u[0]=r.actualWidth/i.width,u[1]=r.actualHeight/i.height,o.copyFlip=this.currentRenderTarget?1:-1,o.inputTexture0=i;var a=!1,f=this.currentRenderTarget,l=this.copyVertexBuffer;return f&&(a=n.beginRenderTarget(f.renderTarget)),n.setTechnique(s),n.setTechniqueParameters(o),n.setStream(l,this.quadSemantics),n.draw(this.quadPrimitive,4,0),f&&a&&n.endRenderTarget(),!0},e.prototype.resetPerformanceData=function(){var e=this.performanceData;e.minBatchSize=e.maxBatchSize=e.avgBatchSize=undefined,e.batchCount=0,e.dataTransfers=0},e.create=function(t){var n=new e,r=n.graphicsDevice=t.graphicsDevice;n.sortMode=undefined,n.blendMode=undefined,n.sortModeStack=[],n.blendModeStack=[],n.drawGroups=[nn.create()],n.numGroups=0,n.texLists={},n.texGroup=undefined,n.drawSprite=sn.create(),n.defaultTexture=r.createTexture({name:"DefaultDraw2DTexture",width:1,height:1,depth:1,format:"L8",cubemap:!1,mipmaps:!0,renderable:!1,dynamic:!1,data:[255]}),n.draw=undefined,n.drawSprite=undefined,n.drawRaw=undefined;var i=r.createShader({version:1,name:"draw2D.cgfx",samplers:{texture:{MinFilter:9985,MagFilter:9729,WrapS:33071,WrapT:33071},inputTexture0:{MinFilter:9728,MagFilter:9729,WrapS:33071,WrapT:33071}},parameters:{clipSpace:{type:"float",columns:4},copyUVScale:{type:"float",columns:2},copyFlip:{type:"float"},texture:{type:"sampler2D"},inputTexture0:{type:"sampler2D"}},techniques:{opaque:[{parameters:["clipSpace","texture"],semantics:["POSITION","COLOR","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_draw2D","fp_draw2D"]}],alpha:[{parameters:["clipSpace","texture"],semantics:["POSITION","COLOR","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[770,771]},programs:["vp_draw2D","fp_draw2D"]}],additive:[{parameters:["clipSpace","texture"],semantics:["POSITION","COLOR","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[770,1]},programs:["vp_draw2D","fp_draw2D"]}],copy:[{parameters:["copyUVScale","copyFlip","inputTexture0"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_copy","fp_copy"]}]},programs:{fp_copy:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nvec4 _ret_0;uniform sampler2D inputTexture0;void main()\n{_ret_0=texture2D(inputTexture0,tz_TexCoord[0].xy);gl_FragColor=_ret_0;}"},vp_copy:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nvec4 _OutPosition1;vec2 _OutUV1;uniform vec2 copyUVScale;uniform float copyFlip;void main()\n{_OutPosition1.x=ATTR0.x;_OutPosition1.y=ATTR0.y*copyFlip;_OutPosition1.zw=ATTR0.zw;_OutUV1=ATTR8.xy*copyUVScale;tz_TexCoord[0].xy=_OutUV1;gl_Position=_OutPosition1;}"},fp_draw2D:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying TZ_LOWP vec4 tz_Color;varying vec4 tz_TexCoord[1];\nvec4 _ret_0;vec4 _TMP0;uniform sampler2D texture;void main()\n{_TMP0=texture2D(texture,tz_TexCoord[0].xy);_ret_0=tz_Color*_TMP0;gl_FragColor=_ret_0;}"},vp_draw2D:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying TZ_LOWP vec4 tz_Color;varying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR3;attribute vec4 ATTR8;\nvec4 _OUTPosition1;vec4 _OUTColor1;vec2 _OUTTexCoord01;uniform vec4 clipSpace;void main()\n{vec2 _position;_position=ATTR0.xy*clipSpace.xy+clipSpace.zw;_OUTPosition1.x=_position.x;_OUTPosition1.y=_position.y;_OUTPosition1.z=0.0;_OUTPosition1.w=1.0;_OUTColor1=ATTR3;_OUTTexCoord01=ATTR8.xy;tz_TexCoord[0].xy=ATTR8.xy;tz_Color=ATTR3;gl_Position=_OUTPosition1;}"}}});n.blendModeTechniques={additive:i.getTechnique("additive"),alpha:i.getTechnique("alpha"),opaque:i.getTechnique("opaque")};if(t.blendModes)for(var s in t.blendModes)t.blendModes.hasOwnProperty(s)&&(n.blend[s]=s,n.blendModeTechniques[s]=t.blendModes[s]);n.techniqueParameters=r.createTechniqueParameters({clipSpace:new e.floatArray(4),texture:null}),n.currentRenderTarget=null,n.renderTargetStructs=[],n.state=n.drawStates.ready,n.scaleMode="none",n.blendMode="opaque",n.width=0,n.height=0,n.scissorX=0,n.scissorY=0,n.scissorWidth=n.graphicsDevice.width,n.scissorHeight=n.graphicsDevice.height,n.clipOffsetX=-1,n.clipOffsetY=1,n.clipScaleX=2/n.graphicsDevice.width,n.clipScaleY=-2/n.graphicsDevice.height,n.viewScaleX=1,n.viewScaleY=1;var o=t.initialGpuMemory?t.initialGpuMemory:0;o<140&&(o=140),o>2293760&&(o=2293760),n.performanceData={gpuMemoryUsage:o,minBatchSize:0,maxBatchSize:0,avgBatchSize:0,batchCount:0,dataTransfers:0},n.maxGpuMemory=t.maxGpuMemory?t.maxGpuMemory:2293760,n.maxGpuMemory<o&&(n.maxGpuMemory=o);var u=Math.floor(o/140)*4;return n.maxVertices=Math.floor(n.maxGpuMemory/140)*4,n.maxVertices>65536&&(n.maxVertices=65536),n.cpuStride=64,n.gpuStride=4,n.vertexBufferParameters={numVertices:u,attributes:[r.VERTEXFORMAT_FLOAT2,r.VERTEXFORMAT_FLOAT4,r.VERTEXFORMAT_FLOAT2],"transient":!0},n.vertexBuffer=r.createVertexBuffer(n.vertexBufferParameters),n.semantics=r.createSemantics([r.SEMANTIC_POSITION,r.SEMANTIC_COLOR,r.SEMANTIC_TEXCOORD0]),n.indexBufferParameters={numIndices:u*1.5,format:r.INDEXFORMAT_USHORT,dynamic:!1,data:n.indexData(u*1.5)},n.indexBuffer=r.createIndexBuffer(n.indexBufferParameters),n.indexBufferParameters.data=null,n.renderTargetIndex=0,n.renderTargetCount=0,n.renderTargetTextureParameters={name:"",width:0,height:0,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,renderable:!0,dynamic:!0},n.renderTargetParams={colorTexture0:null},n.copyTechnique=i.getTechnique("copy"),n.copyTechniqueParameters=r.createTechniqueParameters({inputTexture0:null,copyFlip:1,copyUVScale:new e.floatArray([1,1])}),n.quadSemantics=r.createSemantics([r.SEMANTIC_POSITION,r.SEMANTIC_TEXCOORD0]),n.quadPrimitive=r.PRIMITIVE_TRIANGLE_STRIP,n.copyVertexBufferParams={numVertices:4,attributes:[r.VERTEXFORMAT_FLOAT2,r.VERTEXFORMAT_FLOAT2],"transient":!0},n.copyVertexBuffer=r.createVertexBuffer(n.copyVertexBufferParams),n.vertexBufferData=new e.floatArray([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]),n},e.version=7,e.defaultClearColor=[0,0,0,1],e}();(function(){on.uint16Array=function(e){if(arguments.length===0)return[];var t,n;if(typeof e=="number")n=new Array(e);else{n=[];for(t=0;t<e.length;t+=1)n[t]=e[t]}return n};var e,t;typeof Uint16Array!="undefined"&&(e=new Uint16Array(4),t=Object.prototype.toString.call(e),t==="[object Uint16Array]"&&(on.uint16Array=Uint16Array)),on.floatArray=function(e){if(arguments.length===0)return[];var t,n;if(typeof e=="number")n=new Array(e);else{n=[];for(t=0;t<e.length;t+=1)n[t]=e[t]}return n},typeof Float32Array!="undefined"&&(e=new Float32Array(4),t=Object.prototype.toString.call(e),t==="[object Float32Array]"&&(on.floatArray=Float32Array,on.defaultClearColor=new Float32Array(on.defaultClearColor)))})();var un=function(){function e(e,t,n){this.escapeNodeOffset=t,this.externalNode=n,this.extents=e}return e.prototype.isLeaf=function(){return!!this.externalNode},e.prototype.reset=function(e,t,n,r,i,s){this.escapeNodeOffset=i,this.externalNode=s;var o=this.extents;o[0]=e,o[1]=t,o[2]=n,o[3]=r},e.prototype.clear=function(){this.escapeNodeOffset=1,this.externalNode=undefined;var e=this.extents,t=Number.MAX_VALUE;e[0]=t,e[1]=t,e[2]=-t,e[3]=-t},e.create=function(t,n,r){return new e(t,n,r)},e.version=1,e}(),an=function(){function e(e){this.numNodesLeaf=4,this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.highQuality=e}return e.prototype.add=function(e,t){var n=this.endNode;e.boxTreeIndex=n;var r=new this.arrayConstructor(4);r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],this.nodes[n]=un.create(r,1,e),this.endNode=n+1,this.needsRebuild=!0,this.numAdds+=1,this.numExternalNodes+=1},e.prototype.remove=function(e){var t=e.boxTreeIndex;if(t!==undefined){if(this.numExternalNodes>1){var n=this.nodes;n[t].clear();var r=this.endNode;if(t+1>=r){while(!n[r-1].externalNode)r-=1;this.endNode=r}else this.needsRebuild=!0;this.numExternalNodes-=1}else this.clear();e.boxTreeIndex=undefined}},e.prototype.findParent=function(e){var t=this.nodes,n=e,r=0,i;do n-=1,r+=1,i=t[n];while(i.escapeNodeOffset<=r);return i},e.prototype.update=function(e,t){var n=e.boxTreeIndex;if(n!==undefined){var r=t[0],i=t[1],s=t[2],o=t[3],u=this.needsRebuild,a=this.needsRebound,f=this.nodes,l=f[n],c=l.extents,h=u||a||c[0]>r||c[1]>i||c[2]<s||c[3]<o;c[0]=r,c[1]=i,c[2]=s,c[3]=o;if(h&&!u&&1<f.length){this.numUpdates+=1,this.startUpdate>n&&(this.startUpdate=n),this.endUpdate<n&&(this.endUpdate=n);if(!a)if(2*this.numUpdates>this.numExternalNodes)this.needsRebound=!0;else{var p=this.findParent(n),d=p.extents;if(d[0]>r||d[1]>i||d[2]<s||d[3]<o)this.needsRebound=!0}else this.numUpdates>3*this.numExternalNodes&&(this.needsRebuild=!0,this.numAdds=this.numUpdates)}}else this.add(e,t)},e.prototype.needsFinalize=function(){return this.needsRebuild||this.needsRebound},e.prototype.finalize=function(){this.needsRebuild?this.rebuild():this.needsRebound&&this.rebound()},e.prototype.rebound=function(){var e=this.nodes;if(e.length>1){var t=this.startUpdate,n=this.endUpdate,r=[],i=0,s=0;for(;;){var o=e[s],u=s,a=s+o.escapeNodeOffset,f=s+1,l;do{l=e[f];var c=f+l.escapeNodeOffset;if(!(f<n))break;l.externalNode||c>t&&(r[i]=s,i+=1,s=f),f=c}while(f<a);if(s===u){f=s+1,l=e[f];var h=l.extents,p=h[0],d=h[1],v=h[2],m=h[3];f+=l.escapeNodeOffset;while(f<a)l=e[f],h=l.extents,p>h[0]&&(p=h[0]),d>h[1]&&(d=h[1]),v<h[2]&&(v=h[2]),m<h[3]&&(m=h[3]),f+=l.escapeNodeOffset;h=o.extents,h[0]=p,h[1]=d,h[2]=v,h[3]=m,n=s;if(!(0<i))break;i-=1,s=r[i]}}}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype.rebuild=function(){if(this.numExternalNodes>0){var e=this.nodes,t,n,r;if(this.numExternalNodes===e.length)t=e,n=e.length,e=[],this.nodes=e;else{t=[],t.length=this.numExternalNodes,n=0,r=this.endNode;for(var i=0;i<r;i+=1){var s=e[i];s.externalNode&&(e[i]=undefined,t[n]=s,n+=1)}t.length>n&&(t.length=n)}if(n>1)n>this.numNodesLeaf&&this.numAdds>0&&(this.highQuality?this.sortNodesHighQuality(t):this.sortNodes(t)),this.recursiveBuild(t,0,n,0),r=e[0].escapeNodeOffset,e.length>r&&(e.length=r),this.endNode=r;else{var o=t[0];o.externalNode.boxTreeIndex=0,e.length=1,e[0]=o,this.endNode=1}t=null}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype.sortNodes=function(e){var t=this.numNodesLeaf,n=e.length,r=function(t){var n=t.extents;return n[0]+n[2]},i=function(t){var n=t.extents;return n[1]+n[3]},s=function(t){var n=t.extents;return-(n[0]+n[2])},o=function(t){var n=t.extents;return-(n[1]+n[3])},u=this.nthElement,a=!1,f=0,l=function(n,c,h){var p=c+h>>1;f===0?a?u(n,c,p,h,s):u(n,c,p,h,r):a?u(n,c,p,h,o):u(n,c,p,h,i),f===0?f=2:f===2?f=1:f=0,a=!a,c+t<p&&l(n,c,p),p+t<h&&l(n,p,h)};l(e,0,n)},e.prototype.sortNodesHighQuality=function(e){var t=this.numNodesLeaf,n=e.length,r=function(t){var n=t.extents;return n[0]+n[2]},i=function(t){var n=t.extents;return n[1]+n[3]},s=function(t){var n=t.extents;return n[0]+n[1]+n[2]+n[3]},o=function(t){var n=t.extents;return n[0]-n[1]+n[2]-n[3]},u=function(t){var n=t.extents;return-(n[0]+n[2])},a=function(t){var n=t.extents;return-(n[1]+n[3])},f=function(t){var n=t.extents;return-(n[0]+n[1]+n[2]+n[3])},l=function(t){var n=t.extents;return-(n[0]-n[1]+n[2]-n[3])},c=this.nthElement,h=this.calculateSAH,p=!1,d=function(n,v,m){var g=v+m>>1;c(n,v,g,m,r);var y=h(n,v,g)+h(n,g,m);c(n,v,g,m,i);var b=h(n,v,g)+h(n,g,m);c(n,v,g,m,s);var w=h(n,v,g)+h(n,g,m);c(n,v,g,m,o);var E=h(n,v,g)+h(n,g,m);y<=b&&y<=w&&y<=E?p?c(n,v,g,m,u):c(n,v,g,m,r):b<=w&&b<=E?p?c(n,v,g,m,a):c(n,v,g,m,i):w<=E?p?c(n,v,g,m,f):c(n,v,g,m,s):p?c(n,v,g,m,l):c(n,v,g,m,o),p=!p,v+t<g&&d(n,v,g),g+t<m&&d(n,g,m)};d(e,0,n)},e.prototype.calculateSAH=function(e,t,n){var r,i,s,o,u,a;r=e[t],i=r.extents,s=i[0],o=i[1],u=i[2],a=i[3];for(var f=t+1;f<n;f+=1)r=e[f],i=r.extents,s>i[0]&&(s=i[0]),o>i[1]&&(o=i[1]),u<i[2]&&(u=i[2]),a<i[3]&&(a=i[3]);return u-s+(a-o)},e.prototype.nthElement=function(e,t,n,r,i){function s(e,t,n){return e<t?t<n?t:e<n?n:e:e<n?e:t<n?n:t}function o(e,t,n,r){var i=t+1;while(i!==n){var s=e[i],o=r(s),u=i,a=i-1;while(u!==t&&o<r(e[a]))e[u]=e[a],u-=1,a-=1;u!==i&&(e[u]=s),i+=1}}while(r-t>8){var u=s(i(e[t]),i(e[t+(r-t>>1)]),i(e[r-1])),a=t,f=r,l;for(;;a+=1){while(i(e[a])<u)a+=1;do f-=1;while(u<i(e[f]));if(a>=f){l=a;break}var c=e[a];e[a]=e[f],e[f]=c}l<=n?t=l:r=l}o(e,t,r,i)},e.prototype.recursiveBuild=function(e,t,n,r){var i=this.nodes,s=r;r+=1;var o,u,a,f,l,c,h;if(t+this.numNodesLeaf>=n){c=e[t],l=c.extents,o=l[0],u=l[1],a=l[2],f=l[3],c.externalNode.boxTreeIndex=r,i[r]=c;for(var p=t+1;p<n;p+=1)c=e[p],l=c.extents,o>l[0]&&(o=l[0]),u>l[1]&&(u=l[1]),a<l[2]&&(a=l[2]),f<l[3]&&(f=l[3]),r+=1,c.externalNode.boxTreeIndex=r,i[r]=c;h=i[r]}else{var d=t+n>>1;t+1>=d?(c=e[t],c.externalNode.boxTreeIndex=r,i[r]=c):this.recursiveBuild(e,t,d,r),h=i[r],l=h.extents,o=l[0],u=l[1],a=l[2],f=l[3],r+=h.escapeNodeOffset,d+1>=n?(c=e[d],c.externalNode.boxTreeIndex=r,i[r]=c):this.recursiveBuild(e,d,n,r),h=i[r],l=h.extents,o>l[0]&&(o=l[0]),u>l[1]&&(u=l[1]),a<l[2]&&(a=l[2]),f<l[3]&&(f=l[3])}var v=i[s];if(v!==undefined)v.reset(o,u,a,f,r+h.escapeNodeOffset-s);else{var m=new this.arrayConstructor(4);m[0]=o,m[1]=u,m[2]=a,m[3]=f,i[s]=un.create(m,r+h.escapeNodeOffset-s)}},e.prototype.getVisibleNodes=function(e,t){if(this.numExternalNodes>0){var n=this.nodes,r=this.endNode,i=e.length,s=t.length,o,u,a,f,l,c,h,p,d,v,m,g,y=0;for(;;){o=n[y],u=o.extents,f=u[0],l=u[1],c=u[2],h=u[3],p=!0,d=0;do{v=e[d],m=v[0],g=v[1];if(m*(m<0?f:c)+g*(g<0?l:h)<v[2]){p=!1;break}d+=1}while(d<i);if(p)if(o.externalNode){t[s]=o.externalNode,s+=1,y+=1;if(y>=r)break}else{p=!0,d=0;do{v=e[d],m=v[0],g=v[1];if(m*(m>0?f:c)+g*(g>0?l:h)<v[2]){p=!1;break}d+=1}while(d<i);if(p){a=y+o.escapeNodeOffset,y+=1;do o=n[y],o.externalNode&&(t[s]=o.externalNode,s+=1),y+=1;while(y<a);if(y>=r)break}else y+=1}else{y+=o.escapeNodeOffset;if(y>=r)break}}}},e.prototype.getOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=e[0],i=e[1],s=e[2],o=e[3],u=this.nodes,a=this.endNode,f,l,c,h=0,p=n===undefined?t.length:n,d=0;for(;;){f=u[d],l=f.extents;var v=l[0],m=l[1],g=l[2],y=l[3];if(r<=g&&i<=y&&s>=v&&o>=m)if(f.externalNode){t[p]=f.externalNode,p+=1,h+=1,d+=1;if(d>=a)break}else if(s>=g&&o>=y&&r<=v&&i<=m){c=d+f.escapeNodeOffset,d+=1;do f=u[d],f.externalNode&&(t[p]=f.externalNode,p+=1,h+=1),d+=1;while(d<c);if(d>=a)break}else d+=1;else{d+=f.escapeNodeOffset;if(d>=a)break}}return h}return 0},e.prototype.getCircleOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=t*t,i=e[0],s=e[1],o=this.nodes,u=this.endNode,a,f,l=n.length,c=0;for(;;){a=o[c],f=a.extents;var h=f[0],p=f[1],d=f[2],v=f[3],m=0,g;i<h?(g=h-i,m+=g*g):i>d&&(g=i-d,m+=g*g),s<p?(g=p-s,m+=g*g):s>v&&(g=s-v,m+=g*g);if(m<=r){c+=1;if(a.externalNode){n[l]=a.externalNode,l+=1;if(c>=u)break}}else{c+=a.escapeNodeOffset;if(c>=u)break}}}},e.prototype.getOverlappingPairs=function(e,t){if(this.numExternalNodes>0){var n=this.nodes,r=this.endNode,i,s,o,u,a=0,f=t===undefined?e.length:t,l=0,c;for(;;){i=n[l];while(!i.externalNode)l+=1,i=n[l];l+=1;if(!(l<r))break;s=i.externalNode,u=i.extents;var h=u[0],p=u[1],d=u[2],v=u[3];c=l;for(;;){o=n[c],u=o.extents;if(h<=u[2]&&p<=u[3]&&d>=u[0]&&v>=u[1]){c+=1;if(o.externalNode){e[f]=s,e[f+1]=o.externalNode,f+=2,a+=2;if(c>=r)break}}else{c+=o.escapeNodeOffset;if(c>=r)break}}}return a}return 0},e.prototype.getRootNode=function(){return this.nodes[0]},e.prototype.getNodes=function(){return this.nodes},e.prototype.getEndNodeIndex=function(){return this.endNode},e.prototype.clear=function(){this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.rayTest=function(e,t,n){var r=t.origin,i=t.direction,s=r[0],o=r[1],u=i[0],a=i[1],f=1/u,l=1/a,c=function(t,n){var r=t[0],i=t[1],c=t[2],h=t[3];if(r<=s&&s<=c&&i<=o&&o<=h)return 0;var p,d,v,m,g;return u>=0?(g=r-s,p=g===0?0:g*f,g=c-s,d=g===0?0:g*f):(p=(c-s)*f,d=(r-s)*f),a>=0?(g=i-o,v=g===0?0:g*l,g=h-o,m=g===0?0:g*l):(v=(h-o)*l,m=(i-o)*l),p>m||v>d?undefined:(v>p&&(p=v),m<d&&(d=m),p<0&&(p=d),0<=p&&p<n?p:undefined)},h=[],p=null,d=function(r,i,s){var o=r.getNodes(),u=o[i],a=c(u.extents,s);if(a===undefined)return s;if(u.externalNode){var f=n(r,u.externalNode,t,a,s);f&&(p=f,s=f.factor)}else{var l=h.length,d;for(d=0;d<l;d+=1){var v=h[d];if(a>v.distance)break}h.splice(d-1,0,{tree:r,nodeIndex:i,distance:a})}return s},v=t.maxFactor,m,g;for(g=0;g<e.length;g+=1)m=e[g],m.endNode!==0&&(v=d(m,0,v));while(h.length!==0){var y=h.pop();if(y.distance>=v)continue;var b=y.nodeIndex;m=y.tree;var w=m.getNodes(),E=w[b],S=b+E.escapeNodeOffset,x=b+1;do v=d(m,x,v),x+=w[x].escapeNodeOffset;while(x<S)}return p},e.create=function(t){return new e(t)},e.version=1,e}();(function(){an.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(an.prototype.arrayConstructor=Float32Array)}})();var fn=function(){function e(){}return e.prototype.setPhysics2DViewport=function(e){if(e){var t=this._physics2DPort;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this._physics2DPortEnabled=!0}else this._physics2DPortEnabled=!1;this._invalidated=!0},e.prototype.setScreenViewport=function(e){if(e){var t=this._screenPort;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this._screenPortEnabled=!0}else this._screenPortEnabled=!1;this._invalidated=!0},e.prototype.drawLine=function(e,t,n,r,i){var s=this._numVertices,o=s*6,u=this._numLines*2;this._prepare(2,1);var a=this._vertexData;a[o]=e,a[o+1]=t,a[o+6]=n,a[o+7]=r,a[o+2]=a[o+8]=i[0],a[o+3]=a[o+9]=i[1],a[o+4]=a[o+10]=i[2],a[o+5]=a[o+11]=i[3],a=this._indexData,a[u]=s,a[u+1]=s+1},e.prototype.drawLinearSpring=function(e,t,n,r,i,s,o){if(i<=0){this.drawLine(e,t,n,r,o);return}var u=n-e,a=r-t,f=u*u+a*a,l=this.minSpringLength*this.screenToPhysics2D;if(f<l*l){this.drawLine(e,t,n,r,o);return}var c=-a,h=u,p=2*s/Math.sqrt(c*c+h*h);c*=p,h*=p;var d=1/(i*4);u*=d,a*=d;var v;for(v=0;v<i;v+=1)n=e+u*2,r=t+a*2,this.drawCurve(e,t,e+u+c,t+a+h,n,r,o),e=n,t=r,n=e+u*2,r=t+a*2,this.drawCurve
(e,t,e+u-c,t+a-h,n,r,o),e=n,t=r},e.prototype._drawAngleIndicator=function(e,t,n,r,i,s){var o=Math.cos(n),u=Math.sin(n);this._drawAnchor(e+r*o,t+r*u,i,s)},e.prototype._drawAnchor=function(e,t,n,r){this.drawCircle(e,t,n,r),this.drawCircle(e,t,n*.75,r),this.drawCircle(e,t,n*.5,r),this.drawCircle(e,t,n*.25,r)},e.prototype.drawSpiral=function(e,t,n,r,i,s,o){if(n>r){var u=n;n=r,r=u,u=i,i=s,s=u}if(n===r)return;var a=s-i,f=r-n,l=Math.ceil(f/this.spiralMaxArc),c=a/l,h=f/l,p=Math.cos(h),d=Math.sin(h),v=Math.cos(n),m=Math.sin(n),g=i,y=e+i*v,b=t+i*m,w=a*v-g*f*m,E=a*m+g*f*v,S;for(S=0;S<l;S+=1){var x=g+c,T=p*v-d*m,N=d*v+p*m,C=e+x*T,k=t+x*N,L=a*T-x*f*N,A=a*N+x*f*T,O=w*A-E*L;if(O*O<this.spiralEpsilon)this.drawLine(y,b,C,k,o);else{var M=((C-y)*A+(b-k)*L)/O;M<=0?this.drawLine(y,b,C,k,o):this.drawCurve(y,b,y+w*M,b+E*M,C,k,o)}g=x,v=T,m=N,w=L,E=A,y=C,b=k}},e.prototype.drawSpiralSpring=function(e,t,n,r,i,s,o,u){if(n>r){var a=n;n=r,r=a,a=i,i=s,s=a}if(n===r)return;var f=s-i,l=r-n,c=Math.max(Math.ceil(l/(this.spiralMaxArc*3)),40*o),h=l/c,p=1/c,d=Math.cos(h),v=Math.sin(h),m=this.spiralSpringSize,g=Math.abs(2*Math.PI*f/l),y=m*g,b=2*o*Math.PI,w=y*b,E=Math.cos(n),S=Math.sin(n),x=i,T=e+x*E,N=t+x*S,C=f+w,k=C*E-x*l*S,L=C*S+x*l*E,A;for(A=0;A<c;A+=1){var O=(A+1)*p,M=d*E-v*S,_=v*E+d*S;x=i+f*O+y*Math.sin(b*O);var D=e+x*M,P=t+x*_;C=f+w*Math.cos(b*O);var H=C*M-x*l*_,B=C*_+x*l*M,j=k*B-L*H,F=k*H+L*B;j*j<this.spiralEpsilon||F<0||F>1-this.spiralEpsilon?this.drawLine(T,N,D,P,u):(O=((D-T)*B+(N-P)*H)/j,O<=0?this.drawLine(T,N,D,P,u):this.drawCurve(T,N,T+k*O,N+L*O,D,P,u)),E=M,S=_,k=H,L=B,T=D,N=P}},e.prototype.drawCurve=function(e,t,n,r,i,s,o){var u=o[0],a=o[1],f=o[2],l=o[3],c=this._curveStack,h=this._curveVerts;c.push(e,t,n,r,i,s);while(c.length>0){s=c.pop(),i=c.pop(),r=c.pop(),n=c.pop(),t=c.pop(),e=c.pop();var p=.25*(e+2*n+i),d=.25*(t+2*r+s),v=.5*(e+i),m=.5*(t+s),g=p-v,y=d-m,b=this.curveMaxError*this.screenToPhysics2D;if(g*g+y*y<b*b)h.push(e,t);else{var w=.5*(e+n),E=.5*(t+r),S=.5*(i+n),x=.5*(s+r),T=.5*(w+S),N=.5*(E+x);c.push(T,N,S,x,i,s),c.push(e,t,w,E,T,N)}}h.push(i,s);var C=h.length>>1,k=this._numVertices,L=k*6,A=this._numLines*2;this._prepare(C,C-1);var O=this._vertexData,M=this._indexData,_,D=0;for(_=0;_<C;_+=1)O[L]=h[D],O[L+1]=h[D+1],O[L+2]=u,O[L+3]=a,O[L+4]=f,O[L+5]=l,D+=2,L+=6,_>0&&(M[A]=k+_-1,M[A+1]=k+_,A+=2);h.length=0},e.prototype.drawRectangle=function(e,t,n,r,i){var s=this._numVertices,o=s*6,u=this._numLines*2;this._prepare(4,4);var a=this._vertexData,f=this._indexData;a[o]=a[o+18]=e,a[o+1]=a[o+7]=t,a[o+6]=a[o+12]=n,a[o+13]=a[o+19]=r,a[o+2]=a[o+8]=a[o+14]=a[o+20]=i[0],a[o+3]=a[o+9]=a[o+15]=a[o+21]=i[1],a[o+4]=a[o+10]=a[o+16]=a[o+22]=i[2],a[o+5]=a[o+11]=a[o+17]=a[o+23]=i[3],f[u]=f[u+7]=s,f[u+1]=f[u+2]=s+1,f[u+3]=f[u+4]=s+2,f[u+5]=f[u+6]=s+3},e.prototype.drawCircle=function(e,t,n,r){var i=r[0],s=r[1],o=r[2],u=r[3],a=this.circleMaxError,f=n*this.physics2DToScreen,l;f<a/2?l=3:(l=Math.ceil(Math.PI/Math.acos(1-a/f)),l<3&&(l=3));var c=this._numVertices,h=c*6,p=this._numLines*2;this._prepare(l,l);var d=n,v=0,m=Math.PI*2/l,g=Math.cos(m),y=Math.sin(m),b=this._vertexData,w=this._indexData,E;for(E=0;E<l;E+=1){var S=d*g-v*y;v=d*y+v*g,d=S,b[h]=e+d,b[h+1]=t+v,b[h+2]=i,b[h+3]=s,b[h+4]=o,b[h+5]=u,h+=6,w[p]=c+E,w[p+1]=c+(E+1)%l,p+=2}},e.prototype.drawRigidBody=function(e){e._update();var t=e.shapes,n=t.length,r;for(r=0;r<n;r+=1)this._drawShape(t[r]);if(this.showBodyDetail){var i=e._data;this.drawCircle(i[2],i[3],this.screenToPhysics2D*this.bodyPositionRadius,this.bodyDetailColor),this.drawLine(i[15],i[16],i[2],i[3],this.bodyDetailColor)}},e.prototype.drawConstraint=function(e){e._draw&&e._draw(this,e._stiff)},e.prototype.drawWorld=function(e){var t,n;if(this.showRigidBodies){var r=e.rigidBodies;n=r.length;for(t=0;t<n;t+=1){var i=r[t];this.drawRigidBody(i)}}this.showContacts&&(this._drawArbiters(e.dynamicArbiters),this._drawArbiters(e.staticArbiters));if(this.showConstraints){var s=e.constraints;n=s.length;for(t=0;t<n;t+=1){var o=s[t];o._active&&this.drawConstraint(o)}}},e.prototype._drawArbiters=function(e){var t=this.screenToPhysics2D*this.contactRadius,n=this.screenToPhysics2D*this.contactImpulseScale,r=e.length,i;for(i=0;i<r;i+=1){var s=e[i];if(!s.active)continue;var o=s._static?this.staticContactColor:this.dynamicContactColor,u,a;if(s.sensor)u=0,a=0;else{var f=s._data;u=f[4],a=f[5]}var l=s._contact1._data,c=l[0],h=l[1];this.drawCircle(c,h,t,o);var p,d;this.showContactImpulses&&!s._contact1.virtual&&(p=l[11]*n,d=l[12]*n,this.drawLine(c,h,c+u*p,h+a*p,this.normalImpulseColor),this.drawLine(c,h,c-a*d,h+u*d,this.frictionImpulseColor));if(s._position2Contact){var v=s._contact2._data,m=v[0],g=v[1];this.showContactImpulses&&!s._contact2.virtual&&(p=v[11]*n,d=v[12]*n,this.drawLine(m,g,m+u*p,g+a*p,this.normalImpulseColor),this.drawLine(m,g,m-a*d,g+u*d,this.frictionImpulseColor)),u*=t,a*=t,this.drawCircle(m,g,t,o),this.drawLine(c+u,h+a,m+u,g+a,o),this.drawLine(c-u,h-a,m-u,g-a,o)}}},e.prototype._drawShape=function(e){var t=e.body;if(e.sensor&&!this.showSensorsShapes||!e.sensor&&!this.showColliderShapes)return;var n=this._colors[e.body._type|(t.sleeping?4:0)|(e.sensor?8:0)|(t._bullet?16:0)];e._type===0?this._drawCircleShape(e,n):this._drawPolygonShape(e,n);if(this.showShapeDetail){var r=e._data;this.drawRectangle(r[0],r[1],r[2],r[3],this.shapeDetailColor)}},e.prototype._drawCircleShape=function(e,t){var n=e.body._data,r=e._data,i=r[9],s=r[10],o=r[6];this.drawCircle(i,s,o,t);if(e.body._type!==2){var u=n[5],a=n[6];this.drawLine(i+o*.333*u,s+o*.333*a,i+o*u,s+o*a,t)}this.showShapeDetail&&this.drawCircle(r[9],r[10],this.screenToPhysics2D*this.circleOriginRadius,this.shapeDetailColor)},e.prototype._drawPolygonShape=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=this._numVertices,u=o*6,a=this._numLines*2,f=e._data,l=6,c=f.length,h=(c-l)/13;this._prepare(h,h);var p=this._vertexData,d=this._indexData,v;for(v=0;l<c;l+=13,v+=1)p[u]=f[l+2],p[u+1]=f[l+2+1],p[u+2]=n,p[u+3]=r,p[u+4]=i,p[u+5]=s,u+=6,d[a]=o+v,d[a+1]=o+(v+1)%h,a+=2},e.prototype.begin=function(){var e=this._graphicsDevice,t=e.width,n=e.height,r,i,s,o,u;this._screenPortEnabled?(u=this._screenPort,r=u[0],i=u[1],s=u[2]-r,o=u[3]-i):(r=0,i=0,s=t,o=n);if(t!==this._width||n!==this._height||this._invalidated){this._width=t,this._height=n,this._invalidated=!1;var a,f,l,c;this._physics2DPortEnabled?(u=this._physics2DPort,a=u[0],f=u[1],l=u[2]-a,c=u[3]-f):(a=0,f=0,l=t/60,c=n/60);var h=this._techniqueParams.clipSpace;h[0]=2*s/(t*l),h[1]=-(2*o)/(n*c),h[2]=-(2*a*s)/(t*l)+2*r/t-1,h[3]=2*f*o/(n*c)-2*i/n+1;var p=h[0]*.5*t,d=-(h[1]*.5*n);this.physics2DToScreen=.5*(p+d),this.screenToPhysics2D=1/this.physics2DToScreen}e.setScissor(r,n-i-o,s,o),e.setTechnique(this._technique),e.setTechniqueParameters(this._techniqueParams)},e.prototype.end=function(){this._dispatch()},e.prototype._prepare=function(e,t){var n,r,i,s=this._numVertices*6,o=s+e*6,u=this._vertexData;if(o>u.length){n=this._bufferSizeAlgorithm(o),r=this._vertexData=new tn.prototype.floatArray(n);for(i=0;i<s;i+=1)r[i]=u[i]}this._numVertices+=e,s=this._numLines*2,o=s+t*2,u=this._indexData;if(o>u.length){n=this._bufferSizeAlgorithm(o),r=this._indexData=new tn.prototype.uint16Array(n);for(i=0;i<s;i+=1)r[i]=u[i]}this._numLines+=t},e.prototype._bufferSizeAlgorithm=function(e){var t=1.25,n=Math.ceil(Math.log(e)/Math.log(t)),r=Math.floor(Math.pow(t,n));return 6*Math.ceil(r/6)},e.prototype._dispatch=function(){var e=this._graphicsDevice,t=this._vertexBuffer,n=this._vertexBufferParameters,r=this._vertexData,i=this._indexBuffer,s=this._indexBufferParameters,o=this._indexData,u=this._numVertices;if(u===0)return;var a;u>n.numVertices&&(a=this._bufferSizeAlgorithm(u),n.numVertices=a,this._vertexBuffer.destroy(),this._vertexBuffer=t=e.createVertexBuffer(n)),t.setData(r,0,u),u=this._numLines*2,u>s.numIndices&&(a=this._bufferSizeAlgorithm(u),s.numIndices=a,this._indexBuffer.destroy(),this._indexBuffer=i=e.createIndexBuffer(s)),i.setData(o,0,u),e.setStream(t,this._semantics),e.setIndexBuffer(i),e.drawIndexed(e.PRIMITIVE_LINES,u),this._numVertices=0,this._numLines=0},e.prototype.destroy=function(){this._graphicsDevice=null,this._curveStack.length=0,this._curveVerts.length=0,this._colors.length=0,this._vertexBuffer.destroy(),this._indexBuffer.destroy()},e.create=function(t){var n=new e,r=n._graphicsDevice=t.graphicsDevice;n._screenPort=new tn.prototype.floatArray(4),n._screenPortEnabled=!1,n._physics2DPort=new tn.prototype.floatArray(4),n._physics2DPortEnabled=!1,n._invalidated=!0,n.physics2DToScreen=0,n.screenToPhysics2D=0,n.circleMaxError=.4,n.curveMaxError=.6,n.spiralMaxArc=Math.PI/4,n.spiralEpsilon=1e-5,n.spiralSpringSize=.75,n._curveStack=[],n._curveVerts=[],n.minSpringLength=.5;var i=function(t,n,r,i){var s=new tn.prototype.floatArray(4);return s[0]=t,s[1]=n,s[2]=r,s[3]=i,s},s=i(1,1,1,1),o=i(1,.5,.5,1),u=i(.9,.7,.7,.6),a=i(.8,.3,.8,1),f=i(.8,.4,.8,.6),l=i(.5,1,.5,1),c=i(.7,.9,.7,.6),h=i(.5,1,.5,.5),p=i(.7,.9,.7,.4),d=i(.8,.4,.8,.5),v=i(.8,.5,.8,.4);n.showConstraints=!0,n.constraintAnchorRadius=3,n.constraintSpringRadius=3,n.constraintSpringNumCoils=3,n.constraintSpiralMinRadius=10,n.constraintSpiralDeltaRadius=2.5/Math.PI,n.constraintSpiralNumCoils=4,n.constraintColorA=i(1,0,0,.8),n.constraintSleepingColorA=i(.7,.2,.2,.6),n.constraintColorB=i(0,0,1,.8),n.constraintSleepingColorB=i(.2,.2,.7,.6),n.constraintColorC=i(0,1,0,.8),n.constraintSleepingColorC=i(.2,.7,.2,.6),n.constraintColorD=i(1,0,1,.8),n.constraintSleepingColorD=i(.7,.2,.7,.6),n.constraintErrorColorA=i(1,1,.5,.8),n.constraintErrorSleepingColorA=i(.7,.7,.5,.6),n.constraintErrorColorB=i(.5,1,1,.8),n.constraintErrorSleepingColorB=i(.5,.7,.7,.6),n.constraintErrorColorC=i(.4,1,.4,.8),n.constraintErrorSleepingColorC=i(.4,.7,.4,.6),n.constraintErrorColorD=i(1,.4,1,.8),n.constraintErrorSleepingColorD=i(.7,.4,.7,.6),n.showContacts=!1,n.showContactImpulses=!1,n.contactRadius=3,n.contactImpulseScale=30,n.dynamicContactColor=i(1,0,.5,.7),n.staticContactColor=i(.5,0,1,.7),n.normalImpulseColor=i(1,0,0,1),n.frictionImpulseColor=i(0,0,1,1),n.showRigidBodies=!0,n.showColliderShapes=!0,n.showSensorsShapes=!0,n.showBodyDetail=!1,n.showShapeDetail=!1,n.bodyPositionRadius=.5,n.circleOriginRadius=.5,n.bodyDetailColor=i(0,1,1,.5),n.shapeDetailColor=i(1,1,0,.5);var m=n._colors=[];m[6]=o,m[14]=u,m[0]=l,m[8]=c,m[4]=h,m[12]=p,m[16]=s,m[1]=a,m[9]=f,m[5]=d,m[13]=v;var g=r.createShader({version:1,name:"lines.cgfx",parameters:{clipSpace:{type:"float",columns:4}},techniques:{alpha:[{parameters:["clipSpace"],semantics:["POSITION","COLOR"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[770,771]},programs:["vp_draw2dlines","fp_draw2dlines"]}]},programs:{fp_draw2dlines:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying TZ_LOWP vec4 tz_Color;\nvoid main()\n{gl_FragColor=tz_Color;}"},vp_draw2dlines:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying TZ_LOWP vec4 tz_Color;attribute vec4 ATTR3;attribute vec4 ATTR0;\nvec4 _outpos1;vec4 _outcol1;uniform vec4 clipSpace;void main()\n{vec2 _TMP1;_TMP1=ATTR0.xy*clipSpace.xy+clipSpace.zw;_outpos1=vec4(_TMP1.x,_TMP1.y,0.0,1.0);_outcol1=ATTR3;tz_Color=ATTR3;gl_Position=_outpos1;}"}}});n._techniqueParams=r.createTechniqueParameters({clipSpace:new tn.prototype.floatArray(4)}),n._technique=g.getTechnique("alpha");var y=4,b=4;return n._vertexBufferParameters={numVertices:y,attributes:[r.VERTEXFORMAT_FLOAT2,r.VERTEXFORMAT_FLOAT4],"transient":!0},n._vertexBuffer=r.createVertexBuffer(n._vertexBufferParameters),n._semantics=r.createSemantics([r.SEMANTIC_POSITION,r.SEMANTIC_COLOR]),n._indexBufferParameters={numIndices:b,format:r.INDEXFORMAT_USHORT,"transient":!0},n._indexBuffer=r.createIndexBuffer(n._indexBufferParameters),n._vertexData=new tn.prototype.floatArray(60),n._indexData=new tn.prototype.uint16Array(60),n._numVertices=0,n._numLines=0,n},e.version=1,e}();Dt.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintSleepingColorC:t.constraintColorC,s=this.sleeping?t.constraintSleepingColorD:t.constraintColorD,o=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,u=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB,a=this.sleeping?t.constraintErrorSleepingColorC:t.constraintErrorColorC,f=this.sleeping?t.constraintErrorSleepingColorD:t.constraintErrorColorD,l=this._data,c=this.bodyA._data,h=this.bodyB._data,p=this.bodyC._data,d=this.bodyD._data,v=c[2]+l[19],m=c[3]+l[20],g=h[2]+l[21],y=h[3]+l[22],b=p[2]+l[23],w=p[3]+l[24],E=d[2]+l[25],S=d[3]+l[26],x=g-v,T=y-m,N=E-b,C=S-w,k=Math.sqrt(x*x+T*T),L=Math.sqrt(N*N+C*C),A=l[7];this._drawLink(t,v,m,g,y,x,T,k,L*A,1,o,u),this._drawLink(t,b,w,E,S,N,C,L,k,1/A,a,f);var O=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(v,m,O,n),t._drawAnchor(g,y,O,r),t._drawAnchor(b,w,O,i),t._drawAnchor(E,S,O,s)},Dt.prototype._drawLink=function(t,n,r,i,s,o,u,a,f,l,c,h){if(a>At.NORMALIZE_EPSILON){var p=1/a;o*=p,u*=p;var d=.5*(n+i),v=.5*(r+s),m=this._data,g=(m[5]-f)*l;g<0&&(g=0);var y=(m[6]-f)*l;y<0&&(y=0);var b=d-o*g*.5,w=v-u*g*.5,E=d+o*g*.5,S=v+u*g*.5,x=d-o*y*.5,T=v-u*y*.5,N=d+o*y*.5,C=v+u*y*.5;t.drawLine(b,w,E,S,c),t.drawLine(x,T,b,w,h),t.drawLine(N,C,E,S,h);if(!this._stiff){var k=t.constraintSpringNumCoils,L=t.constraintSpringRadius*t.screenToPhysics2D;a>y?(t.drawLinearSpring(x,T,n,r,k,L,h),t.drawLinearSpring(N,C,i,s,k,L,h)):a<g&&(t.drawLinearSpring(b,w,n,r,k,L,c),t.drawLinearSpring(E,S,i,s,k,L,c))}}},Ht.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,s=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB,o=this.sleeping?t.constraintErrorSleepingColorC:t.constraintErrorColorC,u=this._data,a=this.bodyA._data,f=this.bodyB._data,l=a[2]+u[13],c=a[3]+u[14],h=f[2]+u[15],p=f[3]+u[16],d=u[17],v=u[18],m=u[5],g=u[6];m===Number.NEGATIVE_INFINITY&&(m=-1e20),g===Number.POSITIVE_INFINITY&&(g=1e20);var y=h-l,b=p-c,w=y*d+b*v,E=l+d*m,S=c+v*m,x=l+d*g,T=c+v*g,N;w>m&&(N=Math.min(w,g),t.drawLine(E,S,l+d*N,c+v*N,i)),w<g&&(N=Math.max(w,m),t.drawLine(x,T,l+d*N,c+v*N,s));if(!this._stiff){var C=w<m?E:w>g?x:l+d*w,k=w<m?S:w>g?T:c+v*w,L=t.constraintSpringNumCoils,A=t.constraintSpringRadius*t.screenToPhysics2D;t.drawLinearSpring(C,k,h,p,L,A,o)}var O=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(l,c,O,n),t._drawAnchor(h,p,O,r)},Bt.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,s=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB,o=this._data,u=this.bodyA._data,a=this.bodyB._data,f=u[2]+o[11],l=u[3]+o[12],c=a[2]+o[13],h=a[3]+o[14],p=c-f,d=h-l,v=p*p+d*d;if(v>At.NORMALIZE_SQ_EPSILON){var m=Math.sqrt(v),g=1/m;p*=g,d*=g;var y=.5*(f+c),b=.5*(l+h),w=o[5],E=o[6],S=y-p*w*.5,x=b-d*w*.5,T=y+p*w*.5,N=b+d*w*.5,C=y-p*E*.5,k=b-d*E*.5,L=y+p*E*.5,A=b+d*E*.5;t.drawLine(S,x,T,N,i),t.drawLine(C,k,S,x,s),t.drawLine(L,A,T,N,s);if(!this._stiff){var O=t.constraintSpringNumCoils,M=t.constraintSpringRadius*t.screenToPhysics2D;m>E?(t.drawLinearSpring(C,k,f,l,O,M,s),t.drawLinearSpring(L,A,c,h,O,M,s)):m<w&&(t.drawLinearSpring(S,x,f,l,O,M,i),t.drawLinearSpring(T,N,c,h,O,M,i))}}var _=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(f,l,_,n),t._drawAnchor(c,h,_,r)},jt.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,s=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB,o=this._data,u=this.bodyA._data,a=this.bodyB._data,f=o[7];this._drawForBody(t,u,a,f,-1,i,s,n),this._drawForBody(t,a,u,1/f,1/f,i,s,r)},jt.prototype._drawForBody=function(t,n,r,i,s,o,u,a){var f=this._data,l=f[5],c=f[6],h=r[4]*i+l*s,p=r[4]*i+c*s;if(h>p){var d=h;h=p,p=d}var v=t.constraintSpiralMinRadius*t.screenToPhysics2D,m=t.constraintSpiralDeltaRadius*t.screenToPhysics2D,g=t.constraintAnchorRadius*t.screenToPhysics2D,y=t.constraintSpiralNumCoils,b=n[2],w=n[3],E=n[4],S;E>h?(S=Math.min(E,p),t.drawSpiral(b,w,h,S,v,v+(S-h)*m,o)):!this._stiff&&E<h&&t.drawSpiralSpring(b,w,E,h,v+(E-h)*m,v,y,o),E<p?(S=Math.max(E,h),t.drawSpiral(b,w,S,p,v+(S-h)*m,v+(p-h)*m,u)):!this._stiff&&E>p&&t.drawSpiralSpring(b,w,E,p,v+(E-h)*m,v+(p-h)*m,y,u),t._drawAngleIndicator(b,w,E,v+(E-h)*m,g,a)},Ft.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorC:t.constraintErrorColorC,s=this._data,o=this.bodyA._data,u=this.bodyB._data,a=o[2]+s[9],f=o[3]+s[10],l=u[2]+s[11],c=u[3]+s[12],h=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(a,f,h,n),t._drawAnchor(l,c,h,r);if(this._stiff)t.drawLine(a,f,l,c,i);else{var p=t.constraintSpringNumCoils,d=t.constraintSpringRadius*t.screenToPhysics2D;t.drawLinearSpring(a,f,l,c,p,d,i);var v=t.constraintSpiralMinRadius*t.screenToPhysics2D,m=t.constraintSpiralDeltaRadius*t.screenToPhysics2D,g=t.constraintAnchorRadius*t.screenToPhysics2D;p=t.constraintSpiralNumCoils;var y,b;b=o[4],y=u[4]-s[13];var w=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,E=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB;t.drawSpiralSpring(o[2],o[3],b,y,v,v+(y-b)*m,p,E),t._drawAngleIndicator(o[2],o[3],b,v,g,w),b=u[4],y=s[13]+o[4],t.drawSpiralSpring(u[2],u[3],b,y,v,v+(y-b)*m,p,w),t._drawAngleIndicator(u[2],u[3],b,v,g,E)}},It.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorC:t.constraintErrorColorC,s=this._data,o=this.bodyA._data,u=this.bodyB._data,a=o[2]+s[9],f=o[3]+s[10],l=u[2]+s[11],c=u[3]+s[12],h=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(a,f,h,n),t._drawAnchor(l,c,h,r);if(this._stiff)t.drawLine(a,f,l,c,i);else{var p=t.constraintSpringNumCoils,d=t.constraintSpringRadius*t.screenToPhysics2D;t.drawLinearSpring(a,f,l,c,p,d,i)}};var ln=function(){function e(e,t){this.gd=e,this.fm=t,this.bold=!1,this.italic=!1,this.pageWidth=0,this.pageHeight=0,this.baseline=0,this.glyphs=null,this.numGlyphs=0,this.minGlyphIndex=0,this.lineHeight=0,this.pages=null,this.kernings=null,this.texture=null}return e.prototype.calculateTextDimensions=function(e,t,n){var r=this.glyphs,i=this.lineHeight*t,s=0,o=0,u=0,a=0,f=[],l=e.length,c=0,h,p,d;for(var v=0;v<l;v+=1)h=e.charCodeAt(v),h===10?(c&&(c-=n),f[a]=c,a+=1,s<c&&(s=c),c=0,o+=i):(p=r[h],p&&(d=p.awidth,d?(c+=d*t+n,u+=1):c+=n));return f[a]=c,s<c&&(s=c),o+=i,{width:s,height:o,numGlyphs:u,linesWidth:f}},e.prototype.generateTextVertices=function(e,t){var n=t.rect,r=t.alignment,i=t.scale||1,s=t.spacing?t.spacing*i:0,o=this.calculateTextDimensions(e,i,s),u=o.numGlyphs;if(0>=u)return null;var a=o.linesWidth,f=this.lineHeight*i,l=this.kernings,c=this.glyphs,h=this.fm,p=h.reusableArrays,d=p[u];if(d)p[u]=null;else{var v=u*4;d=new h.float32ArrayConstructor(v*4)}var m=0,g,y,b,w,E,S,x,T,N,C,k,L=a[0],A=n[0],O=n[2],M=n[1],_=A;1===r?_+=(O-L)*.5:2===r&&(_+=O-L);var D=e.length,P=0,H;for(H=0;H<D;H+=1){g=e.charCodeAt(H);if(g===10)M+=f,P+=1,L=a[P],_=A,1===r?_+=(O-L)*.5:2===r&&(_+=O-L);else{y=c[g];if(y){x=y.awidth*i;if(x){b=_+y.xoffset*i,w=M+y.yoffset*i,E=b+y.width*i,S=w+y.height*i,T=y.left,N=y.top,C=y.right,k=y.bottom,d[m+0]=b,d[m+1]=w,d[m+2]=T,d[m+3]=N,d[m+4]=E,d[m+5]=w,d[m+6]=C,d[m+7]=N,d[m+8]=E,d[m+9]=S,d[m+10]=C,d[m+11]=k,d[m+12]=b,d[m+13]=S,d[m+14]=T,d[m+15]=k,m+=16,u-=1;if(0===u)break;_+=x+s;if(l){var B=l[g];if(B&&H<D-1){var j=B[e.charCodeAt(H+1)];j&&(_+=j*i)}}}else _+=s}}}return d},e.prototype.drawTextRect=function(e,t){var n=this.generateTextVertices(e,t);n&&this.drawTextVertices(n,!0)},e.prototype.drawTextVertices=function(e,t){var n=e.length>>4,r=this.gd,i=this.fm;t&&(i.reusableArrays[n]=e);var s=n*4,o=i.sharedVertexBuffer;if(!o||s>o.numVertices)o&&o.destroy(),o=this.createVertexBuffer(n),i.sharedVertexBuffer=o;o.setData(e,0,s),r.setStream(o,i.semantics);var u=i.techniqueParameters;u.texture=this.texture,r.setTechniqueParameters(u);if(4<s){var a=n*6,f=i.sharedIndexBuffer;if(!f||a>f.numIndices)f&&f.destroy(),f=this.createIndexBuffer(n),i.sharedIndexBuffer=f;r.setIndexBuffer(f),r.drawIndexed(i.primitive,a,0)}else r.draw(i.primitiveFan,4,0)},e.prototype.createIndexBuffer=function(e){var t=this.gd,n={numIndices:6*e,format:"USHORT"},r=t.createIndexBuffer(n),i=r.map();if(i){var s,o,u,a;for(var f=0;f<e;f+=1)s=4*f,o=s+1,u=s+2,a=s+3,i(s,o,u),i(u,a,s);r.unmap(i)}return r},e.prototype.createVertexBuffer=function(e){var t=this.gd;return t.createVertexBuffer({numVertices:4*e,attributes:[t.VERTEXFORMAT_FLOAT2,t.VERTEXFORMAT_FLOAT2],dynamic:!0,"transient":!0})},e.version=1,e}(),cn=function(){function e(){}return e.prototype.get=function(e){return undefined},e.create=function(t,n,r,i,s){i||(i=function(){});var o={},u={},a={},f={},c=0,h={},p=null,d="",v=r,m=function(t,n,r){var i=Math.floor,s=r/16,o=1/16,u=1/s,a=.5/n.width,f=.5/n.height,l=i(n.width*o),c=i(n.height*u),h=[];h.length=r;for(var p=0;p<r;p+=1){var d=i(p%16)*o-a,v=i(p/16)*u-f;h[p]={width:l,height:c,awidth:l,xoffset:0,yoffset:0,left:d,top:v,right:d+o,bottom:v+u,page:0}}t.lineHeight=c,t.baseline=c,t.glyphs=h,t.numGlyphs=r,t.minGlyphIndex=0},g=function(t){function r(e,t,n){e[t+0]=255,e[t+1]=n&128?255:0,e[t+2]=255,e[t+3]=n&64?255:0,e[t+4]=255,e[t+5]=n&32?255:0,e[t+6]=255,e[t+7]=n&16?255:0,e[t+8]=255,e[t+9]=n&8?255:0,e[t+10]=255,e[t+11]=n&4?255:0,e[t+12]=255,e[t+13]=n&2?255:0,e[t+14]=255,e[t+15]=n&1?255:0}var n=[0,0,0,0,0,0,0,0,126,129,165,129,189,153,129,126,126,255,219,255,195,231,255,126,108,254,254,254,124,56,16,0,16,56,124,254,124,56,16,0,56,124,56,254,254,124,56,124,16,16,56,124,254,124,56,124,0,0,24,60,60,24,0,0,255,255,231,195,195,231,255,255,0,60,102,66,66,102,60,0,255,195,153,189,189,153,195,255,15,7,15,125,204,204,204,120,60,102,102,102,60,24,126,24,63,51,63,48,48,112,240,224,127,99,127,99,99,103,230,192,153,90,60,231,231,60,90,153,128,224,248,254,248,224,128,0,2,14,62,254,62,14,2,0,24,60,126,24,24,126,60,24,102,102,102,102,102,0,102,0,127,219,219,123,27,27,27,0,62,99,56,108,108,56,204,120,0,0,0,0,126,126,126,0,24,60,126,24,126,60,24,255,24,60,126,24,24,24,24,0,24,24,24,24,126,60,24,0,0,24,12,254,12,24,0,0,0,48,96,254,96,48,0,0,0,0,192,192,192,254,0,0,0,36,102,255,102,36,0,0,0,24,60,126,255,255,0,0,0,255,255,126,60,24,0,0,0,0,0,0,0,0,0,0,48,120,120,120,48,0,48,0,108,108,108,0,0,0,0,0,108,108,254,108,254,108,108,0,48,124,192,120,12,248,48,0,0,198,204,24,48,102,198,0,56,108,56,118,220,204,118,0,96,96,192,0,0,0,0,0,24,48,96,96,96,48,24,0,96,48,24,24,24,48,96,0,0,102,60,255,60,102,0,0,0,48,48,252,48,48,0,0,0,0,0,0,0,48,48,96,0,0,0,252,0,0,0,0,0,0,0,0,0,48,48,0,6,12,24,48,96,192,128,0,124,198,206,222,246,230,124,0,48,112,48,48,48,48,252,0,120,204,12,56,96,204,252,0,120,204,12,56,12,204,120,0,28,60,108,204,254,12,30,0,252,192,248,12,12,204,120,0,56,96,192,248,204,204,120,0,252,204,12,24,48,48,48,0,120,204,204,120,204,204,120,0,120,204,204,124,12,24,112,0,0,48,48,0,0,48,48,0,0,48,48,0,0,48,48,96,24,48,96,192,96,48,24,0,0,0,252,0,0,252,0,0,96,48,24,12,24,48,96,0,120,204,12,24,48,0,48,0,124,198,222,222,222,192,120,0,48,120,204,204,252,204,204,0,252,102,102,124,102,102,252,0,60,102,192,192,192,102,60,0,248,108,102,102,102,108,248,0,126,96,96,120,96,96,126,0,126,96,96,120,96,96,96,0,60,102,192,192,206,102,62,0,204,204,204,252,204,204,204,0,120,48,48,48,48,48,120,0,30,12,12,12,204,204,120,0,230,102,108,120,108,102,230,0,96,96,96,96,96,96,126,0,198,238,254,254,214,198,198,0,198,230,246,222,206,198,198,0,56,108,198,198,198,108,56,0,252,102,102,124,96,96,240,0,120,204,204,204,220,120,28,0,252,102,102,124,108,102,230,0,120,204,224,112,28,204,120,0,252,48,48,48,48,48,48,0,204,204,204,204,204,204,252,0,204,204,204,204,204,120,48,0,198,198,198,214,254,238,198,0,198,198,108,56,56,108,198,0,204,204,204,120,48,48,120,0,254,6,12,24,48,96,254,0,120,96,96,96,96,96,120,0,192,96,48,24,12,6,2,0,120,24,24,24,24,24,120,0,16,56,108,198,0,0,0,0,0,0,0,0,0,0,255,0,48,48,24,0,0,0,0,0,0,0,120,12,124,204,118,0,224,96,96,124,102,102,220,0,0,0,120,204,192,204,120,0,28,12,12,124,204,204,118,0,0,0,120,204,252,192,120,0,56,108,96,240,96,96,240,0,0,0,118,204,204,124,12,248,224,96,108,118,102,102,230,0,48,0,112,48,48,48,120,0,12,0,12,12,12,204,204,120,224,96,102,108,120,108,230,0,112,48,48,48,48,48,120,0,0,0,204,254,254,214,198,0,0,0,248,204,204,204,204,0,0,0,120,204,204,204,120,0,0,0,220,102,102,124,96,240,0,0,118,204,204,124,12,30,0,0,220,118,102,96,240,0,0,0,124,192,120,12,248,0,16,48,124,48,48,52,24,0,0,0,204,204,204,204,118,0,0,0,204,204,204,120,48,0,0,0,198,214,254,254,108,0,0,0,198,108,56,108,198,0,0,0,204,204,204,124,12,248,0,0,252,152,48,100,252,0,28,48,48,224,48,48,28,0,24,24,24,0,24,24,24,0,224,48,48,28,48,48,224,0,118,220,0,0,0,0,0,0,0,16,56,108,198,198,254,0],i=new Array(32768),s,o,u,a,f,l,c;u=0,l=0,c=256;for(o=0;o<16;o+=1){a=u;for(s=0;s<16;s+=1){for(f=0;f<8;f+=1)r(i,a+f*c,n[l]),l+=1;a+=16}u+=2048}return t.createTexture({name:"defaultFont",width:128,height:64,depth:1,format:"L8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:i})},y=new e;y.primitive=t.PRIMITIVE_TRIANGLES,y.primitiveFan=t.PRIMITIVE_TRIANGLE_FAN,y.semantics=t.createSemantics(["POSITION","TEXCOORD0"]),y.techniqueParameters=t.createTechniqueParameters({texture:null}),y.sharedIndexBuffer=null,y.sharedVertexBuffer=null,y.reusableArrays={},y.float32ArrayConstructor=Array;if(typeof Float32Array!="undefined"){var b=new Float32Array(4),w=Object.prototype.toString.call(b);w==="[object Float32Array]"&&(y.float32ArrayConstructor=Float32Array)}if(!v){v=new ln(t,y);var E=g(t);E&&(m(v,E,128),v.texture=E,v.pageWidth=128,v.pageHeight=64)}o["default"]=v;var S=function(t,n){t.texture=n,t.pageWidth=n.width,t.pageHeight=n.height;var r=t.glyphs;r||m(t,n,256)},x=function(r,s){function h(){return f[r]-=1,f[r]===0?(delete f[r],delete u[r],c-=1,!0):!1}function m(e,n){var s=o[r];if(!s){h();return}t.createTexture({src:e,mipmaps:!0,onload:n})||(i("Failed to create texture for font '"+r+"'."),delete o[r],h())}var g=o[r];if(!g){if(r in u)s&&a[r].subscribe(s);else{u[r]=!0,f[r]=0,c+=1;var b=l.create();a[r]=b,s&&b.subscribe(s);var w=function(s,l){if(l!==200||!s){i("Failed to load font file: '"+r+"'."),b.notify(null),delete f[r],delete u[r],c-=1,l===404&&(o[r]=v);return}g=new ln(t,y);var w=JSON.parse(s),E=w.bitmapfontlayouts;for(var x in E)if(E.hasOwnProperty(x)){var T=E[x];g.bold=T.bold||!1,g.italic=T.italic||!1,g.pageWidth=T.pagewidth||0,g.pageHeight=T.pageheight||0,g.baseline=T.baseline||0,g.glyphs=T.glyphs||null,g.numGlyphs=T.numglyphs||0,g.minGlyphIndex=T.minglyphindex||0,g.lineHeight=T.lineheight||0,g.pages=T.pages||null,g.kernings=T.kernings||null;break}o[r]=g;var N,C=g.pages;if(C){var k=C.length;f[r]+=k;var L=function(t,n,s){var u=o[r],f=s.index;if(u){if(t){C[f]=t,f===0&&(u.texture=t),h()&&(b.notify(u),delete a[r]);return}i("Failed to load font page: '"+C[f]+"'."),delete o[r]}h()};for(var A=0;A<k;A+=1)N=C[A],n.request({src:p&&p[N]||d+N,onload:L,requestFn:m,index:A})}else N=r+".dds",n.request({src:p&&p[N]||d+N,onload:function(e){e?(S(g,e),b.notify(g),delete a[r]):(i("Failed to load font page: '"+N+"'."),delete o[r]),delete f[r],delete u[r],c-=1},requestFn:function(e,n){t.createTexture({src:e,mipmaps:!1,onload:n})||(s?i("Failed to create texture for font '"+r+"'."):i("Failed to load font '"+r+"'."),delete o[r],delete f[r],delete u[r],c-=1)}})},E=r,x,T=E.lastIndexOf(".");T!==-1&&(x=E.substr(T));if(!x||x!==".fnt"&&x!==".fontdat")E+=".fontdat";n.request({src:p&&p[E]||d+E,onload:w})}g=v}else s&&TurbulenzEngine.setTimeout(function(){s(g)},0);return g},T=function(t,n){o[t]=o[n],h[t]=!0},N=function(t){t in o&&delete o[t]};return s?(y.load=function(t,n){return s.innerHTML+="FontManager.load:&nbsp;'"+t+"'",x(t,n)},y.map=function(t,n){s.innerHTML+="FontManager.map:&nbsp;'"+n+"' -> '"+t+"'",T(t,n)},y.remove=function(t){s.innerHTML+="FontManager.remove:&nbsp;'"+t+"'",N(t)}):(y.load=x,y.map=T,y.remove=N),y.get=function(t){var n=o[t];return n?n:v},y.getAll=function(){return o},y.getNumPendingFonts=function(){return c},y.isFontLoaded=function(t){return!u[t]},y.isFontMissing=function(t){return!o[t]},y.setPathRemapping=function(t,n){p=t,d=n},y.calculateTextDimensions=function(t,n,r,i){var s=o[t];return s?s.calculateTextDimensions(n,r,i):{width:0,height:0,numGlyphs:0}},y.reuseVertices=function(t){this.reusableArrays[t.length>>4]=t},y.destroy=function(){if(o){var r;for(r in o)if(o.hasOwnProperty(r)){var i=o[r];if(i){var s=i.texture;s&&(s.destroy(),i.texture=null)}}o=null}this.sharedVertexBuffer&&(this.sharedVertexBuffer.destroy(),this.sharedVertexBuffer=null),this.sharedIndexBuffer&&(this.sharedIndexBuffer.destroy(),this.sharedIndexBuffer=null),this.techniqueParameters=null,this.semantics=null,u=null,f=null,a=null,f=null,c=0,h=null,p=null,d=null,n=null,t=null},y},e.version=1,e}(),hn=function(){function e(){this.version=1}return e.prototype.setSelectedRadio=function(e,t){var n=this.radioControls[e],r;n&&(r=n.controls[t],r&&(n.selected=t,this.updateRadio(r.id,!0)))},e.prototype.addRadioControl=function(e){var t=this.radioControls,n=e.groupName,r=e.radioIndex,i=e.id,s=e.fn,o=e.isDefault;if(n===undefined||n===null||r<0||i===undefined||i===null||s===undefined||s===null)return;var u=t[n];u||(t[n]={},u=t[n],u.controls=[],u.selected=0),u.controls[r]=e,o&&(u.selected=r),this.updateRadio(i,o)},e.prototype.addCheckboxControl=function(e){var t=this.checkboxControls,n=e.id,r=e.value;t[r]=e,this.updateCheckbox(n,e.isSelected)},e.prototype.addButtonControl=function(e){var t=this.buttonControls,n=e.id;t[n]=e},e.prototype.addSliderControl=function(e){var t=this.sliderControls;t[e.id]=e},e.prototype.getSliderValue=function(e){var t=window.$("#"+e).value;return t?parseInt(t,10):undefined},e.prototype.getHandler=function(){var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls;return function(r){var i;r||(r=window.event),r.target?i=r.target:r.srcElement&&(i=r.srcElement),i.nodeType===3&&(i=i.parentNode);var s=i.id,o;switch(i.type){case"radio":for(var u in e)if(e.hasOwnProperty(u)){var a=0,f=e[u].controls,l=f.length;while(a<l){o=f[a];if(o.id===s){o.fn();return}a+=1}}break;case"checkbox":for(var c in t)if(t.hasOwnProperty(c)){o=t[c];if(o.id===s){var h=o.fn();h!==undefined&&(document.getElementById(o.id).checked=!!h);return}}break;case"button":for(var p in n)if(n.hasOwnProperty(p)){o=n[p];if(p===s){o.fn();return}}break;default:}}},e.prototype.register=function(){function d(e){return function(t,n){var r=window.$("#"+e+"input");r.val(n.value),r.change()}}function v(e,t){return function(){var n=parseFloat(this.value);if(!window.$)return;var r=window.$("#"+t),i=window.$("#"+t+"input");if(!r||!i)return;var s=r.slider("value");if(n===undefined||isNaN(n)||s===undefined||isNaN(s)||s===n)return;var o=r.slider("option","min"),u=r.slider("option","max");n<o?n=o:n>u&&(n=u),i.val(n),e.value=n,e.fn()}}var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls,r=this.sliderControls,i,s,o;for(var u in e)if(e.hasOwnProperty(u)){var a=e[u].selected,f=e[u].controls,l=f.length;for(var c=0;c<l;c+=1)i=f[c],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.name=i.groupName,s.onclick=this.getHandler(),s.checked=a===i.radioIndex?"checked":"")}for(var h in t)t.hasOwnProperty(h)&&(i=t[h],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler(),s.checked=i.isSelected?"checked":""));for(var p in n)n.hasOwnProperty(p)&&(i=n[p],o=p,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler()));for(var m in r)if(r.hasOwnProperty(m)){i=r[m],o=i.id;if(!window.$)return;var g=window.$("#"+o),y=window.$("#"+o+"input");if(!g||!y)return;g.slider({value:i.value,min:i.min,max:i.max,step:i.step,slide:d(o)}),y.val(g.slider("value")),y.change(v(i,o))}this.registered=!0},e.prototype.updateRadio=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateCheckbox=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateSlider=function(e,t){if(!this.registered)return;if(window.$){var n=window.$("#"+e);n&&n.slider("option","value",t)}},e.create=function(){var t=new e;return t.radioControls={},t.checkboxControls={},t.buttonControls={},t.sliderControls=
{},t.registered=!1,t},e}();TurbulenzEngine.onload=function(){function p(){xt.createMappingTable(u,h,function(e){var t=e.urlMapping,n=e.assetPrefix;f.setPathRemapping(t,n),a.setPathRemapping(t,n),a.load("fonts/hero.fnt",function(e){l=e}),f.load("shaders/font.cgfx",function(e){c=e})})}function S(){function a(e,t,n,r){var i=d.createRigidBody({shapes:[d.createCircleShape({radius:n})],position:[e,t]});b.addRigidBody(i);if(r){var s=d.createPointConstraint({bodyA:w,bodyB:i,anchorA:[e,t],anchorB:[0,0],userData:"pin"});b.addConstraint(s)}return i}b.clear(),E=null;var e=d.createRigidBody({type:"static"}),t=.01,s;for(s=0;s<=4;s+=1){var o=v/4*s;e.addShape(d.createPolygonShape({vertices:d.createRectangleVertices(o-t,0,o+t,m)}))}for(s=0;s<=2;s+=1){var u=m/2*s;e.addShape(d.createPolygonShape({vertices:d.createRectangleVertices(0,u-t,v,u+t)}))}b.addRigidBody(e);var f,l,c;f=a(3.3,5,1),l=a(6.6,5,1),c=[5,5];var h=d.createPointConstraint({bodyA:f,bodyB:l,anchorA:f.transformWorldPointToLocal(c),anchorB:l.transformWorldPointToLocal(c),stiff:!n,frequency:r,damping:i});b.addConstraint(h),f=a(13.3,5,1),l=a(16.6,5,1),c=[15,5];var p=d.createWeldConstraint({bodyA:f,bodyB:l,anchorA:f.transformWorldPointToLocal(c),anchorB:l.transformWorldPointToLocal(c),phase:0,stiff:!n,frequency:r,damping:i});b.addConstraint(p),f=a(23.3,5,1),l=a(26.6,5,1);var g=d.createDistanceConstraint({bodyA:f,bodyB:l,anchorA:[1,0],anchorB:[-1,0],lowerBound:1,upperBound:3,stiff:!n,frequency:r,damping:i});b.addConstraint(g),f=a(33.3,5,1),l=a(36.6,5,1),c=[35,5];var y=d.createLineConstraint({bodyA:f,bodyB:l,anchorA:f.transformWorldPointToLocal(c),anchorB:l.transformWorldPointToLocal(c),axis:[0,1],lowerBound:-1,upperBound:1,stiff:!n,frequency:r,damping:i});b.addConstraint(y),f=a(3,15,1.5,!0),l=a(7,15,1.5,!0);var S=d.createAngleConstraint({bodyA:f,bodyB:l,ratio:3,lowerBound:-Math.PI*2,upperBound:Math.PI*2,stiff:!n,frequency:r,damping:i});b.addConstraint(S),f=a(13,15,1.5,!0),l=a(17,15,1.5,!0);var x=d.createMotorConstraint({bodyA:f,bodyB:l,ratio:4,rate:20});b.addConstraint(x);var T;f=a(23.3,16.6,.5),l=a(25,13.3,1,!0),T=a(26.6,16.6,.5);var N=d.createDistanceConstraint({bodyA:f,bodyB:l,lowerBound:.25,upperBound:Number.POSITIVE_INFINITY,anchorA:[0,-0.5],anchorB:[-1,0],userData:"pin"});b.addConstraint(N);var C=d.createDistanceConstraint({bodyA:T,bodyB:l,lowerBound:.25,upperBound:Number.POSITIVE_INFINITY,anchorA:[0,-0.5],anchorB:[1,0],userData:"pin"});b.addConstraint(C);var k=d.createPulleyConstraint({bodyA:f,bodyB:l,bodyC:l,bodyD:T,anchorA:[0,-0.5],anchorB:[-1,0],anchorC:[1,0],anchorD:[0,-0.5],ratio:2,lowerBound:6,upperBound:8,stiff:!n,frequency:r,damping:i});b.addConstraint(k),f=a(35,13.3,1),l=a(35,16.6,1,!0);var L=d.createLineConstraint({bodyA:w,bodyB:f,anchorA:[35,13.3],anchorB:[0,0],axis:[1,0],lowerBound:-5,upperBound:5,userData:"pin"});b.addConstraint(L);var A=d.createCustomConstraint({bodies:[f,l],dimension:1,position:function(t,n){var r=this.bodies[0],i=this.bodies[1];t[n]=Math.PI/5*(r.getPosition()[0]-35)-i.getRotation()},jacobian:function(t,n){t[n]=Math.PI/5,t[n+1]=0,t[n+2]=0,t[n+3]=0,t[n+4]=0,t[n+5]=-1},debugDraw:function(t,n){if(n)return;var r=this.bodies[0],i=this.bodies[1],s=r.getPosition(),o=i.getPosition(),u=i.getRotation()/(Math.PI/5)+35,a=Math.PI/5*(s[0]-35),f=3*t.screenToPhysics2D;t.drawLinearSpring(s[0],s[1],u,s[1],3,f,[1,0,0,1]),t.drawSpiralSpring(o[0],o[1],a,i.getRotation(),f,f*2,[0,0,1,1])},stiff:!n,frequency:r,damping:i});b.addConstraint(A)}function x(){var e=b.constraints,t=e.length,s;for(s=0;s<t;s+=1){var o=e[s];if(o===E||o.userData==="pin")continue;o.configure({stiff:!n,frequency:r,damping:i})}}function j(){function n(e,t,n,r){var i=g.viewportUnmap(e,t),s=g.viewportUnmap(e+10,t+r);l.drawTextRect(n,{rect:[i[0],i[1],s[0]-i[0],s[1]-i[1]],scale:1,spacing:0,alignment:1})}if(!s.beginFrame())return;T.update(),s.clear([.3,.3,.3,1]),E&&E.setAnchorA(g.viewportMap(k,L));var e=TurbulenzEngine.time,t=e-P;t>.05&&(t=.05),D+=t,P=e;while(b.simulatedTime<D)b.step(1/60);y.setScreenViewport(g.getScreenSpaceViewport()),y.begin(),y.drawWorld(b),y.end(),s.setTechnique(H),B.clipSpace=o.v4Build(2/s.width,-2/s.height,-1,1,B.clipSpace),s.setTechniqueParameters(B);var r=.75;n(0,0,"Point",r),n(10,0,"Weld",r),n(20,0,"Distance",r),n(30,0,"Line",r),n(0,10,"Angle",r),n(10,10,"Motor",r),n(20,10,"Pulley",r),n(30,10,"Custom",r),s.endFrame()}function I(){l&&c&&(H=c.getTechnique("font"),B=s.createTechniqueParameters({clipSpace:o.v4BuildZero(),alphaRef:.01,color:o.v4BuildOne()}),TurbulenzEngine.clearInterval(F),F=TurbulenzEngine.setInterval(j,1e3/60))}function q(){t=hn.create(),t.addCheckboxControl({id:"elasticConstraints",value:"elasticConstraints",isSelected:n,fn:function(){return n=!n,x(),n}}),t.addSliderControl({id:"frequencySlider",value:r,max:10,min:.25,step:.25,fn:function(){r=this.value,t.updateSlider("frequencySlider",r),n&&x()}}),t.addSliderControl({id:"dampingSlider",value:i,max:2,min:0,step:.25,fn:function(){i=this.value,t.updateSlider("dampingSlider",i),n&&x()}}),t.register()}var t,n=!1,r=1,i=.1,s=TurbulenzEngine.createGraphicsDevice({}),o=TurbulenzEngine.createMathDevice({}),u=bt.create({}),a=cn.create(s,u),f=kt.create(s,u),l,c,h;h=xt.createGameSession(u,p);var d=tn.create(),v=40,m=20,g=on.create({graphicsDevice:s}),y=fn.create({graphicsDevice:s});g.configure({viewportRectangle:[0,0,v,m],scaleMode:"scale"}),y.setPhysics2DViewport([0,0,v,m]);var b=d.createWorld({gravity:[0,20]}),w=d.createRigidBody({type:"static"});b.addRigidBody(w);var E=null;S();var T=TurbulenzEngine.createInputDevice({}),N=T.keyCodes,C=T.mouseCodes,k=0,L=0,A=function(t,n){k=t,L=n};T.addEventListener("mouseover",A);var O=function(t){t===N.R&&S()};T.addEventListener("keyup",O);var M=function(t,n,r){k=n,L=r;if(E)return;var i=g.viewportMap(n,r),s;if(t===C.BUTTON_0){var o=[],u=b.bodyPointQuery(i,o),a;for(a=0;a<u;a+=1)s=o[a],s.isDynamic()&&(E=d.createPointConstraint({bodyA:w,bodyB:s,anchorA:i,anchorB:s.transformWorldPointToLocal(i),stiff:!1,maxForce:1e5}),b.addConstraint(E))}};T.addEventListener("mousedown",M);var _=function(){E&&(b.removeConstraint(E),E=null)};T.addEventListener("mouseleave",_),T.addEventListener("mouseup",_);var D=0,P=TurbulenzEngine.time,H,B,F=0;F=TurbulenzEngine.setInterval(I,100),q(),TurbulenzEngine.onunload=function(){F&&TurbulenzEngine.clearInterval(F),h&&(h.destroy(),h=null)}},window.TurbulenzEngine=TurbulenzEngine})();